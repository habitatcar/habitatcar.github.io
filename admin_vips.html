<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel VIPs | H치bitat-Car</title>
    <style>
        :root {
            --azul-oscuro: #0a192f;
            --azul-medio: #334766; 
            --azul-claro: #415a77;
            --celeste-habitat: #004a99;
            --blanco-suave: #e6f1ff;
            --oro: #ffc107;
            --rojo: #dc3545;
            --verde: #28a745;
            --naranja: #ff9800;
        }

        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--azul-oscuro);
            color: var(--blanco-suave);
        }

        body { display: flex; flex-direction: column; }

        .header {
            background: var(--azul-medio);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--oro);
        }

        .logo-container { display: flex; align-items: center; gap: 15px; }
        .logo-container img { height: 50px; }
        .logo-container h1 { margin: 0; font-size: 24px; color: var(--oro); }

        .nav-buttons { display: flex; gap: 10px; }
        .btn-nav {
            background: transparent;
            border: 1px solid var(--oro);
            color: var(--oro);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: 0.3s;
        }
        .btn-nav:hover { background: var(--oro); color: var(--azul-oscuro); }

        .search-container {
            background: var(--azul-claro);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-container input, .search-container select {
            padding: 10px;
            border-radius: 5px;
            border: none;
            outline: none;
        }

        .main-content { flex: 1; overflow-y: auto; padding: 20px 30px; }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: var(--azul-medio); color: var(--oro); position: sticky; top: 0; }

        .estado-activo { color: var(--verde); font-weight: bold; }
        .estado-suspendido { color: var(--rojo); font-weight: bold; }

        .acciones { display: flex; gap: 8px; }
        .acciones button {
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-oro { background: var(--oro); color: var(--azul-oscuro); }
        .btn-azul { background: var(--celeste-habitat); color: white; }
        .btn-rojo { background: var(--rojo); color: white; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo-container">
            <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="Logo">
            <h1>Panel de Control VIP</h1>
        </div>
        <div class="nav-buttons">
            <a href="admin_leads.html" class="btn-nav">Ir a Leads</a>
            <a href="admin_logs.html" class="btn-nav">Ver Logs</a>
            <a href="index.html" class="btn-nav">Cerrar Sesi칩n</a>
        </div>
    </div>

    <div class="search-container">
        <input type="text" id="buscador" placeholder="Buscar..." onkeyup="filtrarVips()" style="width: 70px;">
        
        <select id="filtro-provincia" onchange="filtrarVips()">
            <option value="">Provincia: Todas</option>
        </select>
        
        <select id="filtro-localidad" onchange="filtrarVips()">
            <option value="">Localidad: Todas</option>
        </select>
    </div>

    <div class="main-content">
        <table id="tabla-vips">
            <thead>
                <tr>
                    <th>Nombre y Apellido</th>
                    <th>WhatsApp</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="cuerpo-tabla">
                </tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            storageBucket: "habitat-car.firebasestorage.app",
            projectId: "habitat-car",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let todosLosVips = [];

        onSnapshot(collection(db, "leads"), (snap) => {
            todosLosVips = [];
            const provs = new Set();
            const locs = new Set();

            snap.forEach(doc => {
                const data = doc.data();
                if (data.convertidoVIP === true) {
                    todosLosVips.push({ id: doc.id, ...data });
                    if(data.provincia) provs.add(data.provincia);
                    if(data.localidad) locs.add(data.localidad);
                }
            });

            // L칩gica para llenar los selectores din치micamente
            const sProv = document.getElementById('filtro-provincia');
            const sLoc = document.getElementById('filtro-localidad');
            const valProv = sProv.value;
            const valLoc = sLoc.value;

            sProv.innerHTML = '<option value="">Provincia: Todas</option>';
            [...provs].sort().forEach(p => sProv.innerHTML += `<option value="${p}">${p}</option>`);
            sProv.value = valProv;

            sLoc.innerHTML = '<option value="">Localidad: Todas</option>';
            [...locs].sort().forEach(l => sLoc.innerHTML += `<option value="${l}">${l}</option>`);
            sLoc.value = valLoc;

            filtrarVips();
        });

        window.renderizar = (lista) => {
            const cuerpo = document.getElementById('cuerpo-tabla');
            cuerpo.innerHTML = "";
            lista.forEach(v => {
                const id = v.id;
                const apellido = v.apellido || "";
                const nombres = v.nombres || "";
                const whatsapp = v.whatsapp || "";
                const estado = v.estado || "activo";

                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td>${apellido}, ${nombres}</td>
                    <td>${whatsapp}</td>
                    <td><span class="estado-${estado}">${estado.toUpperCase()}</span></td>
                    <td class="acciones">
                        <button class="btn-oro" onclick="restablecer('${id}', '${apellido}', '${nombres}')">游댃</button>
                        <button class="btn-azul" onclick="toggleEstado('${id}', '${estado}', '${apellido} ${nombres}')">游뛂</button>
                        <button class="btn-rojo" onclick="bajaVip('${id}', '${apellido}', '${nombres}')">游늴</button>
                    </td>
                `;
                cuerpo.appendChild(fila);
            });
        };

        async function registrarActividad(id, nombre, accion) {
            await addDoc(collection(db, "logs_actividad"), {
                usuarioId: id,
                nombreUsuario: nombre,
                accion: accion,
                timestamp: Date.now()
            });
        }

        window.restablecer = async (id, apellido, nombres) => {
            if(confirm(`Restablecer cupones de ${apellido}?`)) {
                await updateDoc(doc(db, "leads", id), {
                    usos: [],
                    cupones_usados: 0,
                    lastSubmission: Date.now()
                });
                await registrarActividad(id, `${apellido}, ${nombres}`, "RESTABLECER CUPONES VIP");
                alert("Cupones restablecidos.");
            }
        };

        window.filtrarVips = () => {
            const b = document.getElementById('buscador').value.toLowerCase();
            const p = document.getElementById('filtro-provincia').value;
            const l = document.getElementById('filtro-localidad').value;

            // L칩gica de filtrado por b칰squeda, provincia y localidad
            const filtrados = todosLosVips.filter(v => {
                const matchBusqueda = (v.apellido && v.apellido.toLowerCase().includes(b)) || 
                                      (v.whatsapp && v.whatsapp.includes(b));
                const matchProv = p === "" || v.provincia === p;
                const matchLoc = l === "" || v.localidad === l;
                return matchBusqueda && matchProv && matchLoc;
            });

            renderizar(filtrados);
        };

        window.toggleEstado = async (id, est, nombreCompleto) => {
            const n = est === 'suspendido' ? 'activo' : 'suspendido';
            const ahora = Date.now();
            await updateDoc(doc(db, "leads", id), { estado: n, lastSubmission: ahora });
            await registrarActividad(id, nombreCompleto, `ESTADO VIP: ${n.toUpperCase()}`);
        };

        window.bajaVip = async (id, apellido, nombres) => {
            if(confirm(`쯈uitar estado VIP a ${apellido}? Volver치 a la lista de Leads.`)) {
                const ahora = Date.now();
                await updateDoc(doc(db, "leads", id), { convertidoVIP: false, lastSubmission: ahora });
                await registrarActividad(id, `${apellido}, ${nombres}`, "BAJA VIP (VUELVE A LEAD)");
            }
        };
    </script>
</body>
</html>
