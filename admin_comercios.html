<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HABITAT-CAR | PANEL ADMINISTRATIVO v6.7</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { 
            --azul-oscuro: #0a192f;
            --azul-medio: #334766; 
            --azul-claro: #415a77;
            --celeste-habitat: #004a99;
            --blanco-suave: #e6f1ff;
            --borravino: #800020; 
            --verde: #28a745; 
            --rojo: #dc3545; 
            --oro: #ffc107; 
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--azul-oscuro); 
            color: var(--blanco-suave);
            margin: 0; 
            padding: 0; 
        }

        #capa-seguridad {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--azul-oscuro); z-index: 9999; display: flex;
            justify-content: center; align-items: center; font-weight: bold;
        }

        .header {
            background: var(--azul-medio);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 4px solid var(--celeste-habitat);
            position: sticky;
            top: 0;
            z-index: 1100;
        }
        .logo { height: 90px; width: auto; } 

        .nav-menu { display: flex; gap: 8px; flex-wrap: wrap; }
        .nav-link {
            padding: 8px 15px;
            border-radius: 6px;
            text-decoration: none;
            color: white;
            font-weight: bold;
            background: var(--azul-claro);
            transition: 0.3s;
            font-size: 12px;
        }
        .nav-link.active { background: var(--rojo); box-shadow: 0 0 10px rgba(220, 53, 69, 0.5); }

        .tools-faja {
            position: sticky;
            top: 124px; 
            z-index: 1000;
            background: #ffffff; 
            padding: 11px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-container { position: relative; flex: 1; max-width: 350px; }
        .search-input { 
            width: 100%; padding: 10px 12px 10px 45px; 
            border: 2px solid var(--borravino); 
            border-radius: 25px; outline: none; font-size: 1em;
            color: #1a1a1a; 
            font-weight: 600;
            background: #fff;
        }
        .search-icon { position: absolute; left: 18px; top: 12px; color: var(--borravino); font-size: 1.1em; }

        .btn-tool { 
            padding: 8px 12px; border: 2px solid var(--borravino); 
            background: white; color: var(--borravino); 
            cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.2s; font-size: 0.9em;
        }
        .btn-tool.active { background: var(--borravino); color: white; }

        .stat-badge { padding: 6px 12px; border-radius: 20px; color: white; font-weight: bold; font-size: 0.8em; display: flex; align-items: center; gap: 5px; }

        .wrapper { max-width: 1600px; margin: 20px auto; display: grid; grid-template-columns: 420px 1fr; gap: 35px; padding: 0 25px; align-items: start; }

        .card-form { 
            background: var(--azul-medio); 
            padding: 30px; 
            border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.1);
            position: fixed; 
            width: 360px;   
            top: 210px;     
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            max-height: calc(100vh - 240px); 
            overflow-y: auto; 
            z-index: 900;
        }

        .card-form::-webkit-scrollbar { width: 8px; }
        .card-form::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 10px; }
        .card-form::-webkit-scrollbar-thumb { background: var(--azul-claro); border-radius: 10px; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .full { grid-column: span 2; }
        
        input, select { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--azul-claro); 
            background: var(--azul-oscuro); 
            color: #ffffff; 
            box-sizing: border-box; 
            font-size: 0.95em;
        }

        .read-only { 
            background: #000 !important; 
            color: var(--oro) !important; 
            font-weight: bold; 
            border: 2px solid var(--oro) !important; 
            text-align: center;
        }
        
        .btn-submit { 
            width: 100%; background: var(--verde); color: white; border: none; padding: 18px; 
            border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.1em; margin-top: 20px;
        }

        .comercio-card { 
            background: var(--azul-medio); 
            border-radius: 20px; 
            margin-bottom: 30px; 
            border-left: 15px solid var(--borravino); 
            display: flex; 
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transition: 0.3s;
        }

        .comercio-card.inactive { background: #121b29; border-left-color: #333; }
        .visual-side { width: 160px; background: rgba(0,0,0,0.15); display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 25px; border-right: 1px solid rgba(255,255,255,0.05); }
        .img-preview { width: 120px; height: 120px; object-fit: cover; border-radius: 12px; background: white; border: 3px solid var(--azul-claro); cursor: zoom-in; }
        
        .info-side { flex: 1; padding: 25px; }
        .comercio-title { font-size: 2.2em; color: var(--oro); margin: 0 0 15px 0; font-weight: 900; }
        .data-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 18px; }
        .data-box b { display: block; color: #cbd5e0; font-size: 0.8em; text-transform: uppercase; margin-bottom: 5px; }
        .data-box span { font-size: 1.1em; color: white; font-weight: 600; }
        .benefit-box { grid-column: span 2; background: rgba(0,0,0,0.25); padding: 12px; border-radius: 10px; border-left: 4px solid var(--borravino); }
        .highlight-ben { color: var(--verde) !important; font-size: 1.3em !important; font-weight: 800 !important; }
        
        .btn-group { margin-top: 25px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; }
        .btn-op { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; color: white; font-weight: bold; font-size: 0.9em; transition: 0.3s; }

        /* Botones de Administraci√≥n en la Card */
        .btn-directo {
            background: var(--celeste-habitat);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            transition: 0.3s;
            text-align: center;
            width: 120px;
            display: inline-block;
        }
        .btn-directo:hover { background: var(--oro); color: var(--azul-oscuro); }
        
        .btn-copiar-link {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn-copiar-link:hover { background: var(--verde); }

        .social-box { display: flex; align-items: center; gap: 10px; border-left: 1px solid rgba(255,255,255,0.1); padding-left: 15px; }
        .social-link { 
            width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; 
            border-radius: 50%; text-decoration: none; font-size: 1.1em; transition: 0.3s;
        }
        .social-link:hover { transform: scale(1.15); filter: brightness(1.2); }
        
        .bg-fb { background: #1877F2; color: white; }
        .bg-ig { background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); color: white; }
        .bg-tk { background: #000000; color: white; border: 1px solid #fff; }
        .bg-web { background: #00d2ff; color: white; }
        
        .owner-email {
            display: flex; align-items: center; gap: 8px; color: var(--oro); text-decoration: none;
            font-weight: bold; font-size: 0.9em; padding: 6px 14px; background: rgba(255,193,7,0.15);
            border-radius: 20px; border: 1px solid var(--oro); transition: 0.3s;
        }
        .owner-email:hover { background: var(--oro); color: var(--azul-oscuro); }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; justify-content: center; align-items: center; }
        #modal-img { max-width: 90%; max-height: 90%; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="capa-seguridad">VALIDANDO SESI√ìN SEGURA...</div>

    <header class="header">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" class="logo">
        <nav class="nav-menu" id="nav-menu-principal">
            <a href="admin_comercios.html" class="nav-link active">COMERCIOS</a>
            <a href="admin_leads.html" class="nav-link">LEADS</a>
            <a href="admin_vips.html" class="nav-link">VIPS</a>
            <a href="admin_tokens_vip.html" class="nav-link">TOKENS VIP</a>
            <a href="admin_curioso.html" class="nav-link">CURIOSO</a>
            <a href="admin_estadisticas.html" class="nav-link">ESTAD√çSTICAS</a>
            <a href="admin_logs.html" class="nav-link">LOG</a>
            <a href="admin_tutoriales.html" class="nav-link">TUTORIALES</a>
            <a href="index.html" class="nav-link">PANEL DE INGRESO</a>
            <a href="admin_legales.html" class="nav-link">LEGALES</a>
        </nav>
    </header>

    <div class="tools-faja" id="faja-herramientas">
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="masterSearch" class="search-input" placeholder="Buscar comercio..." oninput="window.render()">
        </div>
        <div style="display: flex; gap: 10px;">
            <div class="stat-badge" style="background:#4a5568">TOTAL: <span id="count-total">0</span></div>
            <div class="stat-badge" style="background:var(--verde)">ACTIVOS: <span id="count-act">0</span></div>
            <div class="stat-badge" style="background:var(--rojo)">INACTIVOS: <span id="count-inact">0</span></div>
        </div>
        <div style="display: flex; gap: 8px;">
            <button id="fil-todos" class="btn-tool active" onclick="window.cambiarFiltro('todos', 'fil-todos')">Ver Todos</button>
            <button id="fil-inact" class="btn-tool" onclick="window.cambiarFiltro('inactivo', 'fil-inact')">Ver Inactivos</button>
        </div>
    </div>

    <div class="wrapper">
        <aside class="sidebar">
            <div class="card-form">
                <h3 id="titulo-form" style="margin-top:0; color:var(--oro); font-size: 1.5em; text-align: center; margin-bottom: 25px;">‚ûï REGISTRAR COMERCIO</h3>
                <input type="hidden" id="edit-id">
                <div class="form-grid">
                    <input type="text" id="nombre-input" class="full" placeholder="Nombre Fantas√≠a" oninput="genID()">
                    <input type="text" id="id-input" class="read-only" placeholder="ID SISTEMA (AUTO)" readonly>
                    <input type="text" id="token-input" class="read-only" placeholder="TOKEN QR (AUTO)" readonly>
                    <input type="text" id="logo-input" class="full" placeholder="URL Logotipo">
                    <input type="number" id="val-lead" placeholder="Desc. Lead %">
                    <input type="number" id="vig-lead" placeholder="Vigencia Lead (D√≠as)">
                    <input type="text" id="txt-lead" class="full" placeholder="Detalle Lead (Ej: En servicios)">
                    <input type="number" id="val-vip" placeholder="Desc. VIP %">
                    <input type="number" id="vig-vip" placeholder="Vigencia VIP (D√≠as)">
                    <input type="text" id="txt-vip" class="full" placeholder="Detalle VIP (Ej: En toda la compra)">
                    <input type="text" id="direccion-input" class="full" placeholder="Direcci√≥n">
                    <input type="text" id="ciudad-input" placeholder="Ciudad">
                    <input type="text" id="telefono-input" placeholder="WhatsApp (N√∫mero)">
                    <input type="text" id="facebook-input" class="full" placeholder="URL FACEBOOK">
                    <input type="text" id="instagram-input" class="full" placeholder="URL INSTAGRAM">
                    <input type="text" id="web-input" class="full" placeholder="URL TIK TOK">
                    <input type="text" id="sitio-web-input" class="full" placeholder="Sitio Web (URL)">
                    <input type="email" id="email-input" class="full" placeholder="Email Due√±o">
                    <input type="password" id="password-input" class="full" placeholder="CONTRASE√ëA DUE√ëO (OBLIGATORIO)" style="border: 2px solid var(--oro)">
                    <select id="reporte-input" class="full">
                        <option value="Semanal">Reporte Semanal</option>
                        <option value="Quincenal">Reporte Quincenal</option>
                        <option value="Mensual">Reporte Mensual</option>
                    </select>
                </div>
                <button class="btn-submit" onclick="guardar()">GUARDAR COMERCIO ‚úÖ</button>
                <button id="btn-cancel-edit" class="btn-op" style="display:none; width:100%; margin-top:10px; background:#666" onclick="window.clear()">CANCELAR EDICI√ìN</button>
            </div>
        </aside>

        <main id="lista-comercios"></main>
    </div>

    <div id="modal" onclick="this.style.display='none'">
        <img id="modal-img" src="">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const urlParams = new URLSearchParams(window.location.search);
        const idForzado = urlParams.get('id');
        let COMERCIOS = [];
        let FILTRO_ESTADO = 'todos';

        window.addEventListener('load', () => {
            if (idForzado) {
                const token = sessionStorage.getItem('token_habitat_' + idForzado);
                if (!token) {
                    document.body.innerHTML = "<div style='background:#0a192f; height:100vh; color:white; display:flex; justify-content:center; align-items:center; flex-direction:column;'><h1>ACCESO RESTRINGIDO</h1><p>Por favor, ingrese desde el Panel de Auditor√≠a.</p></div>";
                    setTimeout(() => window.location.href = 'index.html', 3000);
                    return;
                }
                const nav = document.getElementById('nav-menu-principal');
                const faja = document.getElementById('faja-herramientas');
                if(nav) nav.style.display = 'none';
                if(faja) faja.style.display = 'none';
            }
            const capa = document.getElementById('capa-seguridad');
            if(capa) capa.style.display = 'none';
        });

        const formatearFecha = (ts) => {
            if (!ts) return "Sin env√≠os";
            try {
                if (typeof ts === 'string') return ts;
                let fecha = ts.toDate ? ts.toDate() : new Date(Number(ts));
                return fecha.toLocaleString('es-AR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
            } catch (e) { return "---"; }
        };

        onSnapshot(collection(db, "comercios"), (snap) => {
            COMERCIOS = snap.docs.map(d => ({ ...d.data(), fbId: d.id }));
            window.render();
            if(idForzado && COMERCIOS.length > 0) {
                const comActual = COMERCIOS.find(x => x.idComercio === idForzado);
                if(comActual) window.edit(null, comActual.fbId);
            }
        });

        window.render = () => {
            const masterSearchInput = document.getElementById('masterSearch');
            const term = masterSearchInput ? masterSearchInput.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
            const box = document.getElementById('lista-comercios');
            if(!box) return;
            box.innerHTML = "";
            
            let filtrados = COMERCIOS.filter(c => {
                const searchStr = ((c.nombre || "") + " " + (c.ciudad || "") + " " + (c.direccion || "")).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const matchesSearch = searchStr.includes(term);
                const matchesFiltro = FILTRO_ESTADO === 'todos' || (FILTRO_ESTADO === 'inactivo' && c.estado !== 'activo');
                const matchesForzado = !idForzado || c.idComercio === idForzado;
                return matchesSearch && matchesFiltro && matchesForzado;
            });

            filtrados.sort((a,b) => (a.nombre || "").localeCompare(b.nombre || ""));

            filtrados.forEach(c => {
                const estaActivo = c.estado === 'activo';
                const displayID = c.idComercio || c.id || "SIN-ID";
                const qr = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${c.tokenQR || displayID}`;
                
                box.innerHTML += `
                <div class="comercio-card ${estaActivo ? '' : 'inactive'}">
                    <div class="visual-side">
                        <img src="${c.logoUrl || 'https://via.placeholder.com/120'}" class="img-preview" onclick="window.zoom('${c.logoUrl}')">
                        <img src="${qr}" class="img-preview" onclick="window.zoom('${qr}')">
                        
                        ${!idForzado ? `
                            <a href="admin_ingreso_duenos.html?id=${displayID}" target="_blank" class="btn-directo">VER PANEL</a>
                            <button class="btn-copiar-link" onclick="window.copiarLinkDirecto('${displayID}')">
                                <i class="fas fa-link"></i> COPIAR LINK
                            </button>
                        ` : ''}
                    </div>
                    <div class="info-side">
                        <h2 class="comercio-title">${c.nombre || 'Sin Nombre'}</h2>
                        <div class="data-grid">
                            <div class="data-box"><b>ID SISTEMA</b><span>${displayID}</span></div>
                            <div class="data-box"><b>Token QR</b><span>${c.tokenQR || '-'}</span></div>
                            <div class="data-box"><b>Reporte</b><span>${c.frecuenciaReporte || 'Semanal'}</span></div>
                            <div class="data-box"><b>WhatsApp</b><span>${c.telefono || '-'}</span></div>
                            <div class="data-box" style="grid-column: span 2"><b>√öltimo Env√≠o</b><span style="color:var(--oro)">${formatearFecha(c.lastSubmission)}</span></div>
                            <div class="data-box" style="grid-column: span 2"><b>Ciudad</b><span>${c.ciudad || '-'}</span></div>
                            <div class="data-box benefit-box"><b>Lead</b><span class="highlight-ben">${c.valLead || 0}% ${c.txtLead || ''}</span></div>
                            <div class="data-box benefit-box"><b>VIP</b><span class="highlight-ben" style="color:var(--oro)!important">${c.valVip || 0}% ${c.txtVip || ''}</span></div>
                        </div>
                        <div class="btn-group">
                            <button class="btn-op" style="background:#f39c12; color:black" onclick="window.edit(event, '${c.fbId}')">EDITAR</button>
                            ${!idForzado ? `
                            <button class="btn-op" style="background:${estaActivo ? 'var(--rojo)' : 'var(--verde)'}" onclick="window.toggleEstado(event, '${c.fbId}', '${c.estado}', '${c.nombre}')">
                                ${estaActivo ? 'PAUSAR' : 'ACTIVAR'}
                            </button>
                            <button class="btn-op" style="background:#333" onclick="window.del(event, '${c.fbId}', '${c.nombre}')">BORRAR</button>
                            ` : ''}
                            <div class="social-box">
                                ${c.emailDueno ? `<a href="mailto:${c.emailDueno}" class="owner-email"><i class="fas fa-envelope"></i> ${c.emailDueno}</a>` : ''}
                                ${c.facebook ? `<a href="${c.facebook}" target="_blank" class="social-link bg-fb"><i class="fab fa-facebook-f"></i></a>` : ''}
                                ${c.instagram ? `<a href="${c.instagram}" target="_blank" class="social-link bg-ig"><i class="fab fa-instagram"></i></a>` : ''}
                                ${c.web ? `<a href="${c.web}" target="_blank" class="social-link bg-tk"><i class="fab fa-tiktok"></i></a>` : ''}
                                ${c.sitioWeb ? `<a href="${c.sitioWeb}" target="_blank" class="social-link bg-web"><i class="fas fa-globe"></i></a>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            document.getElementById('count-total').innerText = COMERCIOS.length;
            document.getElementById('count-act').innerText = COMERCIOS.filter(x => x.estado === 'activo').length;
            document.getElementById('count-inact').innerText = COMERCIOS.filter(x => x.estado !== 'activo').length;
        };

        window.copiarLinkDirecto = (id) => {
            const urlBase = window.location.origin + window.location.pathname.replace('admin_comercios.html', '');
            const urlFinal = `${urlBase}admin_ingreso_duenos.html?id=${id}`;
            
            navigator.clipboard.writeText(urlFinal).then(() => {
                alert("‚úÖ ¬°Enlace copiado al portapapeles!\n\nYa puedes pegarlo en el chat del due√±o.");
            }).catch(err => {
                console.error('Error al copiar: ', err);
            });
        };

        window.edit = (event, id) => {
            if(event) event.preventDefault();
            const c = COMERCIOS.find(x => x.fbId === id);
            if(!c) return;
            document.getElementById('edit-id').value = id;
            document.getElementById('nombre-input').value = c.nombre || "";
            document.getElementById('id-input').value = c.idComercio || "";
            document.getElementById('token-input').value = c.tokenQR || "";
            document.getElementById('logo-input').value = c.logoUrl || "";
            document.getElementById('val-lead').value = c.valLead || "";
            document.getElementById('txt-lead').value = c.txtLead || "";
            document.getElementById('vig-lead').value = c.vigenciaLead || "";
            document.getElementById('val-vip').value = c.valVip || "";
            document.getElementById('txt-vip').value = c.txtVip || "";
            document.getElementById('vig-vip').value = c.vigenciaVip || "";
            document.getElementById('direccion-input').value = c.direccion || "";
            document.getElementById('ciudad-input').value = c.ciudad || "";
            document.getElementById('telefono-input').value = c.telefono || "";
            document.getElementById('facebook-input').value = c.facebook || "";
            document.getElementById('instagram-input').value = c.instagram || "";
            document.getElementById('web-input').value = c.web || "";
            document.getElementById('sitio-web-input').value = c.sitioWeb || "";
            document.getElementById('email-input').value = c.emailDueno || "";
            document.getElementById('password-input').value = c.password || "";
            document.getElementById('reporte-input').value = c.frecuenciaReporte || "Semanal";
            document.getElementById('titulo-form').innerText = "üìù EDITANDO COMERCIO";
            document.getElementById('btn-cancel-edit').style.display = 'block';
        };

        window.guardar = async () => {
            const eid = document.getElementById('edit-id').value;
            const passValue = document.getElementById('password-input').value;
            if(!passValue) return alert("Debes asignar una contrase√±a.");

            const d = { 
                nombre: document.getElementById('nombre-input').value, 
                idComercio: document.getElementById('id-input').value, 
                tokenQR: document.getElementById('token-input').value, 
                logoUrl: document.getElementById('logo-input').value, 
                valLead: document.getElementById('val-lead').value, 
                txtLead: document.getElementById('txt-lead').value, 
                vigenciaLead: document.getElementById('vig-lead').value || "", 
                valVip: document.getElementById('val-vip').value, 
                txtVip: document.getElementById('txt-vip').value, 
                vigenciaVip: document.getElementById('vig-vip').value || "", 
                direccion: document.getElementById('direccion-input').value, 
                ciudad: document.getElementById('ciudad-input').value, 
                telefono: document.getElementById('telefono-input').value,
                facebook: document.getElementById('facebook-input').value,
                instagram: document.getElementById('instagram-input').value,
                web: document.getElementById('web-input').value,
                sitioWeb: document.getElementById('sitio-web-input').value,
                emailDueno: document.getElementById('email-input').value, 
                password: passValue,
                frecuenciaReporte: document.getElementById('reporte-input').value
            };

            try {
                if(eid) {
                    await updateDoc(doc(db, "comercios", eid), d);
                    alert("¬°Ficha actualizada!");
                    if(idForzado) window.location.reload(); 
                } else {
                    d.estado = "activo"; d.fechaCarga = Date.now(); d.lastSubmission = null;
                    await addDoc(collection(db, "comercios"), d);
                    alert("Comercio creado");
                    window.clear();
                }
            } catch(e) { alert("Error: " + e.message); }
        };

        window.clear = () => {
            document.getElementById('edit-id').value = "";
            document.querySelectorAll('.sidebar input').forEach(i => i.value = "");
            document.getElementById('titulo-form').innerText = "‚ûï REGISTRAR COMERCIO";
            document.getElementById('btn-cancel-edit').style.display = 'none';
        };

        window.genID = () => {
            if(document.getElementById('edit-id').value) return;
            const n = document.getElementById('nombre-input').value;
            const id = n.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");
            document.getElementById('id-input').value = id;
            document.getElementById('token-input').value = id ? id + "_" + Math.floor(100000 + Math.random() * 899999) : "";
        };

        window.toggleEstado = async (e, id, est) => { 
            await updateDoc(doc(db, "comercios", id), { estado: est === 'activo' ? 'inactivo' : 'activo' }); 
        };
        
        window.del = async (e, id) => { 
            if(confirm("¬øBorrar comercio?")) await deleteDoc(doc(db, "comercios", id)); 
        };
        
        window.zoom = (u) => { document.getElementById('modal-img').src = u; document.getElementById('modal').style.display='flex'; };
        
        window.cambiarFiltro = (f, id) => {
            FILTRO_ESTADO = f;
            document.querySelectorAll('.btn-tool').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.render();
        };
    </script>
</body>
</html>
