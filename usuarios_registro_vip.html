<script type="module">
    // ... (importaciones y configuración de Firebase igual) ...

    window.registrarVIP = async () => {
        const btn = document.getElementById('btnRegistro');
        const nom = document.getElementById('nombres').value.trim();
        const ape = document.getElementById('apellido').value.trim();
        const tel = document.getElementById('whatsapp').value.trim();
        const mail = document.getElementById('email').value.trim();

        if(!nom || !ape || !tel || !mail) {
            mostrarError("DATOS INCOMPLETOS", "Por favor, complete todos los campos.");
            return;
        }

        // Limpiamos el número para que la búsqueda sea infalible (solo números)
        const whatsappLimpio = tel.replace(/\D/g, '');

        btn.disabled = true;
        btn.innerText = "Procesando...";

        try {
            // 1. RECONOCIMIENTO: Buscamos si ya existe como Lead
            const qLead = query(collection(db, "leads"), where("whatsapp", "==", whatsappLimpio));
            const snapLead = await getDocs(qLead);
            const ahora = Date.now();
            
            let accionParaLog = ""; // Variable para distinguir el origen

            if (!snapLead.empty) {
                // CASO A: YA EXISTÍA COMO LEAD
                const docId = snapLead.docs[0].id;
                const dataPrevia = snapLead.docs[0].data();

                if (dataPrevia.convertidoVIP === true) {
                    mostrarError("YA ES MIEMBRO", "Este número ya está registrado como VIP.");
                    btn.disabled = false;
                    btn.innerText = "Activar Membresía VIP";
                    return;
                }

                // ETIQUETA ESPECÍFICA PARA CONVERSIÓN
                accionParaLog = "SUBIÓ POR CONVERSIÓN";
                
                await updateDoc(doc(db, "leads", docId), {
                    convertidoVIP: true,
                    estado: "activo",
                    fechaVIP: ahora,
                    lastSubmission: ahora,
                    email: mail,
                    tipo: "VIP" // Aseguramos que cambie el tipo
                });
            } else {
                // CASO B: SE REGISTRA POR PRIMERA VEZ DIRECTO A VIP
                accionParaLog = "NUEVO REGISTRO VIP";
                
                await addDoc(collection(db, "leads"), {
                    nombres: nom,
                    apellido: ape,
                    whatsapp: whatsappLimpio,
                    email: mail,
                    convertidoVIP: true,
                    estado: "activo",
                    fechaVIP: ahora,
                    fechaRegistro: ahora,
                    lastSubmission: ahora,
                    tipo: "VIP",
                    origen: "Registro Directo VIP"
                });
            }

            // 2. REGISTRO EN LOGS (Aquí verás la diferencia en la columna TIPO/ACCION)
            await addDoc(collection(db, "logs_actividad"), {
                nombre: `${ape}, ${nom}`,
                tipo: "VIP",
                accion: accionParaLog, // Guardará el resultado del reconocimiento
                timestamp: ahora,
                fecha: new Date().toLocaleString()
            });

            // 3. Finalizar proceso (Token y Redirección)
            await updateDoc(doc(db, "tokens_vip", idDocumentoToken), {
                estado: "usado",
                whatsapp: whatsappLimpio,
                nombreVip: nom,
                fechaUso: ahora
            });

            localStorage.setItem('habitat_vip_auth', 'true');
            document.getElementById('notificacion').style.display = 'block';
            
            setTimeout(() => { 
                window.location.replace("usuarios_cupones_vips.html"); 
            }, 2500);

        } catch (e) {
            mostrarError("ERROR", "No se pudo procesar el registro.");
            console.error(e);
            btn.disabled = false;
            btn.innerText = "Activar Membresía VIP";
        }
    };

    validarTokenInterno();
</script>
