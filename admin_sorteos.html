<script type="module">
    // 1. CONFIGURACI√ìN E IMPORTACIONES (Usando tu l√≥gica de admin_comercios)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, where, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // ‚úÖ Usa tu constante firebaseConfig aqu√≠ (la misma de admin_comercios.html)
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* =========================================================
       üöÄ CARGA DE SORTEOS ACTIVOS (VINCULADO A COMERCIOS)
    ========================================================== */
    function cargarSorteosActivos() {
        const tabla = document.getElementById('tabla-sorteos');
        
        // Escuchamos la colecci√≥n 'comercios'
        onSnapshot(collection(db, "comercios"), (snap) => {
            tabla.innerHTML = ""; // Limpiar para recargar
            snap.forEach(docCom => {
                const c = docCom.data();
                
                // SOLO MOSTRAR SI TIENE SORTEO O PROMO VIGENTE
                if (c.titulo_sorteo && c.titulo_sorteo.trim() !== "") {
                    const fila = `
                        <tr>
                            <td>${c.fecha_inicio_sorteo || 'Activo'}</td>
                            <td>
                                <span class="badge badge-comercio">${c.nombre}</span><br>
                                <span class="badge badge-premio">üéÅ ${c.titulo_sorteo}</span>
                            </td>
                            <td>
                                <div id="ganadores-${docCom.id}">
                                    <button class="btn btn-primary" style="padding: 5px 12px; font-size: 0.8rem;" 
                                        onclick="ejecutarSorteoReal('${docCom.id}', '${c.nombre}', '${c.titulo_sorteo}', ${c.cantidad_ganadores || 1}, '${c.email || ''}')">
                                        üé≤ REALIZAR SORTEO (${c.cantidad_ganadores || 1})
                                    </button>
                                </div>
                            </td>
                            <td>
                                <small>Participantes:</small><br>
                                <strong id="count-${docCom.id}">...</strong>
                            </td>
                        </tr>`;
                    tabla.innerHTML += fila;
                    contarParticipantes(c.nombre, docCom.id);
                }
            });
        });
    }

    /* =========================================================
       üéØ L√ìGICA DE SORTEO REAL (BUSCA EN PARTICIPANTES)
    ========================================================== */
    window.ejecutarSorteoReal = async (idDoc, nombreCom, premio, cant, mailC) => {
        mostrarToast(`Buscando ganadores para ${nombreCom}...`, "warning");
        
        try {
            // Buscamos participantes que se registraron para este comercio
            const q = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nombreCom));
            const querySnap = await getDocs(q);
            
            let participantes = [];
            querySnap.forEach(p => participantes.push(p.data()));

            if (participantes.length === 0) {
                return mostrarToast("‚ùå No hay participantes para este sorteo.", "error");
            }

            // Selecci√≥n Aleatoria
            let ganadores = [];
            for (let i = 0; i < cant; i++) {
                if (participantes.length === 0) break;
                const index = Math.floor(Math.random() * participantes.length);
                ganadores.push(participantes.splice(index, 1)[0]);
            }

            // Guardar en Historial
            await addDoc(collection(db, "historial_sorteos"), {
                comercio: nombreCom,
                premio: premio,
                ganadores: ganadores,
                fecha: serverTimestamp(),
                mailComercio: mailC
            });

            mostrarToast(`‚úÖ ¬°Sorteo finalizado! ${ganadores.length} ganadores hallados.`, "success");
            
            // Refrescar la vista del historial para ver las acciones (WA/Mail)
            window.mostrarHistorial();

        } catch (e) {
            console.error(e);
            mostrarToast("Error al realizar el sorteo", "error");
        }
    };

    /* =========================================================
       üìú HISTORIAL DE √âXITOS
    ========================================================== */
    window.mostrarHistorial = () => {
        const tabla = document.getElementById('tabla-sorteos');
        tabla.innerHTML = "<tr><td colspan='4' style='text-align:center'>Cargando historial...</td></tr>";

        onSnapshot(collection(db, "historial_sorteos"), (snap) => {
            tabla.innerHTML = "";
            snap.forEach(doc => {
                const h = doc.data();
                const fecha = h.fecha ? new Date(h.fecha.seconds * 1000).toLocaleDateString() : '---';
                
                h.ganadores.forEach(g => {
                    const fila = `
                        <tr style="background: #fff9e6">
                            <td>${fecha}</td>
                            <td>
                                <span class="badge badge-comercio">${h.comercio}</span><br>
                                <span class="badge badge-premio">üèÜ ${h.premio}</span>
                            </td>
                            <td>
                                <strong>${g.nombre}</strong><br>
                                <small>${g.celular || g.telefono || ''}</small><br>
                                <div style="margin-top: 8px;">
                                    <button class="btn-accion btn-wa" onclick="abrirWA('${g.celular || g.telefono}','${g.nombre}','${h.premio}')">üí¨ WA</button>
                                    <button class="btn-accion btn-mail" onclick="enviarMail(this,'${g.email}','${g.nombre}','${h.premio}','${h.comercio}','${h.mailComercio}')">üìß Mail</button>
                                </div>
                            </td>
                            <td>
                                <button class="btn-accion btn-copy" onclick="copiarDatos('${g.nombre} | ${g.email}')">üìã Copiar</button>
                            </td>
                        </tr>`;
                    tabla.innerHTML += fila;
                });
            });
        });
    };

    async function contarParticipantes(nombreCom, idDoc) {
        const q = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nombreCom));
        const snap = await getDocs(q);
        const el = document.getElementById(`count-${idDoc}`);
        if(el) el.innerText = snap.size;
    }

    // Vinculaci√≥n de botones de la interfaz
    document.addEventListener('DOMContentLoaded', () => {
        const btns = document.querySelectorAll('.controls .btn');
        btns[1].onclick = cargarSorteosActivos; // Bot√≥n Sorteos Activos
        btns[2].onclick = window.mostrarHistorial; // Bot√≥n Historial
        
        cargarSorteosActivos(); // Carga inicial
    });
</script>
