<html lang="es"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Sorteos Elite | H√°bitat-Car</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--azul-habitat: #003d80;
--rojo-cupon: #e60000;
--naranja: #ff8c00;
--celeste: #0288d1;
--verde: #2e7d32;
--blanco: #ffffff;
--gris-texto: #666666;
--oro: #d4af37;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; padding-top: 140px; }
.faja-superior { position: fixed; top: 0; left: 0; width: 100%; background: var(--azul-habitat); border-bottom: 4px solid var(--rojo-cupon); z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.faja-contenido { max-width: 1200px; margin: 0 auto; padding: 10px 20px; display: flex; flex-direction: column; gap: 10px; }
.faja-logo { text-align: center; padding: 5px 0; }
.faja-logo img { height: 50px; width: auto; max-width: 200px; }
.faja-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; padding: 5px 0; }
.faja-nav a { padding: 6px 10px; border-radius: 4px; text-decoration: none; color: white; font-weight: 600; font-size: 11px; background: rgba(255,255,255,0.15); transition: all 0.2s; text-transform: uppercase; }
.faja-nav a:hover, .faja-nav a.active { background: var(--rojo-cupon); transform: translateY(-1px); }
.faja-nav a.active { box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
header h1 { font-size: 1.8rem; margin-bottom: 8px; }
header p { opacity: 0.9; font-size: 0.95rem; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
.btn-primary { background: #667eea; color: white; }
.btn-primary:hover { background: #5568d3; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.btn-warning { background: #ffc107; color: #333; }
.btn-warning:hover { background: #e0a800; }
.btn-info { background: #17a2b8; color: white; }
.btn-dark { background: #343a40; color: white; }
.btn-danger { background: #dc3545; color: white; }
.btn-danger:hover { background: #c82333; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }
.table-container { overflow-x: auto; max-height: calc(100vh - 280px); }
table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: opacity 0.3s ease; }
thead { position: sticky; top: 0; z-index: 100; background: #667eea; }
th { background: #667eea; color: white; padding: 14px 12px; text-align: left; white-space: nowrap; }
td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
.btn-accion { padding: 6px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; color: white; display: inline-flex; align-items: center; gap: 4px; }
.btn-wa { background: #25D366; }
.btn-mail { background: #ea4335; }
.btn-copy { background: #6c757d; }
.btn-delete { background: #dc3545; }
.btn-delete:hover { background: #c82333; }
.badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.badge-premio { background: #fff3cd; color: #856404; }
.badge-comercio { background: #d1ecf1; color: #0c5460; }
.badge-premios { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-vip { background: #fff8e1; color: #f57f17; font-weight: bold; }
.badge-lead { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 10px; color: white; z-index: 9999; animation: slideIn 0.3s ease; }
.success { background: #28a745; } .error { background: #dc3545; } .warning { background: #ffc107; color: #333; }
@keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
.participantes-cell { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; }
.participantes-row { display: flex; justify-content: space-between; align-items: center; }
.participantes-value { font-weight: bold; padding: 2px 8px; border-radius: 4px; min-width: 30px; text-align: center; }
.valor-lead { background: #e3f2fd; color: #1976d2; }
.valor-vip { background: #fff8e1; color: #f57f17; }
.valor-total { background: #e8f5e9; color: #388e3c; }
.premio-desc { font-size: 0.85rem; color: #666; margin-top: 4px; line-height: 1.4; max-width: 200px; }
.fecha-cell { display: flex; flex-direction: column; gap: 2px; font-size: 0.85rem; min-width: 100px; }
.fecha-principal { font-weight: bold; color: #333; }
.hora-secundaria { color: #666; font-size: 0.8rem; }
.logo-mini { height: 80px; width: auto; max-width: 120px; object-fit: contain; display: block; margin: 0 auto; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
.modal-content { background: white; padding: 25px; border-radius: 16px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.form-group { text-align: left; margin-bottom: 15px; }
.form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
.form-group textarea { width: 100%; height: 150px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: inherit; }
.form-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
.ganador-item { background: #f8f9fa; border-left: 4px solid var(--oro); padding: 12px; margin: 10px 0; border-radius: 8px; text-align: left; }
.email-display { font-size: 0.8em; color: #666; margin-top: 3px; word-break: break-all; }
.checkbox-cell { text-align: center; width: 50px; }
.checkbox-cell input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.bulk-actions { display: none; gap: 10px; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107; }
.bulk-actions.active { display: flex; align-items: center; }
.selected-count { font-weight: bold; color: #856404; }
@media (max-width: 768px) {
.faja-nav { gap: 3px; }
.faja-nav a { font-size: 9px; padding: 4px 6px; }
body { padding-top: 120px; }
.logo-mini { height: 70px; }
}
</style>
</head>
<body>
<div class="faja-superior">
<div class="faja-contenido">
<div class="faja-logo"><a href="index.html"><img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="H√°bitat-Car"></a></div>
<nav class="faja-nav">
<a href="admin_comercios.html">COMERCIOS</a><a href="admin_leads.html">LEADS</a><a href="admin_vips.html">VIPS</a>
<a href="admin_tokens_vip.html">TOKENS VIP</a><a href="admin_curioso.html">CURIOSO</a><a href="admin_estadisticas.html">ESTAD√çSTICAS</a>
<a href="admin_logs.html">LOG</a><a href="admin_tutoriales.html">TUTORIALES</a><a href="index.html">PANEL</a>
<a href="admin_legales.html">LEGALES</a><a href="admin_sorteos.html" class="active">SORTEOS</a>
</nav>
</div>
</div>
<div class="container">
<header><h1>üèÜ SORTEOS PREMIUM</h1><p>Panel de Sorteos Elite | H√°bitat-Car</p></header>
<div class="controls">
<button class="btn btn-success" id="btn-activos">SORTEOS ACTIVOS</button>
<button class="btn btn-warning" id="btn-historial">HISTORIAL DE √âXITOS</button>
<button class="btn btn-info" onclick="abrirEditorEmail()"><i class="fas fa-edit"></i> EDITAR EMAIL</button>
<button class="btn btn-dark" onclick="abrirEditorPDF()"><i class="fas fa-palette"></i> DISE√ëAR PDF</button>
</div>
<div id="bulk-actions" class="bulk-actions">
<span class="selected-count"><i class="fas fa-check-circle"></i> <span id="selected-count">0</span> seleccionado(s)</span>
<button class="btn btn-danger" onclick="eliminarSeleccionados()"><i class="fas fa-trash"></i> ELIMINAR SELECCIONADOS</button>
<button class="btn btn-warning" onclick="desmarcarTodos()"><i class="fas fa-times"></i> CANCELAR</button>
</div>
<div class="table-container">
<table>
<thead>
<tr id="tabla-headers">
<th class="checkbox-cell" id="header-checkbox" style="display:none;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
<th>FECHA</th>
<th>LOGO</th>
<th>COMERCIO / PREMIO</th>
<th>PARTICIPANTES</th>
<th>ACCIONES</th>
<th>PREMIOS</th>
</tr>
</thead>
<tbody id="tabla-sorteos"></tbody>
</table>
</div>
</div>

<!-- ‚úÖ MODAL EDITAR EMAIL -->
<div id="modal-email" class="modal">
<div class="modal-content">
<h3 style="color:var(--azul-habitat); margin-bottom:15px;">‚úâÔ∏è Editar Plantilla de Email</h3>
<p style="font-size:0.9em; color:#666; margin-bottom:15px;">
<b>Instrucciones:</b><br>
El sistema reemplazar√° autom√°ticamente:<br>
<span style="color:#e60000; font-weight:bold">{{NOMBRE}}</span> ‚Üí Nombre del Ganador<br>
<span style="color:#e60000; font-weight:bold">{{PREMIO}}</span> ‚Üí El Regalo<br>
<span style="color:#e60000; font-weight:bold">{{COMERCIO}}</span> ‚Üí Local del Sorteo
</p>
<div class="form-group">
<label>Asunto:</label>
<input type="text" id="inp-asunto" placeholder="Ej: Felicidades {{NOMBRE}}">
</div>
<div class="form-group">
<label>Mensaje (HTML permitido):</label>
<textarea id="inp-cuerpo" placeholder="Resultaste ganador de un {{PREMIO}} del comercio {{COMERCIO}}..."></textarea>
</div>
<button class="btn btn-primary" onclick="guardarConfig('email')">üíæ GUARDAR EMAIL</button>
<button class="btn btn-warning" onclick="cerrarEditores()">‚ùå CANCELAR</button>
</div>
</div>

<!-- ‚úÖ MODAL DISE√ëAR PDF -->
<div id="modal-pdf" class="modal">
<div class="modal-content">
<h3 style="color:var(--azul-habitat); margin-bottom:15px;">üìÑ Dise√±ar Certificado PDF</h3>
<div class="form-group">
<label>URL Imagen de Fondo (210x148mm):</label>
<input type="text" id="inp-pdf-bg" placeholder="https://tu-servidor.com/fondo.jpg">
</div>
<div class="form-group">
<label>Color de Texto Principal (Hex):</label>
<input type="color" id="inp-pdf-color" value="#e60000">
</div>
<button class="btn btn-primary" onclick="guardarConfig('pdf')">üíæ GUARDAR DISE√ëO</button>
<button class="btn btn-warning" onclick="cerrarEditores()">‚ùå CANCELAR</button>
</div>
</div>

<!-- ‚úÖ MODAL CONFIRMACI√ìN SORTEO -->
<div id="popup-confirmacion" class="modal" style="display: none;">
<div class="modal-content">
<h3 style="color: var(--azul-habitat); margin-bottom: 15px;">üéâ ¬°SORTEO REALIZADO!</h3>
<p id="texto-sorteo" style="font-size: 1.1rem; margin-bottom: 20px; line-height: 1.5;"></p>
<div id="lista-ganadores-popup" style="text-align: left; margin-bottom: 20px;"></div>
<button class="btn btn-primary" onclick="irAlHistorial()">IR AL HISTORIAL DE √âXITOS</button>
<button class="btn btn-warning" onclick="cerrarModalSorteo()" style="margin-top: 10px;">SEGUIR AQU√ç</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, where, addDoc, serverTimestamp, getDocs, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
    authDomain: "habitatcar-pro.firebaseapp.com",
    projectId: "habitatcar-pro",
    storageBucket: "habitatcar-pro.firebasestorage.app",
    messagingSenderId: "311691258694",
    appId: "1:311691258694:web:17a09051dcea7707af9347"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbz2xzSyQfL23SSFvvZ5jfKYYWvjMIy56XX33cSuq-DAQG64geSLsHdLnVzNmXDkzSXM5A/exec";
const LOGO_DEFAULT = "https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true";

// --- üõ°Ô∏è FUNCI√ìN AUXILIAR: ESCAPAR CARACTERES PELIGROSOS EN HTML/JS ---
const escapeHtml = (str) => {
    if (!str) return "";
    return str.toString()
        .replace(/'/g, "\\u0027")
        .replace(/"/g, "\\u0022")
        .replace(/</g, "\\u003C")
        .replace(/>/g, "\\u003E")
        .replace(/&/g, "\\u0026")
        .replace(/\n/g, "\\n")
        .replace(/\r/g, "\\r");
};

// --- üìß CONFIGURACI√ìN EMAIL PERSISTENTE ---
window.abrirEditorEmail = () => {
    document.getElementById('inp-asunto').value = localStorage.getItem('hc_asunto') || "üèÜ ¬°Felicidades {{NOMBRE}}!";
    document.getElementById('inp-cuerpo').value = localStorage.getItem('hc_cuerpo') || "Hola {{NOMBRE}}, ganaste {{PREMIO}} en {{COMERCIO}}.";
    document.getElementById('modal-email').style.display = 'flex';
};
window.abrirEditorPDF = () => {
    document.getElementById('inp-pdf-bg').value = localStorage.getItem('hc_pdf_bg') || "";
    document.getElementById('inp-pdf-color').value = localStorage.getItem('hc_pdf_color') || "#e60000";
    document.getElementById('modal-pdf').style.display = 'flex';
};
window.cerrarEditores = () => {
    document.getElementById('modal-email').style.display = 'none';
    document.getElementById('modal-pdf').style.display = 'none';
};
window.guardarConfig = (tipo) => {
    if(tipo === 'email') {
        localStorage.setItem('hc_asunto', document.getElementById('inp-asunto').value);
        localStorage.setItem('hc_cuerpo', document.getElementById('inp-cuerpo').value);
    } else {
        localStorage.setItem('hc_pdf_bg', document.getElementById('inp-pdf-bg').value);
        localStorage.setItem('hc_pdf_color', document.getElementById('inp-pdf-color').value);
    }
    mostrarToast("‚úÖ Configuraci√≥n guardada", "success");
    cerrarEditores();
};

// --- ‚úÖ FUNCI√ìN ENVIAR MAIL BLINDADA (VERSI√ìN FINAL) ---
window.enviarMail = async (btn, email, nombre, premio, comercio, mailCC) => {
    if (!email || email === "undefined" || email.trim() === "") {
        mostrarToast("‚ùå Email no v√°lido", "error");
        return;
    }

    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "‚è≥";

    try {
        // 1. Obtener plantillas del localStorage con fallback
        let asuntoTpl = localStorage.getItem('hc_asunto') || "üèÜ ¬°Felicidades {{NOMBRE}}, ganaste!";
        let cuerpoTpl = localStorage.getItem('hc_cuerpo') || "Hola {{NOMBRE}}, ganaste {{PREMIO}} en {{COMERCIO}}.";

        // 2. INYECCI√ìN SEGURA: replaceAll para evitar conflictos con regex
        const inyectarVariables = (texto, nombre, premio, comercio) => {
            return texto
                .replaceAll('{{NOMBRE}}', nombre || "Ganador/a")
                .replaceAll('{{PREMIO}}', premio || "un premio")
                .replaceAll('{{COMERCIO}}', comercio || "H√°bitat-Car");
        };

        const asuntoFinal = inyectarVariables(asuntoTpl, nombre, premio, comercio);
        const cuerpoFinal = inyectarVariables(cuerpoTpl, nombre, premio, comercio);

        // 3. Preparar payload para Google Apps Script
        const datos = {
            email: email.trim(),
            asunto: asuntoFinal,
            cuerpoHtml: cuerpoFinal.replace(/\n/g, '<br>'),
            nombreGanador: nombre || "",
            premioGanado: premio || "",
            comercioNombre: comercio || "",
            cc: `habitatcar@gmail.com, ${mailCC || ""}`.trim(),
            pdfB64: ""
        };

        // 4. Env√≠o al servidor (no-cors para Google Apps Script)
        await fetch(URL_SCRIPT, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        });

        mostrarToast(`‚úÖ Email enviado a: ${nombre}`);

    } catch (e) {
        console.error("‚ùå Error en enviarMail:", e);
        mostrarToast("‚ùå Error al procesar el env√≠o", "error");
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
};

// --- üì± WHATSAPP: NORMALIZACI√ìN Y APERTURA ---
window.normalizarTelefonoAR = (numero) => {
    if (!numero) return null;
    let num = numero.toString().replace(/\D/g, '');
    if (num.length === 10) return '549' + num;
    if (num.startsWith('54') && !num.startsWith('549')) return '549' + num.substring(2);
    return num.startsWith('549') ? num : '549' + num;
};
window.abrirWA = (cel, nom, pre) => {
    if (!cel) return mostrarToast("‚ö†Ô∏è El participante no tiene celular.", "error");
    const num = window.normalizarTelefonoAR(cel);
    const msg = encodeURIComponent(`¬°Hola ${nom}! üèÜ Soy de H√°bitat-Car. ¬°Felicidades, ganaste el sorteo de ${pre}! üéâ`);
    window.open(`https://wa.me/${num}?text=${msg}`, '_blank');
};

// --- üìÖ FORMATO DE FECHA ---
function formatearFechaHora(fechaISO) {
    if (!fechaISO) return null;
    try {
        const [fechaParte, horaParte] = fechaISO.split('T');
        if (!fechaParte || !horaParte) return null;
        const [anio, mes, dia] = fechaParte.split('-');
        const [hora, minutos] = horaParte.split(':');
        return { fecha: `${dia}/${mes}/${anio}`, hora: `${hora}:${minutos} Hs.` };
    } catch (e) { return null; }
}

// --- üéâ MODAL DE CONFIRMACI√ìN DE SORTEO ---
window.mostrarConfirmacionSorteo = (total, ganadores) => {
    const listaGanadores = document.getElementById('lista-ganadores-popup');
    listaGanadores.innerHTML = ganadores.map(g => {
        const esVIP = g.tipo === "VIP";
        const badgeTipo = esVIP
            ? `<span class="badge badge-vip" style="font-size:0.7rem; margin-left:5px;"><i class="fas fa-crown"></i> VIP</span>`
            : `<span class="badge badge-lead" style="font-size:0.7rem; margin-left:5px;"><i class="fas fa-user"></i> LEAD</span>`;
        return `
        <div class="ganador-item">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: bold;"><i class="fas fa-trophy" style="color:var(--oro); margin-right:5px;"></i>${g.nombreMostrar}</span>
                ${badgeTipo}
            </div>
            <small style="color: #666; display: block; margin-top: 5px;">
                <i class="fab fa-whatsapp"></i> ${g.celular || 'Sin tel√©fono'}
            </small>
        </div>`;
    }).join('');
    document.getElementById('texto-sorteo').innerText = `Se han seleccionado ${ganadores.length} ganador(es) entre ${total} participantes.`;
    document.getElementById('popup-confirmacion').style.display = 'flex';
};
window.cerrarModalSorteo = () => document.getElementById('popup-confirmacion').style.display = 'none';
window.irAlHistorial = () => { window.cerrarModalSorteo(); window.mostrarHistorial(); };

// --- ‚úÖ GESTI√ìN DE SELECCIONES MASIVAS ---
window.itemsSeleccionados = new Set();
window.vistaActual = 'activos';

window.toggleSelectAll = () => {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
        if(selectAll.checked) {
            window.itemsSeleccionados.add(cb.dataset.id);
        } else {
            window.itemsSeleccionados.delete(cb.dataset.id);
        }
    });
    actualizarBulkActions();
};

window.actualizarBulkActions = () => {
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');
    const headerCheckbox = document.getElementById('select-all');
    if(window.itemsSeleccionados.size > 0) {
        bulkActions.classList.add('active');
        selectedCount.textContent = window.itemsSeleccionados.size;
        headerCheckbox.checked = window.itemsSeleccionados.size === document.querySelectorAll('.row-checkbox').length;
    } else {
        bulkActions.classList.remove('active');
        headerCheckbox.checked = false;
    }
};

window.toggleSeleccion = (id, checkbox) => {
    if(checkbox.checked) {
        window.itemsSeleccionados.add(id);
    } else {
        window.itemsSeleccionados.delete(id);
    }
    actualizarBulkActions();
};

window.eliminarSeleccionados = async () => {
    if(window.itemsSeleccionados.size === 0) {
        return mostrarToast("‚ö†Ô∏è No hay items seleccionados", "warning");
    }
    if(!confirm(`¬øEst√°s seguro de eliminar ${window.itemsSeleccionados.size} registro(s) del historial?`)) {
        return;
    }
    mostrarToast("üóëÔ∏è Eliminando registros...", "warning");
    try {
        const promesas = Array.from(window.itemsSeleccionados).map(id => deleteDoc(doc(db, "historial_sorteos", id)));
        await Promise.all(promesas);
        mostrarToast(`‚úÖ ${window.itemsSeleccionados.size} registro(s) eliminado(s)`, "success");
        window.itemsSeleccionados.clear();
        actualizarBulkActions();
        window.mostrarHistorial();
    } catch (e) {
        console.error(e);
        mostrarToast("‚ùå Error al eliminar", "error");
    }
};

window.desmarcarTodos = () => {
    window.itemsSeleccionados.clear();
    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    actualizarBulkActions();
};

window.eliminarIndividual = async (id, btn) => {
    if(!confirm('¬øEst√°s seguro de eliminar este registro?')) {
        return;
    }
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "‚è≥";
    try {
        await deleteDoc(doc(db, "historial_sorteos", id));
        mostrarToast("‚úÖ Registro eliminado", "success");
        window.mostrarHistorial();
    } catch (e) {
        console.error(e);
        mostrarToast("‚ùå Error al eliminar", "error");
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
};

// --- üé≤ CARGAR SORTEOS ACTIVOS ---
const cargarActivos = async () => {
    window.vistaActual = 'activos';
    window.itemsSeleccionados.clear();
    actualizarBulkActions();
    document.getElementById('header-checkbox').style.display = 'none';
    
    onSnapshot(collection(db, "comercios"), async (snap) => {
        const tabla = document.getElementById('tabla-sorteos');
        tabla.innerHTML = "";
        for (const docCom of snap.docs) {
            const c = docCom.data();
            if (c.titulo_sorteo) {
                const nomCom = c.nombre;
                const premio = c.titulo_sorteo;
                const descPremio = c.descripcion_sorteo || "";
                const cant = parseInt(c.cantidad_premios) || 1;
                let cLead = 0, cVip = 0;
                
                const qP = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nomCom));
                const snapP = await getDocs(qP);
                const promesas = snapP.docs.map(async (p) => {
                    const dataP = p.data();
                    if (dataP.usuarioId && !dataP.usuarioId.startsWith('temp_')) {
                        try {
                            const leadDoc = await getDoc(doc(db, "leads", dataP.usuarioId));
                            if (leadDoc.exists()) {
                                const ld = leadDoc.data();
                                if (ld.convertidoVIP === true || ld.tipo === "VIP") return "VIP";
                            }
                        } catch (e) {}
                    }
                    return dataP.tipo === "VIP" ? "VIP" : "LEAD";
                });
                const resultados = await Promise.all(promesas);
                resultados.forEach(tipo => { if (tipo === "VIP") cVip++; else cLead++; });
                const totalP = cLead + cVip;
                const f = formatearFechaHora(c.fecha_sorteo) || {fecha: 'A definir', hora: ''};
                
                tabla.innerHTML += `
                <tr>
                    <td><div class="fecha-cell"><span class="fecha-principal">${f.fecha}</span><span class="hora-secundaria">${f.hora}</span></div></td>
                    <td><img src="${c.logoUrl || ''}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
                    <td>
                        <span class="badge badge-comercio">${escapeHtml(nomCom)}</span><br>
                        <span class="badge badge-premio">üéÅ ${escapeHtml(premio)}</span>
                        ${descPremio ? `<div class="premio-desc">${escapeHtml(descPremio)}</div>` : ''}
                    </td>
                    <td>
                        <div class="participantes-cell">
                            <div class="participantes-row"><span>LEAD:</span><span class="participantes-value valor-lead">${cLead}</span></div>
                            <div class="participantes-row"><span>VIP:</span><span class="participantes-value valor-vip">${cVip}</span></div>
                            <div class="participantes-row"><b>TOTAL:</b><span class="participantes-value valor-total">${totalP}</span></div>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sortear-accion" 
                            data-id="${docCom.id}" 
                            data-nombre="${escapeHtml(nomCom)}" 
                            data-premio="${escapeHtml(premio)}" 
                            data-cant="${cant}" 
                            data-mail="${c.email || ''}" 
                            data-logo="${c.logoUrl || ''}" 
                            data-desc="${escapeHtml(descPremio)}">
                            üé≤ SORTEAR (${cant})
                        </button>
                    </td>
                    <td style="text-align:center"><span class="badge badge-premios">üéÅ ${cant} premio${cant > 1 ? 's' : ''}</span></td>
                </tr>`;
            }
        }
    });
};

document.addEventListener('click', (e) => {
    if (e.target && e.target.classList.contains('btn-sortear-accion')) {
        const b = e.target.dataset;
        ejecutarSorteo(b.id, b.nombre, b.premio, parseInt(b.cant), b.mail, b.logo, b.desc);
    }
});

// --- üé≤ EJECUTAR SORTEO ---
const ejecutarSorteo = async (idCom, nomCom, premio, cant, mailC, logoUrl, desc) => {
    mostrarToast(`üé≤ Procesando sorteo para ${nomCom}...`, "warning");
    try {
        const q = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nomCom));
        const snap = await getDocs(q);
        let participantes = [];
        
        for (const d of snap.docs) {
            const partData = d.data();
            let nombreFinal = partData.nombre || "Participante";
            let celFinal = partData.celular || partData.whatsapp || "S/D";
            let tipoFinal = partData.tipo || "LEAD";
            let emailFinal = partData.email || "";
            
            if (partData.usuarioId && !partData.usuarioId.startsWith('temp_')) {
                const leadDoc = await getDoc(doc(db, "leads", partData.usuarioId));
                if (leadDoc.exists()) {
                    const ld = leadDoc.data();
                    nombreFinal = `${ld.nombres || ''} ${ld.apellido || ''}`.trim() || nombreFinal;
                    celFinal = ld.whatsapp || ld.celular || celFinal;
                    tipoFinal = (ld.convertidoVIP || ld.tipo === "VIP") ? "VIP" : "LEAD";
                    emailFinal = ld.email || emailFinal;
                }
            }
            participantes.push({ ...partData, nombreMostrar: nombreFinal, celular: celFinal, tipo: tipoFinal, email: emailFinal });
        }
        
        if (participantes.length === 0) { mostrarToast(`‚ö†Ô∏è No hay participantes registrados.`, "error"); return; }
        
        let ganadores = [];
        let bolsa = [...participantes];
        const limite = Math.min(cant, bolsa.length);
        for (let i = 0; i < limite; i++) { const idx = Math.floor(Math.random() * bolsa.length); ganadores.push(bolsa.splice(idx, 1)[0]); }
        
        await addDoc(collection(db, "historial_sorteos"), {
            comercio: nomCom,
            premio: premio,
            descripcion_sorteo: desc || "",
            logoUrl: logoUrl || "",
            ganadores: ganadores,
            fecha: serverTimestamp(),
            mailComercio: mailC || 'habitatcar@gmail.com'
        });
        
        mostrarToast(`‚úÖ Sorteo exitoso`, "success");
        window.mostrarConfirmacionSorteo(participantes.length, ganadores);
    } catch (e) { console.error(e); mostrarToast("‚ùå Error en el sorteo", "error"); }
};

// --- üìú MOSTRAR HISTORIAL (CON BOTONES BLINDADOS) ---
window.mostrarHistorial = () => {
    window.vistaActual = 'historial';
    window.itemsSeleccionados.clear();
    actualizarBulkActions();
    document.getElementById('header-checkbox').style.display = 'table-cell';
    
    const tabla = document.getElementById('tabla-sorteos');
    onSnapshot(collection(db, "historial_sorteos"), (snap) => {
        tabla.innerHTML = "";
        const docs = snap.docs.sort((a, b) => (b.data().fecha?.seconds || 0) - (a.data().fecha?.seconds || 0));
        
        docs.forEach(doc => {
            const h = doc.data();
            const fecha = h.fecha?.toDate ? h.fecha.toDate().toLocaleString() : "Reciente";
            
            h.ganadores?.forEach(g => {
                const nombreG = g.nombreMostrar || "Invitado";
                const celG = g.celular || "";
                const emailG = g.email || "";
                const esVIP = g.tipo === "VIP";
                const badgeTipo = esVIP 
                    ? `<span class="badge badge-vip"><i class="fas fa-crown"></i> VIP</span>` 
                    : `<span class="badge badge-lead"><i class="fas fa-user"></i> LEAD</span>`;
                const textoParaCopiar = `${nombreG} - WA: ${celG} - Email: ${emailG}`.trim();
                
                // ‚úÖ BOTONES CON escapeHtml() PARA PROTEGER DATOS DIN√ÅMICOS
                tabla.innerHTML += `<tr>
                    <td class="checkbox-cell"><input type="checkbox" class="row-checkbox" data-id="${doc.id}" onchange="toggleSeleccion('${doc.id}', this)"></td>
                    <td><small>${fecha}</small></td>
                    <td><img src="${h.logoUrl || ''}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
                    <td>
                        <span class="badge badge-comercio">${escapeHtml(h.comercio)}</span><br>
                        <span class="badge badge-premio">üéÅ ${escapeHtml(h.premio)}</span>
                        ${h.descripcion_sorteo ? `<div class="premio-desc">${escapeHtml(h.descripcion_sorteo)}</div>` : ''}
                    </td>
                    <td><div style="font-weight:bold">${escapeHtml(nombreG)}</div><div style="margin-top:4px">${badgeTipo}</div></td>
                    <td>
                        <div style="font-size:0.85em; color:var(--verde); margin-bottom:3px;"><i class="fab fa-whatsapp"></i> ${celG}</div>
                        ${emailG ? `<div class="email-display"><i class="fas fa-envelope"></i> ${emailG}</div>` : ''}
                        <div style="margin-top:8px; display:flex; gap:5px;">
                            <button class="btn-accion btn-wa" onclick="abrirWA('${celG}','${escapeHtml(nombreG)}','${escapeHtml(h.premio)}')">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button class="btn-accion btn-mail" onclick="enviarMail(this,'${emailG}','${escapeHtml(nombreG)}','${escapeHtml(h.premio)}','${escapeHtml(h.comercio)}','${h.mailComercio || ''}')">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <button class="btn-accion" style="background:#666" onclick="navigator.clipboard.writeText('${textoParaCopiar.replace(/'/g, "\\'")}'); mostrarToast('üìã Datos copiados','warning')">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn-accion btn-delete" onclick="eliminarIndividual('${doc.id}', this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
        });
    });
};

// --- üîî TOAST NOTIFICATIONS ---
function mostrarToast(mensaje, tipo = "success") {
    const div = document.createElement('div');
    div.className = `toast ${tipo}`;
    div.innerText = mensaje;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
}

// --- üöÄ INICIALIZACI√ìN ---
document.getElementById('btn-activos').onclick = cargarActivos;
document.getElementById('btn-historial').onclick = window.mostrarHistorial;
document.addEventListener('DOMContentLoaded', () => { cargarActivos(); });

// --- üì¶ EXPORTAR FUNCIONES GLOBALES ---
window.abrirWA = abrirWA;
window.enviarMail = enviarMail;
window.mostrarHistorial = mostrarHistorial;
window.mostrarToast = mostrarToast;
window.mostrarConfirmacionSorteo = mostrarConfirmacionSorteo;
window.cerrarModalSorteo = cerrarModalSorteo;
window.irAlHistorial = irAlHistorial;
window.toggleSeleccion = toggleSeleccion;
window.toggleSelectAll = toggleSelectAll;
window.eliminarSeleccionados = eliminarSeleccionados;
window.desmarcarTodos = desmarcarTodos;
window.eliminarIndividual = eliminarIndividual;
window.actualizarBulkActions = actualizarBulkActions;
window.escapeHtml = escapeHtml;
</script>
</body></html>
