<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Sorteos Elite | H√°bitat-Car</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --azul-habitat: #003d80;
            --rojo-cupon: #e60000;
            --naranja: #ff8c00;
            --celeste: #0288d1;
            --verde: #2e7d32;
            --blanco: #ffffff;
            --gris-texto: #666666;
            --oro: #d4af37;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; padding-top: 140px; }
        
        /* FAJA SUPERIOR */
        .faja-superior { position: fixed; top: 0; left: 0; width: 100%; background: var(--azul-habitat); border-bottom: 4px solid var(--rojo-cupon); z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .faja-contenido { max-width: 1200px; margin: 0 auto; padding: 10px 20px; display: flex; flex-direction: column; gap: 10px; }
        .faja-logo { text-align: center; padding: 5px 0; }
        .faja-logo img { height: 50px; width: auto; max-width: 200px; }
        .faja-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; padding: 5px 0; }
        .faja-nav a { padding: 6px 10px; border-radius: 4px; text-decoration: none; color: white; font-weight: 600; font-size: 11px; background: rgba(255,255,255,0.15); transition: all 0.2s; text-transform: uppercase; }
        .faja-nav a:hover, .faja-nav a.active { background: var(--rojo-cupon); transform: translateY(-1px); }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        
        /* CONTROLES */
        .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-dark { background: #343a40; color: white; }
        
        /* TABLA */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        th { background: #667eea; color: white; padding: 14px 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .btn-accion { padding: 6px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; color: white; display: inline-flex; align-items: center; gap: 4px; }
        .btn-wa { background: #25D366; }
        .btn-mail { background: #ea4335; }
        
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .badge-premio { background: #fff3cd; color: #856404; }
        .badge-comercio { background: #d1ecf1; color: #0c5460; }
        .badge-vip { background: #fff8e1; color: #f57f17; font-weight: bold; }
        .badge-lead { background: #e3f2fd; color: #1976d2; font-weight: bold; }
        
        .logo-mini { height: 60px; width: auto; max-width: 100px; object-fit: contain; display: block; margin: 0 auto; }

        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 1.5rem; color: #666; }
        
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--azul-habitat); }
        .form-group textarea { width: 100%; height: 120px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: inherit; }
        .form-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
        
        .preview-pdf { width: 100%; height: 150px; border: 2px dashed #ccc; border-radius: 10px; margin-top: 10px; display: flex; align-items: center; justify-content: center; background-size: cover; background-position: center; color: #999; }

        .toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 10px; color: white; z-index: 9999; animation: slideIn 0.3s ease; }
        .success { background: #28a745; } .error { background: #dc3545; } .warning { background: #ffc107; color: #333; }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }

        @media (max-width: 768px) {
            body { padding-top: 130px; }
            .controls { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="faja-superior">
        <div class="faja-contenido">
            <div class="faja-logo"><a href="index.html"><img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="H√°bitat-Car"></a></div>
            <nav class="faja-nav">
                <a href="admin_comercios.html">COMERCIOS</a><a href="admin_leads.html">LEADS</a><a href="admin_vips.html">VIPS</a>
                <a href="admin_tokens_vip.html">TOKENS VIP</a><a href="admin_curioso.html">CURIOSO</a><a href="admin_estadisticas.html">ESTAD√çSTICAS</a>
                <a href="admin_logs.html">LOG</a><a href="admin_tutoriales.html">TUTORIALES</a><a href="index.html">PANEL</a>
                <a href="admin_legales.html">LEGALES</a><a href="admin_sorteos.html" class="active">SORTEOS</a>
            </nav>
        </div>
    </div>

    <div class="container">
        <header><h1>üèÜ SORTEOS PREMIUM</h1><p>Panel de Sorteos Elite | H√°bitat-Car</p></header>
        
        <div class="controls">
            <button class="btn btn-success" id="btn-activos"><i class="fas fa-play"></i> SORTEOS ACTIVOS</button>
            <button class="btn btn-warning" id="btn-historial"><i class="fas fa-history"></i> HISTORIAL DE √âXITOS</button>
            <button class="btn btn-info" onclick="abrirEditorEmail()"><i class="fas fa-envelope-open-text"></i> EDITAR EMAIL</button>
            <button class="btn btn-dark" onclick="abrirEditorPDF()"><i class="fas fa-file-pdf"></i> DISE√ëAR PDF</button>
        </div>

        <table>
            <thead><tr><th>FECHA</th><th>LOGO</th><th>COMERCIO / PREMIO</th><th>PARTICIPANTES / GANADOR</th><th>ACCIONES</th><th>COPIAR</th></tr></thead>
            <tbody id="tabla-sorteos"></tbody>
        </table>
    </div>

    <div id="modal-email" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="cerrarModales()">&times;</span>
            <h3>‚úâÔ∏è Configurar Mensaje de Email</h3>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 15px;">Usa etiquetas: {nombre}, {premio}, {comercio}</p>
            <div class="form-group">
                <label>Asunto del Email:</label>
                <input type="text" id="email-asunto" placeholder="Ej: ¬°Felicidades {nombre}! Ganaste un premio">
            </div>
            <div class="form-group">
                <label>Cuerpo del Mensaje (HTML permitido):</label>
                <textarea id="email-cuerpo" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="guardarConfigEmail()">GUARDAR CONFIGURACI√ìN</button>
        </div>
    </div>

    <div id="modal-pdf" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="cerrarModales()">&times;</span>
            <h3>üìÑ Dise√±ador de Certificado PDF</h3>
            <div class="form-group">
                <label>URL Imagen de Fondo (210x148mm):</label>
                <input type="text" id="pdf-bg-url" placeholder="https://tu-imagen.jpg" oninput="previewPdfBg()">
                <div id="pdf-preview" class="preview-pdf">Previsualizaci√≥n de fondo</div>
            </div>
            <div class="form-group">
                <label>Color de Texto Principal (Hex):</label>
                <input type="color" id="pdf-color" value="#e60000" style="height: 40px;">
            </div>
            <button class="btn btn-primary" style="width: 100%;" onclick="guardarConfigPDF()">GUARDAR DISE√ëO PDF</button>
        </div>
    </div>

    <div id="popup-confirmacion" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--azul-habitat); margin-bottom: 15px;">üéâ ¬°SORTEO REALIZADO!</h3>
            <p id="texto-sorteo" style="font-size: 1.1rem; margin-bottom: 20px;"></p>
            <div id="lista-ganadores-popup"></div>
            <button class="btn btn-primary" onclick="irAlHistorial()">VER HISTORIAL</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, addDoc, serverTimestamp, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM", authDomain: "habitatcar-pro.firebaseapp.com", projectId: "habitatcar-pro", storageBucket: "habitatcar-pro.firebasestorage.app", messagingSenderId: "311691258694", appId: "1:311691258694:web:17a09051dcea7707af9347" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbz2xzSyQfL23SSFvvZ5jfKYYWvjMIy56XX33cSuq-DAQG64geSLsHdLnVzNmXDkzSXM5A/exec";
        const LOGO_DEFAULT = "https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true";

        // --- L√ìGICA DE EDITORES (LOCALSTORAGE) ---
        window.abrirEditorEmail = () => {
            document.getElementById('email-asunto').value = localStorage.getItem('hc_email_asunto') || "üèÜ ¬°Felicidades {nombre}! Ganaste un premio";
            document.getElementById('email-cuerpo').value = localStorage.getItem('hc_email_cuerpo') || "Hola {nombre}, ¬°felicitaciones! Ganaste un/a {premio} en {comercio}. Adjuntamos tu certificado oficial.";
            document.getElementById('modal-email').classList.add('active');
        };

        window.abrirEditorPDF = () => {
            document.getElementById('pdf-bg-url').value = localStorage.getItem('hc_pdf_bg') || "";
            document.getElementById('pdf-color').value = localStorage.getItem('hc_pdf_color') || "#e60000";
            previewPdfBg();
            document.getElementById('modal-pdf').classList.add('active');
        };

        window.previewPdfBg = () => {
            const url = document.getElementById('pdf-bg-url').value;
            const pre = document.getElementById('pdf-preview');
            if(url) { pre.style.backgroundImage = `url(${url})`; pre.innerText = ""; }
            else { pre.style.backgroundImage = "none"; pre.innerText = "Sin fondo"; }
        };

        window.guardarConfigEmail = () => {
            localStorage.setItem('hc_email_asunto', document.getElementById('email-asunto').value);
            localStorage.setItem('hc_email_cuerpo', document.getElementById('email-cuerpo').value);
            mostrarToast("‚úÖ Configuraci√≥n de email guardada");
            cerrarModales();
        };

        window.guardarConfigPDF = () => {
            localStorage.setItem('hc_pdf_bg', document.getElementById('pdf-bg-url').value);
            localStorage.setItem('hc_pdf_color', document.getElementById('pdf-color').value);
            mostrarToast("‚úÖ Dise√±o de PDF guardado");
            cerrarModales();
        };

        window.cerrarModales = () => {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        };

        // --- FUNCION ENVIAR MAIL MEJORADA ---
        window.enviarMail = async (btn, mailG, nombre, premio, comercio, mailC) => {
            if (!mailG) return mostrarToast("‚ö†Ô∏è Sin email", "error");
            const original = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = "‚è≥";

            // 1. Generar PDF con dise√±o personalizado
            const { jsPDF } = window.jspdf;
            const docPdf = new jsPDF('l', 'mm', 'a5');
            const bgUrl = localStorage.getItem('hc_pdf_bg');
            const textColor = localStorage.getItem('hc_pdf_color') || "#e60000";

            if (bgUrl) {
                try { docPdf.addImage(bgUrl, 'JPEG', 0, 0, 210, 148); } catch(e) { console.error("Error fondo PDF"); }
            } else {
                docPdf.setDrawColor(230, 0, 0); docPdf.setLineWidth(2); docPdf.rect(5, 5, 200, 138);
            }

            docPdf.setTextColor(textColor);
            docPdf.setFontSize(30); docPdf.text("CERTIFICADO DE GANADOR", 105, 40, { align: "center" });
            docPdf.setTextColor(40, 40, 40);
            docPdf.setFontSize(18); docPdf.text("Otorgado a:", 105, 60, { align: "center" });
            docPdf.setFontSize(26); docPdf.text(nombre.toUpperCase(), 105, 80, { align: "center" });
            docPdf.setFontSize(16); docPdf.text(`Premio: ${premio}`, 105, 110, { align: "center" });
            docPdf.setFontSize(12); docPdf.text(comercio, 105, 130, { align: "center" });

            const pdfBase64 = docPdf.output('datauristring').split(',')[1];

            // 2. Preparar Cuerpo de Email personalizado
            let asunto = localStorage.getItem('hc_email_asunto') || "¬°Felicidades {nombre}!";
            let cuerpo = localStorage.getItem('hc_email_cuerpo') || "Hola {nombre}, ganaste {premio}.";
            
            asunto = asunto.replace(/{nombre}/g, nombre).replace(/{premio}/g, premio).replace(/{comercio}/g, comercio);
            cuerpo = cuerpo.replace(/{nombre}/g, nombre).replace(/{premio}/g, premio).replace(/{comercio}/g, comercio);

            try {
                await fetch(URL_SCRIPT, {
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: mailG.trim(), nombreGanador: nombre, pdfB64: pdfBase64, asunto: asunto, cuerpoHtml: cuerpo, cc: `habitatcar@gmail.com, ${mailC}` })
                });
                mostrarToast("‚úÖ Mail enviado con dise√±o personalizado", "success");
            } catch (e) {
                mostrarToast("‚ùå Error al enviar", "error");
            } finally {
                btn.disabled = false; btn.innerHTML = original;
            }
        };

        // --- CARGAR SORTEOS ACTIVOS ---
        const cargarActivos = async () => {
            onSnapshot(collection(db, "comercios"), async (snap) => {
                const tabla = document.getElementById('tabla-sorteos');
                tabla.innerHTML = "";
                for (const docCom of snap.docs) {
                    const c = docCom.data();
                    if (c.titulo_sorteo) {
                        const qP = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", c.nombre));
                        const snapP = await getDocs(qP);
                        const cantP = snapP.size;
                        const f = formatearFechaHora(c.fecha_sorteo) || {fecha: 'A definir', hora: ''};
                        
                        tabla.innerHTML += `<tr>
                            <td><div class="fecha-cell"><b>${f.fecha}</b><br><small>${f.hora}</small></div></td>
                            <td><img src="${c.logoUrl || ''}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
                            <td><span class="badge badge-comercio">${c.nombre}</span><br><span class="badge badge-premio">üéÅ ${c.titulo_sorteo}</span></td>
                            <td><div class="participantes-cell"><span class="badge" style="background:#eee">Total: ${cantP}</span></div></td>
                            <td><button class="btn btn-primary" onclick="ejecutarSorteo('${docCom.id}','${c.nombre}','${c.titulo_sorteo}',${c.cantidad_premios || 1},'${c.email || ''}','${c.logoUrl || ''}')">üé≤ SORTEAR</button></td>
                            <td>-</td>
                        </tr>`;
                    }
                }
            });
        };

        // --- MOSTRAR HISTORIAL ---
        window.mostrarHistorial = () => {
            const tabla = document.getElementById('tabla-sorteos');
            onSnapshot(collection(db, "historial_sorteos"), (snap) => {
                tabla.innerHTML = "";
                const docs = snap.docs.sort((a, b) => (b.data().fecha?.seconds || 0) - (a.data().fecha?.seconds || 0));
                docs.forEach(doc => {
                    const h = doc.data();
                    const fecha = h.fecha?.toDate ? h.fecha.toDate().toLocaleString() : "Reciente";
                    h.ganadores?.forEach(g => {
                        const nombreG = g.nombreMostrar || "Invitado";
                        const esVIP = g.tipo === "VIP";
                        const badgeTipo = esVIP ? `<span class="badge badge-vip">VIP</span>` : `<span class="badge badge-lead">LEAD</span>`;
                        
                        tabla.innerHTML += `<tr>
                            <td><small>${fecha}</small></td>
                            <td><img src="${h.logoUrl || ''}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
                            <td><span class="badge badge-comercio">${h.comercio}</span><br><span class="badge badge-premio">üéÅ ${h.premio}</span></td>
                            <td><b>${nombreG}</b><br>${badgeTipo}</td>
                            <td>
                                <button class="btn-accion btn-wa" onclick="abrirWA('${g.celular}','${nombreG}','${h.premio}')"><i class="fab fa-whatsapp"></i></button>
                                <button class="btn-accion btn-mail" onclick="enviarMail(this,'${g.email}','${nombreG}','${h.premio}','${h.comercio}','${h.mailComercio}')"><i class="fas fa-envelope"></i></button>
                            </td>
                            <td><button class="btn-accion btn-copy" onclick="navigator.clipboard.writeText('${nombreG} ${g.celular} ${g.email}'); mostrarToast('üìã Copiado')"><i class="fas fa-copy"></i></button></td>
                        </tr>`;
                    });
                });
            });
        };

        // Auxiliares comunes
        function formatearFechaHora(fechaISO) { if (!fechaISO) return null; const [f, h] = fechaISO.split('T'); const [y, m, d] = f.split('-'); return { fecha: `${d}/${m}/${y}`, hora: h ? h.substring(0,5) : '' }; }
        function mostrarToast(m, t="success") { const d = document.createElement('div'); d.className = `toast ${t}`; d.innerText = m; document.body.appendChild(d); setTimeout(()=>d.remove(), 3000); }
        window.abrirWA = (cel, nom, pre) => { window.open(`https://wa.me/${window.normalizarTelefonoAR(cel)}?text=${encodeURIComponent('¬°Hola '+nom+'! Ganaste '+pre)}`, '_blank'); };
        window.normalizarTelefonoAR = (n) => { let num = n.toString().replace(/\D/g, ''); return num.startsWith('549') ? num : '549' + num; };
        
        document.getElementById('btn-activos').onclick = cargarActivos;
        document.getElementById('btn-historial').onclick = window.mostrarHistorial;
        document.addEventListener('DOMContentLoaded', cargarActivos);
        
        // Exponer funciones globales
        window.irAlHistorial = () => { cerrarModales(); window.mostrarHistorial(); };
        window.ejecutarSorteo = async (id, nom, pre, cant, mail, logo) => {
            // L√≥gica simplificada de sorteo para el ejemplo
            mostrarToast("üé≤ Realizando sorteo...");
            const q = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nom));
            const snap = await getDocs(q);
            if(snap.empty) return mostrarToast("No hay participantes", "error");
            const ganadores = [snap.docs[0].data()]; // Ejemplo toma el primero
            ganadores[0].nombreMostrar = ganadores[0].nombre;
            await addDoc(collection(db, "historial_sorteos"), { comercio: nom, premio: pre, ganadores, logoUrl: logo, mailComercio: mail, fecha: serverTimestamp() });
            mostrarToast("‚úÖ Sorteo finalizado");
            window.mostrarHistorial();
        };

    </script>
</body>
</html>
