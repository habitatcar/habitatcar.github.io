<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Sorteos Elite | H√°bitat-Car</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--azul-habitat: #003d80;
--rojo-cupon: #e60000;
--naranja: #ff8c00;
--celeste: #0288d1;
--verde: #2e7d32;
--blanco: #ffffff;
--gris-texto: #666666;
--oro: #d4af37;
--zona-critica: #dc3545;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; padding-top: 140px; }
.faja-superior { position: fixed; top: 0; left: 0; width: 100%; background: var(--azul-habitat); border-bottom: 4px solid var(--rojo-cupon); z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.faja-contenido { max-width: 1200px; margin: 0 auto; padding: 10px 20px; display: flex; flex-direction: column; gap: 10px; }
.faja-logo { text-align: center; padding: 5px 0; }
.faja-logo img { height: 50px; width: auto; max-width: 200px; }
.faja-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; padding: 5px 0; }
.faja-nav a { padding: 6px 10px; border-radius: 4px; text-decoration: none; color: white; font-weight: 600; font-size: 11px; background: rgba(255,255,255,0.15); transition: all 0.2s; text-transform: uppercase; }
.faja-nav a:hover, .faja-nav a.active { background: var(--rojo-cupon); transform: translateY(-1px); }
.faja-nav a.active { box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
header h1 { font-size: 1.8rem; margin-bottom: 8px; }
header p { opacity: 0.9; font-size: 0.95rem; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
.btn-primary { background: #667eea; color: white; }
.btn-primary:hover { background: #5568d3; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.btn-warning { background: #ffc107; color: #333; }
.btn-warning:hover { background: #e0a800; }
.btn-info { background: #17a2b8; color: white; }
.btn-dark { background: #343a40; color: white; }
.btn-danger { background: #dc3545; color: white; }
.btn-danger:hover { background: #c82333; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }
.btn-sm { padding: 4px 8px; font-size: 0.8rem; }
.table-container { overflow-x: auto; max-height: calc(100vh - 280px); }
table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: opacity 0.3s ease; }
thead { position: sticky; top: 0; z-index: 100; background: #667eea; }
th { background: #667eea; color: white; padding: 14px 12px; text-align: left; white-space: nowrap; }
td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
.btn-accion { padding: 6px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: white; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap; }
.btn-wa { background: #25D366; }
/* CHANGE 2+3: bot√≥n unificado WA+PDF */
.btn-wapdf { background: linear-gradient(135deg, #25D366 0%, var(--azul-habitat) 100%); font-weight: 700; }
.btn-wapdf:hover { opacity: 0.88; }
.btn-copy { background: #6c757d; }
.btn-delete { background: #dc3545; }
.btn-delete:hover { background: #c82333; }
.badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.badge-premio { background: #fff3cd; color: #856404; }
.badge-comercio { background: #d1ecf1; color: #0c5460; }
.badge-premios { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-vip { background: #fff8e1; color: #f57f17; font-weight: bold; }
.badge-lead { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-critica { background: #ffebee; color: #c62828; font-weight: bold; animation: pulse 2s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.4); } 70% { box-shadow: 0 0 0 10px rgba(220,53,69,0); } 100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); } }
.toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 10px; color: white; z-index: 9999; animation: slideIn 0.3s ease; max-width: 360px; line-height: 1.4; }
.success { background: #28a745; } .error { background: #dc3545; } .warning { background: #ffc107; color: #333; }
@keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
.participantes-cell { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; }
.participantes-row { display: flex; justify-content: space-between; align-items: center; }
.participantes-value { font-weight: bold; padding: 2px 8px; border-radius: 4px; min-width: 30px; text-align: center; }
.valor-lead { background: #e3f2fd; color: #1976d2; }
.valor-vip { background: #fff8e1; color: #f57f17; }
.valor-total { background: #e8f5e9; color: #388e3c; }
.premio-desc { font-size: 0.85rem; color: #666; margin-top: 4px; line-height: 1.4; max-width: 200px; }
.fecha-cell { display: flex; flex-direction: column; gap: 2px; font-size: 0.85rem; min-width: 100px; }
.fecha-principal { font-weight: bold; color: #333; }
.hora-secundaria { color: #666; font-size: 0.8rem; }
.timestamp-badge { font-size: 0.75rem; color: #666; background: #f1f1f1; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }
.logo-mini { height: 80px; width: auto; max-width: 120px; object-fit: contain; display: block; margin: 0 auto; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
.modal-content { background: white; padding: 25px; border-radius: 16px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.checkbox-cell { text-align: center; width: 50px; }
.checkbox-cell input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.bulk-actions { display: none; gap: 10px; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107; }
.bulk-actions.active { display: flex; align-items: center; }
.selected-count { font-weight: bold; color: #856404; }
/* Editor PDF sliders */
.slider-group { margin-bottom: 10px; }
.slider-group > .sg-label { font-size: 11px; font-weight: bold; color: #444; display: block; margin-bottom: 3px; }
.slider-row { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
.slider-row span.lbl { font-size: 10px; color: #888; width: 16px; flex-shrink: 0; text-align: center; }
.slider-row input[type=range] { flex: 1; height: 4px; }
.slider-row span.val { font-size: 10px; font-weight: bold; color: var(--azul-habitat); min-width: 22px; text-align: right; }
/* Secciones del editor PDF */
.pdf-section { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; }
.pdf-section h4 { font-size: 12px; color: var(--azul-habitat); margin-bottom: 7px; display: flex; align-items: center; gap: 4px; }
.txt-field { width: 100%; padding: 5px 7px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; margin-top: 3px; font-family: inherit; }
.inyectado-tag { font-size: 9px; background: #e3f2fd; color: #1976d2; padding: 1px 5px; border-radius: 10px; margin-left: 4px; }
@media (max-width: 768px) {
.faja-nav { gap: 3px; }
.faja-nav a { font-size: 9px; padding: 4px 6px; }
body { padding-top: 120px; }
.logo-mini { height: 70px; }
}
</style>
</head>
<body>
<div class="faja-superior">
<div class="faja-contenido">
<div class="faja-logo"><a href="index.html"><img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="H√°bitat-Car"></a></div>
<nav class="faja-nav">
<a href="admin_comercios.html">COMERCIOS</a><a href="admin_leads.html">LEADS</a><a href="admin_vips.html">VIPS</a>
<a href="admin_tokens_vip.html">TOKENS VIP</a><a href="admin_curioso.html">CURIOSO</a><a href="admin_estadisticas.html">ESTAD√çSTICAS</a>
<a href="admin_logs.html">LOG</a><a href="admin_tutoriales.html">TUTORIALES</a><a href="index.html">PANEL</a>
<a href="admin_legales.html">LEGALES</a><a href="admin_sorteos.html" class="active">SORTEOS</a>
</nav>
</div>
</div>
<div class="container">
<header><h1>üèÜ SORTEOS PREMIUM</h1><p>Panel de Sorteos Elite | H√°bitat-Car</p></header>
<div class="controls">
<button class="btn btn-success" id="btn-activos">SORTEOS ACTIVOS</button>
<button class="btn btn-warning" id="btn-historial">HISTORIAL DE √âXITOS</button>
<button onclick="abrirEditorPDF()" title="Editar Ticket PDF"
style="background:var(--azul-habitat); color:white; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:600; font-size:0.85rem; display:inline-flex; align-items:center; gap:6px;">
<i class="fas fa-file-pdf"></i> TICKET PDF
</button>
<button onclick="abrirEditorWA()" title="Editar Mensaje WhatsApp"
style="background:#25D366; color:white; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:600; font-size:0.85rem; display:inline-flex; align-items:center; gap:6px;">
<i class="fab fa-whatsapp"></i> MENSAJE WA
</button>
</div>
<div id="bulk-actions" class="bulk-actions">
<span class="selected-count"><i class="fas fa-check-circle"></i> <span id="selected-count">0</span> seleccionado(s)</span>
<button class="btn btn-danger" onclick="eliminarSeleccionados()"><i class="fas fa-trash"></i> ELIMINAR SELECCIONADOS</button>
<button class="btn btn-warning" onclick="desmarcarTodos()"><i class="fas fa-times"></i> CANCELAR</button>
</div>
<div class="table-container">
<table>
<thead>
<tr id="tabla-headers">
<th class="checkbox-cell" id="header-checkbox" style="display:none;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
<th>FECHA</th><th>LOGO</th><th>COMERCIO / PREMIO</th><th>PARTICIPANTES</th><th>ACCIONES</th><th>PREMIOS</th>
</tr>
</thead>
<tbody id="tabla-sorteos"></tbody>
</table>
</div>
</div>
<!-- MODAL CONFIRMACI√ìN SORTEO -->
<div id="popup-confirmacion" class="modal" style="display:none;">
<div class="modal-content">
<h3 style="color:var(--azul-habitat); margin-bottom:15px;">üéâ ¬°SORTEO REALIZADO!</h3>
<p id="texto-sorteo" style="font-size:1.1rem; margin-bottom:20px; line-height:1.5;"></p>
<div id="lista-ganadores-popup" style="text-align:left; margin-bottom:20px;"></div>
<button class="btn btn-primary" onclick="irAlHistorial()">IR AL HISTORIAL DE √âXITOS</button>
<button class="btn btn-warning" onclick="cerrarModalSorteo()" style="margin-top:10px;">SEGUIR AQU√ç</button>
</div>
</div>
<!-- =====================================================
CHANGE 4: MODAL EDITOR PDF ‚Äî logos + textos movibles
===================================================== -->
<div id="modalPDF" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.92); z-index:10000; overflow-y:auto; padding:16px; box-sizing:border-box;">
<div style="display:flex; flex-wrap:wrap; justify-content:center; gap:18px; max-width:1060px; margin:auto; padding-top:8px;">
<!-- Panel de controles (scrollable) -->
<div style="background:white; padding:16px; border-radius:14px; width:330px; color:#333; flex-shrink:0; max-height:88vh; overflow-y:auto;">
<h3 style="color:var(--azul-habitat); margin-bottom:10px; font-size:15px;">üé® Dise√±o del Ticket</h3>
<hr style="margin-bottom:10px;">
<!-- Fondo + color -->
<div class="pdf-section">
<h4>üñºÔ∏è Fondo y color de texto</h4>
<label style="font-size:11px; color:#555;">URL Imagen de Fondo:</label>
<input type="text" id="cfg_bg" class="txt-field" oninput="actualizarPrevia()" placeholder="https://...">
<label style="font-size:11px; color:#555; display:block; margin-top:7px;">Color del Texto:</label>
<input type="color" id="cfg_color" oninput="actualizarPrevia()" style="width:100%; height:28px; cursor:pointer; border:1px solid #ccc; border-radius:4px; margin-top:3px;">
</div>
<!-- CHANGE 1: Logo Comercio (auto desde Firebase) -->
<div class="pdf-section">
<h4>üî¥ Logo Comercio <span class="inyectado-tag">auto</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_l1x" min="0" max="60" value="5" oninput="actualizarPrevia()"><span class="val" id="v_l1x">5</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_l1y" min="0" max="140" value="5" oninput="actualizarPrevia()"><span class="val" id="v_l1y">5</span></div>
<div class="slider-row"><span class="lbl">üìê</span><input type="range" id="cfg_l1s" min="8" max="50" value="20" oninput="actualizarPrevia()"><span class="val" id="v_l1s">20</span></div>
</div>
<!-- CHANGE 1: Logo H√°bitat-Car (siempre auto) -->
<div class="pdf-section">
<h4>üîµ Logo H√°bitat-Car <span class="inyectado-tag">auto</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_l2x" min="0" max="60" value="45" oninput="actualizarPrevia()"><span class="val" id="v_l2x">45</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_l2y" min="0" max="140" value="5" oninput="actualizarPrevia()"><span class="val" id="v_l2y">5</span></div>
<div class="slider-row"><span class="lbl">üìê</span><input type="range" id="cfg_l2s" min="8" max="50" value="20" oninput="actualizarPrevia()"><span class="val" id="v_l2s">20</span></div>
</div>
<!-- CHANGE 4: Texto 1 ‚Äî Nombre (inyectado) -->
<div class="pdf-section">
<h4>‚úèÔ∏è Nombre del Ganador <span class="inyectado-tag">inyectado</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t1x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t1x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t1y" min="20" max="155" value="90" oninput="actualizarPrevia()"><span class="val" id="v_t1y">90</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t1s" min="8" max="32" value="22" oninput="actualizarPrevia()"><span class="val" id="v_t1s">22</span></div>
</div>
<!-- CHANGE 4: Texto 2 ‚Äî Premio (inyectado) -->
<div class="pdf-section">
<h4>‚úèÔ∏è Premio <span class="inyectado-tag">inyectado</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t2x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t2x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t2y" min="20" max="155" value="110" oninput="actualizarPrevia()"><span class="val" id="v_t2y">110</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t2s" min="6" max="28" value="16" oninput="actualizarPrevia()"><span class="val" id="v_t2s">16</span></div>
</div>
<!-- Texto 6 ‚Äî Descripci√≥n del Premio (inyectado) -->
<div class="pdf-section">
<h4>‚úèÔ∏è Descripci√≥n del Premio <span class="inyectado-tag">inyectado</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t6x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t6x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t6y" min="20" max="155" value="120" oninput="actualizarPrevia()"><span class="val" id="v_t6y">120</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t6s" min="6" max="28" value="14" oninput="actualizarPrevia()"><span class="val" id="v_t6s">14</span></div>
</div>
<!-- CHANGE 4: Texto 3 ‚Äî Comercio (inyectado) -->
<div class="pdf-section">
<h4>‚úèÔ∏è Comercio <span class="inyectado-tag">inyectado</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t3x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t3x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t3y" min="20" max="155" value="124" oninput="actualizarPrevia()"><span class="val" id="v_t3y">124</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t3s" min="6" max="28" value="14" oninput="actualizarPrevia()"><span class="val" id="v_t3s">14</span></div>
</div>
<!-- CHANGE 4: Texto 4 ‚Äî Frase libre (editable, no inyectado) -->
<div class="pdf-section">
<h4>‚úèÔ∏è Frase libre <span style="font-size:9px; color:#888;">(editable)</span></h4>
<input type="text" id="cfg_t4txt" class="txt-field" oninput="actualizarPrevia()" value="¬°Felicitaciones!">
<div class="slider-row" style="margin-top:5px;"><span class="lbl">X</span><input type="range" id="cfg_t4x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t4x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t4y" min="20" max="155" value="60" oninput="actualizarPrevia()"><span class="val" id="v_t4y">60</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t4s" min="6" max="28" value="14" oninput="actualizarPrevia()"><span class="val" id="v_t4s">14</span></div>
</div>
<!-- CHANGE 4: Texto 5 ‚Äî Pie de p√°gina (editable, no inyectado) -->
<div class="pdf-section">
<h4>‚úèÔ∏è Pie de p√°gina <span style="font-size:9px; color:#888;">(editable)</span></h4>
<input type="text" id="cfg_t5txt" class="txt-field" oninput="actualizarPrevia()" value="H√°bitat-Car">
<div class="slider-row" style="margin-top:5px;"><span class="lbl">X</span><input type="range" id="cfg_t5x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t5x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t5y" min="20" max="158" value="154" oninput="actualizarPrevia()"><span class="val" id="v_t5y">154</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t5s" min="5" max="16" value="8" oninput="actualizarPrevia()"><span class="val" id="v_t5s">8</span></div>
</div>
<button onclick="guardarConfigPDF()" style="width:100%; background:var(--verde); color:white; padding:11px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:13px; margin-top:4px;">üíæ GUARDAR DISE√ëO</button>
<button onclick="cerrarModales()" style="width:100%; background:none; border:none; color:#dc3545; margin-top:6px; cursor:pointer; padding:7px; font-size:12px;">‚úï Cerrar sin guardar</button>
</div>
<!-- Vista previa proporcional (80x160mm ‚Üí 260x520px) -->
<div style="flex-shrink:0;">
<p style="color:rgba(255,255,255,0.65); text-align:center; font-size:11px; margin-bottom:6px;">Vista previa (escala √ó3.25)</p>
<div id="previa_ticket" style="width:260px; height:520px; background:#ddd; border-radius:14px; border:5px solid #222; position:relative; overflow:hidden; background-size:cover; background-position:center;">
<!-- logos -->
<div id="prev_l1" style="position:absolute; border:2px dashed #e60000; background:rgba(255,255,255,0.5); font-size:8px; display:flex; align-items:center; justify-content:center; color:#c00; font-weight:bold;">L1</div>
<div id="prev_l2" style="position:absolute; border:2px dashed #003d80; background:rgba(255,255,255,0.5); font-size:8px; display:flex; align-items:center; justify-content:center; color:#003d80; font-weight:bold;">L2</div>
<!-- textos -->
<div id="prev_t1" style="position:absolute; font-weight:bold; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">NOMBRE GANADOR</div>
<div id="prev_t2" style="position:absolute; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">PREMIO</div>
<div id="prev_t6" style="position:absolute; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none; font-size:14px;">DESCRIPCION</div>
<div id="prev_t3" style="position:absolute; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">COMERCIO</div>
<div id="prev_t4" style="position:absolute; font-weight:bold; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">¬°Felicitaciones!</div>
<div id="prev_t5" style="position:absolute; white-space:nowrap; transform:translateX(-50%); color:#666; pointer-events:none; font-size:8px;">H√°bitat-Car</div>
</div>
</div>
</div>
</div>
<!-- MODAL EDITOR WHATSAPP -->
<!-- CHANGE 3: variable {{DESCRIPCION}} agregada al aviso de variables -->
<div id="modalWA" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center;">
<div style="background:white; padding:25px; border-radius:15px; width:90%; max-width:440px; color:#333;">
<h3 style="color:#25D366; margin-bottom:8px;"><i class="fab fa-whatsapp"></i> Mensaje de WhatsApp</h3>
<div style="background:#fff8e1; border:1px solid #ffc107; border-radius:8px; padding:10px; margin-bottom:12px; font-size:12px; color:#555;">
<b>‚ö†Ô∏è Sobre el PDF:</b> WhatsApp no permite adjuntar archivos por URL. El PDF se descarga en tu dispositivo y WA se abre con el mensaje listo. Adjunt√° el PDF desde tu galer√≠a.
</div>
<label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Mensaje personalizable:</label>
<textarea id="cfg_wa_msg" style="width:100%; height:170px; padding:10px; font-family:sans-serif; border:1px solid #ccc; border-radius:6px; font-size:12px; resize:vertical; line-height:1.5;"></textarea>
<div style="font-size:11px; color:#666; margin:8px 0 12px; background:#f8f9fa; padding:8px; border-radius:5px; line-height:1.7;">
Variables: <b>{{NOMBRE}}</b>, <b>{{PREMIO}}</b>, <b>{{COMERCIO}}</b>, <b style="color:#e60000;">{{DESCRIPCION}}</b>
</div>
<button onclick="guardarConfigWA()" style="width:100%; background:#25D366; color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">üíæ GUARDAR MENSAJE</button>
<button onclick="cerrarModales()" style="width:100%; background:none; border:none; color:#dc3545; margin-top:6px; cursor:pointer; padding:8px; font-size:13px;">‚úï Cerrar</button>
</div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, where, addDoc, serverTimestamp, getDocs, doc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
const CLAVE_MAESTRA = "HABITAT_MASTER_2026";
const LOGO_DEFAULT  = "https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true";
// CHANGE 1: Logo H√°bitat-Car siempre cargado autom√°ticamente desde esta constante
const LOGO_HABITAT  = "https://i.ibb.co/m5fdvTr/HABITAT-CAR-SF.png";
// CHANGE 3: Nuevo mensaje WA con {{DESCRIPCION}}, √≠conos festivos y advertencia
const WA_DEFAULT = `üéâüèÜ ¬°Hola {{NOMBRE}}! ¬°Felicitaciones!
Ganaste el sorteo üéÅ *{{PREMIO}}*
consistente en *{{DESCRIPCION}}*
realizado por üè™ *{{COMERCIO}}*.
üìé Adjunto tu ticket ganador oficial.
‚ö†Ô∏è *¬°ATENCI√ìN ‚Äî NO TE DUERMAS!* ‚ö†Ô∏è
Ten√©s *30 d√≠as* para presentarte a reclamar tu premio.
‚è∞ Si dej√°s pasar los 30 d√≠as ‚ùå *perd√©s el premio* ‚ùå
üò¥üí§ ¬°No dejes pasar esta oportunidad √∫nica!
‚Äî Equipo H√°bitat-Car üöóüè†`;
const firebaseConfig = {
apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
authDomain: "habitatcar-pro.firebaseapp.com",
projectId: "habitatcar-pro",
storageBucket: "habitatcar-pro.firebasestorage.app",
messagingSenderId: "311691258694",
appId: "1:311691258694:web:17a09051dcea7707af9347"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const leerMsgWA  = () => localStorage.getItem('hc_wa_v3') || WA_DEFAULT;
const leerCfgPDF = () => { try { return JSON.parse(localStorage.getItem('hc_pdf_v3')) || {}; } catch(e) { return {}; } };
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDITOR PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.abrirEditorPDF = () => {
const p = leerCfgPDF();
const sv = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
sv('cfg_bg',    p.bg    ?? '');
sv('cfg_color', p.color ?? '#000000');
// logos
sv('cfg_l1x', p.l1x ?? 5);   sv('cfg_l1y', p.l1y ?? 5);   sv('cfg_l1s', p.l1s ?? 20);
sv('cfg_l2x', p.l2x ?? 45);  sv('cfg_l2y', p.l2y ?? 5);   sv('cfg_l2s', p.l2s ?? 20);
// CHANGE 4: textos
sv('cfg_t1x', p.t1x ?? 40);  sv('cfg_t1y', p.t1y ?? 90);  sv('cfg_t1s', p.t1s ?? 22);
sv('cfg_t2x', p.t2x ?? 40);  sv('cfg_t2y', p.t2y ?? 110); sv('cfg_t2s', p.t2s ?? 16);
sv('cfg_t6x', p.t6x ?? 40);  sv('cfg_t6y', p.t6y ?? 120); sv('cfg_t6s', p.t6s ?? 14);
sv('cfg_t3x', p.t3x ?? 40);  sv('cfg_t3y', p.t3y ?? 124); sv('cfg_t3s', p.t3s ?? 14);
sv('cfg_t4x', p.t4x ?? 40);  sv('cfg_t4y', p.t4y ?? 60);  sv('cfg_t4s', p.t4s ?? 14);
sv('cfg_t4txt', p.t4txt ?? '¬°Felicitaciones!');
sv('cfg_t5x', p.t5x ?? 40);  sv('cfg_t5y', p.t5y ?? 154); sv('cfg_t5s', p.t5s ?? 8);
sv('cfg_t5txt', p.t5txt ?? 'H√°bitat-Car');
document.getElementById('modalPDF').style.display = 'flex';
actualizarPrevia();
};
// CHANGE 4: actualizarPrevia ahora mueve logos Y textos en la previa
window.actualizarPrevia = () => {
const bg    = document.getElementById('cfg_bg').value;
const color = document.getElementById('cfg_color').value;
const prev  = document.getElementById('previa_ticket');
prev.style.backgroundImage = bg ? `url(${bg})` : 'none';
if (!bg) prev.style.backgroundColor = '#ddd';
// Escala: 260px (previa) / 80mm (ticket) = 3.25
const f = 3.25;
// Helper: actualiza posici√≥n/tama√±o de un elemento de previa
const movEl = (elId, xId, yId, sId, vxId, vyId, vsId, isLogo) => {
const x = parseInt(document.getElementById(xId).value) || 0;
const y = parseInt(document.getElementById(yId).value) || 0;
const s = parseInt(document.getElementById(sId).value) || 10;
if (vxId) document.getElementById(vxId).textContent = x;
if (vyId) document.getElementById(vyId).textContent = y;
if (vsId) document.getElementById(vsId).textContent = s;
const el = document.getElementById(elId);
if (!el) return;
el.style.left = (x * f) + 'px';
el.style.top  = (y * f) + 'px';
if (isLogo) {
el.style.width  = (s * f) + 'px';
el.style.height = (s * f) + 'px';
} else {
// Convertir pt ‚Üí px en previa (1pt ‚âà 1.333px, ajustado para escala)
el.style.fontSize = Math.round(s * f / 3.8) + 'px';
el.style.color = color;
}
};
movEl('prev_l1','cfg_l1x','cfg_l1y','cfg_l1s','v_l1x','v_l1y','v_l1s', true);
movEl('prev_l2','cfg_l2x','cfg_l2y','cfg_l2s','v_l2x','v_l2y','v_l2s', true);
movEl('prev_t1','cfg_t1x','cfg_t1y','cfg_t1s','v_t1x','v_t1y','v_t1s', false);
movEl('prev_t2','cfg_t2x','cfg_t2y','cfg_t2s','v_t2x','v_t2y','v_t2s', false);
movEl('prev_t6','cfg_t6x','cfg_t6y','cfg_t6s','v_t6x','v_t6y','v_t6s', false);
movEl('prev_t3','cfg_t3x','cfg_t3y','cfg_t3s','v_t3x','v_t3y','v_t3s', false);
movEl('prev_t4','cfg_t4x','cfg_t4y','cfg_t4s','v_t4x','v_t4y','v_t4s', false);
movEl('prev_t5','cfg_t5x','cfg_t5y','cfg_t5s','v_t5x','v_t5y','v_t5s', false);
// Actualizar contenido editable en previa
const t4el = document.getElementById('prev_t4');
const t5el = document.getElementById('prev_t5');
if (t4el) t4el.textContent = document.getElementById('cfg_t4txt').value || '¬°Felicitaciones!';
if (t5el) t5el.textContent = document.getElementById('cfg_t5txt').value || 'H√°bitat-Car';
};
window.guardarConfigPDF = () => {
const gv = id => { const el = document.getElementById(id); return el ? el.value : ''; };
const gi = id => parseInt(gv(id)) || 0;
const data = {
bg: gv('cfg_bg'), color: gv('cfg_color'),
l1x:gi('cfg_l1x'), l1y:gi('cfg_l1y'), l1s:gi('cfg_l1s'),
l2x:gi('cfg_l2x'), l2y:gi('cfg_l2y'), l2s:gi('cfg_l2s'),
// CHANGE 4
t1x:gi('cfg_t1x'), t1y:gi('cfg_t1y'), t1s:gi('cfg_t1s'),
t2x:gi('cfg_t2x'), t2y:gi('cfg_t2y'), t2s:gi('cfg_t2s'),
t6x:gi('cfg_t6x'), t6y:gi('cfg_t6y'), t6s:gi('cfg_t6s'),
t3x:gi('cfg_t3x'), t3y:gi('cfg_t3y'), t3s:gi('cfg_t3s'),
t4x:gi('cfg_t4x'), t4y:gi('cfg_t4y'), t4s:gi('cfg_t4s'), t4txt: gv('cfg_t4txt'),
t5x:gi('cfg_t5x'), t5y:gi('cfg_t5y'), t5s:gi('cfg_t5s'), t5txt: gv('cfg_t5txt'),
};
localStorage.setItem('hc_pdf_v3', JSON.stringify(data));
mostrarToast("‚úÖ Dise√±o de Ticket guardado", "success");
cerrarModales();
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDITOR WHATSAPP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.abrirEditorWA = () => {
document.getElementById('cfg_wa_msg').value = leerMsgWA();
document.getElementById('modalWA').style.display = 'flex';
};
window.guardarConfigWA = () => {
const msg = document.getElementById('cfg_wa_msg').value;
if (!msg.trim()) return mostrarToast("‚ö†Ô∏è El mensaje no puede estar vac√≠o", "warning");
localStorage.setItem('hc_wa_v3', msg);
mostrarToast("‚úÖ Mensaje guardado", "success");
cerrarModales();
};
window.cerrarModales = () => {
document.getElementById('modalPDF').style.display = 'none';
document.getElementById('modalWA').style.display  = 'none';
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENVIAR TICKET ELITE
// CHANGE 1: logos auto (comercio desde Firebase, H√°bitat siempre)
// CHANGE 3: mensaje inyecta {{DESCRIPCION}}
// CHANGE 4: posiciones de texto desde config guardada
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.enviarTicketElite = async (nombre, premio, comercio, descripcion, telefono, logoComercio) => {
const p = leerCfgPDF();
// CHANGE 3: inyectar todas las variables incluyendo descripcion
const mensajeWA = leerMsgWA()
.replace(/\{\{NOMBRE\}\}/g,      nombre      || 'Ganador')
.replace(/\{\{PREMIO\}\}/g,      premio      || 'el premio')
.replace(/\{\{COMERCIO\}\}/g,    comercio    || 'el comercio')
.replace(/\{\{DESCRIPCION\}\}/g, descripcion || premio || 'el premio');
const { jsPDF } = window.jspdf;
const docPDF = new jsPDF({ unit: "mm", format: [80, 160] });
const loadImg = url => new Promise(res => {
if (!url) return res(null);
const img = new Image(); img.crossOrigin = "Anonymous";
img.onload = () => res(img); img.onerror = () => res(null);
img.src = url;
});
// Fondo
if (p.bg) { const bi = await loadImg(p.bg); if (bi) docPDF.addImage(bi,'JPEG',0,0,80,160); }
// CHANGE 1: Logo comercio auto desde Firebase, logo H√°bitat siempre fijo
const addLogo = async (url, x, y, s) => {
if (!url) return;
const im = await loadImg(url); const sz = parseInt(s)||20;
if (im) docPDF.addImage(im,'PNG',parseInt(x)||0,parseInt(y)||0,sz,sz);
};
await addLogo(logoComercio || LOGO_DEFAULT, p.l1x??5,  p.l1y??5,  p.l1s??20);
await addLogo(LOGO_HABITAT,                 p.l2x??45, p.l2y??5,  p.l2s??20); // siempre H√°bitat
docPDF.setTextColor(p.color || '#000000');
// CHANGE 4: todos los textos usan posici√≥n y tama√±o configurados
// Frase libre (t4) arriba
docPDF.setFont("helvetica","bold"); docPDF.setFontSize(p.t4s??14);
docPDF.text(p.t4txt||'¬°Felicitaciones!', p.t4x??40, p.t4y??60, {align:"center"});
// Nombre ganador (t1) ‚Äî inyectado
docPDF.setFont("helvetica","bold"); docPDF.setFontSize(p.t1s??22);
docPDF.text((nombre||"Ganador").toUpperCase(), p.t1x??40, p.t1y??90, {align:"center"});
// Premio (t2) ‚Äî inyectado
docPDF.setFont("helvetica","normal"); docPDF.setFontSize(p.t2s??16);
docPDF.text(premio||"Premio", p.t2x??40, p.t2y??110, {align:"center"});
// Descripci√≥n del Premio (t6) ‚Äî inyectado
docPDF.setFont("helvetica","normal"); docPDF.setFontSize(p.t6s??14);
docPDF.text(descripcion||"", p.t6x??40, p.t6y??120, {align:"center"});
// Comercio (t3) ‚Äî inyectado
docPDF.setFont("helvetica","normal"); docPDF.setFontSize(p.t3s??14);
docPDF.text(comercio||"Comercio", p.t3x??40, p.t3y??124, {align:"center"});
// Pie de p√°gina (t5) ‚Äî editable, no inyectado
docPDF.setFont("helvetica","normal"); docPDF.setFontSize(p.t5s??8);
docPDF.text(`${p.t5txt||'H√°bitat-Car'} ‚Ä¢ ${new Date().toLocaleDateString()}`, p.t5x??40, p.t5y??154, {align:"center"});
docPDF.save(`Ticket_${(nombre||'Ganador').replace(/\s+/g,'_')}.pdf`);
// CHANGE 2: Solo el bot√≥n "ENVIAR WHATSAPP Y PDF" ‚Äî sin bot√≥n WA separado
if (telefono) {
const num = window.normalizarTelefonoAR(telefono);
if (num) {
setTimeout(() => window.open(`https://wa.me/${num}?text=${encodeURIComponent(mensajeWA)}`,'_blank'), 1200);
mostrarToast("‚úÖ PDF descargado ‚Äî WhatsApp abierto.
Adjunt√° el PDF desde tu galer√≠a.", "success");
return;
}
}
mostrarToast("‚úÖ Ticket PDF descargado", "success");
};
window.normalizarTelefonoAR = n => {
if (!n) return null;
let s = n.toString().replace(/\D/g,'');
if (s.length===10) return '549'+s;
if (s.startsWith('54')&&!s.startsWith('549')) return '549'+s.substring(2);
return s.startsWith('549')?s:'549'+s;
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL CONFIRMACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.mostrarConfirmacionSorteo = (total, ganadores, comercio) => {
document.getElementById('lista-ganadores-popup').innerHTML = ganadores.map(g => {
const badge = g.tipo==="VIP"
? `<span class="badge badge-vip"><i class="fas fa-crown"></i> VIP</span>`
: `<span class="badge badge-lead"><i class="fas fa-user"></i> LEAD</span>`;
return `<div style="background:#f8f9fa;border-left:4px solid var(--oro);padding:12px;margin:8px 0;border-radius:8px;">
<div style="display:flex;justify-content:space-between;align-items:center;">
<span style="font-weight:bold;"><i class="fas fa-trophy" style="color:var(--oro);margin-right:5px;"></i>${g.nombreMostrar}</span>${badge}
</div>
<small style="color:#666;display:block;margin-top:5px;"><i class="fab fa-whatsapp"></i> ${g.celular||'Sin tel√©fono'}</small>
</div>`;
}).join('');
document.getElementById('texto-sorteo').innerText = `Sorteo de ${comercio}: ${ganadores.length} ganador(es) entre ${total} participantes.`;
document.getElementById('popup-confirmacion').style.display = 'flex';
};
window.cerrarModalSorteo = () => document.getElementById('popup-confirmacion').style.display = 'none';
window.irAlHistorial = () => { cerrarModalSorteo(); mostrarHistorial(); };
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHECKBOXES / BULK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.itemsSeleccionados = new Set();
window.vistaActual = 'activos';
window.toggleSelectAll = () => {
const sa = document.getElementById('select-all');
document.querySelectorAll('.row-checkbox').forEach(cb => {
cb.checked = sa.checked;
sa.checked ? window.itemsSeleccionados.add(cb.dataset.id) : window.itemsSeleccionados.delete(cb.dataset.id);
});
actualizarBulkActions();
};
window.actualizarBulkActions = () => {
const bulk = document.getElementById('bulk-actions');
if (window.itemsSeleccionados.size > 0) {
bulk.classList.add('active');
document.getElementById('selected-count').textContent = window.itemsSeleccionados.size;
document.getElementById('select-all').checked = window.itemsSeleccionados.size === document.querySelectorAll('.row-checkbox').length;
} else {
bulk.classList.remove('active');
document.getElementById('select-all').checked = false;
}
};
window.toggleSeleccion = (id, cb) => { cb.checked ? window.itemsSeleccionados.add(id) : window.itemsSeleccionados.delete(id); actualizarBulkActions(); };
window.eliminarSeleccionados = async () => {
if (!window.itemsSeleccionados.size) return mostrarToast("‚ö†Ô∏è No hay items seleccionados","warning");
if (!confirm(`¬øEliminar ${window.itemsSeleccionados.size} registro(s)?`)) return;
mostrarToast("üóëÔ∏è Eliminando...","warning");
try {
await Promise.all([...window.itemsSeleccionados].map(id => deleteDoc(doc(db,"historial_sorteos",id))));
mostrarToast(`‚úÖ ${window.itemsSeleccionados.size} eliminado(s)`,"success");
window.itemsSeleccionados.clear(); actualizarBulkActions(); mostrarHistorial();
} catch(e) { mostrarToast("‚ùå Error","error"); }
};
window.desmarcarTodos = () => {
window.itemsSeleccionados.clear();
document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked=false);
document.getElementById('select-all').checked=false; actualizarBulkActions();
};
window.eliminarIndividual = async (id, btn) => {
if (!confirm('¬øEliminar este registro?')) return;
const orig=btn.innerHTML; btn.disabled=true; btn.innerHTML="‚è≥";
try { await deleteDoc(doc(db,"historial_sorteos",id)); mostrarToast("‚úÖ Eliminado","success"); mostrarHistorial(); }
catch(e) { mostrarToast("‚ùå Error","error"); btn.disabled=false; btn.innerHTML=orig; }
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RELOJES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.iniciarRelojes = () => {
setInterval(() => {
document.querySelectorAll('.btn-sortear-accion').forEach(btn => {
const ts=parseInt(btn.dataset.timestamp), f=ts-Date.now();
if (f>0) {
const d=Math.floor(f/86400000),h=Math.floor((f%86400000)/3600000),m=Math.floor((f%3600000)/60000),s=Math.floor((f%60000)/1000);
btn.innerHTML=`‚è≥ ${d}d ${h}h ${m}m ${s}s`; btn.classList.add('btn-dark'); btn.classList.remove('btn-primary');
} else { btn.innerHTML=`üé≤ SORTEAR AHORA`; btn.classList.remove('btn-dark'); btn.classList.add('btn-primary'); }
});
},1000);
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEGURIDAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.validarAccionSegura = async (idComercio, claveIngresada) => {
if (claveIngresada===CLAVE_MAESTRA) return true;
try { const s=await getDoc(doc(db,"comercios",idComercio)); if(s.exists()&&claveIngresada===s.data().password) return true; } catch(e){}
return false;
};
window.intentarSorteo = async (btn) => {
const ts=parseInt(btn.dataset.timestamp);
if (Date.now()<ts) {
const clave=prompt(`‚è∞ Sorteo programado para ${new Date(ts).toLocaleString()}
Ingrese CLAVE DE COMERCIO o MAESTRA para adelantar:`);
if (!clave) return;
if (!await validarAccionSegura(btn.dataset.id,clave)) { mostrarToast("‚ùå Contrase√±a incorrecta","error"); return; }
mostrarToast("üîì Acceso autorizado - Sorteo adelantado","warning");
}
ejecutarSorteo(btn.dataset.id,btn.dataset.nombre,btn.dataset.premio,parseInt(btn.dataset.cant),btn.dataset.mail,btn.dataset.logo,btn.dataset.desc,btn.dataset.claveComercio);
};
window.intentarEliminarSorteo = async (idComercio, fechaSorteoISO) => {
const dh=(new Date(fechaSorteoISO).getTime()-Date.now())/3600000;
const clave=prompt((dh<24&&dh>0)?"‚ö†Ô∏è ZONA CR√çTICA: Solo CLAVE MAESTRA:":"Ingrese CLAVE DE COMERCIO para eliminar:");
if (!clave) return;
if (!await validarAccionSegura(idComercio,clave)) { mostrarToast("‚ùå Contrase√±a incorrecta","error"); return; }
if (dh<24&&dh>0&&clave!==CLAVE_MAESTRA) { mostrarToast("‚ùå Solo Admin puede cancelar sorteos inminentes","error"); return; }
try {
await updateDoc(doc(db,"comercios",idComercio),{titulo_sorteo:null,descripcion_sorteo:null,fecha_sorteo:null,cantidad_premios:null,logoUrl:null});
mostrarToast("üóëÔ∏è Sorteo cancelado","success"); cargarActivos();
} catch(e) { mostrarToast("‚ùå Error","error"); }
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARGAR ACTIVOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const cargarActivos = async () => {
window.vistaActual='activos'; window.itemsSeleccionados.clear(); actualizarBulkActions();
document.getElementById('header-checkbox').style.display='none';
onSnapshot(collection(db,"comercios"), async snap => {
const tabla=document.getElementById('tabla-sorteos'); tabla.innerHTML="";
for (const docCom of snap.docs) {
const c=docCom.data(); if (!c.titulo_sorteo) continue;
const nomCom=c.nombre, premio=c.titulo_sorteo, descPremio=c.descripcion_sorteo||"";
const cant=parseInt(c.cantidad_premios)||1, fechaISO=c.fecha_sorteo||"";
const ts=fechaISO?new Date(fechaISO).getTime():Date.now();
let cL=0,cV=0;
const snapP=await getDocs(query(collection(db,"admin_participantes_sorteos"),where("comercio","==",nomCom)));
await Promise.all(snapP.docs.map(async p=>{
const pd=p.data();
if(pd.usuarioId&&!pd.usuarioId.startsWith('temp_')){try{const ld=await getDoc(doc(db,"leads",pd.usuarioId));if(ld.exists()&&(ld.data().convertidoVIP||ld.data().tipo==="VIP")){cV++;return;}}catch(e){}}
pd.tipo==="VIP"?cV++:cL++;
}));
const f=formatearFechaHora(fechaISO)||{fecha:'A definir',hora:''};
const badge=ts>Date.now()?`<span class="timestamp-badge">üïê Programado: ${f.fecha} ${f.hora}</span>`:`<span class="badge badge-critica">üî¥ LISTO PARA SORTEAR</span>`;
tabla.innerHTML+=`<tr>
<td><div class="fecha-cell"><span class="fecha-principal">${f.fecha}</span><span class="hora-secundaria">${f.hora}</span>${badge}</div></td>
<td><img src="${c.logoUrl||''}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
<td><span class="badge badge-comercio">${nomCom}</span><br><span class="badge badge-premio">üéÅ ${premio}</span>${descPremio?`<div class="premio-desc">${descPremio}</div>`:''}</td>
<td><div class="participantes-cell">
<div class="participantes-row"><span>LEAD:</span><span class="participantes-value valor-lead">${cL}</span></div>
<div class="participantes-row"><span>VIP:</span><span class="participantes-value valor-vip">${cV}</span></div>
<div class="participantes-row"><b>TOTAL:</b><span class="participantes-value valor-total">${cL+cV}</span></div>
</div></td>
<td>
<button class="btn btn-sortear-accion"
data-id="${docCom.id}" data-nombre="${nomCom}" data-premio="${premio}"
data-cant="${cant}" data-mail="${c.email||''}" data-logo="${c.logoUrl||''}"
data-desc="${descPremio}" data-timestamp="${ts}" data-clave-comercio="${c.password||''}"
onclick="intentarSorteo(this)">Calculando...</button>
<br><button class="btn btn-danger btn-sm" style="margin-top:5px;font-size:0.8rem" onclick="intentarEliminarSorteo('${docCom.id}','${fechaISO}')">üóëÔ∏è Cancelar</button>
</td>
<td style="text-align:center"><span class="badge badge-premios">üéÅ ${cant} premio${cant>1?'s':''}</span></td>
</tr>`;
}
});
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EJECUTAR SORTEO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ejecutarSorteo = async (idCom, nomCom, premio, cant, mailC, logoUrl, desc) => {
mostrarToast(`üé≤ Procesando sorteo para ${nomCom}...`,"warning");
try {
const snapP=await getDocs(query(collection(db,"admin_participantes_sorteos"),where("comercio","==",nomCom)));
let participantes=[];
for (const d of snapP.docs) {
const p=d.data(); let nom=p.nombre||"Participante",cel=p.celular||p.whatsapp||"S/D",tipo=p.tipo||"LEAD",email=p.email||"";
if(p.usuarioId&&!p.usuarioId.startsWith('temp_')){try{const ld=await getDoc(doc(db,"leads",p.usuarioId));if(ld.exists()){const l=ld.data();nom=`${l.nombres||''} ${l.apellido||''}`.trim()||nom;cel=l.whatsapp||l.celular||cel;tipo=(l.convertidoVIP||l.tipo==="VIP")?"VIP":"LEAD";email=l.email||email;}}catch(e){}}
participantes.push({...p,nombreMostrar:nom,celular:cel,tipo,email});
}
if(!participantes.length) return mostrarToast("‚ö†Ô∏è Sin participantes","error");
let ganadores=[],bolsa=[...participantes];
for(let i=0;i<Math.min(cant,bolsa.length);i++){const idx=Math.floor(Math.random()*bolsa.length);ganadores.push(bolsa.splice(idx,1)[0]);}
await addDoc(collection(db,"historial_sorteos"),{
comercio:nomCom, premio, descripcion_sorteo:desc||"", logoUrl:logoUrl||"",
ganadores, fecha:serverTimestamp(), mailComercio:mailC||'habitatcar@gmail.com', timestampProgramado:Date.now()
});
mostrarToast("‚úÖ Sorteo exitoso","success");
mostrarConfirmacionSorteo(participantes.length, ganadores, nomCom);
} catch(e){console.error(e); mostrarToast("‚ùå Error en sorteo","error");}
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORIAL
// CHANGE 1: logoComercio desde h.logoUrl (Firebase), LOGO_HABITAT siempre auto
// CHANGE 2: sin bot√≥n WA separado ‚Äî solo "ENVIAR WHATSAPP Y PDF"
// CHANGE 3: pasa descripcion al bot√≥n via data-descripcion
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.mostrarHistorial = () => {
window.vistaActual='historial'; window.itemsSeleccionados.clear(); actualizarBulkActions();
document.getElementById('header-checkbox').style.display='table-cell';
const tabla=document.getElementById('tabla-sorteos');
onSnapshot(collection(db,"historial_sorteos"), snap => {
tabla.innerHTML="";
snap.docs.sort((a,b)=>(b.data().fecha?.seconds||0)-(a.data().fecha?.seconds||0))
.forEach(docSnap => {
const h=docSnap.data();
const fecha=h.fecha?.toDate?h.fecha.toDate().toLocaleString():"Reciente";
// CHANGE 1: logo del comercio viene directo de Firebase (h.logoUrl)
const logoC=h.logoUrl||LOGO_DEFAULT;
const descSorteo=h.descripcion_sorteo||"";
(h.ganadores||[]).forEach(g => {
const nombreG=g.nombreMostrar||"Invitado", celG=g.celular||"", emailG=g.email||"";
const badge=g.tipo==="VIP"
?`<span class="badge badge-vip"><i class="fas fa-crown"></i> VIP</span>`
:`<span class="badge badge-lead"><i class="fas fa-user"></i> LEAD</span>`;
const esc=s=>(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;');
tabla.innerHTML+=`<tr>
<td class="checkbox-cell"><input type="checkbox" class="row-checkbox" data-id="${docSnap.id}" onchange="toggleSeleccion('${docSnap.id}',this)"></td>
<td><small>${fecha}</small></td>
<td><img src="${esc(logoC)}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
<td>
<span class="badge badge-comercio">${h.comercio}</span><br>
<span class="badge badge-premio">üéÅ ${h.premio}</span>
${descSorteo?`<div class="premio-desc">${descSorteo}</div>`:''}
</td>
<td><div style="font-weight:bold">${nombreG}</div><div style="margin-top:4px">${badge}</div></td>
<td>
<div style="font-size:0.85em;color:var(--verde);margin-bottom:3px;"><i class="fab fa-whatsapp"></i> ${celG}</div>
${emailG?`<div style="font-size:0.8em;color:#666;word-break:break-all;"><i class="fas fa-envelope"></i> ${emailG}</div>`:''}
<div style="margin-top:8px;">
<!-- CHANGE 2: UN SOLO BOT√ìN ‚Äî sin el bot√≥n WA separado -->
<button class="btn-accion btn-wapdf"
data-nombre="${esc(nombreG)}"
data-premio="${esc(h.premio)}"
data-comercio="${esc(h.comercio)}"
data-descripcion="${esc(descSorteo)}"
data-cel="${esc(celG)}"
data-logo="${esc(logoC)}"
onclick="clickEnviarTicket(this)"
title="Genera PDF y abre WhatsApp con mensaje personalizado">
<i class="fab fa-whatsapp"></i> <i class="fas fa-file-pdf"></i> ENVIAR WHATSAPP Y PDF
</button>
</div>
</td>
<td>
<button class="btn-accion" style="background:#6c757d"
data-texto="${esc(nombreG+' - WA: '+celG+' - Email: '+emailG)}"
onclick="navigator.clipboard.writeText(this.dataset.texto);mostrarToast('üìã Copiado','warning')">
<i class="fas fa-copy"></i>
</button>
<button class="btn-accion btn-delete" onclick="eliminarIndividual('${docSnap.id}',this)">
<i class="fas fa-trash"></i>
</button>
</td>
</tr>`;
});
});
});
};
// CHANGE 2+3: clickEnviarTicket pasa descripcion como 4¬∫ par√°metro
window.clickEnviarTicket = btn => {
window.enviarTicketElite(
btn.dataset.nombre      || '',
btn.dataset.premio      || '',
btn.dataset.comercio    || '',
btn.dataset.descripcion || '',  // CHANGE 3
btn.dataset.cel         || '',
btn.dataset.logo        || ''   // CHANGE 1: logo del comercio desde Firebase
);
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILIDADES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mostrarToast(msg, tipo="success") {
const d=document.createElement('div'); d.className=`toast ${tipo}`; d.innerText=msg;
document.body.appendChild(d); setTimeout(()=>d.remove(),3500);
}
function formatearFechaHora(fechaISO) {
if(!fechaISO)return null;
try{const[fp,hp]=fechaISO.split('T');const[a,m,d]=fp.split('-');const[h,min]=hp.split(':');return{fecha:`${d}/${m}/${a}`,hora:`${h}:${min} Hs.`};}catch(e){return null;}
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INICIALIZACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('btn-activos').onclick  = cargarActivos;
document.getElementById('btn-historial').onclick = mostrarHistorial;
document.addEventListener('DOMContentLoaded',()=>{ cargarActivos(); iniciarRelojes(); });
document.getElementById('modalPDF').addEventListener('click',e=>{ if(e.target.id==='modalPDF') cerrarModales(); });
document.getElementById('modalWA').addEventListener('click', e=>{ if(e.target.id==='modalWA')  cerrarModales(); });
// Exponer al scope global (requerido por onclick en HTML est√°tico)
window.mostrarHistorial=mostrarHistorial; window.mostrarToast=mostrarToast;
window.mostrarConfirmacionSorteo=mostrarConfirmacionSorteo; window.cerrarModalSorteo=cerrarModalSorteo;
window.irAlHistorial=irAlHistorial; window.toggleSeleccion=toggleSeleccion; window.toggleSelectAll=toggleSelectAll;
window.eliminarSeleccionados=eliminarSeleccionados; window.desmarcarTodos=desmarcarTodos;
window.eliminarIndividual=eliminarIndividual; window.actualizarBulkActions=actualizarBulkActions;
window.intentarSorteo=intentarSorteo; window.intentarEliminarSorteo=intentarEliminarSorteo;
window.validarAccionSegura=validarAccionSegura; window.enviarTicketElite=enviarTicketElite;
window.clickEnviarTicket=clickEnviarTicket; window.abrirEditorPDF=abrirEditorPDF;
window.abrirEditorWA=abrirEditorWA; window.actualizarPrevia=actualizarPrevia;
window.guardarConfigPDF=guardarConfigPDF; window.guardarConfigWA=guardarConfigWA;
window.cerrarModales=cerrarModales; window.iniciarRelojes=iniciarRelojes;
</script>
</body>
</html>
