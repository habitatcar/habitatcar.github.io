<script type="module">
    // ... (Mantener inicializaciÃ³n de Firebase igual) ...

    // URL de tu Google Apps Script (la misma de admin_estadisticas.html)
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz2xzSyQfL23SSFvvZ5jfKYYWvjMIy56XX33cSuq-DAQG64geSLsHdLnVzNmXDkzSXM5A/exec";

    // 1. CARGA DE COMERCIOS CON CANTIDAD DE GANADORES DESDE LA BASE
    onSnapshot(collection(db, "comercios"), (snap) => {
        const cont = document.getElementById('lista-activos');
        cont.innerHTML = "";
        snap.forEach(docCom => {
            const c = docCom.data();
            if (!c.titulo_sorteo) return;
            
            // LÃ³gica: Si el comercio tiene definido 'cantidad_ganadores', se usa, sino 1.
            const cantConfigurada = c.cantidad_ganadores || 1;

            const div = document.createElement('div');
            div.className = 'card-sorteo';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h3 style="margin:0">${c.nombre}</h3>
                        <span style="color:var(--red-laser); font-size:12px; font-weight:bold;">${c.titulo_sorteo}</span>
                    </div>
                    <button class="btn btn-main" onclick="lanzarSorteo('${docCom.id}', '${c.nombre}', '${c.titulo_sorteo}', '${c.email || 'habitatcar@gmail.com'}', ${cantConfigurada})">
                        <i class="fas fa-trophy"></i> SORTEAR (${cantConfigurada})
                    </button>
                </div>
                <div class="stats-row">
                    <div class="stat-item"><span id="t-${docCom.id}">0</span><label>Participantes</label></div>
                </div>
            `;
            cont.appendChild(div);
            vincularParticipantes(c.nombre, docCom.id);
        });
    });

    // 2. ENVÃO DE EMAIL DIRECTO (MISMA LÃ“GICA QUE ESTADÃSTICAS)
    window.enviarMail = async (mailG, nombre, premio, comercio, mailC) => {
        const btn = event.currentTarget;
        const iconOriginal = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        // Generamos el PDF alegre en memoria
        const docPDF = window.generarEstructuraPDF(nombre, premio, comercio);
        const pdfBase64 = docPDF.output('datauristring').split(',')[1];

        const payload = {
            email: mailG,
            nombreGanador: nombre,
            premio: premio,
            comercio: comercio,
            pdfB64: pdfBase64,
            asunto: `ðŸ† Â¡FELICITACIONES! Ganaste en el sorteo de HÃ¡bitat-Car`,
            cc: `habitatcar@gmail.com, ${mailC}`
        };

        try {
            await fetch(WEB_APP_URL, {
                method: "POST",
                mode: 'no-cors',
                body: JSON.stringify(payload)
            });
            alert(`âœ… Mail enviado a ${nombre} (${mailG}). Copia enviada a Admin y Comercio.`);
        } catch (e) {
            console.error("Error envÃ­o:", e);
            alert("Error en el servidor de correo.");
        } finally {
            btn.innerHTML = iconOriginal;
        }
    };

    // 3. GENERADOR DE PDF "ALEGRE Y CLARO" (ESTILO DIPLOMA)
    window.generarEstructuraPDF = (nombre, premio, comercio) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a5');

        // DiseÃ±o Fondo Blanco (Limpio para imprimir)
        doc.setFillColor(255, 255, 255);
        doc.rect(0, 0, 210, 148, 'F');

        // Bordes Oro y Rojo
        doc.setDrawColor(230, 57, 70); doc.setLineWidth(2); doc.rect(5, 5, 200, 138); 
        doc.setDrawColor(255, 193, 7); doc.setLineWidth(0.5); doc.rect(7, 7, 196, 134);

        doc.setTextColor(0, 74, 153);
        doc.setFontSize(30);
        doc.setFont("helvetica", "bold");
        doc.text("Â¡FELICITACIONES!", 105, 40, { align: "center" });

        doc.setTextColor(60, 60, 60);
        doc.setFontSize(16);
        doc.text("Se otorga este certificado a:", 105, 55, { align: "center" });

        doc.setTextColor(230, 57, 70); // Rojo
        doc.setFontSize(26);
        doc.text(nombre.toUpperCase(), 105, 75, { align: "center" });

        doc.setTextColor(40, 40, 40);
        doc.setFontSize(18);
        doc.text(`Ganador del premio: ${premio}`, 105, 100, { align: "center" });
        
        doc.setFontSize(12);
        doc.setTextColor(150, 150, 150);
        doc.text(`${comercio} | HÃ¡bitat-Car Ecosistema`, 105, 130, { align: "center" });

        return doc;
    };

    // FunciÃ³n para descargar solo el PDF desde la tabla
    window.descargarPDF = (nombre, premio, comercio) => {
        const doc = window.generarEstructuraPDF(nombre, premio, comercio);
        doc.save(`Certificado_${nombre}.pdf`);
    };

    // 4. LÃ“GICA DE SORTEO MULTI-GANADOR
    window.lanzarSorteo = async (id, nom, pre, mailC, cant) => {
        const list = partGlobal[id];
        if(!list || list.length === 0) return alert("Sin participantes.");

        let seleccionados = [];
        let bolsa = [...list];

        for(let i=0; i < cant; i++) {
            if(bolsa.length === 0) break;
            const index = Math.floor(Math.random() * bolsa.length);
            seleccionados.push(bolsa.splice(index, 1)[0]);
        }

        await addDoc(collection(db, "historial_sorteos"), {
            comercio: nom, 
            premio: pre, 
            ganadores: seleccionados, 
            mailComercio: mailC,
            fecha: serverTimestamp()
        });

        document.getElementById('ganador-nombre-anim').innerText = seleccionados.map(g => g.nombre).join(" & ");
        document.getElementById('modal-ganador').style.display = 'block';
    };

    // 5. TEST DATA CON MAILS SOLICITADOS
    window.testRealData = async () => {
        const tests = [
            { nombre: "MAXI TEST", celular: "+543884618228", email: "lormaxi@hotmail.com", tipo: "VIP", comercio: "COMERCIO DE PRUEBA" },
            { nombre: "HABITAT ADMIN", celular: "3884618156", email: "habitatcar@gmail.com", tipo: "LEAD", comercio: "COMERCIO DE PRUEBA" }
        ];
        for(let t of tests) {
            await addDoc(collection(db, "admin_participantes_sorteos"), t);
        }
        alert("Datos de prueba cargados.");
    };

    // ... (Mantener switchTab y resto de estructura) ...
</script>
