<html lang="es"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Sorteos Elite | H√°bitat-Car</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--azul-habitat: #003d80;
--rojo-cupon: #e60000;
--naranja: #ff8c00;
--celeste: #0288d1;
--verde: #2e7d32;
--blanco: #ffffff;
--gris-texto: #666666;
--oro: #d4af37;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; padding-top: 140px; }
/* ... (Se mantienen todos tus estilos originales) ... */
</style>
</head>
<body>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const firebaseConfig = {
    // TUS CREDENCIALES (C√≥pialas de tu archivo original aqu√≠)
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const URL_SCRIPT = "TU_URL_DE_GOOGLE_SCRIPT_AQUI"; // Aseg√∫rate de poner tu URL /exec

// --- FUNCI√ìN DE ENV√çO (Extra√≠da de la copia que funciona) ---
window.enviarMail = async (btn, emailDestino, nombre, premio, comercio, mailCC, logoComercio) => {
    if (!emailDestino) return mostrarToast("Sin email", "error");
    
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "‚è≥";

    let asuntoP = localStorage.getItem('hc_asunto') || "üèÜ ¬°Felicidades {{NOMBRE}}, ganaste!";
    let cuerpoP = localStorage.getItem('hc_cuerpo') || "Hola {{NOMBRE}}, ganaste {{PREMIO}} en {{COMERCIO}}.";

    // Inyecci√≥n exacta
    let asuntoFinal = asuntoP.replace(/{{NOMBRE}}/g, nombre).replace(/{{PREMIO}}/g, premio).replace(/{{COMERCIO}}/g, comercio);
    let cuerpoFinal = cuerpoP.replace(/{{NOMBRE}}/g, nombre).replace(/{{PREMIO}}/g, premio).replace(/{{COMERCIO}}/g, comercio);

    try {
        const datos = {
            email: emailDestino.trim(),
            asunto: asuntoFinal,
            cuerpoHtml: cuerpoFinal,
            nombreGanador: nombre,
            cc: `habitatcar@gmail.com${mailCC ? ', ' + mailCC : ''}`,
            pdfB64: "" 
        };

        await fetch(URL_SCRIPT, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'text/plain' }, 
            body: JSON.stringify(datos)
        });

        mostrarToast("‚úÖ Mail enviado correctamente");
    } catch (e) {
        console.error("Error env√≠o:", e);
        mostrarToast("‚ùå Error de conexi√≥n", "error");
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
};

// --- FUNCI√ìN MOSTRAR HISTORIAL (Corregida para pasar datos bien) ---
window.mostrarHistorial = async () => {
    const cont = document.getElementById('sorteos-activos');
    cont.innerHTML = '<div class="loading">Cargando historial...</div>';
    
    const querySnapshot = await getDocs(collection(db, "comercios"));
    let html = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:var(--azul-habitat)"><i class="fas fa-history"></i> Historial de Ganadores</h2>
            <button class="btn-sortear" onclick="cargarActivos()" style="background:var(--gris-texto)">Volver</button>
        </div>
        <table class="tabla-sorteos">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Comercio</th>
                    <th>Premio</th>
                    <th>Ganador/es</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>`;

    querySnapshot.forEach((docCom) => {
        const c = docCom.data();
        if (c.historial_sorteos) {
            c.historial_sorteos.forEach((h) => {
                h.ganadores.forEach(gan => {
                    const nombreG = gan.nombre;
                    const emailG = gan.email;
                    // AQU√ç EST√Å EL CAMBIO: Usamos comillas simples para proteger los datos con espacios
                    html += `
                    <tr>
                        <td>${h.fecha}</td>
                        <td><strong>${h.comercio}</strong></td>
                        <td>${h.premio}</td>
                        <td>${nombreG}<br><small>${emailG}</small></td>
                        <td>
                            <button class="btn-accion btn-mail" onclick="enviarMail(this, '${emailG}', '${nombreG}', '${h.premio}', '${h.comercio}', '${c.mail_comercio || ''}')">
                                <i class="fas fa-envelope"></i>
                            </button>
                            <button class="btn-accion btn-wa" onclick="abrirWA('${gan.telefono}', '${nombreG}', '${h.premio}', '${h.comercio}')">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                        </td>
                    </tr>`;
                });
            });
        }
    });
    html += `</tbody></table>`;
    cont.innerHTML = html;
};

// ... (El resto de tus funciones cargarActivos, ejecutarSorteo, etc. se mantienen igual) ...

function mostrarToast(mensaje, tipo = "success") { 
    const div = document.createElement('div'); 
    div.className = `toast ${tipo}`; 
    div.innerText = mensaje; 
    document.body.appendChild(div); 
    setTimeout(() => div.remove(), 3000); 
}

document.getElementById('btn-activos').onclick = cargarActivos;
document.getElementById('btn-historial').onclick = window.mostrarHistorial;
document.addEventListener('DOMContentLoaded', () => { cargarActivos(); });

window.enviarMail = enviarMail;
window.mostrarHistorial = mostrarHistorial;
window.mostrarToast = mostrarToast;
// ... (Tus otras exportaciones de window)
</script>
</body></html>
