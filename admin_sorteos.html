<!-- ========================================
     ARCHIVO: admin_sorteos.html
     PANEL DE SORTEOS ELITE | H√ÅBITAT-CAR
     Funciones: Sorteos, WhatsApp, Email con PDF, Firebase
     √öltima actualizaci√≥n: 2026
     ======================================== -->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Sorteos Elite | H√°bitat-Car</title>
    <!-- ‚úÖ jsPDF corregido (sin espacios) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- ‚úÖ Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== FAJA PRINCIPAL (COPIADA DE admin_comercios.html) ===== */
        :root {
            --azul-habitat: #003d80;
            --rojo-cupon: #e60000;
            --naranja: #ff8c00;
            --celeste: #0288d1;
            --verde: #2e7d32;
            --blanco: #ffffff;
            --gris-texto: #666666;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: #f8f9fa; 
            color: #333; 
            line-height: 1.6;
            padding-top: 140px; /* Espacio para la faja fija */
        }
        
        /* Faja superior fija */
        .faja-superior {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--azul-habitat);
            border-bottom: 4px solid var(--rojo-cupon);
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .faja-contenido {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .faja-logo {
            text-align: center;
            padding: 5px 0;
        }
        
        .faja-logo img {
            height: 50px;
            width: auto;
            max-width: 200px;
        }
        
        .faja-nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            padding: 5px 0;
        }
        
        .faja-nav a {
            padding: 6px 10px;
            border-radius: 4px;
            text-decoration: none;
            color: white;
            font-weight: 600;
            font-size: 11px;
            background: rgba(255,255,255,0.15);
            transition: all 0.2s;
            text-transform: uppercase;
        }
        
        .faja-nav a:hover,
        .faja-nav a.active {
            background: var(--rojo-cupon);
            transform: translateY(-1px);
        }
        
        .faja-nav a.active {
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        /* ===== ESTILOS DEL PANEL DE SORTEOS ===== */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            text-align: center; 
        }
        header h1 { font-size: 1.8rem; margin-bottom: 8px; }
        header p { opacity: 0.9; font-size: 0.95rem; }
        
        .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        th { background: #667eea; color: white; padding: 14px 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .btn-accion { padding: 6px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; color: white; }
        .btn-wa { background: #25D366; }
        .btn-mail { background: #ea4335; }
        .btn-copy { background: #6c757d; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .badge-premio { background: #fff3cd; color: #856404; }
        .badge-comercio { background: #d1ecf1; color: #0c5460; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 10px; color: white; z-index: 9999; animation: slideIn 0.3s ease; }
        .success { background: #28a745; } .error { background: #dc3545; } .warning { background: #ffc107; color: #333; }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
        
        /* ‚úÖ ESTILOS PARA COLUMNAS DE PARTICIPANTES */
        .participantes-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.85rem;
        }
        .participantes-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .participantes-label {
            font-weight: 600;
            color: #666;
            min-width: 40px;
        }
        .participantes-value {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
            min-width: 30px;
            text-align: center;
        }
        .valor-lead { background: #e3f2fd; color: #1976d2; }
        .valor-vip { background: #fff8e1; color: #f57f17; }
        .valor-total { background: #e8f5e9; color: #388e3c; }
        
        /* ‚úÖ ESTILO PARA DESCRIPCI√ìN DEL PREMIO */
        .premio-desc {
            font-size: 0.85rem;
            color: #666;
            margin-top: 4px;
            line-height: 1.4;
            max-width: 200px;
        }
        
        /* ‚úÖ ESTILOS PARA FECHA Y HORA SEPARADAS */
        .fecha-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 0.85rem;
            min-width: 100px;
        }
        .fecha-principal {
            font-weight: bold;
            color: #333;
        }
        .hora-secundaria {
            color: #666;
            font-size: 0.8rem;
        }
        
        /* ‚úÖ ESTILOS PARA LOGO MINI (DOBLE TAMA√ëO) */
        .logo-mini {
            height: 80px;
            width: auto;
            max-width: 120px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }
        
        /* ‚úÖ ESTILOS PARA MODAL DE CONFIRMACI√ìN DE SORTEO */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 16px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        /* Responsive para m√≥vil */
        @media (max-width: 768px) {
            .faja-nav { gap: 3px; }
            .faja-nav a { font-size: 9px; padding: 4px 6px; }
            .faja-logo img { height: 40px; }
            body { padding-top: 120px; }
            .participantes-row { font-size: 0.8rem; }
            .premio-desc { max-width: 150px; font-size: 0.8rem; }
            .fecha-cell { min-width: 80px; }
            .logo-mini { height: 70px; max-width: 100px; }
        }
    </style>
</head>
<body>
    <!-- ‚úÖ FAJA PRINCIPAL (COPIADA DE admin_comercios.html) -->
    <div class="faja-superior">
        <div class="faja-contenido">
            <div class="faja-logo">
                <a href="index.html">
                    <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="H√°bitat-Car">
                </a>
            </div>
            <nav class="faja-nav">
                <a href="admin_comercios.html">COMERCIOS</a>
                <a href="admin_leads.html">LEADS</a>
                <a href="admin_vips.html">VIPS</a>
                <a href="admin_tokens_vip.html">TOKENS VIP</a>
                <a href="admin_curioso.html">CURIOSO</a>
                <a href="admin_estadisticas.html">ESTAD√çSTICAS</a>
                <a href="admin_logs.html">LOG</a>
                <a href="admin_tutoriales.html">TUTORIALES</a>
                <a href="index.html">PANEL</a>
                <a href="admin_legales.html">LEGALES</a>
                <!-- ‚úÖ Link activo para esta p√°gina -->
                <a href="admin_sorteos.html" class="active">SORTEOS</a>
            </nav>
        </div>
    </div>

    <!-- ===== CONTENIDO DEL PANEL DE SORTEOS ===== -->
    <div class="container">
        <header>
            <h1>üèÜ SORTEOS PREMIUM</h1>
            <p>Panel de Sorteos Elite | H√°bitat-Car</p>
        </header>

        <div class="controls">
            <button class="btn btn-primary" id="btn-prueba">üß™ CARGAR PRUEBA</button>
            <button class="btn btn-success" id="btn-activos">SORTEOS ACTIVOS</button>
            <button class="btn btn-warning" id="btn-historial">HISTORIAL DE √âXITOS</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>FECHA</th>
                    <th>LOGO</th>
                    <th>COMERCIO / PREMIO</th>
                    <th>PARTICIPANTES</th>
                    <th>ACCIONES</th>
                    <th>BENEFICIARIOS</th>
                </tr>
            </thead>
            <tbody id="tabla-sorteos"></tbody>
        </table>
    </div>

    <!-- ‚úÖ MODAL DE CONFIRMACI√ìN DE SORTEO -->
    <div id="modal-sorteo-confirm" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--azul-habitat); margin-bottom: 15px;">üéâ ¬°SORTEO REALIZADO!</h3>
            <p id="texto-sorteo" style="font-size: 1.1rem; margin-bottom: 20px; line-height: 1.5;"></p>
            <button class="btn btn-primary" onclick="irAlHistorial()">IR AL HISTORIAL DE √âXITOS</button>
            <button class="btn btn-warning" onclick="cerrarModalSorteo()" style="margin-top: 10px;">SEGUIR AQU√ç</button>
        </div>
    </div>

    <script type="module">
        // ‚úÖ Imports corregidos (sin espacios al final)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, addDoc, serverTimestamp, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // üìù COPIA AQU√ç TUS CREDENCIALES REALES de admin_comercios.html
        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // ‚úÖ URL corregida (sin espacios al final)
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbz2xzSyQfL23SSFvvZ5jfKYYWvjMIy56XX33cSuq-DAQG64geSLsHdLnVzNmXDkzSXM5A/exec";

        /* =========================================================
           üõ†Ô∏è L√ìGICA DE WHATSAPP Y MAIL (SACADAS A WINDOW)
        ========================================================== */
        window.normalizarTelefonoAR = (numero) => {
            if (!numero) return null;
            let num = numero.toString().replace(/\D/g, '');
            if (num.length === 10) return '549' + num;
            if (num.startsWith('54') && !num.startsWith('549')) return '549' + num.substring(2);
            return num.startsWith('549') ? num : '549' + num;
        };

        window.abrirWA = (cel, nom, pre) => {
            if (!cel) return mostrarToast("‚ö†Ô∏è El participante no tiene celular.", "error");
            const num = window.normalizarTelefonoAR(cel);
            const msg = encodeURIComponent(`¬°Hola ${nom}! üèÜ Soy de H√°bitat-Car. ¬°Felicidades, ganaste el sorteo de ${pre}! üéâ`);
            window.open(`https://wa.me/${num}?text=${msg}`, '_blank');
        };

        window.enviarMail = async (btn, mailG, nombre, premio, comercio, mailC) => {
            if (!mailG) return mostrarToast("‚ö†Ô∏è El participante no tiene email.", "error");
            
            const original = btn.innerHTML;
            btn.disabled = true; 
            btn.innerHTML = "‚è≥";
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a5');
            
            doc.setFillColor(255, 255, 255); doc.rect(0, 0, 210, 148, 'F');
            doc.setDrawColor(230, 57, 70); doc.setLineWidth(2); doc.rect(5, 5, 200, 138);
            doc.setDrawColor(255, 193, 7); doc.setLineWidth(0.5); doc.rect(7, 7, 196, 134);
            
            doc.setTextColor(0, 74, 153); doc.setFontSize(30); doc.text("¬°FELICITACIONES!", 105, 35, { align: "center" });
            doc.setTextColor(60, 60, 60); doc.setFontSize(16); doc.text("Certificado otorgado a:", 105, 55, { align: "center" });
            doc.setTextColor(230, 57, 70); doc.setFontSize(26); doc.text(nombre.toUpperCase(), 105, 75, { align: "center" });
            doc.setTextColor(40, 40, 40); doc.setFontSize(16); doc.text(`Ganador de: ${premio}`, 105, 100, { align: "center" });
            doc.setFontSize(10); doc.text(`${comercio} & H√°bitat-Car`, 105, 130, { align: "center" });
            
            const pdfBase64 = doc.output('datauristring').split(',')[1];

            try {
                await fetch(URL_SCRIPT, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: mailG.trim(), 
                        nombreGanador: nombre, 
                        premio, 
                        comercio, 
                        pdfB64: pdfBase64, 
                        asunto: `üèÜ ¬°Felicidades ${nombre}!`,
                        cc: `habitatcar@gmail.com, ${mailC}` 
                    })
                });
                mostrarToast("‚úÖ Mail enviado correctamente", "success");
            } catch (e) { 
                console.error(e);
                mostrarToast("‚ùå Error en env√≠o", "error"); 
            } finally {
                btn.disabled = false; 
                btn.innerHTML = original; 
            }
        };

        /* =========================================================
           üìä FORMATEAR FECHA Y HORA (FUNCI√ìN AUXILIAR)
        ========================================================== */
        function formatearFechaHora(fechaISO) {
            if (!fechaISO) return null;
            try {
                const [fechaParte, horaParte] = fechaISO.split('T');
                if (!fechaParte || !horaParte) return null;
                const [anio, mes, dia] = fechaParte.split('-');
                const [hora, minutos] = horaParte.split(':');
                return {
                    fecha: `${dia}/${mes}/${anio}`,
                    hora: `${hora}:${minutos} Hs.`
                };
            } catch (e) {
                return null;
            }
        }

        /* =========================================================
           ‚úÖ FUNCI√ìN AUXILIAR: CONSTRUIR NOMBRE COMPLETO
        ========================================================== */
        function construirNombreCompleto(data) {
            // Prioridad: (nombre + apellido) > nombre > usuario > fallback
            if (data.nombre && data.apellido) {
                return `${data.nombre} ${data.apellido}`.trim();
            }
            if (data.nombre) return data.nombre.trim();
            if (data.usuario) return data.usuario.trim();
            if (data.fullName) return data.fullName.trim();
            return "Participante sin nombre";
        }

        /* =========================================================
           üéâ MODAL DE CONFIRMACI√ìN DE SORTEO (‚úÖ CORREGIDO: NOMBRE COMPLETO + TIPO)
        ========================================================== */
        window.mostrarConfirmacionSorteo = (totalParticipantes, ganadores) => {
            const modal = document.getElementById('modal-sorteo-confirm');
            const texto = document.getElementById('texto-sorteo');
            
            const pluralPersona = ganadores.length > 1 ? 'personas' : 'persona';
            const pluralSali√≥ = ganadores.length > 1 ? 'salieron' : 'sali√≥';
            const pluralSorteado = ganadores.length > 1 ? 'sorteados' : 'sorteado';

            // ‚úÖ CORRECCI√ìN: Muestra Nombre Completo y Tipo (VIP/LEAD)
            const nombres = ganadores.map(g => {
                const nombreReal = construirNombreCompleto(g);
                const tipo = g.tipo ? `(${g.tipo.toUpperCase()})` : "(LEAD)";
                return `<span style="background:#fff8e1; color:#f57f17; padding:3px 10px; border-radius:6px; font-weight:600; margin:3px 0; display:inline-block;">üé´ ${nombreReal} <small style="color:#666">${tipo}</small></span>`;
            }).join('<br>');
            
            texto.innerHTML = `
                De <b>${totalParticipantes}</b> participantes, ${pluralSali√≥} ${pluralSorteado}:<br>
                <div style="margin-top:12px; line-height:1.9;">${nombres}</div>
            `;
            
            modal.classList.add('active');
        };

        window.cerrarModalSorteo = () => {
            document.getElementById('modal-sorteo-confirm').classList.remove('active');
        };

        window.irAlHistorial = () => {
            window.cerrarModalSorteo();
            window.mostrarHistorial();
        };

        /* =========================================================
           üìä CARGA DE DATOS Y RENDERIZADO (CORREGIDO CON DELEGACI√ìN)
        ========================================================== */
        const cargarActivos = async () => {
            onSnapshot(collection(db, "comercios"), async (snap) => {
                const tabla = document.getElementById('tabla-sorteos');
                tabla.innerHTML = "";
                
                for (const docCom of snap.docs) {
                    const c = docCom.data();
                    
                    if (c.titulo_sorteo) {
                        const idCom = docCom.id;
                        const nomCom = c.nombre;
                        const premio = c.titulo_sorteo;
                        const cant = parseInt(c.cantidad_ganadores) || 1;
                        const mailC = c.email || "";

                        // Contar participantes en tiempo real
                        let cLead = 0, cVip = 0;
                        const qP = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nomCom));
                        const snapP = await getDocs(qP);
                        snapP.forEach(p => {
                            if (p.data().tipo === "VIP") cVip++;
                            else cLead++;
                        });

                        const totalP = cLead + cVip;
                        const f = formatearFechaHora(c.fecha_sorteo) || {fecha: 'A definir', hora: ''};

                        // ‚úÖ Bot√≥n con atributos data-* para delegaci√≥n de eventos
                        const fila = `
                        <tr>
                            <td><div class="fecha-cell"><span class="fecha-principal">${f.fecha}</span><span class="hora-secundaria">${f.hora}</span></div></td>
                            <td><img src="${c.logoUrl || ''}" class="logo-mini" onerror="this.src='https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true'"></td>
                            <td><span class="badge badge-comercio">${nomCom}</span><br><span class="badge badge-premio">üéÅ ${premio}</span></td>
                            <td>
                                <div class="participantes-cell">
                                    <div class="participantes-row"><span>LEAD:</span><span class="participantes-value valor-lead">${cLead}</span></div>
                                    <div class="participantes-row"><span>VIP:</span><span class="participantes-value valor-vip">${cVip}</span></div>
                                    <div class="participantes-row"><b>TOTAL:</b><span class="participantes-value valor-total">${totalP}</span></div>
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sortear-accion" 
                                    data-id="${idCom}" 
                                    data-nombre="${nomCom}" 
                                    data-premio="${premio}" 
                                    data-cant="${cant}" 
                                    data-mail="${mailC}">
                                    üé≤ SORTEAR (${cant})
                                </button>
                            </td>
                            <td><small>${cant} beneficiarios</small></td>
                        </tr>`;
                        tabla.innerHTML += fila;
                    }
                }
            });
        };

        /* =========================================================
           üéØ DELEGACI√ìN DE EVENTOS (SOLUCI√ìN AL BOT√ìN MUERTO)
        ========================================================== */
        document.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('btn-sortear-accion')) {
                const b = e.target.dataset;
                ejecutarSorteo(b.id, b.nombre, b.premio, parseInt(b.cant), b.mail);
            }
        });

        /* =========================================================
           üé≤ L√ìGICA DE SORTEO MEJORADA (‚úÖ CORREGIDO: NOMBRE COMPLETO + TOAST)
        ========================================================== */
        const ejecutarSorteo = async (idCom, nomCom, premio, cant, mailC) => {
            mostrarToast(`üé≤ Verificando participantes para ${nomCom}...`, "warning");
            
            try {
                const q = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nomCom));
                const snap = await getDocs(q);
                
                let participantes = [];
                snap.forEach(d => {
                    let data = d.data();
                    // ‚úÖ Creamos nombreMostrar combinando nombre + apellido si existen
                    data.nombreMostrar = construirNombreCompleto(data);
                    participantes.push(data);
                });
                
                // ‚úÖ CORRECCI√ìN: Toast en lugar de alert (desaparece a los 3s)
                if (participantes.length === 0) {
                    mostrarToast(`‚ö†Ô∏è El comercio "${nomCom}" no tiene participantes registrados.`, "error");
                    return; 
                }

                // Selecci√≥n Aleatoria
                let bolsa = [...participantes];
                let ganadores = [];
                const limite = Math.min(cant, bolsa.length);
                
                for (let i = 0; i < limite; i++) {
                    const idx = Math.floor(Math.random() * bolsa.length);
                    ganadores.push(bolsa.splice(idx, 1)[0]);
                }

                // Guardar en Historial
                await addDoc(collection(db, "historial_sorteos"), { 
                    comercio: nomCom, 
                    premio: premio, 
                    ganadores: ganadores, 
                    fecha: serverTimestamp(),
                    mailComercio: mailC || 'habitatcar@gmail.com'
                });
                
                mostrarToast(`‚úÖ ¬°Sorteo realizado!`, "success");
                window.mostrarConfirmacionSorteo(participantes.length, ganadores);
                
            } catch (e) {
                console.error("Error al sortear:", e);
                mostrarToast("‚ùå Error al conectar con la base de datos.", "error");
            }
        };

        /* =========================================================
           üìú HISTORIAL DE √âXITOS (‚úÖ CORREGIDO: LOGO + NOMBRE COMPLETO + SIN DUPLICADOS)
        ========================================================== */
        window.mostrarHistorial = async () => {
            const tabla = document.getElementById('tabla-sorteos');
            tabla.innerHTML = "<tr><td colspan='6' style='text-align:center'>üîÑ Cargando historial...</td></tr>";
            
            try {
                // ‚úÖ Query ordenado por fecha descendente para mostrar lo m√°s reciente primero
                const q = query(collection(db, "historial_sorteos"));
                const snap = await getDocs(q);
                
                tabla.innerHTML = "";
                
                if (snap.empty) {
                    tabla.innerHTML = "<tr><td colspan='6' style='text-align:center;color:#666;padding:30px'>‚ú® Sin sorteos registrados a√∫n</td></tr>";
                    mostrarToast("üìú Historial vac√≠o", "warning");
                    return;
                }

                // ‚úÖ Procesar cada sorteo del historial
                for (const docHist of snap.docs) {
                    const h = docHist.data();
                    const fecha = h.fecha?.toDate ? h.fecha.toDate().toLocaleDateString('es-AR', {day:'2-digit', month:'2-digit', year:'numeric'}) : '-';
                    
                    // ‚úÖ Buscar logo del comercio en la colecci√≥n 'comercios'
                    let logoUrl = 'https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true';
                    try {
                        const qCom = query(collection(db, "comercios"), where("nombre", "==", h.comercio));
                        const snapCom = await getDocs(qCom);
                        if (!snapCom.empty) {
                            const comData = snapCom.docs[0].data();
                            if (comData.logoUrl) logoUrl = comData.logoUrl;
                        }
                    } catch (e) {
                        console.warn("No se pudo cargar logo para:", h.comercio);
                    }

                    // ‚úÖ Mostrar cada ganador en una fila separada (evita duplicados visuales)
                    if (h.ganadores && Array.isArray(h.ganadores)) {
                        for (const g of h.ganadores) {
                            const cel = g.celular || g.telefono || '';
                            const email = g.email || '';
                            // ‚úÖ Usar funci√≥n de nombre completo para consistencia
                            const nombre = construirNombreCompleto(g);
                            const tipoBadge = g.tipo 
                                ? `<span class="badge" style="background:${g.tipo==='VIP'?'#fff8e1:#e3f2fd};color:${g.tipo==='VIP'?'#f57f17:#1976d2'};font-size:0.75rem">${g.tipo.toUpperCase()}</span>` 
                                : '<span class="badge" style="background:#e3f2fd;color:#1976d2;font-size:0.75rem">LEAD</span>';
                            
                            tabla.innerHTML += `
                            <tr style="background:#fff9e6;border-left:4px solid var(--rojo-cupon)">
                                <td><small>${fecha}</small></td>
                                <td><img src="${logoUrl}" class="logo-mini" style="height:50px;max-width:80px" onerror="this.src='https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true'"></td>
                                <td>
                                    <span class="badge badge-comercio">${h.comercio}</span><br>
                                    <small style="color:#666">üéÅ ${h.premio}</small>
                                </td>
                                <td>${tipoBadge}</td>
                                <td>
                                    <div style="display:flex;flex-direction:column;gap:4px">
                                        <button class="btn-accion btn-wa" onclick="abrirWA('${cel}','${nombre}','${h.premio}')">üí¨ WA</button>
                                        <button class="btn-accion btn-mail" onclick="enviarMail(this,'${email}','${nombre}','${h.premio}','${h.comercio}','${h.mailComercio || ''}')">üìß Mail</button>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn-accion btn-copy" onclick="navigator.clipboard.writeText('${nombre} | ${email}')">üìã Copiar</button>
                                </td>
                            </tr>`;
                        }
                    }
                }
                
                mostrarToast("üìú Historial cargado correctamente", "success");
                
            } catch (e) {
                console.error("Error cargando historial:", e);
                tabla.innerHTML = "<tr><td colspan='6' style='text-align:center;color:#dc3545'>‚ùå Error al cargar historial</td></tr>";
                mostrarToast("‚ùå Error al cargar historial", "error");
            }
        };

        function mostrarToast(mensaje, tipo = "success") {
            const div = document.createElement('div'); 
            div.className = `toast ${tipo}`;
            div.innerText = mensaje; 
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // Asignar botones de controles
        document.getElementById('btn-activos').onclick = cargarActivos;
        document.getElementById('btn-historial').onclick = window.mostrarHistorial;
        document.getElementById('btn-prueba').onclick = () => mostrarToast("üß™ Modo prueba listo", "warning");

        // Carga inicial
        document.addEventListener('DOMContentLoaded', () => {
            cargarActivos();
        });

        // Exponer funciones globalmente
        window.abrirWA = abrirWA;
        window.enviarMail = enviarMail;
        window.mostrarHistorial = mostrarHistorial;
        window.mostrarToast = mostrarToast;
        window.mostrarConfirmacionSorteo = mostrarConfirmacionSorteo;
        window.cerrarModalSorteo = cerrarModalSorteo;
        window.irAlHistorial = irAlHistorial;
        window.construirNombreCompleto = construirNombreCompleto;
    </script>
</body>
</html><!-- ========================================
     ARCHIVO: admin_sorteos.html
     PANEL DE SORTEOS ELITE | H√ÅBITAT-CAR
     Funciones: Sorteos, WhatsApp, Email con PDF, Firebase
     √öltima actualizaci√≥n: 2026
     ======================================== -->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Sorteos Elite | H√°bitat-Car</title>
    <!-- ‚úÖ jsPDF corregido (sin espacios) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- ‚úÖ Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== FAJA PRINCIPAL (COPIADA DE admin_comercios.html) ===== */
        :root {
            --azul-habitat: #003d80;
            --rojo-cupon: #e60000;
            --naranja: #ff8c00;
            --celeste: #0288d1;
            --verde: #2e7d32;
            --blanco: #ffffff;
            --gris-texto: #666666;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: #f8f9fa; 
            color: #333; 
            line-height: 1.6;
            padding-top: 140px; /* Espacio para la faja fija */
        }
        
        /* Faja superior fija */
        .faja-superior {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--azul-habitat);
            border-bottom: 4px solid var(--rojo-cupon);
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .faja-contenido {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .faja-logo {
            text-align: center;
            padding: 5px 0;
        }
        
        .faja-logo img {
            height: 50px;
            width: auto;
            max-width: 200px;
        }
        
        .faja-nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            padding: 5px 0;
        }
        
        .faja-nav a {
            padding: 6px 10px;
            border-radius: 4px;
            text-decoration: none;
            color: white;
            font-weight: 600;
            font-size: 11px;
            background: rgba(255,255,255,0.15);
            transition: all 0.2s;
            text-transform: uppercase;
        }
        
        .faja-nav a:hover,
        .faja-nav a.active {
            background: var(--rojo-cupon);
            transform: translateY(-1px);
        }
        
        .faja-nav a.active {
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        /* ===== ESTILOS DEL PANEL DE SORTEOS ===== */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            text-align: center; 
        }
        header h1 { font-size: 1.8rem; margin-bottom: 8px; }
        header p { opacity: 0.9; font-size: 0.95rem; }
        
        .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        th { background: #667eea; color: white; padding: 14px 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .btn-accion { padding: 6px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; color: white; }
        .btn-wa { background: #25D366; }
        .btn-mail { background: #ea4335; }
        .btn-copy { background: #6c757d; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .badge-premio { background: #fff3cd; color: #856404; }
        .badge-comercio { background: #d1ecf1; color: #0c5460; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 10px; color: white; z-index: 9999; animation: slideIn 0.3s ease; }
        .success { background: #28a745; } .error { background: #dc3545; } .warning { background: #ffc107; color: #333; }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
        
        /* ‚úÖ ESTILOS PARA COLUMNAS DE PARTICIPANTES */
        .participantes-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.85rem;
        }
        .participantes-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .participantes-label {
            font-weight: 600;
            color: #666;
            min-width: 40px;
        }
        .participantes-value {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
            min-width: 30px;
            text-align: center;
        }
        .valor-lead { background: #e3f2fd; color: #1976d2; }
        .valor-vip { background: #fff8e1; color: #f57f17; }
        .valor-total { background: #e8f5e9; color: #388e3c; }
        
        /* ‚úÖ ESTILO PARA DESCRIPCI√ìN DEL PREMIO */
        .premio-desc {
            font-size: 0.85rem;
            color: #666;
            margin-top: 4px;
            line-height: 1.4;
            max-width: 200px;
        }
        
        /* ‚úÖ ESTILOS PARA FECHA Y HORA SEPARADAS */
        .fecha-cell {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 0.85rem;
            min-width: 100px;
        }
        .fecha-principal {
            font-weight: bold;
            color: #333;
        }
        .hora-secundaria {
            color: #666;
            font-size: 0.8rem;
        }
        
        /* ‚úÖ ESTILOS PARA LOGO MINI (DOBLE TAMA√ëO) */
        .logo-mini {
            height: 80px;
            width: auto;
            max-width: 120px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }
        
        /* ‚úÖ ESTILOS PARA MODAL DE CONFIRMACI√ìN DE SORTEO */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 16px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        /* Responsive para m√≥vil */
        @media (max-width: 768px) {
            .faja-nav { gap: 3px; }
            .faja-nav a { font-size: 9px; padding: 4px 6px; }
            .faja-logo img { height: 40px; }
            body { padding-top: 120px; }
            .participantes-row { font-size: 0.8rem; }
            .premio-desc { max-width: 150px; font-size: 0.8rem; }
            .fecha-cell { min-width: 80px; }
            .logo-mini { height: 70px; max-width: 100px; }
        }
    </style>
</head>
<body>
    <!-- ‚úÖ FAJA PRINCIPAL (COPIADA DE admin_comercios.html) -->
    <div class="faja-superior">
        <div class="faja-contenido">
            <div class="faja-logo">
                <a href="index.html">
                    <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="H√°bitat-Car">
                </a>
            </div>
            <nav class="faja-nav">
                <a href="admin_comercios.html">COMERCIOS</a>
                <a href="admin_leads.html">LEADS</a>
                <a href="admin_vips.html">VIPS</a>
                <a href="admin_tokens_vip.html">TOKENS VIP</a>
                <a href="admin_curioso.html">CURIOSO</a>
                <a href="admin_estadisticas.html">ESTAD√çSTICAS</a>
                <a href="admin_logs.html">LOG</a>
                <a href="admin_tutoriales.html">TUTORIALES</a>
                <a href="index.html">PANEL</a>
                <a href="admin_legales.html">LEGALES</a>
                <!-- ‚úÖ Link activo para esta p√°gina -->
                <a href="admin_sorteos.html" class="active">SORTEOS</a>
            </nav>
        </div>
    </div>

    <!-- ===== CONTENIDO DEL PANEL DE SORTEOS ===== -->
    <div class="container">
        <header>
            <h1>üèÜ SORTEOS PREMIUM</h1>
            <p>Panel de Sorteos Elite | H√°bitat-Car</p>
        </header>

        <div class="controls">
            <button class="btn btn-primary" id="btn-prueba">üß™ CARGAR PRUEBA</button>
            <button class="btn btn-success" id="btn-activos">SORTEOS ACTIVOS</button>
            <button class="btn btn-warning" id="btn-historial">HISTORIAL DE √âXITOS</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>FECHA</th>
                    <th>LOGO</th>
                    <th>COMERCIO / PREMIO</th>
                    <th>PARTICIPANTES</th>
                    <th>ACCIONES</th>
                    <th>BENEFICIARIOS</th>
                </tr>
            </thead>
            <tbody id="tabla-sorteos"></tbody>
        </table>
    </div>

    <!-- ‚úÖ MODAL DE CONFIRMACI√ìN DE SORTEO -->
    <div id="modal-sorteo-confirm" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--azul-habitat); margin-bottom: 15px;">üéâ ¬°SORTEO REALIZADO!</h3>
            <p id="texto-sorteo" style="font-size: 1.1rem; margin-bottom: 20px; line-height: 1.5;"></p>
            <button class="btn btn-primary" onclick="irAlHistorial()">IR AL HISTORIAL DE √âXITOS</button>
            <button class="btn btn-warning" onclick="cerrarModalSorteo()" style="margin-top: 10px;">SEGUIR AQU√ç</button>
        </div>
    </div>

    <script type="module">
        // ‚úÖ Imports corregidos (sin espacios al final)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // üìù COPIA AQU√ç TUS CREDENCIALES REALES de admin_comercios.html
        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // ‚úÖ URL corregida (sin espacios al final)
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbz2xzSyQfL23SSFvvZ5jfKYYWvjMIy56XX33cSuq-DAQG64geSLsHdLnVzNmXDkzSXM5A/exec";

        /* =========================================================
           üõ†Ô∏è L√ìGICA DE WHATSAPP Y MAIL (SACADAS A WINDOW)
        ========================================================== */
        window.normalizarTelefonoAR = (numero) => {
            if (!numero) return null;
            let num = numero.toString().replace(/\D/g, '');
            if (num.length === 10) return '549' + num;
            if (num.startsWith('54') && !num.startsWith('549')) return '549' + num.substring(2);
            return num.startsWith('549') ? num : '549' + num;
        };

        window.abrirWA = (cel, nom, pre) => {
            if (!cel) return mostrarToast("‚ö†Ô∏è El participante no tiene celular.", "error");
            const num = window.normalizarTelefonoAR(cel);
            const msg = encodeURIComponent(`¬°Hola ${nom}! üèÜ Soy de H√°bitat-Car. ¬°Felicidades, ganaste el sorteo de ${pre}! üéâ`);
            window.open(`https://wa.me/${num}?text=${msg}`, '_blank');
        };

        window.enviarMail = async (btn, mailG, nombre, premio, comercio, mailC) => {
            if (!mailG) return mostrarToast("‚ö†Ô∏è El participante no tiene email.", "error");
            
            const original = btn.innerHTML;
            btn.disabled = true; 
            btn.innerHTML = "‚è≥";
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a5');
            
            doc.setFillColor(255, 255, 255); doc.rect(0, 0, 210, 148, 'F');
            doc.setDrawColor(230, 57, 70); doc.setLineWidth(2); doc.rect(5, 5, 200, 138);
            doc.setDrawColor(255, 193, 7); doc.setLineWidth(0.5); doc.rect(7, 7, 196, 134);
            
            doc.setTextColor(0, 74, 153); doc.setFontSize(30); doc.text("¬°FELICITACIONES!", 105, 35, { align: "center" });
            doc.setTextColor(60, 60, 60); doc.setFontSize(16); doc.text("Certificado otorgado a:", 105, 55, { align: "center" });
            doc.setTextColor(230, 57, 70); doc.setFontSize(26); doc.text(nombre.toUpperCase(), 105, 75, { align: "center" });
            doc.setTextColor(40, 40, 40); doc.setFontSize(16); doc.text(`Ganador de: ${premio}`, 105, 100, { align: "center" });
            doc.setFontSize(10); doc.text(`${comercio} & H√°bitat-Car`, 105, 130, { align: "center" });
            
            const pdfBase64 = doc.output('datauristring').split(',')[1];

            try {
                await fetch(URL_SCRIPT, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: mailG.trim(), 
                        nombreGanador: nombre, 
                        premio, 
                        comercio, 
                        pdfB64: pdfBase64, 
                        asunto: `üèÜ ¬°Felicidades ${nombre}!`,
                        cc: `habitatcar@gmail.com, ${mailC}` 
                    })
                });
                mostrarToast("‚úÖ Mail enviado correctamente", "success");
            } catch (e) { 
                console.error(e);
                mostrarToast("‚ùå Error en env√≠o", "error"); 
            } finally {
                btn.disabled = false; 
                btn.innerHTML = original; 
            }
        };

        /* =========================================================
           üìä FORMATEAR FECHA Y HORA (FUNCI√ìN AUXILIAR)
        ========================================================== */
        function formatearFechaHora(fechaISO) {
            if (!fechaISO) return null;
            try {
                const [fechaParte, horaParte] = fechaISO.split('T');
                if (!fechaParte || !horaParte) return null;
                const [anio, mes, dia] = fechaParte.split('-');
                const [hora, minutos] = horaParte.split(':');
                return {
                    fecha: `${dia}/${mes}/${anio}`,
                    hora: `${hora}:${minutos} Hs.`
                };
            } catch (e) {
                return null;
            }
        }

        /* =========================================================
           üéâ MODAL DE CONFIRMACI√ìN DE SORTEO (‚úÖ CORREGIDO: NOMBRE REAL + TIPO)
        ========================================================== */
        window.mostrarConfirmacionSorteo = (totalParticipantes, ganadores) => {
            const modal = document.getElementById('modal-sorteo-confirm');
            const texto = document.getElementById('texto-sorteo');
            
            const pluralPersona = ganadores.length > 1 ? 'personas' : 'persona';
            const pluralSali√≥ = ganadores.length > 1 ? 'salieron' : 'sali√≥';
            const pluralSorteado = ganadores.length > 1 ? 'sorteados' : 'sorteado';

            // ‚úÖ CORRECCI√ìN PUNTO 2: Muestra Nombre y Tipo (VIP/LEAD)
            const nombres = ganadores.map(g => {
                const nombreReal = g.nombreMostrar || "Sin Nombre";
                const tipo = g.tipo ? `(${g.tipo})` : "";
                return `${nombreReal} ${tipo}`;
            }).join(', ');
            
            texto.innerHTML = `
                De <b>${totalParticipantes}</b> participantes, ${pluralSali√≥} ${pluralSorteado}:<br>
                <b style="color: var(--rojo-cupon); font-size: 1.3rem; display: block; margin-top: 10px;">
                    ${nombres}
                </b>
            `;
            
            modal.classList.add('active');
        };

        window.cerrarModalSorteo = () => {
            document.getElementById('modal-sorteo-confirm').classList.remove('active');
        };

        window.irAlHistorial = () => {
            window.cerrarModalSorteo();
            window.mostrarHistorial();
        };

        /* =========================================================
           üìä CARGA DE DATOS Y RENDERIZADO (CORREGIDO CON DELEGACI√ìN)
        ========================================================== */
        const cargarActivos = async () => {
            onSnapshot(collection(db, "comercios"), async (snap) => {
                const tabla = document.getElementById('tabla-sorteos');
                tabla.innerHTML = "";
                
                for (const docCom of snap.docs) {
                    const c = docCom.data();
                    
                    if (c.titulo_sorteo) {
                        const idCom = docCom.id;
                        const nomCom = c.nombre;
                        const premio = c.titulo_sorteo;
                        const cant = parseInt(c.cantidad_ganadores) || 1;
                        const mailC = c.email || "";

                        // Contar participantes en tiempo real
                        let cLead = 0, cVip = 0;
                        const qP = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nomCom));
                        const snapP = await getDocs(qP);
                        snapP.forEach(p => {
                            if (p.data().tipo === "VIP") cVip++;
                            else cLead++;
                        });

                        const totalP = cLead + cVip;
                        const f = formatearFechaHora(c.fecha_sorteo) || {fecha: 'A definir', hora: ''};

                        // ‚úÖ Bot√≥n con atributos data-* para delegaci√≥n de eventos
                        const fila = `
                        <tr>
                            <td><div class="fecha-cell"><span class="fecha-principal">${f.fecha}</span><span class="hora-secundaria">${f.hora}</span></div></td>
                            <td><img src="${c.logoUrl || ''}" class="logo-mini" onerror="this.src='https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true'"></td>
                            <td><span class="badge badge-comercio">${nomCom}</span><br><span class="badge badge-premio">üéÅ ${premio}</span></td>
                            <td>
                                <div class="participantes-cell">
                                    <div class="participantes-row"><span>LEAD:</span><span class="participantes-value valor-lead">${cLead}</span></div>
                                    <div class="participantes-row"><span>VIP:</span><span class="participantes-value valor-vip">${cVip}</span></div>
                                    <div class="participantes-row"><b>TOTAL:</b><span class="participantes-value valor-total">${totalP}</span></div>
                                </div>
                            </td>
                            <td>
                                <button class="btn btn-primary btn-sortear-accion" 
                                    data-id="${idCom}" 
                                    data-nombre="${nomCom}" 
                                    data-premio="${premio}" 
                                    data-cant="${cant}" 
                                    data-mail="${mailC}">
                                    üé≤ SORTEAR (${cant})
                                </button>
                            </td>
                            <td><small>${cant} beneficiarios</small></td>
                        </tr>`;
                        tabla.innerHTML += fila;
                    }
                }
            });
        };

        /* =========================================================
           üéØ DELEGACI√ìN DE EVENTOS (SOLUCI√ìN AL BOT√ìN MUERTO)
        ========================================================== */
        document.addEventListener('click', (e) => {
            if (e.target && e.target.classList.contains('btn-sortear-accion')) {
                const b = e.target.dataset;
                ejecutarSorteo(b.id, b.nombre, b.premio, parseInt(b.cant), b.mail);
            }
        });

        /* =========================================================
           üé≤ L√ìGICA DE SORTEO MEJORADA (‚úÖ CORREGIDO: TOAST + nombreMostrar)
        ========================================================== */
        const ejecutarSorteo = async (idCom, nomCom, premio, cant, mailC) => {
            // 1. Mensaje inicial de proceso
            mostrarToast(`üé≤ Verificando participantes para ${nomCom}...`, "warning");
            
            try {
                const q = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nomCom));
                const snap = await getDocs(q);
                
                let participantes = [];
                snap.forEach(d => {
                    let data = d.data();
                    // ‚úÖ Aseguramos que tenga un nombre legible antes de meterlo a la bolsa
                    data.nombreMostrar = data.nombre || data.usuario || "Participante sin nombre";
                    participantes.push(data);
                });
                
                // ‚úÖ CORRECCI√ìN PUNTO 1: Sin alert con URL, ahora usa Toast de 3 seg
                if (participantes.length === 0) {
                    mostrarToast(`‚ö†Ô∏è El comercio "${nomCom}" no tiene participantes registrados.`, "error");
                    return; 
                }

                // Selecci√≥n Aleatoria
                let bolsa = [...participantes];
                let ganadores = [];
                const limite = Math.min(cant, bolsa.length);
                
                for (let i = 0; i < limite; i++) {
                    const idx = Math.floor(Math.random() * bolsa.length);
                    ganadores.push(bolsa.splice(idx, 1)[0]);
                }

                // Guardar en Historial
                await addDoc(collection(db, "historial_sorteos"), { 
                    comercio: nomCom, 
                    premio: premio, 
                    ganadores: ganadores, 
                    fecha: serverTimestamp(),
                    mailComercio: mailC || 'habitatcar@gmail.com'
                });
                
                mostrarToast(`‚úÖ ¬°Sorteo realizado!`, "success");
                
                // Llamamos a la confirmaci√≥n pasando los datos limpios
                window.mostrarConfirmacionSorteo(participantes.length, ganadores);
                
            } catch (e) {
                console.error("Error al sortear:", e);
                mostrarToast("‚ùå Error al conectar con la base de datos.", "error");
            }
        };

        window.mostrarHistorial = () => {
            const tabla = document.getElementById('tabla-sorteos');
            tabla.innerHTML = "<tr><td colspan='6' style='text-align:center'>Cargando historial...</td></tr>";
            
            onSnapshot(collection(db, "historial_sorteos"), (snap) => {
                tabla.innerHTML = "";
                if (snap.empty) {
                    tabla.innerHTML = "<tr><td colspan='6' style='text-align:center;color:#666'>Sin sorteos registrados</td></tr>";
                    return;
                }
                snap.forEach(doc => {
                    const h = doc.data();
                    const fecha = h.fecha?.toDate ? h.fecha.toDate().toLocaleDateString('es-AR') : '-';
                    h.ganadores?.forEach(g => {
                        const cel = g.celular || g.telefono || '';
                        const email = g.email || '';
                        const nombre = g.nombreMostrar || g.nombre || 'Sin nombre';
                        tabla.innerHTML += `<tr style="background:#fff9e6">
                            <td>${fecha}</td>
                            <td>-</td>
                            <td><span class="badge badge-comercio">${h.comercio}</span></td>
                            <td>-</td>
                            <td>
                                <div style="margin-top:5px;">
                                    <button class="btn-accion btn-wa" onclick="abrirWA('${cel}','${nombre}','${h.premio}')">üí¨ WA</button>
                                    <button class="btn-accion btn-mail" onclick="enviarMail(this,'${email}','${nombre}','${h.premio}','${h.comercio}','${h.mailComercio || ''}')">üìß Mail</button>
                                </div>
                            </td>
                            <td>
                                <button class="btn-accion btn-copy" onclick="navigator.clipboard.writeText('${nombre} | ${email}')">üìã Copiar</button>
                            </td>
                        </tr>`;
                    });
                });
            });
            mostrarToast("üìú Historial cargado", "success");
        };

        function mostrarToast(mensaje, tipo = "success") {
            const div = document.createElement('div'); 
            div.className = `toast ${tipo}`;
            div.innerText = mensaje; 
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // Asignar botones de controles
        document.getElementById('btn-activos').onclick = cargarActivos;
        document.getElementById('btn-historial').onclick = window.mostrarHistorial;
        document.getElementById('btn-prueba').onclick = () => mostrarToast("üß™ Modo prueba listo", "warning");

        // Carga inicial
        document.addEventListener('DOMContentLoaded', () => {
            cargarActivos();
        });

        // Exponer funciones globalmente
        window.abrirWA = abrirWA;
        window.enviarMail = enviarMail;
        window.mostrarHistorial = mostrarHistorial;
        window.mostrarToast = mostrarToast;
        window.mostrarConfirmacionSorteo = mostrarConfirmacionSorteo;
        window.cerrarModalSorteo = cerrarModalSorteo;
        window.irAlHistorial = irAlHistorial;
    </script>
</body>
</html>

