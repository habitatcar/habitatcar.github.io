<html lang="es"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Sorteos Elite | H√°bitat-Car</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--azul-habitat: #003d80;
--rojo-cupon: #e60000;
--naranja: #ff8c00;
--celeste: #0288d1;
--verde: #2e7d32;
--blanco: #ffffff;
--gris-texto: #666666;
--oro: #d4af37;
--zona-critica: #dc3545;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; padding-top: 140px; }
.faja-superior { position: fixed; top: 0; left: 0; width: 100%; background: var(--azul-habitat); border-bottom: 4px solid var(--naranja); z-index: 1000; padding: 10px 0; }
.faja-superior .container { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
.logo-container img { height: 60px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
.nav-links { display: flex; gap: 20px; }
.nav-links button { background: none; border: none; color: white; font-weight: 600; cursor: pointer; padding: 10px 15px; border-radius: 5px; transition: 0.3s; font-size: 14px; text-transform: uppercase; }
.nav-links button:hover { background: rgba(255,255,255,0.1); }
.nav-links button.active { background: var(--naranja); color: white; }
.faja-admin { position: fixed; top: 84px; left: 0; width: 100%; background: white; border-bottom: 1px solid #ddd; z-index: 999; padding: 10px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.faja-admin .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
.admin-info { display: flex; align-items: center; gap: 15px; }
.admin-avatar { width: 35px; height: 35px; background: var(--azul-habitat); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
.container-principal { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
.card { background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 25px; margin-bottom: 25px; border: 1px solid #eee; position: relative; }
.card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
.comercio-badge { background: #e3f2fd; color: var(--azul-habitat); padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
.tabla-sorteos { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
.tabla-sorteos th { background: #f1f3f5; padding: 15px; text-align: left; color: var(--azul-habitat); font-weight: 700; border-bottom: 2px solid #dee2e6; }
.tabla-sorteos td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
.btn-sortear { background: var(--verde); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; display: flex; align-items: center; gap: 8px; text-decoration: none; }
.btn-sortear:hover { background: #246328; transform: translateY(-1px); }
.btn-sortear:disabled { background: #ccc; cursor: not-allowed; }
.btn-accion { width: 32px; height: 32px; border-radius: 6px; border: none; cursor: pointer; transition: 0.2s; color: white; display: inline-flex; align-items: center; justify-content: center; margin-right: 5px; }
.btn-mail { background: var(--celeste); }
.btn-wa { background: #25D366; }
.btn-delete { background: var(--zona-critica); }
.btn-accion:hover { transform: scale(1.1); filter: brightness(1.1); }
.reloj-container { background: #fff3e0; padding: 5px 10px; border-radius: 4px; border-left: 3px solid var(--naranja); font-family: monospace; font-weight: bold; color: #e65100; font-size: 15px; }
.toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; font-weight: 600; z-index: 3000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease; }
.toast.success { background: var(--verde); }
.toast.error { background: var(--zona-critica); }
.toast.warning { background: var(--naranja); }
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.loading { text-align: center; padding: 50px; font-size: 1.2rem; color: var(--gris-texto); }
</style>
</head>
<body>

<div class="faja-superior">
    <div class="container">
        <div class="logo-container"><img src="https://i.ibb.co/m5fdvTr/HABITAT-CAR-SF.png" alt="Logo"></div>
        <div class="nav-links">
            <button id="btn-activos" class="active"><i class="fas fa-bolt"></i> Activos</button>
            <button id="btn-historial"><i class="fas fa-history"></i> Historial</button>
        </div>
    </div>
</div>

<div class="faja-admin">
    <div class="container">
        <div class="admin-info">
            <div class="admin-avatar">H</div>
            <div><strong>Administraci√≥n</strong><br><small id="status-fb">Conectado a Firebase</small></div>
        </div>
    </div>
</div>

<div class="container-principal" id="main-content">
    <div id="sorteos-activos"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyC...", // PEGA TUS DATOS REALES AQU√ç
    authDomain: "tu-app.firebaseapp.com",
    projectId: "tu-app",
    storageBucket: "tu-app.appspot.com",
    messagingSenderId: "...",
    appId: "..."
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const URL_SCRIPT_BREVO = "TU_NUEVA_URL_DE_GOOGLE_SCRIPT"; // <--- PEGA AQU√ç LA URL DE TU IMPLEMENTACI√ìN

// --- FUNCI√ìN ENVIAR MAIL (BREVO) ---
window.enviarMail = async (btn, email, nombre, premio, comercio, mailCC) => {
    if (!email || email === 'undefined') return mostrarToast("Email inv√°lido", "error");
    const originalText = btn.innerHTML;
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    const asuntoT = localStorage.getItem('hc_asunto') || "üèÜ ¬°Felicidades {{NOMBRE}}!";
    const cuerpoT = localStorage.getItem('hc_cuerpo') || "Hola {{NOMBRE}}, ganaste {{PREMIO}} en {{COMERCIO}}.";

    const inyectar = (t) => t.split('{{NOMBRE}}').join(nombre).split('{{PREMIO}}').join(premio).split('{{COMERCIO}}').join(comercio);

    try {
        await fetch(URL_SCRIPT_BREVO, {
            method: 'POST',
            body: JSON.stringify({
                email: email.trim(),
                asunto: inyectar(asuntoT),
                cuerpoHtml: inyectar(cuerpoT).replace(/\n/g, '<br>'),
                cc: `habitatcar@gmail.com, ${mailCC || ''}`
            })
        });
        mostrarToast(`‚úÖ Enviado a ${nombre}`);
    } catch (e) {
        mostrarToast("Error de env√≠o", "error");
    } finally {
        btn.disabled = false; btn.innerHTML = originalText;
    }
};

// --- CARGAR SORTEOS ACTIVOS ---
window.cargarActivos = async () => {
    document.getElementById('btn-activos').classList.add('active');
    document.getElementById('btn-historial').classList.remove('active');
    const cont = document.getElementById('sorteos-activos');
    cont.innerHTML = '<div class="loading">Cargando sorteos...</div>';

    const snap = await getDocs(collection(db, "comercios"));
    let html = '';
    
    snap.forEach(docCom => {
        const c = docCom.data();
        if (c.titulo_sorteo) {
            html += `
            <div class="card">
                <div class="card-header">
                    <div>
                        <span class="comercio-badge">${c.nombre_comercio}</span>
                        <h3 style="margin-top:10px">${c.titulo_sorteo}</h3>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <div><i class="fas fa-gift"></i> ${c.premio_sorteo}</div>
                    <button class="btn-sortear" onclick="ejecutarSorteo('${docCom.id}')">
                        <i class="fas fa-trophy"></i> SORTEAR AHORA
                    </button>
                </div>
            </div>`;
        }
    });
    cont.innerHTML = html || '<p>No hay sorteos activos.</p>';
};

// --- HISTORIAL (CORREGIDO: Carga garantizada y borrado individual) ---
window.mostrarHistorial = async () => {
    document.getElementById('btn-activos').classList.remove('active');
    document.getElementById('btn-historial').classList.add('active');
    const cont = document.getElementById('sorteos-activos');
    cont.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Cargando historial...</div>';

    try {
        const snap = await getDocs(collection(db, "comercios"));
        let html = `
            <table class="tabla-sorteos">
                <thead>
                    <tr><th>Fecha</th><th>Comercio</th><th>Premio</th><th>Ganador</th><th>Acciones</th></tr>
                </thead>
                <tbody>`;

        let total = 0;
        snap.forEach(docCom => {
            const c = docCom.data();
            const idC = docCom.id;
            if (c.historial_sorteos && Array.isArray(c.historial_sorteos)) {
                c.historial_sorteos.forEach((sorteo, idxS) => {
                    if (sorteo.ganadores && Array.isArray(sorteo.ganadores)) {
                        sorteo.ganadores.forEach((gan, idxG) => {
                            total++;
                            const n = gan.nombre || gan.nombre_completo || "S/N";
                            const e = gan.email || gan.email_usuario || "";
                            html += `
                            <tr>
                                <td>${sorteo.fecha || '---'}</td>
                                <td>${sorteo.comercio || c.nombre_comercio}</td>
                                <td>${sorteo.premio || '---'}</td>
                                <td>${n}<br><small>${e}</small></td>
                                <td>
                                    <button class="btn-accion btn-mail" onclick="enviarMail(this, '${e}', '${n}', '${sorteo.premio}', '${sorteo.comercio}', '${c.mail_comercio}')"><i class="fas fa-envelope"></i></button>
                                    <button class="btn-accion btn-delete" onclick="eliminarGanadorIndiv('${idC}', ${idxS}, ${idxG})"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>`;
                        });
                    }
                });
            }
        });

        cont.innerHTML = total > 0 ? html + '</tbody></table>' : '<p style="text-align:center;padding:40px">El historial est√° vac√≠o.</p>';
    } catch (err) {
        cont.innerHTML = '<p>Error al cargar historial.</p>';
    }
};

// --- BORRAR SOLO UN GANADOR DEL GRUPO ---
window.eliminarGanadorIndiv = async (idCom, iS, iG) => {
    if (!confirm("¬øEliminar solo a este ganador?")) return;
    try {
        const ref = doc(db, "comercios", idCom);
        const snap = await getDoc(ref);
        let d = snap.data();
        d.historial_sorteos[iS].ganadores.splice(iG, 1);
        if (d.historial_sorteos[iS].ganadores.length === 0) d.historial_sorteos.splice(iS, 1);
        await updateDoc(ref, { historial_sorteos: d.historial_sorteos });
        mostrarToast("Ganador eliminado");
        window.mostrarHistorial();
    } catch (e) { mostrarToast("Error", "error"); }
};

window.mostrarToast = (mensaje, tipo="success") => {
    const div = document.createElement('div');
    div.className = `toast ${tipo}`;
    div.innerText = mensaje;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
};

document.getElementById('btn-activos').onclick = cargarActivos;
document.getElementById('btn-historial').onclick = window.mostrarHistorial;
window.onload = cargarActivos;
</script>
</body></html>
