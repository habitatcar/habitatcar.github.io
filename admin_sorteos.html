<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Sorteos Elite | H√°bitat-Car</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--azul-habitat: #003d80;
--rojo-cupon: #e60000;
--naranja: #ff8c00;
--celeste: #0288d1;
--verde: #2e7d32;
--blanco: #ffffff;
--gris-texto: #666666;
--oro: #d4af37;
--zona-critica: #dc3545;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; padding-top: 140px; }
.faja-superior { position: fixed; top: 0; left: 0; width: 100%; background: var(--azul-habitat); border-bottom: 4px solid var(--rojo-cupon); z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.faja-contenido { max-width: 1200px; margin: 0 auto; padding: 10px 20px; display: flex; flex-direction: column; gap: 10px; }
.faja-logo { text-align: center; padding: 5px 0; }
.faja-logo img { height: 50px; width: auto; max-width: 200px; }
.faja-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; padding: 5px 0; }
.faja-nav a { padding: 6px 10px; border-radius: 4px; text-decoration: none; color: white; font-weight: 600; font-size: 11px; background: rgba(255,255,255,0.15); transition: all 0.2s; text-transform: uppercase; }
.faja-nav a:hover, .faja-nav a.active { background: var(--rojo-cupon); transform: translateY(-1px); }
.faja-nav a.active { box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
header h1 { font-size: 1.8rem; margin-bottom: 8px; }
header p { opacity: 0.9; font-size: 0.95rem; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
.btn-primary { background: #667eea; color: white; }
.btn-primary:hover { background: #5568d3; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.btn-warning { background: #ffc107; color: #333; }
.btn-warning:hover { background: #e0a800; }
.btn-info { background: #17a2b8; color: white; }
.btn-dark { background: #343a40; color: white; }
.btn-danger { background: #dc3545; color: white; }
.btn-danger:hover { background: #c82333; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }
.btn-sm { padding: 4px 8px; font-size: 0.8rem; }
.btn-icon { padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
.table-container { overflow-x: auto; max-height: calc(100vh - 280px); }
table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: opacity 0.3s ease; }
thead { position: sticky; top: 0; z-index: 100; background: #667eea; }
th { background: #667eea; color: white; padding: 14px 12px; text-align: left; white-space: nowrap; }
td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
.btn-accion { padding: 6px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; color: white; display: inline-flex; align-items: center; gap: 4px; }
.btn-wa { background: #25D366; }
.btn-copy { background: #6c757d; }
.btn-delete { background: #dc3545; }
.btn-delete:hover { background: #c82333; }
.badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.badge-premio { background: #fff3cd; color: #856404; }
.badge-comercio { background: #d1ecf1; color: #0c5460; }
.badge-premios { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-vip { background: #fff8e1; color: #f57f17; font-weight: bold; }
.badge-lead { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-critica { background: #ffebee; color: #c62828; font-weight: bold; animation: pulse 2s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.4); } 70% { box-shadow: 0 0 0 10px rgba(220,53,69,0); } 100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); } }
.toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 10px; color: white; z-index: 9999; animation: slideIn 0.3s ease; }
.success { background: #28a745; } .error { background: #dc3545; } .warning { background: #ffc107; color: #333; }
@keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
.participantes-cell { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; }
.participantes-row { display: flex; justify-content: space-between; align-items: center; }
.participantes-value { font-weight: bold; padding: 2px 8px; border-radius: 4px; min-width: 30px; text-align: center; }
.valor-lead { background: #e3f2fd; color: #1976d2; }
.valor-vip { background: #fff8e1; color: #f57f17; }
.valor-total { background: #e8f5e9; color: #388e3c; }
.premio-desc { font-size: 0.85rem; color: #666; margin-top: 4px; line-height: 1.4; max-width: 200px; }
.fecha-cell { display: flex; flex-direction: column; gap: 2px; font-size: 0.85rem; min-width: 100px; }
.fecha-principal { font-weight: bold; color: #333; }
.hora-secundaria { color: #666; font-size: 0.8rem; }
.timestamp-badge { font-size: 0.75rem; color: #666; background: #f1f1f1; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }
.logo-mini { height: 80px; width: auto; max-width: 120px; object-fit: contain; display: block; margin: 0 auto; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
.modal-content { background: white; padding: 25px; border-radius: 16px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.checkbox-cell { text-align: center; width: 50px; }
.checkbox-cell input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.bulk-actions { display: none; gap: 10px; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107; }
.bulk-actions.active { display: flex; align-items: center; }
.selected-count { font-weight: bold; color: #856404; }

/* Editor PDF sliders */
.slider-group { margin-bottom: 10px; }
.slider-group > .sg-label { font-size: 11px; font-weight: bold; color: #444; display: block; margin-bottom: 3px; }
.slider-row { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
.slider-row > .lbl { font-size: 11px; color: #666; width: 20px; }
.slider-row > .val { font-size: 11px; color: #888; width: 30px; text-align: right; }
.slider-row input[type="range"] { flex: 1; }
.txt-field { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
.pdf-section { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #eee; }
.pdf-section h4 { font-size: 12px; color: #333; margin-bottom: 8px; }
.inyectado-tag { font-size: 9px; color: #888; font-weight: normal; }

/* Previsualizaci√≥n */
#previa_ticket {
    width: 280px; height: 560px;
    background: #ddd; border-radius: 15px;
    border: 5px solid #222;
    position: relative; overflow: hidden;
    background-size: 100% 100%; background-position: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
#prev_l1, #prev_l2 {
    position: absolute; width: 50px; height: 50px;
    border: 1px dashed #666; background: rgba(255,255,255,0.5);
    font-size: 9px; text-align: center;
    display: flex; align-items: center; justify-content: center;
    pointer-events: none;
}
#prev_t1, #prev_t2, #prev_t3, #prev_t4 {
    position: absolute;
    text-align: center;
    font-weight: bold;
    transform: translateX(-50%);
    pointer-events: none;
    width: 90%;
    left: 50%;
    word-wrap: break-word;
}
#prev_t1 { color: #000; }
#prev_t2 { color: #000; }
#prev_t3 { color: #666; }
#prev_t4 { color: #666; font-weight: normal; font-size: 11px; }

@media (max-width: 768px) {
.faja-nav { gap: 3px; }
.faja-nav a { font-size: 9px; padding: 4px 6px; }
body { padding-top: 120px; }
.logo-mini { height: 70px; }
}
</style>
</head>
<body>
<div class="faja-superior">
<div class="faja-contenido">
<div class="faja-logo"><a href="index.html"><img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="H√°bitat-Car"></a></div>
<nav class="faja-nav">
<a href="admin_comercios.html">COMERCIOS</a><a href="admin_leads.html">LEADS</a><a href="admin_vips.html">VIPS</a>
<a href="admin_tokens_vip.html">TOKENS VIP</a><a href="admin_curioso.html">CURIOSO</a><a href="admin_estadisticas.html">ESTAD√çSTICAS</a>
<a href="admin_logs.html">LOG</a><a href="admin_tutoriales.html">TUTORIALES</a><a href="index.html">PANEL</a>
<a href="admin_legales.html">LEGALES</a><a href="admin_sorteos.html" class="active">SORTEOS</a>
</nav>
</div>
</div>
<div class="container">
<header><h1>üèÜ SORTEOS PREMIUM</h1><p>Panel de Sorteos Elite | H√°bitat-Car</p></header>
<div class="controls">
<button class="btn btn-success" id="btn-activos">SORTEOS ACTIVOS</button>
<button class="btn btn-warning" id="btn-historial">HISTORIAL DE √âXITOS</button>
<button class="btn btn-info" onclick="abrirEditorPDF()" style="background:var(--azul-habitat);"><i class="fas fa-file-pdf"></i> TICKET PDF</button>
<button class="btn btn-info" onclick="abrirEditorWA()" style="background:#25D366;"><i class="fab fa-whatsapp"></i> MENSAJE WA</button>
</div>
<div id="bulk-actions" class="bulk-actions">
<span class="selected-count"><i class="fas fa-check-circle"></i> <span id="selected-count">0</span> seleccionado(s)</span>
<button class="btn btn-danger" onclick="eliminarSeleccionados()"><i class="fas fa-trash"></i> ELIMINAR SELECCIONADOS</button>
<button class="btn btn-warning" onclick="desmarcarTodos()"><i class="fas fa-times"></i> CANCELAR</button>
</div>
<div class="table-container">
<table>
<thead>
<tr id="tabla-headers">
<th class="checkbox-cell" id="header-checkbox" style="display:none;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
<th>FECHA</th>
<th>LOGO</th>
<th>COMERCIO / PREMIO</th>
<th>PARTICIPANTES</th>
<th>ACCIONES</th>
<th>PREMIOS</th>
</tr>
</thead>
<tbody id="tabla-sorteos"></tbody>
</table>
</div>
</div>

<!-- MODAL CONFIRMACI√ìN SORTEO -->
<div id="popup-confirmacion" class="modal" style="display:none;">
<div class="modal-content">
<h3 style="color:var(--azul-habitat); margin-bottom:15px;">üéâ ¬°SORTEO REALIZADO!</h3>
<p id="texto-sorteo" style="font-size:1.1rem; margin-bottom:20px; line-height:1.5;"></p>
<div id="lista-ganadores-popup" style="text-align:left; margin-bottom:20px;"></div>
<button class="btn btn-primary" onclick="irAlHistorial()">IR AL HISTORIAL DE √âXITOS</button>
<button class="btn btn-warning" onclick="cerrarModalSorteo()" style="margin-top:10px;">SEGUIR AQU√ç</button>
</div>
</div>

<!-- MODAL EDITOR PDF -->
<div id="modalPDF" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; overflow-y:auto; padding:20px;">
<div style="display:flex; flex-wrap:wrap; justify-content:center; gap:20px; max-width:1200px; margin:auto;">
<div style="background:white; padding:20px; border-radius:15px; width:380px; color:#333; max-height:90vh; overflow-y:auto;">
<h3 style="color:var(--azul-habitat); margin-bottom:10px;">üé® Dise√±o del Ticket</h3><hr><br>

<label>Imagen de Fondo (URL):</label>
<input type="text" id="cfg_bg" class="txt-field" oninput="actualizarPrevia()" placeholder="https://...">

<div class="pdf-section">
<h4>üè™ Logo Comercio <span class="inyectado-tag">auto</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_l1x" min="0" max="60" value="5" oninput="actualizarPrevia()"><span class="val" id="v_l1x">5</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_l1y" min="0" max="140" value="5" oninput="actualizarPrevia()"><span class="val" id="v_l1y">5</span></div>
<div class="slider-row"><span class="lbl">üìê</span><input type="range" id="cfg_l1s" min="8" max="50" value="20" oninput="actualizarPrevia()"><span class="val" id="v_l1s">20</span></div>
</div>

<div class="pdf-section">
<h4>üè¢ Logo H√°bitat-Car <span class="inyectado-tag">auto</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_l2x" min="0" max="60" value="55" oninput="actualizarPrevia()"><span class="val" id="v_l2x">55</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_l2y" min="0" max="140" value="5" oninput="actualizarPrevia()"><span class="val" id="v_l2y">5</span></div>
<div class="slider-row"><span class="lbl">üìê</span><input type="range" id="cfg_l2s" min="8" max="50" value="20" oninput="actualizarPrevia()"><span class="val" id="v_l2s">20</span></div>
</div>

<div class="pdf-section">
<h4>‚úèÔ∏è Nombre del Ganador <span class="inyectado-tag">inyectado</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t1x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t1x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t1y" min="20" max="155" value="90" oninput="actualizarPrevia()"><span class="val" id="v_t1y">90</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t1s" min="8" max="32" value="22" oninput="actualizarPrevia()"><span class="val" id="v_t1s">22</span></div>
</div>

<div class="pdf-section">
<h4>‚úèÔ∏è Premio <span class="inyectado-tag">inyectado</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t2x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t2x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t2y" min="20" max="155" value="110" oninput="actualizarPrevia()"><span class="val" id="v_t2y">110</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t2s" min="6" max="28" value="16" oninput="actualizarPrevia()"><span class="val" id="v_t2s">16</span></div>
</div>

<!-- ‚úÖ CORRECCI√ìN 1: CAMPO DESCRIPCI√ìN DEL PREMIO AGREGADO -->
<div class="pdf-section">
<h4>üìù Descripci√≥n del Premio <span class="inyectado-tag">inyectado</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t4x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t4x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t4y" min="20" max="155" value="120" oninput="actualizarPrevia()"><span class="val" id="v_t4y">120</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t4s" min="6" max="28" value="11" oninput="actualizarPrevia()"><span class="val" id="v_t4s">11</span></div>
</div>

<div class="pdf-section">
<h4>‚úèÔ∏è Comercio <span class="inyectado-tag">inyectado</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t3x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t3x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t3y" min="20" max="155" value="124" oninput="actualizarPrevia()"><span class="val" id="v_t3y">124</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t3s" min="6" max="28" value="14" oninput="actualizarPrevia()"><span class="val" id="v_t3s">14</span></div>
</div>

<div class="pdf-section">
<h4>‚úèÔ∏è Pie de p√°gina <span style="font-size:9px; color:#888;">(editable)</span></h4>
<input type="text" id="cfg_t5txt" class="txt-field" oninput="actualizarPrevia()" value="H√°bitat-Car">
</div>

<button onclick="guardarConfigPDF()" style="width:100%; background:var(--verde); color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">üíæ GUARDAR DISE√ëO</button>
<button onclick="cerrarModales()" style="width:100%; background:none; border:none; color:#dc3545; margin-top:6px; cursor:pointer; padding:8px; font-size:13px;">‚úï Cerrar</button>
</div>

<!-- Previsualizaci√≥n -->
<div id="previa_ticket">
<div id="prev_l1">Logo 1</div>
<div id="prev_l2">Logo 2</div>
<div id="prev_t1">NOMBRE GANADOR</div>
<div id="prev_t2">PREMIO</div>
<div id="prev_t4">Descripci√≥n del premio</div>
<div id="prev_t3">COMERCIO</div>
</div>
</div>
</div>

<!-- MODAL EDITOR WHATSAPP -->
<div id="modalWA" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center;">
<div style="background:white; padding:25px; border-radius:15px; width:90%; max-width:440px; color:#333;">
<h3 style="color:#25D366; margin-bottom:8px;"><i class="fab fa-whatsapp"></i> Mensaje de WhatsApp</h3>
<p style="font-size:12px; margin-bottom:10px;">Configur√° el saludo autom√°tico:</p>
<textarea id="cfg_wa_msg" style="width:100%; height:170px; padding:10px; font-family:sans-serif; border:1px solid #ccc; border-radius:6px; font-size:12px; resize:vertical; line-height:1.5;"></textarea>
<div style="font-size:11px; color:#666; margin:8px 0 12px; background:#f8f9fa; padding:8px; border-radius:5px; line-height:1.7;">
Variables: <b>{{NOMBRE}}</b>, <b>{{PREMIO}}</b>, <b>{{COMERCIO}}</b>, <b style="color:#e60000;">{{DESCRIPCION}}</b>
</div>
<button onclick="guardarConfigWA()" style="width:100%; background:#25D366; color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">üíæ GUARDAR MENSAJE</button>
<button onclick="cerrarModales()" style="width:100%; background:none; border:none; color:#dc3545; margin-top:6px; cursor:pointer; padding:8px; font-size:13px;">‚úï Cerrar</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, where, addDoc, serverTimestamp, getDocs, doc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const CLAVE_MAESTRA = "HABITAT_MASTER_2026";
const LOGO_DEFAULT = "https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true";
const LOGO_HABITAT = "https://i.ibb.co/m5fdvTr/HABITAT-CAR-SF.png";

const firebaseConfig = { 
    apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM", 
    authDomain: "habitatcar-pro.firebaseapp.com", 
    projectId: "habitatcar-pro", 
    storageBucket: "habitatcar-pro.firebasestorage.app", 
    messagingSenderId: "311691258694", 
    appId: "1:311691258694:web:17a09051dcea7707af9347" 
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Configuraci√≥n default
const WA_DEFAULT = `üéâ ¬°Hola {{NOMBRE}}! Ganaste el sorteo {{PREMIO}}

üéÅ ***consistente en {{DESCRIPCION}}***

üè™ ***realizado por*** {{COMERCIO}}

üìé Adjunto tu ticket.

‚è∞ Presentate antes de los 30 d√≠as para reclamar tu premio.

‚ö†Ô∏è Si dejas pasar los 30 d√≠as, perd√©s el premio.

üö® ¬°NO TE DUERMAS! üö®`;

const leerMsgWA = () => localStorage.getItem('hc_wa_v3') || WA_DEFAULT;
const leerCfgPDF = () => { try { return JSON.parse(localStorage.getItem('hc_pdf_v3')) || {}; } catch(e) { return {}; } };

// EDITOR PDF
window.abrirEditorPDF = () => {
    const p = leerCfgPDF();
    const sv = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
    const su = (id, val, vid) => { sv(id, val); const v = document.getElementById(vid); if(v) v.textContent = val; };
    
    sv('cfg_bg', p.bg ?? '');
    su('cfg_l1x', p.l1x ?? 5, 'v_l1x'); su('cfg_l1y', p.l1y ?? 5, 'v_l1y'); su('cfg_l1s', p.l1s ?? 20, 'v_l1s');
    su('cfg_l2x', p.l2x ?? 55, 'v_l2x'); su('cfg_l2y', p.l2y ?? 5, 'v_l2y'); su('cfg_l2s', p.l2s ?? 20, 'v_l2s');
    su('cfg_t1x', p.t1x ?? 40, 'v_t1x'); su('cfg_t1y', p.t1y ?? 90, 'v_t1y'); su('cfg_t1s', p.t1s ?? 22, 'v_t1s');
    su('cfg_t2x', p.t2x ?? 40, 'v_t2x'); su('cfg_t2y', p.t2y ?? 110, 'v_t2y'); su('cfg_t2s', p.t2s ?? 16, 'v_t2s');
    // ‚úÖ CORRECCI√ìN 1: Descripci√≥n del premio
    su('cfg_t4x', p.t4x ?? 40, 'v_t4x'); su('cfg_t4y', p.t4y ?? 120, 'v_t4y'); su('cfg_t4s', p.t4s ?? 11, 'v_t4s');
    su('cfg_t3x', p.t3x ?? 40, 'v_t3x'); su('cfg_t3y', p.t3y ?? 124, 'v_t3y'); su('cfg_t3s', p.t3s ?? 14, 'v_t3s');
    sv('cfg_t5txt', p.t5txt ?? 'H√°bitat-Car');
    
    document.getElementById('modalPDF').style.display = 'flex';
    actualizarPrevia();
};

// EDITOR WHATSAPP
window.abrirEditorWA = () => {
    document.getElementById('cfg_wa_msg').value = leerMsgWA();
    document.getElementById('modalWA').style.display = 'flex';
};

// Actualizar previsualizaci√≥n
window.actualizarPrevia = () => {
    const bg = document.getElementById('cfg_bg').value;
    const p = document.getElementById('previa_ticket');
    if(bg) { p.style.backgroundImage = `url(${bg})`; } else { p.style.backgroundImage = 'none'; p.style.background = '#ddd'; }
    
    const movEl = (pid, xid, yid, sid, vxid, vyid, vsid, isLogo) => {
        const el = document.getElementById(pid);
        const x = document.getElementById(xid).value;
        const y = document.getElementById(yid).value;
        const s = document.getElementById(sid).value;
        const f = isLogo ? 3.5 : 1;
        if(el) {
            el.style.left = (x * f) + (isLogo ? 'px' : '%');
            el.style.top = y + 'px';
            if(isLogo) { el.style.width = (s * f) + 'px'; el.style.height = (s * f) + 'px'; }
            else { el.style.fontSize = s + 'px'; }
        }
        const vx = document.getElementById(vxid), vy = document.getElementById(vyid), vs = document.getElementById(vsid);
        if(vx) vx.textContent = x; if(vy) vy.textContent = y; if(vs) vs.textContent = s;
    };
    
    movEl('prev_l1','cfg_l1x','cfg_l1y','cfg_l1s','v_l1x','v_l1y','v_l1s', true);
    movEl('prev_l2','cfg_l2x','cfg_l2y','cfg_l2s','v_l2x','v_l2y','v_l2s', true);
    movEl('prev_t1','cfg_t1x','cfg_t1y','cfg_t1s','v_t1x','v_t1y','v_t1s', false);
    movEl('prev_t2','cfg_t2x','cfg_t2y','cfg_t2s','v_t2x','v_t2y','v_t2s', false);
    // ‚úÖ CORRECCI√ìN 1: Mover descripci√≥n en previa
    movEl('prev_t4','cfg_t4x','cfg_t4y','cfg_t4s','v_t4x','v_t4y','v_t4s', false);
    movEl('prev_t3','cfg_t3x','cfg_t3y','cfg_t3s','v_t3x','v_t3y','v_t3s', false);
    
    const t5el = document.getElementById('prev_t5');
    if(t5el) t5el.textContent = document.getElementById('cfg_t5txt').value || 'H√°bitat-Car';
};

// Guardar configuraci√≥n PDF
window.guardarConfigPDF = () => {
    const gv = id => { const el = document.getElementById(id); return el ? el.value : ''; };
    const gi = id => parseInt(gv(id)) || 0;
    const data = {
        bg: gv('cfg_bg'),
        l1x:gi('cfg_l1x'), l1y:gi('cfg_l1y'), l1s:gi('cfg_l1s'),
        l2x:gi('cfg_l2x'), l2y:gi('cfg_l2y'), l2s:gi('cfg_l2s'),
        t1x:gi('cfg_t1x'), t1y:gi('cfg_t1y'), t1s:gi('cfg_t1s'),
        t2x:gi('cfg_t2x'), t2y:gi('cfg_t2y'), t2s:gi('cfg_t2s'),
        // ‚úÖ CORRECCI√ìN 1: Guardar descripci√≥n
        t4x:gi('cfg_t4x'), t4y:gi('cfg_t4y'), t4s:gi('cfg_t4s'),
        t3x:gi('cfg_t3x'), t3y:gi('cfg_t3y'), t3s:gi('cfg_t3s'),
        t5txt:gv('cfg_t5txt')
    };
    localStorage.setItem('hc_pdf_v3', JSON.stringify(data));
    mostrarToast("‚úÖ Dise√±o de Ticket guardado", "success");
    cerrarModales();
};

// Guardar configuraci√≥n WhatsApp
window.guardarConfigWA = () => {
    localStorage.setItem('hc_wa_v3', document.getElementById('cfg_wa_msg').value);
    mostrarToast("‚úÖ Mensaje de WhatsApp guardado", "success");
    cerrarModales();
};

window.cerrarModales = () => {
    document.getElementById('modalPDF').style.display = 'none';
    document.getElementById('modalWA').style.display = 'none';
};

// ‚úÖ CORRECCI√ìN 2: FUNCI√ìN PARA ENVIAR TICKET CON WORD WRAP
window.clickEnviarTicket = async (btn) => {
    const nombre = btn.dataset.nombre;
    const premio = btn.dataset.premio;
    const comercio = btn.dataset.comercio;
    const descripcion = btn.dataset.descripcion || '';
    const telefono = btn.dataset.cel;
    const logoComercio = btn.dataset.logo;
    
    const p = leerCfgPDF();
    const mensajeWA = leerMsgWA()
        .replace(/\{\{NOMBRE\}\}/g, nombre || 'Ganador')
        .replace(/\{\{PREMIO\}\}/g, premio || 'el premio')
        .replace(/\{\{COMERCIO\}\}/g, comercio || 'el comercio')
        .replace(/\{\{DESCRIPCION\}\}/g, descripcion || premio || 'el premio');
    
    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF({ unit: "mm", format: [80, 160] });
    
    const loadImg = url => new Promise(res => {
        if (!url) return res(null);
        const img = new Image(); img.crossOrigin = "Anonymous";
        img.onload = () => res(img); img.onerror = () => res(null);
        img.src = url;
    });
    
    if (p.bg) { const bi = await loadImg(p.bg); if (bi) docPDF.addImage(bi,'JPEG',0,0,80,160); }
    
    const ls = p.l1s||20;
    if(logoComercio) { const i1 = await loadImg(logoComercio); if(i1) docPDF.addImage(i1,'PNG',p.l1x||5,p.l1y||5,ls,ls); }
    const i2 = await loadImg(LOGO_HABITAT); if(i2) docPDF.addImage(i2,'PNG',p.l2x||55,p.l2y||5,p.l2s||20,p.l2s||20);
    
    docPDF.setTextColor(0,0,0);
    
    // T√≠tulo
    docPDF.setFont("helvetica","bold"); docPDF.setFontSize(14);
    docPDF.text('¬°Felicitaciones!', 40, 60, {align:"center"});
    
    // ‚úÖ CORRECCI√ìN 2: Nombre con word wrap para nombres largos
    docPDF.setFont("helvetica","bold"); docPDF.setFontSize(p.t1s||22);
    const nombreLines = docPDF.splitTextToSize((nombre||"Ganador").toUpperCase(), 70);
    docPDF.text(nombreLines, p.t1x||40, p.t1y||90, {align:"center"});
    
    // Premio
    docPDF.setFont("helvetica","normal"); docPDF.setFontSize(p.t2s||16);
    const premioLines = docPDF.splitTextToSize(premio||"Premio", 70);
    docPDF.text(premioLines, p.t2x||40, p.t2y||110, {align:"center"});
    
    // ‚úÖ CORRECCI√ìN 1: Descripci√≥n del premio con word wrap
    if(descripcion) {
        docPDF.setFont("helvetica","normal"); docPDF.setFontSize(p.t4s||11);
        const descLines = docPDF.splitTextToSize(descripcion, 70);
        docPDF.text(descLines, p.t4x||40, p.t4y||120, {align:"center"});
    }
    
    // Comercio
    docPDF.setFont("helvetica","normal"); docPDF.setFontSize(p.t3s||14);
    const comercioLines = docPDF.splitTextToSize(comercio||"Comercio", 70);
    docPDF.text(comercioLines, p.t3x||40, p.t3y||124, {align:"center"});
    
    // Footer
    docPDF.setFont("helvetica","normal"); docPDF.setFontSize(8);
    docPDF.text(`${p.t5txt||'H√°bitat-Car'} ‚Ä¢ ${new Date().toLocaleDateString()}`, 40, 154, {align:"center"});
    
    docPDF.save(`Ticket_${(nombre||'Ganador').replace(/\s+/g,'_')}.pdf`);
    
    if (telefono) {
        const num = normalizarTelefonoAR(telefono);
        if (num) {
            setTimeout(() => {
                window.open(`https://wa.me/${num}?text=${encodeURIComponent(mensajeWA)}`, '_blank');
            }, 1200);
        }
    }
    
    mostrarToast("‚úÖ Ticket generado", "success");
};

// Utilidades
function normalizarTelefonoAR(numero) { 
    if (!numero) return null; 
    let num = numero.toString().replace(/\D/g, ''); 
    if (num.length === 10) return '549' + num; 
    if (num.startsWith('54') && !num.startsWith('549')) return '549' + num.substring(2); 
    return num.startsWith('549') ? num : '549' + num; 
}

function mostrarToast(msg, tipo="success") {
    const d = document.createElement('div');
    d.className = `toast ${tipo}`;
    d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 3500);
}

function formatearFechaHora(fechaISO) {
    if(!fechaISO) return null;
    try {
        const [fp,hp] = fechaISO.split('T');
        const [a,m,d] = fp.split('-');
        const [h,min] = hp.split(':');
        return { fecha: `${d}/${m}/${a}`, hora: `${h}:${min} Hs.` };
    } catch(e) { return null; }
}

function esc(s) { return (s||'').toString().replace(/'/g,"\\'").replace(/"/g,"&quot;"); }

// Validaci√≥n de seguridad
window.validarAccionSegura = async (idComercio, claveIngresada) => {
    if (claveIngresada === CLAVE_MAESTRA) return true;
    try {
        const comercioRef = doc(db, "comercios", idComercio);
        const snap = await getDoc(comercioRef);
        if (snap.exists()) {
            const datosComercio = snap.data();
            const claveReal = datosComercio.password;
            if (claveIngresada === claveReal) return true;
        }
    } catch (error) { console.error("Error al validar clave:", error); }
    return false;
};

// Intentar sorteo
window.intentarSorteo = async (btn) => {
    const ts = parseInt(btn.dataset.timestamp);
    const ahora = Date.now();
    if (ahora < ts) {
        const clave = prompt(`‚è∞ Sorteo programado para ${new Date(ts).toLocaleString()}\nIngrese CLAVE DE COMERCIO o MAESTRA para adelantar:`);
        if (!clave) return;
        if (!await validarAccionSegura(btn.dataset.id, clave)) {
            mostrarToast("‚ùå Contrase√±a incorrecta", "error");
            return;
        }
        mostrarToast("üîì Acceso autorizado - Sorteo adelantado", "warning");
    }
    ejecutarSorteo(btn.dataset.id, btn.dataset.nombre, btn.dataset.premio, parseInt(btn.dataset.cant), btn.dataset.mail, btn.dataset.logo, btn.dataset.desc, btn.dataset.claveComercio);
};

// Eliminar sorteo
window.intentarEliminarSorteo = async (idComercio, fechaSorteoISO) => {
    const dh = (new Date(fechaSorteoISO).getTime() - Date.now()) / 3600000;
    const clave = prompt((dh<24 && dh>0) ? "‚ö†Ô∏è ZONA CR√çTICA: Solo CLAVE MAESTRA:" : "Ingrese CLAVE DE COMERCIO para eliminar:");
    if (!clave) return;
    if (!await validarAccionSegura(idComercio, clave)) { mostrarToast("‚ùå Contrase√±a incorrecta", "error"); return; }
    if (dh<24 && dh>0 && clave!==CLAVE_MAESTRA) { mostrarToast("‚ùå Solo Admin puede cancelar sorteos inminentes", "error"); return; }
    try {
        await updateDoc(doc(db,"comercios",idComercio), { titulo_sorteo:null, descripcion_sorteo:null, fecha_sorteo:null, cantidad_premios:null, logoUrl:null });
        mostrarToast("üóëÔ∏è Sorteo cancelado", "success");
        cargarActivos();
    } catch(e) { mostrarToast("‚ùå Error", "error"); }
};

// Relojes
window.iniciarRelojes = () => {
    setInterval(() => {
        document.querySelectorAll('.btn-sortear-accion').forEach(btn => {
            const ts = parseInt(btn.dataset.timestamp), f = ts - Date.now();
            if (f > 0) {
                const d = Math.floor(f/86400000), h = Math.floor((f%86400000)/3600000), m = Math.floor((f%3600000)/60000), s = Math.floor((f%60000)/1000);
                btn.innerHTML = `‚è≥ ${d}d ${h}h ${m}m ${s}s`;
                btn.classList.add('btn-dark'); btn.classList.remove('btn-primary');
                btn.dataset.estado = 'bloqueado';
            } else {
                btn.innerHTML = `üé≤ SORTEAR AHORA`;
                btn.classList.remove('btn-dark'); btn.classList.add('btn-primary');
                btn.dataset.estado = 'listo';
            }
        });
    }, 1000);
};

// Confirmaci√≥n de sorteo
window.mostrarConfirmacionSorteo = (total, ganadores, comercio) => {
    const listaGanadores = document.getElementById('lista-ganadores-popup');
    listaGanadores.innerHTML = ganadores.map(g => {
        const esVIP = g.tipo === "VIP";
        const badgeTipo = esVIP ? `<span class="badge badge-vip"><i class="fas fa-crown"></i> VIP</span>` : `<span class="badge badge-lead"><i class="fas fa-user"></i> LEAD</span>`;
        return `<div class="ganador-item"><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:bold;"><i class="fas fa-trophy" style="color:var(--oro);margin-right:5px;"></i>${g.nombreMostrar}</span>${badgeTipo}</div><small style="color:#666;display:block;margin-top:5px;"><i class="fab fa-whatsapp"></i> ${g.celular||'Sin tel√©fono'}</small></div>`;
    }).join('');
    document.getElementById('texto-sorteo').innerText = `Sorteo de ${comercio}: ${ganadores.length} ganador(es) entre ${total} participantes.`;
    document.getElementById('popup-confirmacion').style.display = 'flex';
};
window.cerrarModalSorteo = () => document.getElementById('popup-confirmacion').style.display = 'none';
window.irAlHistorial = () => { cerrarModalSorteo(); mostrarHistorial(); };

// Checkboxes / Bulk
window.itemsSeleccionados = new Set();
window.vistaActual = 'activos';
window.toggleSelectAll = () => {
    const sa = document.getElementById('select-all');
    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.checked = sa.checked;
        sa.checked ? window.itemsSeleccionados.add(cb.dataset.id) : window.itemsSeleccionados.delete(cb.dataset.id);
    });
    actualizarBulkActions();
};
window.actualizarBulkActions = () => {
    const bulk = document.getElementById('bulk-actions');
    const count = document.getElementById('selected-count');
    const sa = document.getElementById('select-all');
    if (window.itemsSeleccionados.size > 0) {
        bulk.classList.add('active');
        count.textContent = window.itemsSeleccionados.size;
        sa.checked = window.itemsSeleccionados.size === document.querySelectorAll('.row-checkbox').length;
    } else {
        bulk.classList.remove('active');
        sa.checked = false;
    }
};
window.toggleSeleccion = (id, cb) => { cb.checked ? window.itemsSeleccionados.add(id) : window.itemsSeleccionados.delete(id); actualizarBulkActions(); };
window.eliminarSeleccionados = async () => {
    if (!window.itemsSeleccionados.size) return mostrarToast("‚ö†Ô∏è No hay items seleccionados", "warning");
    if (!confirm(`¬øEliminar ${window.itemsSeleccionados.size} registro(s)?`)) return;
    mostrarToast("üóëÔ∏è Eliminando...", "warning");
    try {
        await Promise.all(Array.from(window.itemsSeleccionados).map(id => deleteDoc(doc(db, "historial_sorteos", id))));
        mostrarToast(`‚úÖ ${window.itemsSeleccionados.size} eliminado(s)`, "success");
        window.itemsSeleccionados.clear();
        actualizarBulkActions();
        mostrarHistorial();
    } catch(e) { mostrarToast("‚ùå Error", "error"); }
};
window.desmarcarTodos = () => {
    window.itemsSeleccionados.clear();
    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    actualizarBulkActions();
};
window.eliminarIndividual = async (id, btn) => {
    if (!confirm('¬øEliminar este registro?')) return;
    const original = btn.innerHTML;
    btn.disabled = true; btn.innerHTML = "‚è≥";
    try {
        await deleteDoc(doc(db, "historial_sorteos", id));
        mostrarToast("‚úÖ Eliminado", "success");
        mostrarHistorial();
    } catch(e) { mostrarToast("‚ùå Error", "error"); btn.disabled = false; btn.innerHTML = original; }
};

// Cargar activos
const cargarActivos = async () => {
    window.vistaActual = 'activos';
    window.itemsSeleccionados.clear();
    actualizarBulkActions();
    document.getElementById('header-checkbox').style.display = 'none';
    
    onSnapshot(collection(db, "comercios"), async snap => {
        const tabla = document.getElementById('tabla-sorteos');
        tabla.innerHTML = "";
        for (const docCom of snap.docs) {
            const c = docCom.data();
            if (!c.titulo_sorteo) continue;
            const nomCom = c.nombre, premio = c.titulo_sorteo, descPremio = c.descripcion_sorteo || "";
            const cant = parseInt(c.cantidad_premios) || 1, fechaISO = c.fecha_sorteo || "";
            const ts = fechaISO ? new Date(fechaISO).getTime() : Date.now();
            let cL = 0, cV = 0;
            const snapP = await getDocs(query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nomCom)));
            await Promise.all(snapP.docs.map(async p => {
                const pd = p.data();
                if (pd.usuarioId && !pd.usuarioId.startsWith('temp_')) {
                    try {
                        const ld = await getDoc(doc(db, "leads", pd.usuarioId));
                        if (ld.exists() && (ld.data().convertidoVIP || ld.data().tipo === "VIP")) { cV++; return; }
                    } catch(e) {}
                }
                pd.tipo === "VIP" ? cV++ : cL++;
            }));
            const f = formatearFechaHora(fechaISO) || {fecha:'A definir', hora:''};
            const badge = ts > Date.now() ? `<span class="timestamp-badge">üïê Programado: ${f.fecha} ${f.hora}</span>` : `<span class="badge badge-critica">üî¥ LISTO PARA SORTEAR</span>`;
            tabla.innerHTML += `<tr>
            <td><div class="fecha-cell"><span class="fecha-principal">${f.fecha}</span><span class="hora-secundaria">${f.hora}</span>${badge}</div></td>
            <td><img src="${c.logoUrl||''}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
            <td><span class="badge badge-comercio">${nomCom}</span><br><span class="badge badge-premio">üéÅ ${premio}</span>${descPremio?`<div class="premio-desc">${descPremio}</div>`:''}</td>
            <td><div class="participantes-cell"><div class="participantes-row"><span>LEAD:</span><span class="participantes-value valor-lead">${cL}</span></div><div class="participantes-row"><span>VIP:</span><span class="participantes-value valor-vip">${cV}</span></div><div class="participantes-row"><b>TOTAL:</b><span class="participantes-value valor-total">${cL+cV}</span></div></div></td>
            <td><button class="btn btn-sortear-accion" data-id="${docCom.id}" data-nombre="${nomCom}" data-premio="${premio}" data-cant="${cant}" data-mail="${c.email||''}" data-logo="${c.logoUrl||''}" data-desc="${descPremio}" data-timestamp="${ts}" data-clave-comercio="${c.password||''}" onclick="intentarSorteo(this)">Calculando...</button><br><button class="btn btn-danger btn-sm" style="margin-top:5px;font-size:0.8rem" onclick="intentarEliminarSorteo('${docCom.id}','${fechaISO}')">üóëÔ∏è Cancelar</button></td>
            <td style="text-align:center"><span class="badge badge-premios">üéÅ ${cant} premio${cant>1?'s':''}</span></td>
            </tr>`;
        }
    });
};

// Ejecutar sorteo
const ejecutarSorteo = async (idCom, nomCom, premio, cant, mailC, logoUrl, desc) => {
    mostrarToast(`üé≤ Procesando sorteo para ${nomCom}...`, "warning");
    try {
        const q = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nomCom));
        const snap = await getDocs(q);
        let participantes = [];
        for (const d of snap.docs) {
            const p = d.data();
            let nom = p.nombre || "Participante", cel = p.celular || p.whatsapp || "S/D", tipo = p.tipo || "LEAD", email = p.email || "";
            if (p.usuarioId && !p.usuarioId.startsWith('temp_')) {
                try {
                    const l = await getDoc(doc(db, "leads", p.usuarioId));
                    if (l.exists()) {
                        const ld = l.data();
                        nom = `${ld.nombres||''} ${ld.apellido||''}`.trim() || nom;
                        cel = ld.whatsapp || ld.celular || cel;
                        tipo = (ld.convertidoVIP || ld.tipo === "VIP") ? "VIP" : "LEAD";
                        email = ld.email || email;
                    }
                } catch(e) {}
            }
            participantes.push({ ...p, nombreMostrar: nom, celular: cel, tipo, email });
        }
        if (!participantes.length) return mostrarToast("‚ö†Ô∏è Sin participantes", "error");
        let ganadores = [], bolsa = [...participantes];
        for (let i = 0; i < Math.min(cant, bolsa.length); i++) {
            const idx = Math.floor(Math.random() * bolsa.length);
            ganadores.push(bolsa.splice(idx, 1)[0]);
        }
        await addDoc(collection(db, "historial_sorteos"), {
            comercio: nomCom, premio, descripcion_sorteo: desc || "", logoUrl: logoUrl || "",
            ganadores, fecha: serverTimestamp(), mailComercio: mailC || 'habitatcar@gmail.com', timestampProgramado: Date.now()
        });
        mostrarToast(`‚úÖ Sorteo exitoso`, "success");
        window.mostrarConfirmacionSorteo(participantes.length, ganadores, nomCom);
    } catch(e) { console.error(e); mostrarToast("‚ùå Error en sorteo", "error"); }
};

// Historial
window.mostrarHistorial = () => {
    window.vistaActual = 'historial';
    window.itemsSeleccionados.clear();
    actualizarBulkActions();
    document.getElementById('header-checkbox').style.display = 'table-cell';
    const tabla = document.getElementById('tabla-sorteos');
    
    onSnapshot(collection(db, "historial_sorteos"), snap => {
        tabla.innerHTML = "";
        const docs = snap.docs.sort((a,b) => (b.data().fecha?.seconds||0) - (a.data().fecha?.seconds||0));
        docs.forEach(docSnap => {
            const h = docSnap.data();
            const fecha = h.fecha?.toDate ? h.fecha.toDate().toLocaleString() : "Reciente";
            (h.ganadores||[]).forEach((g, idx) => {
                const nombreG = g.nombreMostrar || "Invitado";
                const celG = g.celular || "";
                const emailG = g.email || "";
                const esVIP = g.tipo === "VIP";
                const badgeTipo = esVIP ? `<span class="badge badge-vip"><i class="fas fa-crown"></i> VIP</span>` : `<span class="badge badge-lead"><i class="fas fa-user"></i> LEAD</span>`;
                const descSorteo = h.descripcion_sorteo || "";
                const logoC = h.logoUrl || LOGO_DEFAULT;
                
                tabla.innerHTML += `<tr>
                <td class="checkbox-cell"><input type="checkbox" class="row-checkbox" data-id="${docSnap.id}" onchange="toggleSeleccion('${docSnap.id}', this)"></td>
                <td><small>${fecha}</small></td>
                <td><img src="${h.logoUrl||''}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
                <td><span class="badge badge-comercio">${h.comercio}</span><br><span class="badge badge-premio">üéÅ ${h.premio}</span>${descSorteo?`<div class="premio-desc">${descSorteo}</div>`:''}</td>
                <td><div style="font-weight:bold">${nombreG}</div><div style="margin-top:4px">${badgeTipo}</div></td>
                <td><div style="font-size:0.85em;color:var(--verde);margin-bottom:3px;"><i class="fab fa-whatsapp"></i> ${celG}</div>${emailG?`<div style="font-size:0.8em;color:#666;word-break:break-all;"><i class="fas fa-envelope"></i> ${emailG}</div>`:''}<div style="margin-top:8px;">
                <button class="btn-accion btn-wapdf" data-nombre="${esc(nombreG)}" data-premio="${esc(h.premio)}" data-comercio="${esc(h.comercio)}" data-descripcion="${esc(descSorteo)}" data-cel="${esc(celG)}" data-logo="${esc(logoC)}" onclick="clickEnviarTicket(this)" title="Genera PDF y abre WhatsApp"><i class="fab fa-whatsapp"></i> <i class="fas fa-file-pdf"></i> ENVIAR WHATSAPP Y PDF</button></div></td>
                <td><button class="btn-accion" style="background:#6c757d" data-texto="${esc(nombreG+' - WA: '+celG+' - Email: '+emailG)}" onclick="navigator.clipboard.writeText(this.dataset.texto);mostrarToast('üìã Copiado','warning')"><i class="fas fa-copy"></i></button><button class="btn-accion btn-delete" onclick="eliminarIndividual('${docSnap.id}',this)"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
        });
    });
};

// Inicializaci√≥n
document.getElementById('btn-activos').onclick = cargarActivos;
document.getElementById('btn-historial').onclick = mostrarHistorial;
document.addEventListener('DOMContentLoaded', () => { cargarActivos(); iniciarRelojes(); });
document.getElementById('modalPDF').addEventListener('click', e => { if(e.target.id==='modalPDF') cerrarModales(); });
document.getElementById('modalWA').addEventListener('click', e => { if(e.target.id==='modalWA') cerrarModales(); });

// Exponer funciones globales
window.mostrarHistorial = mostrarHistorial;
window.mostrarToast = mostrarToast;
window.mostrarConfirmacionSorteo = mostrarConfirmacionSorteo;
window.cerrarModalSorteo = cerrarModalSorteo;
window.irAlHistorial = irAlHistorial;
window.toggleSeleccion = toggleSeleccion;
window.toggleSelectAll = toggleSelectAll;
window.eliminarSeleccionados = eliminarSeleccionados;
window.desmarcarTodos = desmarcarTodos;
window.eliminarIndividual = eliminarIndividual;
window.actualizarBulkActions = actualizarBulkActions;
window.intentarSorteo = intentarSorteo;
window.intentarEliminarSorteo = intentarEliminarSorteo;
window.validarAccionSegura = validarAccionSegura;
window.clickEnviarTicket = clickEnviarTicket;
window.abrirEditorPDF = abrirEditorPDF;
window.abrirEditorWA = abrirEditorWA;
window.actualizarPrevia = actualizarPrevia;
window.guardarConfigPDF = guardarConfigPDF;
window.guardarConfigWA = guardarConfigWA;
window.cerrarModales = cerrarModales;
</script>
</body>
</html>
