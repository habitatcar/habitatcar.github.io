<html lang="es"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Sorteos Elite | H√°bitat-Car</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--azul-habitat: #003d80;
--rojo-cupon: #e60000;
--naranja: #ff8c00;
--celeste: #0288d1;
--verde: #2e7d32;
--blanco: #ffffff;
--gris-texto: #666666;
--oro: #d4af37;
--zona-critica: #dc3545;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; padding-top: 140px; }
.faja-superior { position: fixed; top: 0; left: 0; width: 100%; background: var(--azul-habitat); border-bottom: 4px solid var(--rojo-cupon); z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.faja-contenido { max-width: 1200px; margin: 0 auto; padding: 10px 20px; display: flex; flex-direction: column; gap: 10px; }
.faja-logo { text-align: center; padding: 5px 0; }
.faja-logo img { height: 50px; width: auto; max-width: 200px; }
.faja-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; padding: 5px 0; }
.faja-nav a { padding: 6px 10px; border-radius: 4px; text-decoration: none; color: white; font-weight: 600; font-size: 11px; background: rgba(255,255,255,0.15); transition: all 0.2s; text-transform: uppercase; }
.faja-nav a:hover, .faja-nav a.active { background: var(--rojo-cupon); transform: translateY(-1px); }
.faja-nav a.active { box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
header h1 { font-size: 1.8rem; margin-bottom: 8px; }
header p { opacity: 0.9; font-size: 0.95rem; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
.btn-primary { background: #667eea; color: white; }
.btn-primary:hover { background: #5568d3; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.btn-warning { background: #ffc107; color: #333; }
.btn-warning:hover { background: #e0a800; }
.btn-info { background: #17a2b8; color: white; }
.btn-dark { background: #343a40; color: white; }
.btn-danger { background: #dc3545; color: white; }
.btn-danger:hover { background: #c82333; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }
.btn-sm { padding: 4px 8px; font-size: 0.8rem; }
.table-container { overflow-x: auto; max-height: calc(100vh - 280px); }
table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
thead { position: sticky; top: 0; z-index: 100; }
th { background: #667eea; color: white; padding: 14px 12px; text-align: left; white-space: nowrap; }
td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
.btn-accion { padding: 6px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; color: white; display: inline-flex; align-items: center; gap: 4px; }
.btn-wa { background: #25D366; }
.btn-mail { background: #ea4335; }
.btn-delete { background: #dc3545; }
.btn-delete:hover { background: #c82333; }
.badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.badge-premio { background: #fff3cd; color: #856404; }
.badge-comercio { background: #d1ecf1; color: #0c5460; }
.badge-premios { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-vip { background: #fff8e1; color: #f57f17; font-weight: bold; }
.badge-lead { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-critica { background: #ffebee; color: #c62828; font-weight: bold; animation: pulse 2s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.4); } 70% { box-shadow: 0 0 0 10px rgba(220,53,69,0); } 100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); } }
.toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 10px; color: white; z-index: 9999; animation: slideIn 0.3s ease; }
.success { background: #28a745; } .error { background: #dc3545; } .warning { background: #ffc107; color: #333; }
@keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
.participantes-cell { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; }
.participantes-row { display: flex; justify-content: space-between; align-items: center; }
.participantes-value { font-weight: bold; padding: 2px 8px; border-radius: 4px; min-width: 30px; text-align: center; }
.valor-lead { background: #e3f2fd; color: #1976d2; }
.valor-vip { background: #fff8e1; color: #f57f17; }
.valor-total { background: #e8f5e9; color: #388e3c; }
.premio-desc { font-size: 0.85rem; color: #666; margin-top: 4px; line-height: 1.4; max-width: 200px; }
.fecha-cell { display: flex; flex-direction: column; gap: 2px; font-size: 0.85rem; min-width: 100px; }
.fecha-principal { font-weight: bold; color: #333; }
.hora-secundaria { color: #666; font-size: 0.8rem; }
.timestamp-badge { font-size: 0.75rem; color: #666; background: #f1f1f1; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }
.logo-mini { height: 80px; width: auto; max-width: 120px; object-fit: contain; display: block; margin: 0 auto; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
.modal-content { background: white; padding: 25px; border-radius: 16px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.form-group { text-align: left; margin-bottom: 15px; }
.form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
.form-group textarea { width: 100%; height: 150px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: inherit; }
.form-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
.ganador-item { background: #f8f9fa; border-left: 4px solid var(--oro); padding: 12px; margin: 10px 0; border-radius: 8px; text-align: left; }
.email-display { font-size: 0.8em; color: #666; margin-top: 3px; word-break: break-all; }
.checkbox-cell { text-align: center; width: 50px; }
.checkbox-cell input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.bulk-actions { display: none; gap: 10px; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107; }
.bulk-actions.active { display: flex; align-items: center; }
.selected-count { font-weight: bold; color: #856404; }
@media (max-width: 768px) {
.faja-nav { gap: 3px; }
.faja-nav a { font-size: 9px; padding: 4px 6px; }
body { padding-top: 120px; }
.logo-mini { height: 70px; }
}
</style>
</head>
<body>
<div class="faja-superior">
<div class="faja-contenido">
<div class="faja-logo"><a href="index.html"><img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="H√°bitat-Car"></a></div>
<nav class="faja-nav">
<a href="admin_comercios.html">COMERCIOS</a><a href="admin_leads.html">LEADS</a><a href="admin_vips.html">VIPS</a>
<a href="admin_tokens_vip.html">TOKENS VIP</a><a href="admin_curioso.html">CURIOSO</a><a href="admin_estadisticas.html">ESTAD√çSTICAS</a>
<a href="admin_logs.html">LOG</a><a href="admin_tutoriales.html">TUTORIALES</a><a href="index.html">PANEL</a>
<a href="admin_legales.html">LEGALES</a><a href="admin_sorteos.html" class="active">SORTEOS</a>
</nav>
</div>
</div>

<div class="container">
<header><h1>üèÜ SORTEOS PREMIUM</h1><p>Panel de Sorteos Elite | H√°bitat-Car</p></header>
<div class="controls">
<button class="btn btn-success" id="btn-activos">SORTEOS ACTIVOS</button>
<button class="btn btn-warning" id="btn-historial">HISTORIAL DE √âXITOS</button>
<button class="btn btn-info" onclick="abrirEditorEmail()"><i class="fas fa-edit"></i> EDITAR EMAIL</button>
<button class="btn btn-dark" onclick="abrirEditorPDF()"><i class="fas fa-palette"></i> DISE√ëAR PDF</button>
</div>
<div id="bulk-actions" class="bulk-actions">
<span class="selected-count"><i class="fas fa-check-circle"></i> <span id="selected-count">0</span> seleccionado(s)</span>
<button class="btn btn-danger" onclick="eliminarSeleccionados()"><i class="fas fa-trash"></i> ELIMINAR SELECCIONADOS</button>
<button class="btn btn-warning" onclick="desmarcarTodos()"><i class="fas fa-times"></i> CANCELAR</button>
</div>
<div class="table-container">
<table>
<thead>
<tr id="tabla-headers">
<th class="checkbox-cell" id="header-checkbox" style="display:none;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
<th>FECHA</th><th>LOGO</th><th>COMERCIO / PREMIO</th><th>PARTICIPANTES</th><th>ACCIONES</th><th>PREMIOS</th>
</tr>
</thead>
<tbody id="tabla-sorteos"></tbody>
</table>
</div>
</div>

<!-- MODAL EDITAR EMAIL -->
<div id="modal-email" class="modal">
<div class="modal-content">
<h3 style="color:var(--azul-habitat); margin-bottom:15px;">‚úâÔ∏è Editar Plantilla de Email</h3>
<p style="font-size:0.9em; color:#666; margin-bottom:15px;">
<b>Variables disponibles:</b><br>
<span style="color:#e60000; font-weight:bold">{{NOMBRE}}</span> ‚Üí Nombre del Ganador<br>
<span style="color:#e60000; font-weight:bold">{{PREMIO}}</span> ‚Üí El Regalo<br>
<span style="color:#e60000; font-weight:bold">{{COMERCIO}}</span> ‚Üí Local del Sorteo<br>
<span style="color:#e60000; font-weight:bold">{{WHATSAPP_COMERCIO}}</span> ‚Üí WhatsApp del Comercio<br>
<span style="color:#e60000; font-weight:bold">{{DIRECCION_COMERCIO}}</span> ‚Üí Direcci√≥n del Comercio
</p>
<div class="form-group"><label>Asunto:</label><input type="text" id="inp-asunto"></div>
<div class="form-group"><label>Mensaje (HTML permitido):</label><textarea id="inp-cuerpo"></textarea></div>
<button class="btn btn-primary" onclick="guardarConfig('email')">üíæ GUARDAR EMAIL</button>
<button class="btn btn-warning" onclick="cerrarEditores()">‚ùå CANCELAR</button>
</div>
</div>

<!-- MODAL DISE√ëAR PDF -->
<div id="modal-pdf" class="modal">
<div class="modal-content">
<h3 style="color:var(--azul-habitat); margin-bottom:15px;">üìÑ Dise√±ar Certificado PDF</h3>
<div class="form-group"><label>URL Imagen de Fondo (210x148mm):</label><input type="text" id="inp-pdf-bg"></div>
<div class="form-group"><label>Color de Texto Principal:</label><input type="color" id="inp-pdf-color" value="#e60000"></div>
<button class="btn btn-primary" onclick="guardarConfig('pdf')">üíæ GUARDAR DISE√ëO</button>
<button class="btn btn-warning" onclick="cerrarEditores()">‚ùå CANCELAR</button>
</div>
</div>

<!-- MODAL CONFIRMACI√ìN SORTEO -->
<div id="popup-confirmacion" class="modal" style="display:none;">
<div class="modal-content">
<h3 style="color:var(--azul-habitat); margin-bottom:15px;">üéâ ¬°SORTEO REALIZADO!</h3>
<p id="texto-sorteo" style="font-size:1.1rem; margin-bottom:20px; line-height:1.5;"></p>
<div id="lista-ganadores-popup" style="text-align:left; margin-bottom:20px;"></div>
<button class="btn btn-primary" onclick="irAlHistorial()">IR AL HISTORIAL DE √âXITOS</button>
<button class="btn btn-warning" onclick="cerrarModalSorteo()" style="margin-top:10px;">SEGUIR AQU√ç</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, where, addDoc, serverTimestamp, getDocs, doc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const CLAVE_MAESTRA = "HABITAT_MASTER_2026";
const LOGO_DEFAULT  = "https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true";
const URL_SCRIPT    = "https://script.google.com/macros/s/AKfycbz2xzSyQfL23SSFvvZ5jfKYYWvjMIy56XX33cSuq-DAQG64geSLsHdLnVzNmXDkzSXM5A/exec";

const firebaseConfig = {
    apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
    authDomain: "habitatcar-pro.firebaseapp.com",
    projectId: "habitatcar-pro",
    storageBucket: "habitatcar-pro.firebasestorage.app",
    messagingSenderId: "311691258694",
    appId: "1:311691258694:web:17a09051dcea7707af9347"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// =========================================================
// SOLUCI√ìN DEFINITIVA AL PROBLEMA DE INYECCI√ìN
// =========================================================
// En lugar de guardar datos en un objeto global que se puede
// perder cuando Firebase recarga la tabla, guardamos cada dato
// directamente en el bot√≥n como atributo data-*.
// Cuando el usuario hace click, el bot√≥n lee sus propios datos.
// As√≠ no importa cu√°ntas veces Firebase regenere la tabla:
// los datos siempre est√°n pegados al bot√≥n mismo.
// =========================================================

// ‚úÖ FUNCI√ìN CENTRAL: lee los datos del bot√≥n y env√≠a el mail
window.clickEnviarMail = async (btn) => {
    const nombre           = btn.getAttribute('data-nombre')    || '';
    const email            = btn.getAttribute('data-email')     || '';
    const premio           = btn.getAttribute('data-premio')    || '';
    const comercio         = btn.getAttribute('data-comercio')  || '';
    const mailCC           = btn.getAttribute('data-mailcc')    || '';
    const logoUrl          = btn.getAttribute('data-logo')      || '';
    const whatsapp         = btn.getAttribute('data-wap')       || '';
    const direccion        = btn.getAttribute('data-dir')       || '';

    if (!email) return mostrarToast("Sin email registrado", "error");

    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "‚è≥";

    // Plantillas con variables
    const asuntoPlantilla = localStorage.getItem('hc_asunto') ||
        "üèÜ ¬°Felicidades {{NOMBRE}}! Ganaste en {{COMERCIO}}";
    const cuerpoPlantilla = localStorage.getItem('hc_cuerpo') ||
`Hola {{NOMBRE}}, ganaste un/a {{PREMIO}} en {{COMERCIO}}.

Es un gran placer saber que fuiste beneficiado con un importante premio que vas a poder disfrutar al m√°ximo.

Ten√©s 30 d√≠as para ir por {{DIRECCION_COMERCIO}} a buscar tu premio o contactarte con {{WHATSAPP_COMERCIO}}.

Saludos, el equipo de H√°bitat-Car.`;

    // ‚úÖ INYECCI√ìN: reemplaza todas las variables con los datos reales
    const inyectar = (t) => t
        .replace(/\{\{NOMBRE\}\}/g,            nombre    || 'Ganador/a')
        .replace(/\{\{PREMIO\}\}/g,             premio    || 'el premio')
        .replace(/\{\{COMERCIO\}\}/g,           comercio  || 'el comercio')
        .replace(/\{\{WHATSAPP_COMERCIO\}\}/g,  whatsapp  || 'el comercio')
        .replace(/\{\{DIRECCION_COMERCIO\}\}/g, direccion || 'el comercio');

    const asuntoFinal = inyectar(asuntoPlantilla);
    const cuerpoFinal = inyectar(cuerpoPlantilla);

    // Generar PDF con los datos correctos
    const { jsPDF } = window.jspdf;
    const pdf   = new jsPDF('l', 'mm', 'a5');
    const ancho = 210, alto = 148;

    pdf.setFillColor(0, 61, 128);
    pdf.triangle(0, 0, 80, 0, 0, 80, 'F');
    pdf.setDrawColor(0, 61, 128); pdf.setLineWidth(1);
    pdf.rect(5, 5, ancho-10, alto-10);
    pdf.setDrawColor(212, 175, 55); pdf.setLineWidth(0.5);
    pdf.rect(7, 7, ancho-14, alto-14);

    if (logoUrl) { try { pdf.addImage(logoUrl, 'PNG', ancho-55, 15, 40, 40, '', 'FAST'); } catch(e){} }
    try { pdf.addImage(LOGO_DEFAULT, 'PNG', 15, alto-45, 45, 30, '', 'FAST'); } catch(e){}

    pdf.setTextColor(0, 61, 128); pdf.setFont("helvetica","bold"); pdf.setFontSize(26);
    pdf.text("CERTIFICADO DE GANADOR", ancho/2, 45, {align:"center"});

    pdf.setTextColor(40,40,40); pdf.setFontSize(14); pdf.setFont("helvetica","normal");
    pdf.text("Por el presente se certifica que:", ancho/2, 60, {align:"center"});

    pdf.setFontSize(22); pdf.setFont("helvetica","bold");
    pdf.text(nombre.toUpperCase(), ancho/2, 75, {align:"center"});

    pdf.setFontSize(12); pdf.setFont("helvetica","normal");
    pdf.text(`Fuiste favorecido con el sorteo de ${comercio}:`, ancho/2, 90, {align:"center"});

    pdf.setFontSize(14); pdf.setFont("helvetica","bold");
    pdf.text(`"${premio.toUpperCase()}"`, ancho/2, 100, {align:"center"});

    pdf.setFontSize(9); pdf.setFont("helvetica","normal");
    pdf.text(`Emitido el: ${new Date().toLocaleDateString()}`, ancho-20, alto-15, {align:"right"});

    const pdfB64 = pdf.output('datauristring').split(',')[1];

    try {
        await fetch(URL_SCRIPT, {
            method: 'POST', mode: 'no-cors', cache: 'no-cache',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({
                email: email.trim(),
                asunto: asuntoFinal,
                cuerpoHtml: cuerpoFinal,
                nombreGanador: nombre,
                cc: `habitatcar@gmail.com, ${mailCC}`,
                pdfB64: pdfB64
            })
        });
        mostrarToast(`‚úÖ Mail enviado a ${nombre}!`);
    } catch(e) {
        console.error(e);
        mostrarToast("‚ùå Error al enviar", "error");
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
};

// ‚úÖ WHATSAPP: tambi√©n lee sus datos del propio bot√≥n
window.clickAbrirWA = (btn) => {
    const cel    = btn.getAttribute('data-cel')    || '';
    const nombre = btn.getAttribute('data-nombre') || '';
    const premio = btn.getAttribute('data-premio') || '';
    if (!cel) return mostrarToast("Sin celular registrado", "error");
    let num = cel.replace(/\D/g,'');
    if (num.length===10) num = '549'+num;
    else if (num.startsWith('54') && !num.startsWith('549')) num = '549'+num.substring(2);
    else if (!num.startsWith('549')) num = '549'+num;
    const msg = encodeURIComponent(`¬°Hola ${nombre}! üèÜ Soy de H√°bitat-Car. ¬°Felicidades, ganaste el sorteo de ${premio}! üéâ`);
    window.open(`https://wa.me/${num}?text=${msg}`, '_blank');
};

// ‚úÖ COPIAR: tambi√©n lee sus datos del propio bot√≥n
window.clickCopiar = (btn) => {
    const nombre = btn.getAttribute('data-nombre') || '';
    const cel    = btn.getAttribute('data-cel')    || 'sin tel';
    const email  = btn.getAttribute('data-email')  || 'sin email';
    navigator.clipboard.writeText(`${nombre} - WA: ${cel} - Email: ${email}`);
    mostrarToast('üìã Copiado', 'warning');
};

window.validarAccionSegura = async (idComercio, claveIngresada) => {
    if (claveIngresada === CLAVE_MAESTRA) return true;
    try {
        const snap = await getDoc(doc(db, "comercios", idComercio));
        if (snap.exists() && claveIngresada === snap.data().password) return true;
    } catch(e) { console.error(e); }
    return false;
};

window.abrirEditorEmail = () => {
    document.getElementById('inp-asunto').value = localStorage.getItem('hc_asunto') || "üèÜ ¬°Felicidades {{NOMBRE}}! Ganaste en {{COMERCIO}}";
    document.getElementById('inp-cuerpo').value = localStorage.getItem('hc_cuerpo') ||
`Hola {{NOMBRE}}, ganaste un/a {{PREMIO}} en {{COMERCIO}}.

Es un gran placer saber que fuiste beneficiado con un importante premio que vas a poder disfrutar al m√°ximo.

Ten√©s 30 d√≠as para ir por {{DIRECCION_COMERCIO}} a buscar tu premio o contactarte con {{WHATSAPP_COMERCIO}}.

Saludos, el equipo de H√°bitat-Car.`;
    document.getElementById('modal-email').style.display = 'flex';
};

window.abrirEditorPDF = () => {
    document.getElementById('inp-pdf-bg').value    = localStorage.getItem('hc_pdf_bg')    || '';
    document.getElementById('inp-pdf-color').value = localStorage.getItem('hc_pdf_color') || '#e60000';
    document.getElementById('modal-pdf').style.display = 'flex';
};

window.cerrarEditores = () => {
    document.getElementById('modal-email').style.display = 'none';
    document.getElementById('modal-pdf').style.display   = 'none';
};

window.guardarConfig = (tipo) => {
    if (tipo === 'email') {
        localStorage.setItem('hc_asunto', document.getElementById('inp-asunto').value);
        localStorage.setItem('hc_cuerpo', document.getElementById('inp-cuerpo').value);
    } else {
        localStorage.setItem('hc_pdf_bg',    document.getElementById('inp-pdf-bg').value);
        localStorage.setItem('hc_pdf_color', document.getElementById('inp-pdf-color').value);
    }
    mostrarToast("‚úÖ Configuraci√≥n guardada", "success");
    cerrarEditores();
};

function formatearFechaHora(fechaISO) {
    if (!fechaISO) return null;
    try {
        const [fp, hp] = fechaISO.split('T');
        const [a,m,d]  = fp.split('-');
        const [h,min]  = hp.split(':');
        return { fecha: `${d}/${m}/${a}`, hora: `${h}:${min} Hs.` };
    } catch(e) { return null; }
}

window.mostrarConfirmacionSorteo = (total, ganadores, comercio) => {
    document.getElementById('lista-ganadores-popup').innerHTML = ganadores.map(g => {
        const badge = g.tipo==="VIP"
            ? `<span class="badge badge-vip"><i class="fas fa-crown"></i> VIP</span>`
            : `<span class="badge badge-lead"><i class="fas fa-user"></i> LEAD</span>`;
        return `<div class="ganador-item">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-weight:bold;"><i class="fas fa-trophy" style="color:var(--oro);margin-right:5px;"></i>${g.nombreMostrar}</span>${badge}
            </div>
            <small style="color:#666;display:block;margin-top:5px;"><i class="fab fa-whatsapp"></i> ${g.celular||'Sin tel√©fono'}</small>
        </div>`;
    }).join('');
    document.getElementById('texto-sorteo').innerText = `Sorteo de ${comercio}: ${ganadores.length} ganador(es) entre ${total} participantes.`;
    document.getElementById('popup-confirmacion').style.display = 'flex';
};
window.cerrarModalSorteo = () => document.getElementById('popup-confirmacion').style.display = 'none';
window.irAlHistorial     = () => { cerrarModalSorteo(); mostrarHistorial(); };

window.itemsSeleccionados = new Set();
window.vistaActual = 'activos';

window.toggleSelectAll = () => {
    const sa = document.getElementById('select-all');
    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.checked = sa.checked;
        sa.checked ? window.itemsSeleccionados.add(cb.dataset.id) : window.itemsSeleccionados.delete(cb.dataset.id);
    });
    actualizarBulkActions();
};
window.actualizarBulkActions = () => {
    const bulk = document.getElementById('bulk-actions');
    const cnt  = document.querySelectorAll('.row-checkbox').length;
    if (window.itemsSeleccionados.size > 0) {
        bulk.classList.add('active');
        document.getElementById('selected-count').textContent = window.itemsSeleccionados.size;
        document.getElementById('select-all').checked = window.itemsSeleccionados.size === cnt;
    } else {
        bulk.classList.remove('active');
        document.getElementById('select-all').checked = false;
    }
};
window.toggleSeleccion = (id, cb) => {
    cb.checked ? window.itemsSeleccionados.add(id) : window.itemsSeleccionados.delete(id);
    actualizarBulkActions();
};
window.eliminarSeleccionados = async () => {
    if (!window.itemsSeleccionados.size) return mostrarToast("‚ö†Ô∏è No hay items seleccionados","warning");
    if (!confirm(`¬øEliminar ${window.itemsSeleccionados.size} registro(s)?`)) return;
    mostrarToast("üóëÔ∏è Eliminando...","warning");
    try {
        await Promise.all([...window.itemsSeleccionados].map(id => deleteDoc(doc(db,"historial_sorteos",id))));
        mostrarToast(`‚úÖ ${window.itemsSeleccionados.size} eliminado(s)`,"success");
        window.itemsSeleccionados.clear();
        actualizarBulkActions();
        mostrarHistorial();
    } catch(e) { mostrarToast("‚ùå Error","error"); }
};
window.desmarcarTodos = () => {
    window.itemsSeleccionados.clear();
    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    actualizarBulkActions();
};
window.eliminarIndividual = async (id, btn) => {
    if (!confirm('¬øEliminar este registro?')) return;
    const orig = btn.innerHTML; btn.disabled=true; btn.innerHTML="‚è≥";
    try {
        await deleteDoc(doc(db,"historial_sorteos",id));
        mostrarToast("‚úÖ Eliminado","success");
        mostrarHistorial();
    } catch(e) { mostrarToast("‚ùå Error","error"); btn.disabled=false; btn.innerHTML=orig; }
};

window.iniciarRelojes = () => {
    setInterval(() => {
        document.querySelectorAll('.btn-sortear-accion').forEach(btn => {
            const ts = parseInt(btn.dataset.timestamp);
            const f  = ts - Date.now();
            if (f > 0) {
                const d=Math.floor(f/86400000), h=Math.floor((f%86400000)/3600000),
                      m=Math.floor((f%3600000)/60000), s=Math.floor((f%60000)/1000);
                btn.innerHTML = `‚è≥ ${d}d ${h}h ${m}m ${s}s`;
                btn.classList.add('btn-dark'); btn.classList.remove('btn-primary');
            } else {
                btn.innerHTML = `üé≤ SORTEAR AHORA`;
                btn.classList.remove('btn-dark'); btn.classList.add('btn-primary');
            }
        });
    }, 1000);
};

window.intentarSorteo = async (btn) => {
    const ts = parseInt(btn.dataset.timestamp);
    if (Date.now() < ts) {
        const clave = prompt(`‚è∞ Sorteo programado para ${new Date(ts).toLocaleString()}\nIngrese CLAVE DE COMERCIO o MAESTRA para adelantar:`);
        if (!clave) return;
        if (!await validarAccionSegura(btn.dataset.id, clave)) return mostrarToast("‚ùå Contrase√±a incorrecta","error");
        mostrarToast("üîì Acceso autorizado","warning");
    }
    ejecutarSorteo(btn.dataset.id, btn.dataset.nombre, btn.dataset.premio, parseInt(btn.dataset.cant), btn.dataset.mail, btn.dataset.logo, btn.dataset.desc, btn.dataset.claveComercio);
};

window.intentarEliminarSorteo = async (idComercio, fechaISO) => {
    const diff = (new Date(fechaISO).getTime() - Date.now()) / 3600000;
    const msg  = (diff<24&&diff>0) ? "‚ö†Ô∏è ZONA CR√çTICA: Solo CLAVE MAESTRA:" : "Ingrese CLAVE DE COMERCIO para eliminar:";
    const clave = prompt(msg);
    if (!clave) return;
    if (!await validarAccionSegura(idComercio, clave)) return mostrarToast("‚ùå Contrase√±a incorrecta","error");
    if (diff<24 && diff>0 && clave!==CLAVE_MAESTRA) return mostrarToast("‚ùå Solo Admin puede cancelar sorteos inminentes","error");
    try {
        await updateDoc(doc(db,"comercios",idComercio), {titulo_sorteo:null,descripcion_sorteo:null,fecha_sorteo:null,cantidad_premios:null,logoUrl:null});
        mostrarToast("üóëÔ∏è Sorteo cancelado","success");
        cargarActivos();
    } catch(e) { mostrarToast("‚ùå Error","error"); }
};

const cargarActivos = async () => {
    window.vistaActual = 'activos';
    window.itemsSeleccionados.clear(); actualizarBulkActions();
    document.getElementById('header-checkbox').style.display = 'none';
    onSnapshot(collection(db,"comercios"), async (snap) => {
        const tabla = document.getElementById('tabla-sorteos');
        tabla.innerHTML = "";
        for (const docCom of snap.docs) {
            const c = docCom.data();
            if (!c.titulo_sorteo) continue;
            const nomCom   = c.nombre || '';
            const premio   = c.titulo_sorteo || '';
            const desc     = c.descripcion_sorteo || '';
            const cant     = parseInt(c.cantidad_premios)||1;
            const fechaISO = c.fecha_sorteo || '';
            const ts       = fechaISO ? new Date(fechaISO).getTime() : Date.now();
            let cL=0, cV=0;
            const qP   = query(collection(db,"admin_participantes_sorteos"), where("comercio","==",nomCom));
            const snapP = await getDocs(qP);
            await Promise.all(snapP.docs.map(async p => {
                const pd = p.data();
                if (pd.usuarioId && !pd.usuarioId.startsWith('temp_')) {
                    try {
                        const ld = await getDoc(doc(db,"leads",pd.usuarioId));
                        if (ld.exists() && (ld.data().convertidoVIP||ld.data().tipo==="VIP")) { cV++; return; }
                    } catch(e){}
                }
                pd.tipo==="VIP" ? cV++ : cL++;
            }));
            const f = formatearFechaHora(fechaISO) || {fecha:'A definir',hora:''};
            const badge = ts>Date.now()
                ? `<span class="timestamp-badge">üïê Programado: ${f.fecha} ${f.hora}</span>`
                : `<span class="badge badge-critica">üî¥ LISTO PARA SORTEAR</span>`;
            tabla.innerHTML += `<tr>
            <td><div class="fecha-cell"><span class="fecha-principal">${f.fecha}</span><span class="hora-secundaria">${f.hora}</span>${badge}</div></td>
            <td><img src="${c.logoUrl||''}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
            <td><span class="badge badge-comercio">${nomCom}</span><br><span class="badge badge-premio">üéÅ ${premio}</span>${desc?`<div class="premio-desc">${desc}</div>`:''}</td>
            <td><div class="participantes-cell">
                <div class="participantes-row"><span>LEAD:</span><span class="participantes-value valor-lead">${cL}</span></div>
                <div class="participantes-row"><span>VIP:</span><span class="participantes-value valor-vip">${cV}</span></div>
                <div class="participantes-row"><b>TOTAL:</b><span class="participantes-value valor-total">${cL+cV}</span></div>
            </div></td>
            <td>
                <button class="btn btn-sortear-accion"
                    data-id="${docCom.id}" data-nombre="${nomCom}" data-premio="${premio}"
                    data-cant="${cant}" data-mail="${c.email||''}" data-logo="${c.logoUrl||''}"
                    data-desc="${desc}" data-timestamp="${ts}" data-clave-comercio="${c.password||''}"
                    onclick="intentarSorteo(this)">Calculando...</button>
                <br><button class="btn btn-danger btn-sm" style="margin-top:5px;" onclick="intentarEliminarSorteo('${docCom.id}','${fechaISO}')">üóëÔ∏è Cancelar</button>
            </td>
            <td style="text-align:center"><span class="badge badge-premios">üéÅ ${cant} premio${cant>1?'s':''}</span></td>
            </tr>`;
        }
    });
};

const ejecutarSorteo = async (idCom, nomCom, premio, cant, mailC, logoUrl, desc) => {
    mostrarToast(`üé≤ Procesando sorteo para ${nomCom}...`,"warning");
    try {
        const snapP = await getDocs(query(collection(db,"admin_participantes_sorteos"), where("comercio","==",nomCom)));
        let participantes = [];
        for (const d of snapP.docs) {
            const p = d.data();
            let nombre=p.nombre||"Participante", cel=p.celular||p.whatsapp||"", tipo=p.tipo||"LEAD", email=p.email||"";
            if (p.usuarioId && !p.usuarioId.startsWith('temp_')) {
                try {
                    const ld = await getDoc(doc(db,"leads",p.usuarioId));
                    if (ld.exists()) {
                        const l=ld.data();
                        nombre = `${l.nombres||''} ${l.apellido||''}`.trim() || nombre;
                        cel    = l.whatsapp||l.celular||cel;
                        tipo   = (l.convertidoVIP||l.tipo==="VIP")?"VIP":"LEAD";
                        email  = l.email||email;
                    }
                } catch(e){}
            }
            participantes.push({...p, nombreMostrar:nombre, celular:cel, tipo, email});
        }
        if (!participantes.length) return mostrarToast("‚ö†Ô∏è Sin participantes","error");

        let ganadores=[], bolsa=[...participantes];
        for (let i=0; i<Math.min(cant,bolsa.length); i++) {
            const idx = Math.floor(Math.random()*bolsa.length);
            ganadores.push(bolsa.splice(idx,1)[0]);
        }

        const cDoc = await getDoc(doc(db,"comercios",idCom));
        const cData = cDoc.exists() ? cDoc.data() : {};

        await addDoc(collection(db,"historial_sorteos"), {
            comercio: nomCom, premio, descripcion_sorteo: desc||"", logoUrl: logoUrl||"",
            ganadores, fecha: serverTimestamp(),
            mailComercio: mailC||'habitatcar@gmail.com',
            timestampProgramado: Date.now(),
            whatsappComercio:  cData.whatsapp  || "",
            direccionComercio: cData.direccion || ""
        });

        mostrarToast("‚úÖ Sorteo exitoso","success");
        mostrarConfirmacionSorteo(participantes.length, ganadores, nomCom);
    } catch(e) { console.error(e); mostrarToast("‚ùå Error en sorteo","error"); }
};

// =========================================================
// HISTORIAL - SOLUCI√ìN DEFINITIVA
// Los datos se pegan directamente en cada bot√≥n como data-*
// Firebase puede recargar la tabla las veces que quiera:
// cada bot√≥n nuevo siempre tiene sus datos frescos adentro.
// =========================================================
window.mostrarHistorial = () => {
    window.vistaActual = 'historial';
    window.itemsSeleccionados.clear(); actualizarBulkActions();
    document.getElementById('header-checkbox').style.display = 'table-cell';
    const tabla = document.getElementById('tabla-sorteos');

    onSnapshot(collection(db,"historial_sorteos"), (snap) => {
        tabla.innerHTML = "";
        snap.docs
            .sort((a,b) => (b.data().fecha?.seconds||0)-(a.data().fecha?.seconds||0))
            .forEach(docSnap => {
                const h     = docSnap.data();
                const fecha = h.fecha?.toDate ? h.fecha.toDate().toLocaleString() : "Reciente";

                (h.ganadores||[]).forEach((g) => {
                    const nombre  = (g.nombreMostrar||"Invitado").replace(/"/g,'&quot;').replace(/'/g,'&#39;');
                    const cel     = (g.celular      ||"").replace(/"/g,'&quot;');
                    const email   = (g.email        ||"").replace(/"/g,'&quot;');
                    const premio  = (h.premio       ||"").replace(/"/g,'&quot;').replace(/'/g,'&#39;');
                    const comercio= (h.comercio     ||"").replace(/"/g,'&quot;').replace(/'/g,'&#39;');
                    const mailCC  = (h.mailComercio ||"").replace(/"/g,'&quot;');
                    const logo    = (h.logoUrl      ||"").replace(/"/g,'&quot;');
                    const wap     = (h.whatsappComercio  ||"").replace(/"/g,'&quot;');
                    const dir     = (h.direccionComercio ||"").replace(/"/g,'&quot;');

                    const badge = g.tipo==="VIP"
                        ? `<span class="badge badge-vip"><i class="fas fa-crown"></i> VIP</span>`
                        : `<span class="badge badge-lead"><i class="fas fa-user"></i> LEAD</span>`;

                    tabla.innerHTML += `<tr>
                    <td class="checkbox-cell">
                        <input type="checkbox" class="row-checkbox" data-id="${docSnap.id}" onchange="toggleSeleccion('${docSnap.id}',this)">
                    </td>
                    <td><small>${fecha}</small></td>
                    <td><img src="${h.logoUrl||''}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
                    <td>
                        <span class="badge badge-comercio">${h.comercio}</span><br>
                        <span class="badge badge-premio">üéÅ ${h.premio}</span>
                        ${h.descripcion_sorteo?`<div class="premio-desc">${h.descripcion_sorteo}</div>`:''}
                    </td>
                    <td><div style="font-weight:bold">${g.nombreMostrar||'Invitado'}</div><div style="margin-top:4px">${badge}</div></td>
                    <td>
                        <div style="font-size:0.85em;color:var(--verde);margin-bottom:3px;"><i class="fab fa-whatsapp"></i> ${g.celular||''}</div>
                        ${g.email?`<div class="email-display"><i class="fas fa-envelope"></i> ${g.email}</div>`:''}
                        <div style="margin-top:8px;display:flex;gap:5px;">
                            <button class="btn-accion btn-wa"
                                data-cel="${cel}" data-nombre="${nombre}" data-premio="${premio}"
                                onclick="clickAbrirWA(this)">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button class="btn-accion btn-mail"
                                data-nombre="${nombre}"
                                data-email="${email}"
                                data-premio="${premio}"
                                data-comercio="${comercio}"
                                data-mailcc="${mailCC}"
                                data-logo="${logo}"
                                data-wap="${wap}"
                                data-dir="${dir}"
                                onclick="clickEnviarMail(this)">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <button class="btn-accion" style="background:#666"
                            data-nombre="${nombre}" data-cel="${cel}" data-email="${email}"
                            onclick="clickCopiar(this)">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn-accion btn-delete" onclick="eliminarIndividual('${docSnap.id}',this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                    </tr>`;
                });
            });
    });
};

function mostrarToast(msg, tipo="success") {
    const d = document.createElement('div');
    d.className = `toast ${tipo}`; d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 3000);
}

document.getElementById('btn-activos').onclick  = cargarActivos;
document.getElementById('btn-historial').onclick = window.mostrarHistorial;
document.addEventListener('DOMContentLoaded', () => { cargarActivos(); iniciarRelojes(); });

window.clickEnviarMail       = clickEnviarMail;
window.clickAbrirWA          = clickAbrirWA;
window.clickCopiar           = clickCopiar;
window.mostrarHistorial      = mostrarHistorial;
window.mostrarToast          = mostrarToast;
window.mostrarConfirmacionSorteo = mostrarConfirmacionSorteo;
window.cerrarModalSorteo     = cerrarModalSorteo;
window.irAlHistorial         = irAlHistorial;
window.toggleSeleccion       = toggleSeleccion;
window.toggleSelectAll       = toggleSelectAll;
window.eliminarSeleccionados = eliminarSeleccionados;
window.desmarcarTodos        = desmarcarTodos;
window.eliminarIndividual    = eliminarIndividual;
window.actualizarBulkActions = actualizarBulkActions;
window.iniciarRelojes        = iniciarRelojes;
window.intentarSorteo        = intentarSorteo;
window.intentarEliminarSorteo = intentarEliminarSorteo;
window.validarAccionSegura   = validarAccionSegura;
window.cerrarEditores        = cerrarEditores;
window.guardarConfig         = guardarConfig;
window.abrirEditorEmail      = abrirEditorEmail;
window.abrirEditorPDF        = abrirEditorPDF;
</script>
</body></html>
