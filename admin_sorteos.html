<html lang="es"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Sorteos Elite | H√°bitat-Car</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ... (Se mantienen todos tus estilos originales intactos) ... */
:root { --azul-habitat: #003d80; --rojo-cupon: #e60000; --naranja: #ff8c00; --celeste: #0288d1; --verde: #2e7d32; --blanco: #ffffff; --gris-texto: #666666; --oro: #d4af37; --zona-critica: #dc3545; }
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; padding-top: 140px; }
.faja-superior { position: fixed; top: 0; left: 0; width: 100%; background: var(--azul-habitat); border-bottom: 4px solid var(--naranja); z-index: 1000; padding: 10px 0; }
/* ... (He omitido el resto del CSS aqu√≠ por brevedad, pero en tu archivo DEBES mantenerlo todo) ... */
</style>
</head>
<body>

<script type="module">
// --- CONFIGURACI√ìN DE FIREBASE ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const firebaseConfig = {
    // COPIA AQU√ç TUS CREDENCIALES DE FIREBASE
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// URL DE TU SCRIPT DE GOOGLE (Aseg√∫rate de que sea la √∫ltima versi√≥n implementada)
const URL_SCRIPT = "TU_URL_AQUI_TERMINADA_EN_EXEC";

// --- MOTOR DE ENV√çO CORREGIDO (Extra√≠do de la versi√≥n funcional) ---
window.enviarMail = async (btn, emailDestino, nombre, premio, comercio, mailCC) => {
    if (!emailDestino || emailDestino === 'undefined') return mostrarToast("‚ùå Email inv√°lido", "error");
    
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "‚è≥";

    // 1. Obtenci√≥n de plantillas
    let asuntoP = localStorage.getItem('hc_asunto') || "üèÜ ¬°Felicidades {{NOMBRE}}, ganaste!";
    let cuerpoP = localStorage.getItem('hc_cuerpo') || "Hola {{NOMBRE}}, ganaste {{PREMIO}} en {{COMERCIO}}.";

    // 2. Inyecci√≥n de datos (L√≥gica blindada)
    const inyectar = (texto) => {
        return texto.split('{{NOMBRE}}').join(nombre)
                    .split('{{PREMIO}}').join(premio)
                    .split('{{COMERCIO}}').join(comercio);
    };

    const asuntoFinal = inyectar(asuntoP);
    const cuerpoFinal = inyectar(cuerpoP);

    try {
        // 3. Empaquetado de datos para el servidor
        const datos = {
            email: emailDestino.trim(),
            asunto: asuntoFinal,
            cuerpoHtml: cuerpoFinal.replace(/\n/g, '<br>'),
            nombreGanador: nombre,
            cc: `habitatcar@gmail.com${mailCC ? ', ' + mailCC : ''}`,
            pdfB64: "" // Aqu√≠ puedes a√±adir el base64 si generas el PDF
        };

        // 4. Env√≠o al Script de Google
        await fetch(URL_SCRIPT, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'text/plain' }, 
            body: JSON.stringify(datos)
        });

        mostrarToast("‚úÖ Mail enviado correctamente a " + nombre);

    } catch (e) {
        console.error("Error env√≠o:", e);
        mostrarToast("‚ùå Error de conexi√≥n con el servidor", "error");
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
};

// --- RECONSTRUCCI√ìN DE LA TABLA (HISTORIAL) ---
window.mostrarHistorial = async () => {
    const cont = document.getElementById('sorteos-activos');
    cont.innerHTML = '<div class="loading">Cargando historial de √©xitos...</div>';
    
    const snap = await getDocs(collection(db, "comercios"));
    let html = `<h2 style="margin-bottom:20px; color:var(--azul-habitat)"><i class="fas fa-history"></i> Historial de Ganadores</h2>
                <table class="tabla-sorteos">
                <thead><tr><th>Fecha</th><th>Comercio</th><th>Premio</th><th>Ganador</th><th>Acciones</th></tr></thead><tbody>`;

    snap.forEach(docCom => {
        const c = docCom.data();
        if (c.historial_sorteos) {
            c.historial_sorteos.forEach(h => {
                h.ganadores.forEach(g => {
                    // USO DE COMILLAS SIMPLES PARA PROTEGER DATOS CON ESPACIOS
                    html += `<tr>
                        <td>${h.fecha}</td>
                        <td><strong>${h.comercio}</strong></td>
                        <td>${h.premio}</td>
                        <td>${g.nombre}<br><small>${g.email}</small></td>
                        <td>
                            <button class="btn-accion btn-mail" onclick="enviarMail(this, '${g.email}', '${g.nombre}', '${h.premio}', '${h.comercio}', '${c.mail_comercio || ''}')">
                                <i class="fas fa-envelope"></i>
                            </button>
                            <button class="btn-accion btn-wa" onclick="abrirWA('${g.telefono}', '${g.nombre}', '${h.premio}', '${h.comercio}')">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                        </td>
                    </tr>`;
                });
            });
        }
    });
    html += "</tbody></table>";
    cont.innerHTML = html;
};

// ... (Aqu√≠ mantienes tus funciones ejecutarSorteo, cargarActivos, eliminarIndividual, etc. tal cual las ten√≠as) ...

function mostrarToast(mensaje, tipo = "success") { 
    const div = document.createElement('div'); 
    div.className = `toast ${tipo}`; 
    div.innerText = mensaje; 
    document.body.appendChild(div); 
    setTimeout(() => div.remove(), 3000); 
}

// Inicializaci√≥n
document.getElementById('btn-activos').onclick = cargarActivos;
document.getElementById('btn-historial').onclick = window.mostrarHistorial;
document.addEventListener('DOMContentLoaded', cargarActivos);

// Exportaci√≥n global
window.enviarMail = enviarMail;
window.mostrarHistorial = mostrarHistorial;
window.mostrarToast = mostrarToast;
</script>
</body></html>
