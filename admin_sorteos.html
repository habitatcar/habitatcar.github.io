<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Sorteos Elite | H√°bitat-Car</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--azul-habitat: #003d80;
--rojo-cupon: #e60000;
--naranja: #ff8c00;
--celeste: #0288d1;
--verde: #2e7d32;
--blanco: #ffffff;
--gris-texto: #666666;
--oro: #d4af37;
--zona-critica: #dc3545;
--bg-body: #f8f9fa;
--text-color: #333;
--table-bg: white;
--modal-bg: white;
--section-bg: #f8f9fa;
--border-color: #dee2e6;
}
body.dark-mode {
--azul-habitat: #1a5a9c;
--rojo-cupon: #ff4d4d;
--naranja: #ffaa33;
--celeste: #4aa3d1;
--verde: #4caf50;
--bg-body: #1a1a1a;
--text-color: #e0e0e0;
--table-bg: #2d2d2d;
--modal-bg: #2d2d2d;
--section-bg: #3d3d3d;
--border-color: #4d4d4d;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
font-family: 'Segoe UI', system-ui, sans-serif;
background: var(--bg-body);
color: var(--text-color);
line-height: 1.6;
padding-top: 140px;
transition: background-color 0.3s, color 0.3s;
}
.faja-superior { position: fixed; top: 0; left: 0; width: 100%; background: var(--azul-habitat); border-bottom: 4px solid var(--rojo-cupon); z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.faja-contenido { max-width: 1200px; margin: 0 auto; padding: 10px 20px; display: flex; flex-direction: column; gap: 10px; }
.faja-logo { text-align: center; padding: 5px 0; }
.faja-logo img { height: 50px; width: auto; max-width: 200px; }
.faja-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; padding: 5px 0; }
.faja-nav a { padding: 6px 10px; border-radius: 4px; text-decoration: none; color: white; font-weight: 600; font-size: 11px; background: rgba(255,255,255,0.15); transition: all 0.2s; text-transform: uppercase; }
.faja-nav a:hover, .faja-nav a.active { background: var(--rojo-cupon); transform: translateY(-1px); }
.faja-nav a.active { box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
.stats-header {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
padding: 20px;
border-radius: 12px;
margin-bottom: 20px;
}
.stats-header h1 { font-size: 1.8rem; margin-bottom: 8px; }
.stats-header p { opacity: 0.9; font-size: 0.95rem; }
.stats-cards {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 15px;
margin-top: 15px;
}
.stat-card {
background: rgba(255,255,255,0.15);
backdrop-filter: blur(10px);
padding: 15px;
border-radius: 10px;
text-align: center;
border: 1px solid rgba(255,255,255,0.2);
}
.stat-card i { font-size: 24px; margin-bottom: 5px; }
.stat-value { font-size: 24px; font-weight: bold; }
.stat-label { font-size: 12px; opacity: 0.9; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
.btn-primary { background: #667eea; color: white; }
.btn-primary:hover { background: #5568d3; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.btn-warning { background: #ffc107; color: #333; }
.btn-warning:hover { background: #e0a800; }
.btn-info { background: #17a2b8; color: white; }
.btn-dark { background: #343a40; color: white; }
.btn-danger { background: #dc3545; color: white; }
.btn-danger:hover { background: #c82333; }
.btn-purple { background: #6f42c1; color: white; }
.btn-purple:hover { background: #5e35b1; }
.btn-secondary { background: #6c757d; color: white; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }
.btn-sm { padding: 4px 8px; font-size: 0.8rem; }
.table-container { overflow-x: auto; max-height: calc(100vh - 280px); }
table { width: 100%; border-collapse: collapse; background: var(--table-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: opacity 0.3s ease; }
thead { position: sticky; top: 0; z-index: 100; background: #667eea; }
th { background: #667eea; color: white; padding: 14px 12px; text-align: left; white-space: nowrap; }
td { padding: 12px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
tr.finalizado { opacity: 0.7; background-color: rgba(128, 128, 128, 0.1); }
tr.finalizado td { border-bottom-color: #999; }
tr.finalizado .btn-sortear-accion { opacity: 0.5; pointer-events: none; }
.btn-accion { padding: 6px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: white; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap; }
.btn-wa { background: #25D366; }
.btn-wapdf { background: #20a37f; font-weight: 700; }
.btn-wapdf:hover { opacity: 0.88; }
.btn-copy { background: #6c757d; }
.btn-delete { background: #dc3545; }
.btn-delete:hover { background: #c82333; }
.badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.badge-premio { background: #fff3cd; color: #856404; }
.badge-comercio { background: #d1ecf1; color: #0c5460; }
.badge-premios { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-vip { background: #fff8e1; color: #f57f17; font-weight: bold; }
.badge-lead { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-critica { background: #ffebee; color: #c62828; font-weight: bold; animation: pulse 2s infinite; }
.badge-finalizado { background: #6c757d; color: white; font-weight: bold; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.4); } 70% { box-shadow: 0 0 0 10px rgba(220,53,69,0); } 100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); } }
.toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 10px; color: white; z-index: 9999; animation: slideIn 0.3s ease; max-width: 360px; line-height: 1.4; }
.success { background: #28a745; } .error { background: #dc3545; } .warning { background: #ffc107; color: #333; }
@keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
.participantes-cell { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; }
.participantes-row { display: flex; justify-content: space-between; align-items: center; }
.participantes-value { font-weight: bold; padding: 2px 8px; border-radius: 4px; min-width: 30px; text-align: center; }
.valor-lead { background: #e3f2fd; color: #1976d2; }
.valor-vip { background: #fff8e1; color: #f57f17; }
.valor-total { background: #e8f5e9; color: #388e3c; }
.premio-desc { font-size: 0.85rem; color: #666; margin-top: 4px; line-height: 1.4; max-width: 200px; }
.fecha-cell { display: flex; flex-direction: column; gap: 2px; font-size: 0.85rem; min-width: 100px; }
.fecha-principal { font-weight: bold; color: #333; }
.hora-secundaria { color: #666; font-size: 0.8rem; }
.timestamp-badge { font-size: 0.75rem; color: #666; background: #f1f1f1; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }
.logo-mini { height: 80px; width: auto; max-width: 120px; object-fit: contain; display: block; margin: 0 auto; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
.modal-content { background: var(--modal-bg); padding: 25px; border-radius: 16px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.modal-content input { width: 100%; padding: 10px; margin: 15px 0; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-body); color: var(--text-color); }
.modal-buttons { display: flex; gap: 10px; justify-content: center; }
.checkbox-cell { text-align: center; width: 50px; }
.checkbox-cell input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.bulk-actions { display: none; gap: 10px; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107; }
.bulk-actions.active { display: flex; align-items: center; }
.selected-count { font-weight: bold; color: #856404; }
.slider-group { margin-bottom: 10px; }
.slider-group > .sg-label { font-size: 11px; font-weight: bold; color: #444; display: block; margin-bottom: 3px; }
.slider-row { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
.slider-row span.lbl { font-size: 10px; color: #888; width: 16px; flex-shrink: 0; text-align: center; }
.slider-row input[type=range] { flex: 1; height: 4px; }
.slider-row span.val { font-size: 10px; font-weight: bold; color: var(--azul-habitat); min-width: 22px; text-align: right; }
.pdf-section { background: var(--section-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; }
.pdf-section h4 { font-size: 12px; color: var(--azul-habitat); margin-bottom: 7px; display: flex; align-items: center; gap: 4px; }
.txt-field { width: 100%; padding: 5px 7px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; margin-top: 3px; font-family: inherit; background: var(--modal-bg); color: var(--text-color); }
.inyectado-tag { font-size: 9px; background: #e3f2fd; color: #1976d2; padding: 1px 5px; border-radius: 10px; margin-left: 4px; }
.color-row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
.color-row label { font-size: 11px; width: 80px; }
.color-row input[type=color] { width: 50px; height: 25px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
.font-row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
.font-row label { font-size: 11px; width: 80px; }
.font-row select { flex: 1; padding: 3px; font-size: 11px; border-radius: 4px; border: 1px solid #ccc; background: var(--modal-bg); color: var(--text-color); }
.template-buttons { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
.template-btn { padding: 5px 8px; font-size: 10px; border: none; border-radius: 4px; cursor: pointer; background: var(--azul-habitat); color: white; }
.upload-btn { background: var(--celeste); color: white; padding: 5px 10px; font-size: 11px; border: none; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 5px; }
.dark-mode-toggle { position: fixed; bottom: 20px; right: 20px; background: var(--azul-habitat); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1001; border: none; font-size: 24px; }
.btn-email { background: #4285F4; font-weight: 700; }
.btn-email:hover { background: #3367D6; }
@media (max-width: 768px) {
.faja-nav { gap: 3px; }
.faja-nav a { font-size: 9px; padding: 4px 6px; }
body { padding-top: 120px; }
.logo-mini { height: 70px; }
}
</style>
</head>
<body>
<div class="faja-superior">
<div class="faja-contenido">
<div class="faja-logo"><a href="index.html"><img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="H√°bitat-Car"></a></div>
<nav class="faja-nav">
<a href="admin_comercios.html">COMERCIOS</a><a href="admin_leads.html">LEADS</a><a href="admin_vips.html">VIPS</a>
<a href="admin_tokens_vip.html">TOKENS VIP</a><a href="admin_curioso.html">CURIOSO</a><a href="admin_estadisticas.html">ESTAD√çSTICAS</a>
<a href="admin_logs.html">LOG</a><a href="admin_tutoriales.html">TUTORIALES</a><a href="index.html">PANEL</a>
<a href="admin_legales.html">LEGALES</a><a href="admin_sorteos.html" class="active">SORTEOS</a>
</nav>
</div>
</div>
<div class="container">
<div class="stats-header">
<h1>üèÜ SORTEOS PREMIUM</h1>
<p>Panel de Sorteos Elite | H√°bitat-Car</p>
<div class="stats-cards" id="stats-cards">
<div class="stat-card"><i class="fas fa-trophy"></i><div class="stat-value" id="stat-total">0</div><div class="stat-label">Sorteos</div></div>
<div class="stat-card"><i class="fas fa-users"></i><div class="stat-value" id="stat-ganadores">0</div><div class="stat-label">Ganadores</div></div>
<div class="stat-card"><i class="fas fa-store"></i><div class="stat-value" id="stat-top">-</div><div class="stat-label">Top Comercio</div></div>
<div class="stat-card"><i class="fas fa-user-plus"></i><div class="stat-value" id="stat-participantes">0</div><div class="stat-label">Participantes</div></div>
</div>
</div>
<div class="controls">
<button class="btn btn-success" id="btn-activos">SORTEOS ACTIVOS</button>
<button class="btn btn-warning" id="btn-historial">HISTORIAL DE √âXITOS</button>
<button onclick="abrirEditorPDF()" title="Editar Ticket PDF"
style="background:var(--azul-habitat); color:white; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:600; font-size:0.85rem; display:inline-flex; align-items:center; gap:6px;">
<i class="fas fa-file-pdf"></i> TICKET PDF
</button>
<button onclick="abrirEditorWA()" title="Editar Mensaje WhatsApp"
style="background:#25D366; color:white; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:600; font-size:0.85rem; display:inline-flex; align-items:center; gap:6px;">
<i class="fab fa-whatsapp"></i> MENSAJE WA
</button>
</div>
<div id="bulk-actions" class="bulk-actions">
<span class="selected-count"><i class="fas fa-check-circle"></i> <span id="selected-count">0</span> seleccionado(s)</span>
<button class="btn btn-danger" id="btn-eliminar-seleccionados"><i class="fas fa-trash"></i> ELIMINAR SELECCIONADOS</button>
<button class="btn btn-warning" onclick="desmarcarTodos()"><i class="fas fa-times"></i> CANCELAR</button>
</div>
<div class="table-container">
<table>
<thead>
<tr id="tabla-headers">
<th class="checkbox-cell" id="header-checkbox" style="display:none;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
<th>FECHA</th><th>LOGO</th><th>COMERCIO / PREMIO</th><th>PARTICIPANTES</th><th>ACCIONES</th><th>PREMIOS</th>
</tr>
</thead>
<tbody id="tabla-sorteos"></tbody>
</table>
</div>
</div>
<!-- MODAL CONFIRMACI√ìN SORTEO -->
<div id="popup-confirmacion" class="modal" style="display:none;">
<div class="modal-content">
<h3 style="color:var(--azul-habitat); margin-bottom:15px;">üéâ ¬°SORTEO REALIZADO!</h3>
<p id="texto-sorteo" style="font-size:1.1rem; margin-bottom:20px; line-height:1.5;"></p>
<div id="lista-ganadores-popup" style="text-align:left; margin-bottom:20px;"></div>
<button class="btn btn-primary" onclick="irAlHistorial()">IR AL HISTORIAL DE √âXITOS</button>
<button class="btn btn-warning" onclick="cerrarModalSorteo()" style="margin-top:10px;">SEGUIR AQU√ç</button>
</div>
</div>
<!-- MODAL PARA SOLICITAR CLAVE -->
<div id="modal-clave" class="modal" style="display:none;">
<div class="modal-content">
<h3 style="color:var(--azul-habitat); margin-bottom:15px;">üîê AUTORIZACI√ìN REQUERIDA</h3>
<p id="modal-clave-mensaje" style="margin-bottom:15px;">Ingrese la clave de comercio o maestra</p>
<input type="password" id="modal-clave-input" placeholder="Clave de acceso">
<div class="modal-buttons">
<button class="btn btn-success" onclick="validarClaveModal()">CONFIRMAR</button>
<button class="btn btn-danger" onclick="cerrarModalClave()">CANCELAR</button>
</div>
</div>
</div>
<!-- MODAL EDITOR PDF -->
<div id="modalPDF" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.92); z-index:10000; overflow-y:auto; padding:16px; box-sizing:border-box;">
<div style="display:flex; flex-wrap:wrap; justify-content:center; gap:18px; max-width:1060px; margin:auto; padding-top:8px;">
<div style="background:var(--modal-bg); padding:16px; border-radius:14px; width:360px; color:#333; flex-shrink:0; max-height:88vh; overflow-y:auto;">
<h3 style="color:var(--azul-habitat); margin-bottom:10px; font-size:15px;">üé® Dise√±o del Ticket</h3>
<!-- PLANTILLAS R√ÅPIDAS -->
<div class="template-buttons">
<button class="template-btn" onclick="cargarPlantilla('clasica')">üìÑ Cl√°sica</button>
<button class="template-btn" onclick="cargarPlantilla('elegante')">‚ú® Elegante</button>
<button class="template-btn" onclick="cargarPlantilla('destacada')">üåü Destacada</button>
<button class="template-btn" onclick="cargarPlantilla('minimalista')">‚ö™ Minimalista</button>
</div>
<hr style="margin-bottom:10px;">
<!-- FONDO + UPLOAD -->
<div class="pdf-section">
<h4>üñºÔ∏è Fondo</h4>
<label style="font-size:11px; color:#555;">URL Imagen:</label>
<input type="text" id="cfg_bg" class="txt-field" oninput="actualizarPrevia()" placeholder="https://...">
<button class="upload-btn" onclick="subirImagenFondo()"><i class="fas fa-upload"></i> Subir desde PC</button>
<input type="file" id="upload-bg" accept="image/*" style="display:none;" onchange="procesarImagenSubida(event)">
</div>
<!-- COLORES POR TEXTO -->
<div class="pdf-section">
<h4>üé® Colores individuales</h4>
<div class="color-row"><label>Nombre:</label><input type="color" id="cfg_color_t1" oninput="actualizarPrevia()" value="#000000"></div>
<div class="color-row"><label>Premio:</label><input type="color" id="cfg_color_t2" oninput="actualizarPrevia()" value="#000000"></div>
<div class="color-row"><label>Descripci√≥n:</label><input type="color" id="cfg_color_t6" oninput="actualizarPrevia()" value="#000000"></div>
<div class="color-row"><label>Comercio:</label><input type="color" id="cfg_color_t3" oninput="actualizarPrevia()" value="#000000"></div>
<div class="color-row"><label>Frase:</label><input type="color" id="cfg_color_t4" oninput="actualizarPrevia()" value="#000000"></div>
<div class="color-row"><label>Pie:</label><input type="color" id="cfg_color_t5" oninput="actualizarPrevia()" value="#666666"></div>
</div>
<!-- FUENTES POR TEXTO -->
<div class="pdf-section">
<h4>‚úíÔ∏è Fuentes</h4>
<div class="font-row"><label>Nombre:</label><select id="cfg_font_t1" onchange="actualizarPrevia()"><option value="helvetica">Helvetica</option><option value="times">Times</option><option value="courier">Courier</option><option value="arial">Arial</option></select></div>
<div class="font-row"><label>Premio:</label><select id="cfg_font_t2" onchange="actualizarPrevia()"><option value="helvetica">Helvetica</option><option value="times">Times</option><option value="courier">Courier</option><option value="arial">Arial</option></select></div>
<div class="font-row"><label>Descripci√≥n:</label><select id="cfg_font_t6" onchange="actualizarPrevia()"><option value="helvetica">Helvetica</option><option value="times">Times</option><option value="courier">Courier</option><option value="arial">Arial</option></select></div>
<div class="font-row"><label>Comercio:</label><select id="cfg_font_t3" onchange="actualizarPrevia()"><option value="helvetica">Helvetica</option><option value="times">Times</option><option value="courier">Courier</option><option value="arial">Arial</option></select></div>
<div class="font-row"><label>Frase:</label><select id="cfg_font_t4" onchange="actualizarPrevia()"><option value="helvetica">Helvetica</option><option value="times">Times</option><option value="courier">Courier</option><option value="arial">Arial</option></select></div>
<div class="font-row"><label>Pie:</label><select id="cfg_font_t5" onchange="actualizarPrevia()"><option value="helvetica">Helvetica</option><option value="times">Times</option><option value="courier">Courier</option><option value="arial">Arial</option></select></div>
</div>
<!-- LOGOS -->
<div class="pdf-section">
<h4>üî¥ Logo Comercio <span class="inyectado-tag">auto</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_l1x" min="0" max="60" value="5" oninput="actualizarPrevia()"><span class="val" id="v_l1x">5</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_l1y" min="0" max="140" value="5" oninput="actualizarPrevia()"><span class="val" id="v_l1y">5</span></div>
<div class="slider-row"><span class="lbl">üìê</span><input type="range" id="cfg_l1s" min="8" max="50" value="20" oninput="actualizarPrevia()"><span class="val" id="v_l1s">20</span></div>
</div>
<div class="pdf-section">
<h4>üîµ Logo H√°bitat-Car <span class="inyectado-tag">auto</span></h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_l2x" min="0" max="60" value="45" oninput="actualizarPrevia()"><span class="val" id="v_l2x">45</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_l2y" min="0" max="140" value="5" oninput="actualizarPrevia()"><span class="val" id="v_l2y">5</span></div>
<div class="slider-row"><span class="lbl">üìê</span><input type="range" id="cfg_l2s" min="8" max="50" value="20" oninput="actualizarPrevia()"><span class="val" id="v_l2s">20</span></div>
</div>
<!-- TEXTOS -->
<div class="pdf-section">
<h4>‚úèÔ∏è Nombre</h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t1x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t1x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t1y" min="20" max="155" value="70" oninput="actualizarPrevia()"><span class="val" id="v_t1y">70</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t1s" min="8" max="32" value="22" oninput="actualizarPrevia()"><span class="val" id="v_t1s">22</span></div>
</div>
<div class="pdf-section">
<h4>‚úèÔ∏è Premio</h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t2x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t2x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t2y" min="20" max="155" value="90" oninput="actualizarPrevia()"><span class="val" id="v_t2y">90</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t2s" min="6" max="28" value="16" oninput="actualizarPrevia()"><span class="val" id="v_t2s">16</span></div>
</div>
<div class="pdf-section">
<h4>‚úèÔ∏è Descripci√≥n</h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t6x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t6x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t6y" min="20" max="155" value="105" oninput="actualizarPrevia()"><span class="val" id="v_t6y">105</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t6s" min="6" max="28" value="12" oninput="actualizarPrevia()"><span class="val" id="v_t6s">12</span></div>
</div>
<div class="pdf-section">
<h4>‚úèÔ∏è Comercio</h4>
<div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t3x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t3x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t3y" min="20" max="155" value="118" oninput="actualizarPrevia()"><span class="val" id="v_t3y">118</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t3s" min="6" max="28" value="14" oninput="actualizarPrevia()"><span class="val" id="v_t3s">14</span></div>
</div>
<div class="pdf-section">
<h4>‚úèÔ∏è Frase libre</h4>
<input type="text" id="cfg_t4txt" class="txt-field" oninput="actualizarPrevia()" value="¬°Felicitaciones!">
<div class="slider-row" style="margin-top:5px;"><span class="lbl">X</span><input type="range" id="cfg_t4x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t4x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t4y" min="20" max="155" value="45" oninput="actualizarPrevia()"><span class="val" id="v_t4y">45</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t4s" min="6" max="28" value="14" oninput="actualizarPrevia()"><span class="val" id="v_t4s">14</span></div>
</div>
<div class="pdf-section">
<h4>‚úèÔ∏è Pie de p√°gina</h4>
<input type="text" id="cfg_t5txt" class="txt-field" oninput="actualizarPrevia()" value="H√°bitat-Car">
<div class="slider-row" style="margin-top:5px;"><span class="lbl">X</span><input type="range" id="cfg_t5x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t5x">40</span></div>
<div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t5y" min="20" max="158" value="148" oninput="actualizarPrevia()"><span class="val" id="v_t5y">148</span></div>
<div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t5s" min="5" max="16" value="8" oninput="actualizarPrevia()"><span class="val" id="v_t5s">8</span></div>
</div>
<button onclick="guardarConfigPDF()" style="width:100%; background:var(--verde); color:white; padding:11px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:13px; margin-top:4px;">üíæ GUARDAR DISE√ëO</button>
<button onclick="cerrarModales()" style="width:100%; background:none; border:none; color:#dc3545; margin-top:6px; cursor:pointer; padding:7px; font-size:12px;">‚úï Cerrar sin guardar</button>
</div>
<!-- VISTA PREVIA REAL -->
<div style="flex-shrink:0;">
<p style="color:rgba(255,255,255,0.65); text-align:center; font-size:11px; margin-bottom:6px;">Vista previa REAL (escala √ó3.25)</p>
<div id="previa_ticket" style="width:260px; height:520px; background:#ddd; border-radius:14px; border:5px solid #222; position:relative; overflow:hidden; background-size:cover; background-position:center;">
<div id="prev_l1" style="position:absolute; border:2px dashed #e60000; background:rgba(255,255,255,0.5); font-size:8px; display:flex; align-items:center; justify-content:center; color:#c00; font-weight:bold;">L1</div>
<div id="prev_l2" style="position:absolute; border:2px dashed #003d80; background:rgba(255,255,255,0.5); font-size:8px; display:flex; align-items:center; justify-content:center; color:#003d80; font-weight:bold;">L2</div>
<div id="prev_t1" style="position:absolute; font-weight:bold; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">JUAN CARLOS P√âREZ</div>
<div id="prev_t2" style="position:absolute; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">CENA PARA DOS</div>
<div id="prev_t6" style="position:absolute; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">CENA COMPLETA CON VINO</div>
<div id="prev_t3" style="position:absolute; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">RESTAURANTE EL CHEFF</div>
<div id="prev_t4" style="position:absolute; font-weight:bold; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">¬°Felicitaciones!</div>
<div id="prev_t5" style="position:absolute; white-space:nowrap; transform:translateX(-50%); color:#666; pointer-events:none; font-size:8px;">H√°bitat-Car ‚Ä¢ 22/02/2026</div>
</div>
</div>
</div>
</div>
<!-- MODAL WHATSAPP -->
<div id="modalWA" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center;">
<div style="background:var(--modal-bg); padding:25px; border-radius:15px; width:90%; max-width:440px; color:var(--text-color);">
<h3 style="color:#25D366; margin-bottom:8px;"><i class="fab fa-whatsapp"></i> Mensaje de WhatsApp</h3>
<div style="background:#fff8e1; border:1px solid #ffc107; border-radius:8px; padding:10px; margin-bottom:12px; font-size:12px; color:#555;">
<b>‚ö†Ô∏è Sobre el PDF:</b> WhatsApp no permite adjuntar archivos por URL. El PDF se descarga en tu dispositivo y WA se abre con el mensaje listo. Adjunt√° el PDF desde tu galer√≠a.
</div>
<label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Mensaje personalizable:</label>
<textarea id="cfg_wa_msg" style="width:100%; height:170px; padding:10px; font-family:sans-serif; border:1px solid #ccc; border-radius:6px; font-size:12px; resize:vertical; line-height:1.5; background:var(--modal-bg); color:var(--text-color);"></textarea>
<div style="font-size:11px; color:#666; margin:8px 0 12px; background:#f8f9fa; padding:8px; border-radius:5px; line-height:1.7;">
Variables: <b>{{NOMBRE}}</b>, <b>{{PREMIO}}</b>, <b>{{COMERCIO}}</b>, <b style="color:#e60000;">{{DESCRIPCION}}</b>
</div>
<button onclick="guardarConfigWA()" style="width:100%; background:#25D366; color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">üíæ GUARDAR MENSAJE</button>
<button onclick="cerrarModales()" style="width:100%; background:none; border:none; color:#dc3545; margin-top:6px; cursor:pointer; padding:8px; font-size:13px;">‚úï Cerrar</button>
</div>
</div>
<!-- BOT√ìN MODO OSCURO -->
<div class="dark-mode-toggle" onclick="toggleDarkMode()" id="darkModeToggle">üåô</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, where, addDoc, serverTimestamp, getDocs, doc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

// ============================================
// CONSTANTES Y CONFIGURACI√ìN
// ============================================
const CLAVE_MAESTRA = "HABITAT_MASTER_2026";
const LOGO_DEFAULT  = "https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true";
const LOGO_HABITAT  = "https://raw.githubusercontent.com/habitatcar/habitatcar.github.io/refs/heads/main/logo_redondo.png";
const GAS_URL = "https://script.google.com/macros/s/AKfycbwWqItLbuGollI4F6OBDrHHoWwrvSJz88CWp1Wutt5hPWbqPUaATtIxVVv-wHOu3DGLbQ/exec";

const WA_DEFAULT = `üéâüèÜ ¬°Hola {{NOMBRE}}! ¬°Felicitaciones!
Ganaste el sorteo üéÅ *{{PREMIO}}*
consistente en *{{DESCRIPCION}}*
realizado por üè™ *{{COMERCIO}}*.
üìé Adjunto tu ticket ganador oficial.
‚ö†Ô∏è *¬°ATENCI√ìN ‚Äî NO TE DUERMAS!* ‚ö†Ô∏è
Ten√©s *30 d√≠as* para presentarte a reclamar tu premio.
‚è∞ Si dej√°s pasar los 30 d√≠as ‚ùå *perd√©s el premio* ‚ùå
üò¥üí§ ¬°No dejes pasar esta oportunidad √∫nica!
‚Äî Equipo H√°bitat-Car üöóüè†`;

const firebaseConfig = {
    apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
    authDomain: "habitatcar-pro.firebaseapp.com",
    projectId: "habitatcar-pro",
    storageBucket: "habitatcar-pro.firebasestorage.app",
    messagingSenderId: "311691258694",
    appId: "1:311691258694:web:17a09051dcea7707af9347"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// ============================================
// ESTADO GLOBAL
// ============================================
const state = {
    vistaActual: 'activos',
    itemsSeleccionados: new Set(),
    listenerActivos: null,
    listenerHistorial: null,
    callbackClave: null
};

// ============================================
// UTILIDADES
// ============================================
const proxyURL = (url) => {
    if (!url) return url;
    if (url.includes('raw.githubusercontent.com') || url.includes('github.com')) return url;
    if (url.includes('firebasestorage.googleapis.com')) {
        return `https://corsproxy.io/?${encodeURIComponent(url)}`;
    }
    return url;
};

const mostrarToast = (msg, tipo = "success") => {
    const d = document.createElement('div');
    d.className = `toast ${tipo}`;
    d.innerText = msg;
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 3500);
};

const formatearFechaHora = (fechaISO) => {
    if (!fechaISO) return null;
    try {
        const [fp, hp] = fechaISO.split('T');
        const [a, m, d] = fp.split('-');
        const [h, min] = hp.split(':');
        return { fecha: `${d}/${m}/${a}`, hora: `${h}:${min} Hs.` };
    } catch (e) {
        return null;
    }
};

const normalizarTelefonoAR = (n) => {
    if (!n) return null;
    let s = n.toString().replace(/\D/g,'');
    if (s.length===10) return '549'+s;
    if (s.startsWith('54')&&!s.startsWith('549')) return '549'+s.substring(2);
    return s.startsWith('549')?s:'549'+s;
};

// ============================================
// MODO OSCURO
// ============================================
window.toggleDarkMode = () => {
    document.body.classList.toggle('dark-mode');
    const toggle = document.getElementById('darkModeToggle');
    toggle.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
};

if (localStorage.getItem('darkMode') === 'dark') {
    document.body.classList.add('dark-mode');
    document.getElementById('darkModeToggle').textContent = '‚òÄÔ∏è';
}

// ============================================
// ESTAD√çSTICAS
// ============================================
const actualizarEstadisticas = async () => {
    try {
        const snap = await getDocs(collection(db, "historial_sorteos"));
        let totalGanadores = 0;
        let comercioCount = {};
        let participantesSet = new Set();
        
        snap.docs.forEach(doc => {
            const h = doc.data();
            if (h.ganadores) {
                totalGanadores += h.ganadores.length;
                h.ganadores.forEach(g => {
                    if (g.celular) participantesSet.add(g.celular);
                });
            }
            if (h.comercio) {
                comercioCount[h.comercio] = (comercioCount[h.comercio] || 0) + (h.ganadores?.length || 0);
            }
        });
        
        let topComercio = '-';
        let maxGanadores = 0;
        for (const [comercio, count] of Object.entries(comercioCount)) {
            if (count > maxGanadores) {
                maxGanadores = count;
                topComercio = comercio;
            }
        }
        
        document.getElementById('stat-total').textContent = snap.size;
        document.getElementById('stat-ganadores').textContent = totalGanadores;
        document.getElementById('stat-top').textContent = topComercio;
        document.getElementById('stat-participantes').textContent = participantesSet.size;
    } catch(e) {
        console.error("Error actualizando estad√≠sticas:", e);
    }
};

// ============================================
// CONFIGURACI√ìN PDF Y WA
// ============================================
const leerMsgWA  = () => localStorage.getItem('hc_wa_v3') || WA_DEFAULT;
const leerCfgPDF = () => {
    try {
        return JSON.parse(localStorage.getItem('hc_pdf_v3')) || {};
    } catch(e) {
        return {};
    }
};

// ============================================
// EDITOR PDF
// ============================================
window.subirImagenFondo = () => {
    document.getElementById('upload-bg').click();
};

window.procesarImagenSubida = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('cfg_bg').value = e.target.result;
        actualizarPrevia();
        mostrarToast("‚úÖ Imagen cargada como fondo", "success");
    };
    reader.readAsDataURL(file);
};

window.cargarPlantilla = (tipo) => {
    const plantillas = {
        clasica: { l1x:5, l1y:5, l1s:20, l2x:45, l2y:5, l2s:20, t1x:40, t1y:70, t1s:22, t2x:40, t2y:90, t2s:16, t6x:40, t6y:105, t6s:12, t3x:40, t3y:118, t3s:14, t4x:40, t4y:45, t4s:14, t5x:40, t5y:148, t5s:8, t4txt:'¬°Felicitaciones!', t5txt:'H√°bitat-Car' },
        elegante: { l1x:10, l1y:10, l1s:15, l2x:40, l2y:10, l2s:15, t1x:40, t1y:65, t1s:18, t2x:40, t2y:85, t2s:14, t6x:40, t6y:100, t6s:10, t3x:40, t3y:115, t3s:12, t4x:40, t4y:45, t4s:12, t5x:40, t5y:150, t5s:7, t4txt:'Enhorabuena', t5txt:'H√°bitat-Car' },
        destacada: { l1x:5, l1y:5, l1s:25, l2x:45, l2y:5, l2s:25, t1x:40, t1y:75, t1s:28, t2x:40, t2y:95, t2s:20, t6x:40, t6y:110, t6s:14, t3x:40, t3y:123, t3s:16, t4x:40, t4y:45, t4s:16, t5x:40, t5y:148, t5s:9, t4txt:'¬°GRAN GANADOR!', t5txt:'H√°bitat-Car' },
        minimalista: { l1x:5, l1y:5, l1s:18, l2x:45, l2y:5, l2s:18, t1x:40, t1y:68, t1s:20, t2x:40, t2y:88, t2s:14, t6x:40, t6y:103, t6s:10, t3x:40, t3y:116, t3s:12, t4x:40, t4y:45, t4s:12, t5x:40, t5y:148, t5s:7, t4txt:'Gracias', t5txt:'HC' }
    };
    
    const p = plantillas[tipo];
    if (!p) return;
    
    Object.keys(p).forEach(key => {
        const el = document.getElementById(`cfg_${key}`);
        if (el) el.value = p[key];
    });
    actualizarPrevia();
};

window.abrirEditorPDF = () => {
    const p = leerCfgPDF();
    document.getElementById('cfg_bg').value = p.bg || '';
    
    ['l1','l2','t1','t2','t3','t4','t5','t6'].forEach(pref => {
        ['x','y','s'].forEach(suf => {
            const el = document.getElementById(`cfg_${pref}${suf}`);
            if (el) el.value = p[`${pref}${suf}`] ?? el.getAttribute('value');
        });
    });
    
    ['t4txt','t5txt'].forEach(id => {
        const el = document.getElementById(`cfg_${id}`);
        if (el) el.value = p[id] ?? el.getAttribute('value');
    });
    
    ['t1','t2','t3','t4','t5','t6'].forEach(t => {
        document.getElementById(`cfg_color_${t}`).value = p[`color_${t}`] || '#000000';
        document.getElementById(`cfg_font_${t}`).value = p[`font_${t}`] || 'helvetica';
    });
    document.getElementById('cfg_color_t5').value = p.color_t5 || '#666666';
    
    document.getElementById('modalPDF').style.display = 'flex';
    actualizarPrevia();
};

window.actualizarPrevia = () => {
    const bg = document.getElementById('cfg_bg').value;
    const prev = document.getElementById('previa_ticket');
    prev.style.backgroundImage = bg ? `url(${bg})` : 'none';
    if (!bg) prev.style.backgroundColor = '#ddd';
    
    const f = 3.25;
    
    const movEl = (elId, xId, yId, sId, vxId, vyId, vsId, isLogo) => {
        const x = parseInt(document.getElementById(xId)?.value) || 0;
        const y = parseInt(document.getElementById(yId)?.value) || 0;
        const s = parseInt(document.getElementById(sId)?.value) || 10;
        
        if (vxId) document.getElementById(vxId).textContent = x;
        if (vyId) document.getElementById(vyId).textContent = y;
        if (vsId) document.getElementById(vsId).textContent = s;
        
        const el = document.getElementById(elId);
        if (!el) return;
        
        el.style.left = (x * f) + 'px';
        el.style.top = (y * f) + 'px';
        
        if (isLogo) {
            el.style.width = (s * f) + 'px';
            el.style.height = (s * f) + 'px';
        } else {
            el.style.fontSize = Math.round(s * f / 3.8) + 'px';
        }
    };
    
    const fontMap = { helvetica: 'Helvetica', times: 'Times New Roman', courier: 'Courier New', arial: 'Arial' };
    
    ['t1','t2','t3','t4','t5','t6'].forEach(t => {
        const colorEl = document.getElementById(`cfg_color_${t}`);
        const fontEl = document.getElementById(`cfg_font_${t}`);
        const prevEl = document.getElementById(`prev_${t}`);
        
        if (prevEl) {
            if (colorEl) prevEl.style.color = colorEl.value;
            if (fontEl) prevEl.style.fontFamily = fontMap[fontEl.value] || 'Helvetica';
        }
    });
    
    movEl('prev_l1','cfg_l1x','cfg_l1y','cfg_l1s','v_l1x','v_l1y','v_l1s', true);
    movEl('prev_l2','cfg_l2x','cfg_l2y','cfg_l2s','v_l2x','v_l2y','v_l2s', true);
    movEl('prev_t1','cfg_t1x','cfg_t1y','cfg_t1s','v_t1x','v_t1y','v_t1s', false);
    movEl('prev_t2','cfg_t2x','cfg_t2y','cfg_t2s','v_t2x','v_t2y','v_t2s', false);
    movEl('prev_t6','cfg_t6x','cfg_t6y','cfg_t6s','v_t6x','v_t6y','v_t6s', false);
    movEl('prev_t3','cfg_t3x','cfg_t3y','cfg_t3s','v_t3x','v_t3y','v_t3s', false);
    movEl('prev_t4','cfg_t4x','cfg_t4y','cfg_t4s','v_t4x','v_t4y','v_t4s', false);
    movEl('prev_t5','cfg_t5x','cfg_t5y','cfg_t5s','v_t5x','v_t5y','v_t5s', false);
    
    document.getElementById('prev_t4').textContent = document.getElementById('cfg_t4txt')?.value || '¬°Felicitaciones!';
    document.getElementById('prev_t5').textContent = (document.getElementById('cfg_t5txt')?.value || 'H√°bitat-Car') + ' ‚Ä¢ 22/02/2026';
};

window.guardarConfigPDF = () => {
    const gv = id => document.getElementById(id)?.value;
    const gi = id => parseInt(gv(id)) || 0;
    
    const data = {
        bg: gv('cfg_bg'),
        l1x: gi('cfg_l1x'), l1y: gi('cfg_l1y'), l1s: gi('cfg_l1s'),
        l2x: gi('cfg_l2x'), l2y: gi('cfg_l2y'), l2s: gi('cfg_l2s'),
        t1x: gi('cfg_t1x'), t1y: gi('cfg_t1y'), t1s: gi('cfg_t1s'),
        t2x: gi('cfg_t2x'), t2y: gi('cfg_t2y'), t2s: gi('cfg_t2s'),
        t3x: gi('cfg_t3x'), t3y: gi('cfg_t3y'), t3s: gi('cfg_t3s'),
        t4x: gi('cfg_t4x'), t4y: gi('cfg_t4y'), t4s: gi('cfg_t4s'), t4txt: gv('cfg_t4txt'),
        t5x: gi('cfg_t5x'), t5y: gi('cfg_t5y'), t5s: gi('cfg_t5s'), t5txt: gv('cfg_t5txt'),
        t6x: gi('cfg_t6x'), t6y: gi('cfg_t6y'), t6s: gi('cfg_t6s'),
        color_t1: gv('cfg_color_t1'), color_t2: gv('cfg_color_t2'), color_t3: gv('cfg_color_t3'),
        color_t4: gv('cfg_color_t4'), color_t5: gv('cfg_color_t5'), color_t6: gv('cfg_color_t6'),
        font_t1: gv('cfg_font_t1'), font_t2: gv('cfg_font_t2'), font_t3: gv('cfg_font_t3'),
        font_t4: gv('cfg_font_t4'), font_t5: gv('cfg_font_t5'), font_t6: gv('cfg_font_t6')
    };
    
    localStorage.setItem('hc_pdf_v3', JSON.stringify(data));
    mostrarToast("‚úÖ Dise√±o de Ticket guardado", "success");
    cerrarModales();
};

// ============================================
// EDITOR WHATSAPP
// ============================================
window.abrirEditorWA = () => {
    document.getElementById('cfg_wa_msg').value = leerMsgWA();
    document.getElementById('modalWA').style.display = 'flex';
};

window.guardarConfigWA = () => {
    const msg = document.getElementById('cfg_wa_msg').value;
    if (!msg.trim()) return mostrarToast("‚ö†Ô∏è El mensaje no puede estar vac√≠o", "warning");
    localStorage.setItem('hc_wa_v3', msg);
    mostrarToast("‚úÖ Mensaje guardado", "success");
    cerrarModales();
};

window.cerrarModales = () => {
    document.getElementById('modalPDF').style.display = 'none';
    document.getElementById('modalWA').style.display = 'none';
    document.getElementById('modal-clave').style.display = 'none';
};

// ============================================
// MODAL DE CLAVE
// ============================================
window.abrirModalClave = (mensaje, callback) => {
    document.getElementById('modal-clave-mensaje').textContent = mensaje;
    document.getElementById('modal-clave-input').value = '';
    document.getElementById('modal-clave').style.display = 'flex';
    state.callbackClave = callback;
};

window.cerrarModalClave = () => {
    document.getElementById('modal-clave').style.display = 'none';
    state.callbackClave = null;
};

window.validarClaveModal = async () => {
    const clave = document.getElementById('modal-clave-input').value;
    if (!clave || !state.callbackClave) return;
    const resultado = await state.callbackClave(clave);
    if (resultado) cerrarModalClave();
};

// ============================================
// EMAIL
// ============================================
window.enviarEmailGanador = async (nombre, premio, comercio, email) => {
    if (!email) {
        mostrarToast("‚ö†Ô∏è Este ganador no tiene email registrado", "warning");
        return;
    }
    
    const payload = {
        email: email,
        asunto: `¬°Felicitaciones! Ganaste en ${comercio}`,
        cuerpoHtml: `
            <h2>¬°FELICITACIONES ${nombre}!</h2>
            <p>Has resultado ganador del sorteo de <strong>${premio}</strong> en <strong>${comercio}</strong>.</p>
            <p>Comun√≠cate con el comercio para reclamar tu premio.</p>
            <br>
            <p>Saludos,<br>Equipo H√°bitat-Car</p>
        `,
        cc: ''
    };
    
    try {
        await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        mostrarToast(`üìß Email enviado a ${email}`, "success");
    } catch(error) {
        console.error("Error enviando email:", error);
        mostrarToast("‚ö†Ô∏è No se pudo enviar el email", "warning");
    }
};

const enviarEmailAutomatico = async (ganadores, comercio, premio) => {
    for (const g of ganadores) {
        if (g.email) {
            const payload = {
                email: g.email,
                asunto: `¬°Felicitaciones! Ganaste en ${comercio}`,
                cuerpoHtml: `
                    <h2>¬°FELICITACIONES ${g.nombreMostrar}!</h2>
                    <p>Has resultado ganador del sorteo de <strong>${premio}</strong> en <strong>${comercio}</strong>.</p>
                    <p>Comun√≠cate con el comercio para reclamar tu premio.</p>
                    <br>
                    <p>Saludos,<br>Equipo H√°bitat-Car</p>
                `,
                cc: 'habitatcar@gmail.com'
            };
            
            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                console.log(`‚úÖ Email enviado a ${g.email}`);
            } catch(e) {
                console.error(`‚ùå Error enviando email a ${g.email}:`, e);
            }
        }
    }
};

// ============================================
// BULK ACTIONS / CHECKBOXES
// ============================================
window.toggleSelectAll = () => {
    const sa = document.getElementById('select-all');
    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.checked = sa.checked;
        sa.checked ? state.itemsSeleccionados.add(cb.dataset.id) : state.itemsSeleccionados.delete(cb.dataset.id);
    });
    actualizarBulkActions();
};

window.actualizarBulkActions = () => {
    const bulk = document.getElementById('bulk-actions');
    const btnEliminar = document.getElementById('btn-eliminar-seleccionados');
    
    if (state.itemsSeleccionados.size > 0) {
        bulk.classList.add('active');
        document.getElementById('selected-count').textContent = state.itemsSeleccionados.size;
        document.getElementById('select-all').checked = 
            state.itemsSeleccionados.size === document.querySelectorAll('.row-checkbox').length;
        
        if (btnEliminar) {
            if (state.vistaActual === 'activos') {
                btnEliminar.innerHTML = '<i class="fas fa-trash"></i> ELIMINAR SORTEOS';
                btnEliminar.onclick = eliminarSeleccionadosActivos;
            } else {
                btnEliminar.innerHTML = '<i class="fas fa-trash"></i> ELIMINAR DEL HISTORIAL';
                btnEliminar.onclick = eliminarSeleccionados;
            }
        }
    } else {
        bulk.classList.remove('active');
        document.getElementById('select-all').checked = false;
    }
};

window.toggleSeleccion = (id, cb) => {
    cb.checked ? state.itemsSeleccionados.add(id) : state.itemsSeleccionados.delete(id);
    actualizarBulkActions();
};

window.desmarcarTodos = () => {
    state.itemsSeleccionados.clear();
    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    actualizarBulkActions();
};

// ============================================
// ELIMINAR SELECCIONADOS (HISTORIAL)
// ============================================
window.eliminarSeleccionados = async () => {
    if (!state.itemsSeleccionados.size) {
        return mostrarToast("‚ö†Ô∏è No hay items seleccionados", "warning");
    }
    
    if (!confirm(`¬øEliminar ${state.itemsSeleccionados.size} registro(s) del historial?`)) return;
    
    mostrarToast("üóëÔ∏è Eliminando...", "warning");
    
    try {
        await Promise.all([...state.itemsSeleccionados].map(id => deleteDoc(doc(db, "historial_sorteos", id))));
        mostrarToast(`‚úÖ ${state.itemsSeleccionados.size} eliminado(s)`, "success");
        state.itemsSeleccionados.clear();
        actualizarBulkActions();
        mostrarHistorial();
        actualizarEstadisticas();
    } catch(e) {
        mostrarToast("‚ùå Error al eliminar", "error");
    }
};

// ============================================
// ELIMINAR SELECCIONADOS (ACTIVOS) - CORREGIDO
// ============================================
window.eliminarSeleccionadosActivos = async () => {
    if (!state.itemsSeleccionados.size) {
        return mostrarToast("‚ö†Ô∏è No hay items seleccionados", "warning");
    }
    
    if (!confirm(`¬øEliminar ${state.itemsSeleccionados.size} sorteo(s) seleccionado(s)?`)) return;
    
    mostrarToast("üóëÔ∏è Eliminando...", "warning");
    
    let exitosos = 0;
    let errores = 0;
    
    for (const id of state.itemsSeleccionados) {
        try {
            const docSnap = await getDoc(doc(db, "comercios", id));
            if (docSnap.exists()) {
                await updateDoc(doc(db, "comercios", id), {
                    titulo_sorteo: null,
                    descripcion_sorteo: null,
                    fecha_sorteo: null,
                    cantidad_premios: null,
                    sorteo_finalizado: null,
                    timestamp_finalizacion: null
                });
                exitosos++;
            }
        } catch (e) {
            console.error("Error eliminando sorteo:", e);
            errores++;
        }
    }
    
    state.itemsSeleccionados.clear();
    actualizarBulkActions();
    mostrarToast(`‚úÖ ${exitosos} eliminados, ${errores} errores`, exitosos > 0 ? "success" : "error");
    cargarActivos();
};

window.eliminarIndividual = async (id, btn) => {
    if (!confirm('¬øEliminar este registro del historial?')) return;
    
    const orig = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "‚è≥";
    
    try {
        await deleteDoc(doc(db, "historial_sorteos", id));
        mostrarToast("‚úÖ Eliminado", "success");
        mostrarHistorial();
        actualizarEstadisticas();
    } catch(e) {
        mostrarToast("‚ùå Error", "error");
        btn.disabled = false;
        btn.innerHTML = orig;
    }
};

// ============================================
// SEGURIDAD
// ============================================
window.validarAccionSegura = async (idComercio, claveIngresada) => {
    if (claveIngresada === CLAVE_MAESTRA) return true;
    
    try {
        const s = await getDoc(doc(db, "comercios", idComercio));
        if (s.exists() && claveIngresada === s.data().password) return true;
    } catch(e) {}
    
    return false;
};

window.intentarSorteo = async (btn) => {
    if (btn.closest('tr')?.classList.contains('finalizado')) {
        mostrarToast("üîí Sorteo ya finalizado", "warning");
        return;
    }
    
    const ts = parseInt(btn.dataset.timestamp);
    const idComercio = btn.dataset.id;
    const nombreComercio = btn.dataset.nombre;
    const premio = btn.dataset.premio;
    const cant = parseInt(btn.dataset.cant);
    const mailC = btn.dataset.mail;
    const logoUrl = btn.dataset.logo;
    const desc = btn.dataset.desc;
    
    if (Date.now() < ts) {
        const mensaje = `üîí Sorteo programado para ${new Date(ts).toLocaleString()}\nIngrese clave de comercio o maestra para realizar el sorteo AHORA`;
        
        abrirModalClave(mensaje, async (clave) => {
            if (!clave) return false;
            const valida = await validarAccionSegura(idComercio, clave);
            if (valida) {
                mostrarToast("üîì Acceso autorizado - Realizando sorteo", "warning");
                ejecutarSorteo(idComercio, nombreComercio, premio, cant, mailC, logoUrl, desc);
                return true;
            } else {
                mostrarToast("‚ùå Contrase√±a incorrecta", "error");
                return false;
            }
        });
    } else {
        ejecutarSorteo(idComercio, nombreComercio, premio, cant, mailC, logoUrl, desc);
    }
};

window.intentarEliminarSorteo = async (idComercio, fechaSorteoISO) => {
    const dh = (new Date(fechaSorteoISO).getTime() - Date.now()) / 3600000;
    
    let mensaje;
    if (dh < 24 && dh > 0) {
        mensaje = "‚ö†Ô∏è ZONA CR√çTICA: Faltan menos de 24hs\nSolo la CLAVE MAESTRA puede cancelar este sorteo.\nIngrese la clave:";
    } else {
        mensaje = "Ingrese CLAVE DE COMERCIO o MAESTRA para eliminar:";
    }
    
    abrirModalClave(mensaje, async (clave) => {
        if (!clave) return false;
        
        const valida = await validarAccionSegura(idComercio, clave);
        if (!valida) {
            mostrarToast("‚ùå Contrase√±a incorrecta", "error");
            return false;
        }
        
        if (dh < 24 && dh > 0 && clave !== CLAVE_MAESTRA) {
            mostrarToast("‚ùå Solo Admin puede cancelar sorteos inminentes", "error");
            return false;
        }
        
        try {
            await updateDoc(doc(db, "comercios", idComercio), {
                titulo_sorteo: null,
                descripcion_sorteo: null,
                fecha_sorteo: null,
                cantidad_premios: null,
                logoUrl: null,
                sorteo_finalizado: null,
                timestamp_finalizacion: null
            });
            mostrarToast("üóëÔ∏è Sorteo cancelado", "success");
            cargarActivos();
            return true;
        } catch (e) {
            mostrarToast("‚ùå Error", "error");
            return false;
        }
    });
};

// ============================================
// EJECUTAR SORTEO
// ============================================
const ejecutarSorteo = async (idCom, nomCom, premio, cant, mailC, logoUrl, desc) => {
    mostrarToast(`üé≤ Procesando sorteo para ${nomCom}...`, "warning");
    
    try {
        const snapP = await getDocs(query(
            collection(db, "admin_participantes_sorteos"),
            where("comercio", "==", nomCom)
        ));
        
        let participantes = [];
        for (const d of snapP.docs) {
            const p = d.data();
            let nom = p.nombre || "Participante";
            let cel = p.celular || p.whatsapp || "S/D";
            let tipo = p.tipo || "LEAD";
            let email = p.email || "";
            
            if (p.usuarioId && !p.usuarioId.startsWith('temp_')) {
                try {
                    const ld = await getDoc(doc(db, "leads", p.usuarioId));
                    if (ld.exists()) {
                        const l = ld.data();
                        nom = `${l.nombres || ''} ${l.apellido || ''}`.trim() || nom;
                        cel = l.whatsapp || l.celular || cel;
                        tipo = (l.convertidoVIP || l.tipo === "VIP") ? "VIP" : "LEAD";
                        email = l.email || email;
                    }
                } catch (e) {}
            }
            
            participantes.push({ ...p, nombreMostrar: nom, celular: cel, tipo, email });
        }
        
        if (!participantes.length) return mostrarToast("‚ö†Ô∏è Sin participantes", "error");
        
        let ganadores = [];
        let bolsa = [...participantes];
        for (let i = 0; i < Math.min(cant, bolsa.length); i++) {
            const idx = Math.floor(Math.random() * bolsa.length);
            ganadores.push(bolsa.splice(idx, 1)[0]);
        }
        
        const ganadoresConNumero = ganadores.map((g, index) => {
            let numeroPremio = cant === 1 ? "Ganador" : `${index + 1}¬∫ Premio`;
            return { ...g, numeroPremio };
        });
        
        await addDoc(collection(db, "historial_sorteos"), {
            comercio: nomCom,
            premio,
            descripcion_sorteo: desc || "",
            logoUrl: logoUrl || "",
            ganadores: ganadoresConNumero,
            fecha: serverTimestamp(),
            mailComercio: mailC || 'habitatcar@gmail.com',
            timestampProgramado: Date.now()
        });
        
        try {
            await updateDoc(doc(db, "comercios", idCom), {
                sorteo_finalizado: true,
                timestamp_finalizacion: serverTimestamp()
            });
        } catch (e) {
            console.error("Error marcando sorteo como finalizado:", e);
        }
        
        await enviarEmailAutomatico(ganadoresConNumero, nomCom, premio);
        
        // Notificar al comercio
        try {
            const comercioSnap = await getDoc(doc(db, "comercios", idCom));
            const comercio = comercioSnap.data();
            if (comercio?.telefono) {
                const mensajeComercio = `üéâ Sorteo MANUAL realizado para ${comercio.nombre}\nGanadores: ${ganadores.length}\nüì± Revisa el historial en el panel.`;
                const num = normalizarTelefonoAR(comercio.telefono);
                if (num) {
                    window.open(`https://wa.me/${num}?text=${encodeURIComponent(mensajeComercio)}`, '_blank');
                }
            }
        } catch (e) {
            console.error("Error notificando al comercio:", e);
        }
        
        // Eliminar participantes
        try {
            const participantesAEliminar = await getDocs(query(
                collection(db, "admin_participantes_sorteos"),
                where("comercio", "==", nomCom)
            ));
            await Promise.all(participantesAEliminar.docs.map(d => deleteDoc(d.ref)));
            console.log(`‚úÖ Participantes de ${nomCom} eliminados`);
        } catch (e) {
            console.error("Error eliminando participantes:", e);
        }
        
        mostrarToast("‚úÖ Sorteo exitoso", "success");
        mostrarConfirmacionSorteo(participantes.length, ganadoresConNumero, nomCom);
        actualizarEstadisticas();
        cargarActivos();
    } catch (e) {
        console.error(e);
        mostrarToast("‚ùå Error en sorteo", "error");
    }
};

// ============================================
// SORTEO AUTOM√ÅTICO
// ============================================
window.ejecutarSorteoAutomatico = async (idComercio) => {
    try {
        const comercioRef = doc(db, "comercios", idComercio);
        const comercioSnap = await getDoc(comercioRef);
        
        if (!comercioSnap.exists()) return;
        
        const comercio = comercioSnap.data();
        if (comercio.sorteo_finalizado) {
            console.log("Sorteo ya finalizado");
            return;
        }
        
        const snapP = await getDocs(query(
            collection(db, "admin_participantes_sorteos"),
            where("comercio", "==", comercio.nombre)
        ));
        
        let participantes = [];
        for (const d of snapP.docs) {
            const p = d.data();
            let nom = p.nombre || "Participante";
            let cel = p.celular || p.whatsapp || "S/D";
            let tipo = p.tipo || "LEAD";
            let email = p.email || "";
            
            if (p.usuarioId && !p.usuarioId.startsWith('temp_')) {
                try {
                    const ld = await getDoc(doc(db, "leads", p.usuarioId));
                    if (ld.exists()) {
                        const l = ld.data();
                        nom = `${l.nombres || ''} ${l.apellido || ''}`.trim() || nom;
                        cel = l.whatsapp || l.celular || cel;
                        tipo = (l.convertidoVIP || l.tipo === "VIP") ? "VIP" : "LEAD";
                        email = l.email || email;
                    }
                } catch (e) {}
            }
            
            participantes.push({ ...p, nombreMostrar: nom, celular: cel, tipo, email });
        }
        
        if (!participantes.length) return;
        
        const cant = parseInt(comercio.cantidad_premios) || 1;
        let ganadores = [];
        let bolsa = [...participantes];
        
        for (let i = 0; i < Math.min(cant, bolsa.length); i++) {
            const idx = Math.floor(Math.random() * bolsa.length);
            ganadores.push(bolsa.splice(idx, 1)[0]);
        }
        
        const ganadoresConNumero = ganadores.map((g, index) => ({
            ...g,
            numeroPremio: cant === 1 ? "Ganador" : `${index + 1}¬∫ Premio`
        }));
        
        await addDoc(collection(db, "historial_sorteos"), {
            comercio: comercio.nombre,
            premio: comercio.titulo_sorteo,
            descripcion_sorteo: comercio.descripcion_sorteo || "",
            logoUrl: comercio.logoUrl || "",
            ganadores: ganadoresConNumero,
            fecha: serverTimestamp(),
            mailComercio: comercio.email || 'habitatcar@gmail.com',
            timestampProgramado: Date.now()
        });
        
        await updateDoc(comercioRef, {
            sorteo_finalizado: true,
            timestamp_finalizacion: serverTimestamp()
        });
        
        await enviarEmailAutomatico(ganadoresConNumero, comercio.nombre, comercio.titulo_sorteo);
        
        // Notificar comercio
        if (comercio.telefono) {
            const mensajeComercio = `üéâ Sorteo AUTOM√ÅTICO realizado para ${comercio.nombre}\nGanadores: ${ganadores.length}\nüì± Revisa el historial en el panel.`;
            const num = normalizarTelefonoAR(comercio.telefono);
            if (num) {
                window.open(`https://wa.me/${num}?text=${encodeURIComponent(mensajeComercio)}`, '_blank');
            }
        }
        
        // Eliminar participantes
        try {
            const participantesAEliminar = await getDocs(query(
                collection(db, "admin_participantes_sorteos"),
                where("comercio", "==", comercio.nombre)
            ));
            await Promise.all(participantesAEliminar.docs.map(d => deleteDoc(d.ref)));
            console.log(`‚úÖ Participantes de ${comercio.nombre} eliminados`);
        } catch (e) {
            console.error("Error eliminando participantes:", e);
        }
        
        mostrarToast(`‚úÖ Sorteo autom√°tico de ${comercio.nombre} realizado`, "success");
        actualizarEstadisticas();
    } catch (e) {
        console.error("Error en sorteo autom√°tico:", e);
        mostrarToast("‚ùå Error en sorteo autom√°tico", "error");
    }
};

// ============================================
// PROGRAMAR SORTEOS
// ============================================
const programarSorteosPendientes = async () => {
    try {
        const ahora = Date.now();
        const q = query(collection(db, "comercios"), where("titulo_sorteo", "!=", null));
        const snap = await getDocs(q);
        
        snap.forEach(doc => {
            const c = doc.data();
            if (!c.fecha_sorteo) return;
            
            const ts = new Date(c.fecha_sorteo).getTime();
            if (ts <= ahora && !c.sorteo_finalizado) {
                console.log(`‚è∞ Ejecutando sorteo de ${c.nombre} ahora mismo`);
                window.ejecutarSorteoAutomatico(doc.id);
            }
        });
    } catch (e) {
        console.error("Error programando sorteos:", e);
    }
};

// ============================================
// CONFIRMACI√ìN SORTEO
// ============================================
window.mostrarConfirmacionSorteo = (total, ganadores, comercio) => {
    document.getElementById('lista-ganadores-popup').innerHTML = ganadores.map((g, index) => {
        const badge = g.tipo === "VIP"
            ? `<span class="badge badge-vip"><i class="fas fa-crown"></i> VIP</span>`
            : `<span class="badge badge-lead"><i class="fas fa-user"></i> LEAD</span>`;
        
        const numeroPremio = ganadores.length === 1 ? "üèÜ Ganador" : `${index + 1}¬∫ Premio`;
        
        return `<div style="background:#f8f9fa;border-left:4px solid var(--oro);padding:12px;margin:8px 0;border-radius:8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-weight:bold;"><i class="fas fa-trophy" style="color:var(--oro);margin-right:5px;"></i>${g.nombreMostrar}</span>
                <span><span class="badge" style="background:var(--oro); color:white;">${numeroPremio}</span> ${badge}</span>
            </div>
            <small style="color:#666;display:block;margin-top:5px;"><i class="fab fa-whatsapp"></i> ${g.celular||'Sin tel√©fono'} | <i class="fas fa-envelope"></i> ${g.email||'Sin email'}</small>
        </div>`;
    }).join('');
    
    document.getElementById('texto-sorteo').innerText = `Sorteo de ${comercio}: ${ganadores.length} ganador(es) entre ${total} participantes.`;
    document.getElementById('popup-confirmacion').style.display = 'flex';
};

window.cerrarModalSorteo = () => {
    document.getElementById('popup-confirmacion').style.display = 'none';
};

window.irAlHistorial = () => {
    cerrarModalSorteo();
    mostrarHistorial();
};

// ============================================
// RELOJES
// ============================================
window.iniciarRelojes = () => {
    setInterval(() => {
        document.querySelectorAll('.btn-sortear-accion:not(.finalizado)').forEach(btn => {
            const ts = parseInt(btn.dataset.timestamp);
            const f = ts - Date.now();
            
            if (f > 0) {
                const d = Math.floor(f/86400000);
                const h = Math.floor((f%86400000)/3600000);
                const m = Math.floor((f%3600000)/60000);
                const s = Math.floor((f%60000)/1000);
                btn.innerHTML = `‚è≥ ${d}d ${h}h ${m}m ${s}s`;
                btn.classList.add('btn-dark');
                btn.classList.remove('btn-primary');
            } else {
                btn.innerHTML = `üé≤ SORTEAR AHORA`;
                btn.classList.remove('btn-dark');
                btn.classList.add('btn-primary');
            }
        });
    }, 1000);
};

// ============================================
// CARGAR ACTIVOS
// ============================================
const cargarActivos = () => {
    state.vistaActual = 'activos';
    state.itemsSeleccionados.clear();
    actualizarBulkActions();
    document.getElementById('header-checkbox').style.display = 'table-cell';
    
    const tabla = document.getElementById('tabla-sorteos');
    tabla.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;">‚è≥ Cargando sorteos...</td></tr>';
    
    if (state.listenerActivos) state.listenerActivos();
    if (state.listenerHistorial) {
        state.listenerHistorial();
        state.listenerHistorial = null;
    }
    
    state.listenerActivos = onSnapshot(collection(db, "comercios"), async (snap) => {
        tabla.innerHTML = "";
        const comerciosArray = [];
        
        snap.forEach(doc => {
            const data = doc.data();
            if (data.titulo_sorteo) {
                comerciosArray.push({ id: doc.id, data: data });
            }
        });
        
        const ahora = Date.now();
        comerciosArray.sort((a, b) => {
            const fechaA = a.data.fecha_sorteo ? new Date(a.data.fecha_sorteo).getTime() : 0;
            const fechaB = b.data.fecha_sorteo ? new Date(b.data.fecha_sorteo).getTime() : 0;
            
            const finalizadoA = fechaA < ahora - 3600000;
            const finalizadoB = fechaB < ahora - 3600000;
            
            if (finalizadoA && finalizadoB) return fechaB - fechaA;
            if (finalizadoA && !finalizadoB) return 1;
            if (!finalizadoA && finalizadoB) return -1;
            return fechaA - fechaB;
        });
        
        if (comerciosArray.length === 0) {
            tabla.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#666;">üì≠ No hay sorteos activos</td></tr>';
            return;
        }
        
        for (const { id: docId, data: c } of comerciosArray) {
            const nomCom = c.nombre || "Sin nombre";
            const premio = c.titulo_sorteo;
            const descPremio = c.descripcion_sorteo || "";
            const cant = parseInt(c.cantidad_premios) || 1;
            const fechaISO = c.fecha_sorteo || "";
            const ts = fechaISO ? new Date(fechaISO).getTime() : Date.now();
            const finalizado = ts < ahora - 3600000;
            
            let cL = 0, cV = 0;
            try {
                const snapP = await getDocs(query(
                    collection(db, "admin_participantes_sorteos"),
                    where("comercio", "==", nomCom)
                ));
                
                await Promise.all(snapP.docs.map(async p => {
                    const pd = p.data();
                    if (pd.usuarioId && !pd.usuarioId.startsWith('temp_')) {
                        try {
                            const ld = await getDoc(doc(db, "leads", pd.usuarioId));
                            if (ld.exists() && (ld.data().convertidoVIP || ld.data().tipo === "VIP")) {
                                cV++;
                                return;
                            }
                        } catch (e) {}
                    }
                    pd.tipo === "VIP" ? cV++ : cL++;
                }));
            } catch (e) {
                console.error("Error contando participantes:", e);
            }
            
            const f = formatearFechaHora(fechaISO) || { fecha: 'A definir', hora: '' };
            
            let badge = '';
            let estadoClase = finalizado ? 'finalizado' : '';
            
            if (finalizado) {
                badge = `<span class="badge badge-finalizado">‚úÖ SORTEO FINALIZADO</span>`;
            } else if (ts > ahora) {
                badge = `<span class="timestamp-badge">üïê Programado: ${f.fecha} ${f.hora}</span>`;
            } else {
                badge = `<span class="badge badge-critica">üî¥ LISTO PARA SORTEAR</span>`;
            }
            
            const tr = document.createElement('tr');
            tr.className = estadoClase;
            tr.innerHTML = `
                <td class="checkbox-cell"><input type="checkbox" class="row-checkbox" data-id="${docId}" onchange="toggleSeleccion('${docId}',this)"></td>
                <td><div class="fecha-cell"><span class="fecha-principal">${f.fecha}</span><span class="hora-secundaria">${f.hora}</span>${badge}</div></td>
                <td><img src="${c.logoUrl || ''}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
                <td>
                    <span class="badge badge-comercio">${nomCom}</span><br>
                    <span class="badge badge-premio">üéÅ ${premio}</span>
                    ${descPremio ? `<div class="premio-desc">${descPremio}</div>` : ''}
                </td>
                <td>
                    <div class="participantes-cell">
                        <div class="participantes-row"><span>LEAD:</span><span class="participantes-value valor-lead">${cL}</span></div>
                        <div class="participantes-row"><span>VIP:</span><span class="participantes-value valor-vip">${cV}</span></div>
                        <div class="participantes-row"><b>TOTAL:</b><span class="participantes-value valor-total">${cL + cV}</span></div>
                    </div>
                </td>
                <td>
                    ${finalizado ?
                        `<button class="btn btn-secondary btn-sm" disabled style="opacity:0.5">‚úÖ FINALIZADO</button>` :
                        `<button class="btn btn-sortear-accion"
                            data-id="${docId}"
                            data-nombre="${nomCom}"
                            data-premio="${premio}"
                            data-cant="${cant}"
                            data-mail="${c.email || ''}"
                            data-logo="${c.logoUrl || ''}"
                            data-desc="${descPremio}"
                            data-timestamp="${ts}"
                            data-clave-comercio="${c.password || ''}"
                            onclick="intentarSorteo(this)">Calculando...</button>`
                    }
                    <br><button class="btn btn-danger btn-sm" style="margin-top:5px;font-size:0.8rem" onclick="intentarEliminarSorteo('${docId}','${fechaISO}')">üóëÔ∏è Cancelar</button>
                </td>
                <td style="text-align:center"><span class="badge badge-premios">üéÅ ${cant} premio${cant > 1 ? 's' : ''}</span></td>
            `;
            tabla.appendChild(tr);
        }
    });
};

// ============================================
// HISTORIAL
// ============================================
window.mostrarHistorial = () => {
    state.vistaActual = 'historial';
    state.itemsSeleccionados.clear();
    actualizarBulkActions();
    document.getElementById('header-checkbox').style.display = 'table-cell';
    
    const tabla = document.getElementById('tabla-sorteos');
    tabla.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;">‚è≥ Cargando historial...</td></tr>';
    
    if (state.listenerHistorial) state.listenerHistorial();
    if (state.listenerActivos) {
        state.listenerActivos();
        state.listenerActivos = null;
    }
    
    state.listenerHistorial = onSnapshot(collection(db, "historial_sorteos"), snap => {
        tabla.innerHTML = "";
        actualizarEstadisticas();
        
        if (snap.empty) {
            tabla.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:40px;color:#666;">üì≠ No hay historial de sorteos</td></tr>';
            return;
        }
        
        const docsOrdenados = snap.docs.sort((a, b) => 
            (b.data().fecha?.seconds || 0) - (a.data().fecha?.seconds || 0)
        );
        
        docsOrdenados.forEach(docSnap => {
            const h = docSnap.data();
            const fecha = h.fecha?.toDate ? h.fecha.toDate().toLocaleString() : "Reciente";
            const logoC = h.logoUrl || LOGO_DEFAULT;
            const descSorteo = h.descripcion_sorteo || "";
            
            (h.ganadores || []).forEach((g, index) => {
                const nombreG = g.nombreMostrar || "Invitado";
                const celG = g.celular || "";
                const emailG = g.email || "";
                const numeroPremio = g.numeroPremio || (h.ganadores.length === 1 ? "Ganador" : `${index + 1}¬∫ Premio`);
                
                const badge = g.tipo === "VIP"
                    ? `<span class="badge badge-vip"><i class="fas fa-crown"></i> VIP</span>`
                    : `<span class="badge badge-lead"><i class="fas fa-user"></i> LEAD</span>`;
                
                const esc = s => (s || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="checkbox-cell"><input type="checkbox" class="row-checkbox" data-id="${docSnap.id}" onchange="toggleSeleccion('${docSnap.id}',this)"></td>
                    <td><small>${fecha}</small></td>
                    <td><img src="${esc(logoC)}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
                    <td>
                        <span class="badge badge-comercio">${h.comercio}</span><br>
                        <span class="badge badge-premio">üéÅ ${h.premio}</span>
                        ${descSorteo ? `<div class="premio-desc">${descSorteo}</div>` : ''}
                    </td>
                    <td>
                        <div style="font-weight:bold">${nombreG}</div>
                        <div><span class="badge" style="background:var(--oro); color:white; margin-top:4px;">${numeroPremio}</span> ${badge}</div>
                    </td>
                    <td>
                        <div style="font-size:0.85em;color:var(--verde);margin-bottom:3px;"><i class="fab fa-whatsapp"></i> ${celG}</div>
                        ${emailG ? `<div style="font-size:0.8em;color:#666;word-break:break-all;"><i class="fas fa-envelope"></i> ${emailG}</div>` : ''}
                        <div style="margin-top:8px; display:flex; gap:5px; flex-wrap:wrap;">
                            <button class="btn-accion btn-wapdf"
                                data-nombre="${esc(nombreG)}"
                                data-premio="${esc(h.premio)}"
                                data-comercio="${esc(h.comercio)}"
                                data-descripcion="${esc(descSorteo)}"
                                data-cel="${esc(celG)}"
                                data-logo="${esc(logoC)}"
                                onclick="clickEnviarTicket(this)"
                                title="Genera PDF y abre WhatsApp">
                                <i class="fab fa-whatsapp"></i> <i class="fas fa-file-pdf"></i>
                            </button>
                            <button class="btn-accion btn-email"
                                onclick="enviarEmailGanador('${esc(nombreG)}', '${esc(h.premio)}', '${esc(h.comercio)}', '${esc(emailG)}')"
                                title="Enviar email al ganador">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <button class="btn-accion" style="background:#6c757d"
                            data-texto="${esc(nombreG + ' - WA: ' + celG + ' - Email: ' + emailG)}"
                            onclick="navigator.clipboard.writeText(this.dataset.texto);mostrarToast('üìã Copiado','warning')">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn-accion btn-delete" onclick="eliminarIndividual('${docSnap.id}',this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tabla.appendChild(tr);
            });
        });
    });
};

// ============================================
// ENVIAR TICKET
// ============================================
window.clickEnviarTicket = btn => {
    window.enviarTicketElite(
        btn.dataset.nombre || '',
        btn.dataset.premio || '',
        btn.dataset.comercio || '',
        btn.dataset.descripcion || '',
        btn.dataset.cel || '',
        btn.dataset.logo || ''
    );
};

window.enviarTicketElite = async (nombre, premio, comercio, descripcion, telefono, logoComercio) => {
    const p = leerCfgPDF();
    const mensajeWA = leerMsgWA()
        .replace(/\{\{NOMBRE\}\}/g, nombre || 'Ganador')
        .replace(/\{\{PREMIO\}\}/g, premio || 'el premio')
        .replace(/\{\{COMERCIO\}\}/g, comercio || 'el comercio')
        .replace(/\{\{DESCRIPCION\}\}/g, descripcion || premio || 'el premio');
    
    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF({ unit: "mm", format: [80, 160] });
    
    const loadImg = url => new Promise(resolve => {
        if (!url) return resolve(null);
        const proxiedUrl = proxyURL(url);
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = proxiedUrl;
    });
    
    const [bgImg, logoComercioImg, logoHabitatImg] = await Promise.all([
        loadImg(p.bg),
        loadImg(logoComercio || LOGO_DEFAULT),
        loadImg(LOGO_HABITAT)
    ]);
    
    if (bgImg) docPDF.addImage(bgImg, 'JPEG', 0, 0, 80, 160);
    
    if (logoComercioImg) {
        const sz = parseInt(p.l1s) || 20;
        const aspectRatio = logoComercioImg.width / logoComercioImg.height;
        if (aspectRatio > 1) {
            docPDF.addImage(logoComercioImg, 'PNG', parseInt(p.l1x) || 5, parseInt(p.l1y) || 5, sz, sz / aspectRatio);
        } else {
            docPDF.addImage(logoComercioImg, 'PNG', parseInt(p.l1x) || 5, parseInt(p.l1y) || 5, sz * aspectRatio, sz);
        }
    }
    
    if (logoHabitatImg) {
        const sz = parseInt(p.l2s) || 20;
        const aspectRatio = logoHabitatImg.width / logoHabitatImg.height;
        if (aspectRatio > 1) {
            docPDF.addImage(logoHabitatImg, 'PNG', parseInt(p.l2x) || 45, parseInt(p.l2y) || 5, sz, sz / aspectRatio);
        } else {
            docPDF.addImage(logoHabitatImg, 'PNG', parseInt(p.l2x) || 45, parseInt(p.l2y) || 5, sz * aspectRatio, sz);
        }
    }
    
    // Textos
    docPDF.setFont(p.font_t4 || 'helvetica', "bold");
    docPDF.setFontSize(p.t4s || 14);
    docPDF.setTextColor(p.color_t4 || '#000000');
    docPDF.text(p.t4txt || '¬°Felicitaciones!', p.t4x || 40, p.t4y || 45, { align: "center" });
    
    docPDF.setFont(p.font_t1 || 'helvetica', "bold");
    docPDF.setFontSize(p.t1s || 22);
    docPDF.setTextColor(p.color_t1 || '#000000');
    const nombreLines = docPDF.splitTextToSize((nombre || "Ganador").toUpperCase(), 70);
    const lineHeightNombre = (p.t1s || 22) * 0.35;
    nombreLines.forEach((line, index) => {
        docPDF.text(line, p.t1x || 40, (p.t1y || 70) + (index * lineHeightNombre), { align: "center" });
    });
    
    docPDF.setFont(p.font_t2 || 'helvetica', "normal");
    docPDF.setFontSize(p.t2s || 16);
    docPDF.setTextColor(p.color_t2 || '#000000');
    docPDF.text(premio || "Premio", p.t2x || 40, p.t2y || 90, { align: "center" });
    
    docPDF.setFont(p.font_t6 || 'helvetica', "normal");
    docPDF.setFontSize(p.t6s || 12);
    docPDF.setTextColor(p.color_t6 || '#000000');
    const descLines = docPDF.splitTextToSize(descripcion || premio || "", 70);
    const lineHeightDesc = (p.t6s || 12) * 0.35;
    descLines.forEach((line, index) => {
        docPDF.text(line, p.t6x || 40, (p.t6y || 105) + (index * lineHeightDesc), { align: "center" });
    });
    
    docPDF.setFont(p.font_t3 || 'helvetica', "normal");
    docPDF.setFontSize(p.t3s || 14);
    docPDF.setTextColor(p.color_t3 || '#000000');
    docPDF.text(comercio || "Comercio", p.t3x || 40, p.t3y || 118, { align: "center" });
    
    docPDF.setFont(p.font_t5 || 'helvetica', "normal");
    docPDF.setFontSize(p.t5s || 8);
    docPDF.setTextColor(p.color_t5 || '#666666');
    docPDF.text(`${p.t5txt || 'H√°bitat-Car'} ‚Ä¢ ${new Date().toLocaleDateString()}`, p.t5x || 40, p.t5y || 148, { align: "center" });
    
    docPDF.save(`Ticket_${(nombre || 'Ganador').replace(/\s+/g, '_')}.pdf`);
    
    if (telefono) {
        const num = normalizarTelefonoAR(telefono);
        if (num) {
            setTimeout(() => window.open(`https://wa.me/${num}?text=${encodeURIComponent(mensajeWA)}`, '_blank'), 1200);
            mostrarToast("‚úÖ PDF descargado ‚Äî WhatsApp abierto.\nAdjunt√° el PDF desde tu galer√≠a.", "success");
            return;
        }
    }
    mostrarToast("‚úÖ Ticket PDF descargado", "success");
};

// ============================================
// INICIALIZACI√ìN
// ============================================
document.getElementById('btn-activos').onclick = cargarActivos;
document.getElementById('btn-historial').onclick = () => { mostrarHistorial(); actualizarEstadisticas(); };

document.addEventListener('DOMContentLoaded', () => {
    cargarActivos();
    iniciarRelojes();
    actualizarEstadisticas();
    programarSorteosPendientes();
    setInterval(programarSorteosPendientes, 30000);
});

// Cerrar modales al hacer click fuera
['modalPDF', 'modalWA', 'modal-clave'].forEach(id => {
    document.getElementById(id)?.addEventListener('click', e => {
        if (e.target.id === id) {
            if (id === 'modal-clave') cerrarModalClave();
            else cerrarModales();
        }
    });
});
</script>
</body>
</html>
