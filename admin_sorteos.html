<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Sorteos Elite | H√°bitat-Car</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--azul-habitat: #003d80;
--rojo-cupon: #e60000;
--naranja: #ff8c00;
--celeste: #0288d1;
--verde: #2e7d32;
--blanco: #ffffff;
--gris-texto: #666666;
--oro: #d4af37;
--zona-critica: #dc3545;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; padding-top: 140px; }
.faja-superior { position: fixed; top: 0; left: 0; width: 100%; background: var(--azul-habitat); border-bottom: 4px solid var(--rojo-cupon); z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.faja-contenido { max-width: 1200px; margin: 0 auto; padding: 10px 20px; display: flex; flex-direction: column; gap: 10px; }
.faja-logo { text-align: center; padding: 5px 0; }
.faja-logo img { height: 50px; width: auto; max-width: 200px; }
.faja-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; padding: 5px 0; }
.faja-nav a { padding: 6px 10px; border-radius: 4px; text-decoration: none; color: white; font-weight: 600; font-size: 11px; background: rgba(255,255,255,0.15); transition: all 0.2s; text-transform: uppercase; }
.faja-nav a:hover, .faja-nav a.active { background: var(--rojo-cupon); transform: translateY(-1px); }
.faja-nav a.active { box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
header h1 { font-size: 1.8rem; margin-bottom: 8px; }
header p { opacity: 0.9; font-size: 0.95rem; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
.btn-primary { background: #667eea; color: white; }
.btn-primary:hover { background: #5568d3; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.btn-warning { background: #ffc107; color: #333; }
.btn-warning:hover { background: #e0a800; }
.btn-info { background: #17a2b8; color: white; }
.btn-dark { background: #343a40; color: white; }
.btn-danger { background: #dc3545; color: white; }
.btn-danger:hover { background: #c82333; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }
.btn-sm { padding: 4px 8px; font-size: 0.8rem; }
.table-container { overflow-x: auto; max-height: calc(100vh - 280px); }
table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: opacity 0.3s ease; }
thead { position: sticky; top: 0; z-index: 100; background: #667eea; }
th { background: #667eea; color: white; padding: 14px 12px; text-align: left; white-space: nowrap; }
td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
.btn-accion { padding: 6px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; color: white; display: inline-flex; align-items: center; gap: 4px; }
.btn-wa { background: #25D366; }
.btn-mail { background: #ea4335; }
.btn-copy { background: #6c757d; }
.btn-delete { background: #dc3545; }
.btn-delete:hover { background: #c82333; }
.badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.badge-premio { background: #fff3cd; color: #856404; }
.badge-comercio { background: #d1ecf1; color: #0c5460; }
.badge-premios { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-vip { background: #fff8e1; color: #f57f17; font-weight: bold; }
.badge-lead { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-critica { background: #ffebee; color: #c62828; font-weight: bold; animation: pulse 2s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.4); } 70% { box-shadow: 0 0 0 10px rgba(220,53,69,0); } 100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); } }
.toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 10px; color: white; z-index: 9999; animation: slideIn 0.3s ease; }
.success { background: #28a745; } .error { background: #dc3545; } .warning { background: #ffc107; color: #333; }
@keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
.participantes-cell { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; }
.participantes-row { display: flex; justify-content: space-between; align-items: center; }
.participantes-value { font-weight: bold; padding: 2px 8px; border-radius: 4px; min-width: 30px; text-align: center; }
.valor-lead { background: #e3f2fd; color: #1976d2; }
.valor-vip { background: #fff8e1; color: #f57f17; }
.valor-total { background: #e8f5e9; color: #388e3c; }
.premio-desc { font-size: 0.85rem; color: #666; margin-top: 4px; line-height: 1.4; max-width: 200px; }
.fecha-cell { display: flex; flex-direction: column; gap: 2px; font-size: 0.85rem; min-width: 100px; }
.fecha-principal { font-weight: bold; color: #333; }
.hora-secundaria { color: #666; font-size: 0.8rem; }
.timestamp-badge { font-size: 0.75rem; color: #666; background: #f1f1f1; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }
.logo-mini { height: 80px; width: auto; max-width: 120px; object-fit: contain; display: block; margin: 0 auto; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
.modal-content { background: white; padding: 25px; border-radius: 16px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.form-group { text-align: left; margin-bottom: 15px; }
.form-group label { display: block; font-weight: bold; margin-bottom: 5px; }
.form-group textarea { width: 100%; height: 150px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: inherit; }
.form-group input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
.ganador-item { background: #f8f9fa; border-left: 4px solid var(--oro); padding: 12px; margin: 10px 0; border-radius: 8px; text-align: left; }
.email-display { font-size: 0.8em; color: #666; margin-top: 3px; word-break: break-all; }
.checkbox-cell { text-align: center; width: 50px; }
.checkbox-cell input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.bulk-actions { display: none; gap: 10px; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107; }
.bulk-actions.active { display: flex; align-items: center; }
.selected-count { font-weight: bold; color: #856404; }
@media (max-width: 768px) {
.faja-nav { gap: 3px; }
.faja-nav a { font-size: 9px; padding: 4px 6px; }
body { padding-top: 120px; }
.logo-mini { height: 70px; }
}
</style>
</head>
<body>
<div class="faja-superior">
<div class="faja-contenido">
<div class="faja-logo"><a href="index.html"><img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="H√°bitat-Car"></a></div>
<nav class="faja-nav">
<a href="admin_comercios.html">COMERCIOS</a><a href="admin_leads.html">LEADS</a><a href="admin_vips.html">VIPS</a>
<a href="admin_tokens_vip.html">TOKENS VIP</a><a href="admin_curioso.html">CURIOSO</a><a href="admin_estadisticas.html">ESTAD√çSTICAS</a>
<a href="admin_logs.html">LOG</a><a href="admin_tutoriales.html">TUTORIALES</a><a href="index.html">PANEL</a>
<a href="admin_legales.html">LEGALES</a><a href="admin_sorteos.html" class="active">SORTEOS</a>
</nav>
</div>
</div>
<div class="container">
<header><h1>üèÜ SORTEOS PREMIUM</h1><p>Panel de Sorteos Elite | H√°bitat-Car</p></header>
<div class="controls">
<button class="btn btn-success" id="btn-activos">SORTEOS ACTIVOS</button>
<button class="btn btn-warning" id="btn-historial">HISTORIAL DE √âXITOS</button>
<button class="btn btn-info" onclick="abrirEditorEmail()"><i class="fas fa-edit"></i> EDITAR EMAIL</button>
<button class="btn btn-dark" onclick="abrirEditorPDF()"><i class="fas fa-palette"></i> DISE√ëAR PDF</button>
</div>
<div id="bulk-actions" class="bulk-actions">
<span class="selected-count"><i class="fas fa-check-circle"></i> <span id="selected-count">0</span> seleccionado(s)</span>
<button class="btn btn-danger" onclick="eliminarSeleccionados()"><i class="fas fa-trash"></i> ELIMINAR SELECCIONADOS</button>
<button class="btn btn-warning" onclick="desmarcarTodos()"><i class="fas fa-times"></i> CANCELAR</button>
</div>
<div class="table-container">
<table>
<thead>
<tr id="tabla-headers">
<th class="checkbox-cell" id="header-checkbox" style="display: table-cell;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
<th>FECHA</th>
<th>LOGO</th>
<th>COMERCIO / PREMIO</th>
<th>PARTICIPANTES</th>
<th>ACCIONES</th>
<th>PREMIOS</th>
</tr>
</thead>
<tbody id="tabla-sorteos"></tbody>
</table>
</div>
</div>

<!-- MODAL EDITAR EMAIL -->
<div id="modal-email" class="modal">
<div class="modal-content">
<h3 style="color:var(--azul-habitat); margin-bottom:15px;">‚úâÔ∏è Editar Plantilla de Email</h3>
<p style="font-size:0.9em; color:#666; margin-bottom:15px;">
<b>Instrucciones:</b><br>
El sistema reemplazar√° autom√°ticamente:<br>
<span style="color:#e60000; font-weight:bold">{{NOMBRE}}</span> ‚Üí Nombre del Ganador<br>
<span style="color:#e60000; font-weight:bold">{{PREMIO}}</span> ‚Üí El Regalo<br>
<span style="color:#e60000; font-weight:bold">{{COMERCIO}}</span> ‚Üí Local del Sorteo
</p>
<div class="form-group">
<label>Asunto:</label>
<input type="text" id="inp-asunto" placeholder="Ej: Felicidades {{NOMBRE}}">
</div>
<div class="form-group">
<label>Mensaje (HTML permitido):</label>
<textarea id="inp-cuerpo" placeholder="Resultaste ganador de un {{PREMIO}} del comercio {{COMERCIO}}..."></textarea>
</div>
<button class="btn btn-primary" onclick="guardarConfig('email')">üíæ GUARDAR EMAIL</button>
<button class="btn btn-warning" onclick="cerrarEditores()">‚ùå CANCELAR</button>
</div>
</div>

<!-- MODAL DISE√ëAR PDF -->
<div id="modal-pdf" class="modal">
<div class="modal-content">
<h3 style="color:var(--azul-habitat); margin-bottom:15px;">üìÑ Dise√±ar Certificado PDF</h3>
<div class="form-group">
<label>URL Imagen de Fondo (210x148mm):</label>
<input type="text" id="inp-pdf-bg" placeholder="https://tu-servidor.com/fondo.jpg">
</div>
<div class="form-group">
<label>Color de Texto Principal (Hex):</label>
<input type="color" id="inp-pdf-color" value="#e60000">
</div>
<button class="btn btn-primary" onclick="guardarConfig('pdf')">üíæ GUARDAR DISE√ëO</button>
<button class="btn btn-warning" onclick="cerrarEditores()">‚ùå CANCELAR</button>
</div>
</div>

<!-- MODAL CONFIRMACI√ìN SORTEO -->
<div id="popup-confirmacion" class="modal" style="display: none;">
<div class="modal-content">
<h3 style="color: var(--azul-habitat); margin-bottom: 15px;">üéâ ¬°SORTEO REALIZADO!</h3>
<p id="texto-sorteo" style="font-size: 1.1rem; margin-bottom: 20px; line-height: 1.5;"></p>
<div id="lista-ganadores-popup" style="text-align: left; margin-bottom: 20px;"></div>
<button class="btn btn-primary" onclick="irAlHistorial()">IR AL HISTORIAL DE √âXITOS</button>
<button class="btn btn-warning" onclick="cerrarModalSorteo()" style="margin-top: 10px;">SEGUIR AQU√ç</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, where, addDoc, serverTimestamp, getDocs, doc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const CLAVE_MAESTRA = "HABITAT_MASTER_2026";
window._ganadorData = {};

const firebaseConfig = {
    apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
    authDomain: "habitatcar-pro.firebaseapp.com",
    projectId: "habitatcar-pro",
    storageBucket: "habitatcar-pro.firebasestorage.app",
    messagingSenderId: "311691258694",
    appId: "1:311691258694:web:17a09051dcea7707af9347"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbz2xzSyQfL23SSFvvZ5jfKYYWvjMIy56XX33cSuq-DAQG64geSLsHdLnVzNmXDkzSXM5A/exec";
const LOGO_DEFAULT = "https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true";

// FUNCIONES DE EDICI√ìN
window.abrirEditorEmail = () => {
    document.getElementById('inp-asunto').value = localStorage.getItem('hc_asunto') || "üèÜ ¬°Felicidades {{NOMBRE}}!";
    document.getElementById('inp-cuerpo').value = localStorage.getItem('hc_cuerpo') || "Hola {{NOMBRE}}, ganaste un/a {{PREMIO}} en {{COMERCIO}}.";
    document.getElementById('modal-email').style.display = 'flex';
};
window.abrirEditorPDF = () => {
    document.getElementById('inp-pdf-bg').value = localStorage.getItem('hc_pdf_bg') || "";
    document.getElementById('inp-pdf-color').value = localStorage.getItem('hc_pdf_color') || "#e60000";
    document.getElementById('modal-pdf').style.display = 'flex';
};
window.cerrarEditores = () => {
    document.getElementById('modal-email').style.display = 'none';
    document.getElementById('modal-pdf').style.display = 'none';
};
window.guardarConfig = (tipo) => {
    if(tipo === 'email') {
        localStorage.setItem('hc_asunto', document.getElementById('inp-asunto').value);
        localStorage.setItem('hc_cuerpo', document.getElementById('inp-cuerpo').value);
    } else {
        localStorage.setItem('hc_pdf_bg', document.getElementById('inp-pdf-bg').value);
        localStorage.setItem('hc_pdf_color', document.getElementById('inp-pdf-color').value);
    }
    mostrarToast("‚úÖ Configuraci√≥n guardada", "success");
    cerrarEditores();
};

// UTILIDADES
window.normalizarTelefonoAR = (numero) => {
    if (!numero) return null;
    let num = numero.toString().replace(/\D/g, '');
    if (num.length === 10) return '549' + num;
    if (num.startsWith('54') && !num.startsWith('549')) return '549' + num.substring(2);
    return num.startsWith('549') ? num : '549' + num;
};
window.abrirWA = (cel, nom, pre) => {
    if (!cel) return mostrarToast("‚ö†Ô∏è El participante no tiene celular.", "error");
    const num = window.normalizarTelefonoAR(cel);
    const msg = encodeURIComponent(`¬°Hola ${nom}! üèÜ Soy de H√°bitat-Car. ¬°Felicidades, ganaste el sorteo de ${pre}! üéâ`);
    window.open(`https://wa.me/${num}?text=${msg}`, '_blank');
};

// ‚úÖ FUNCI√ìN ENVIAR MAIL CORREGIDA - M√âTODO ROBUSTO
window.enviarMail = async (btn, email, nombre, premio, comercio, mailCC) => {
    if (!email) return mostrarToast("Email no encontrado", "error");
    
    btn.disabled = true;
    btn.innerHTML = "‚è≥";

    // 1. Preparamos las plantillas
    const asuntoT = localStorage.getItem('hc_asunto') || "üèÜ ¬°Felicidades {{NOMBRE}}!";
    const cuerpoT = localStorage.getItem('hc_cuerpo') || "Hola {{NOMBRE}}, ganaste {{PREMIO}}.";

    // 2. Inyectamos los datos (M√©todo Robusto con split/join)
    const inyectar = (texto) => {
        return texto.split('{{NOMBRE}}').join(nombre)
                    .split('{{PREMIO}}').join(premio)
                    .split('{{COMERCIO}}').join(comercio);
    };

    try {
        const respuesta = await fetch(URL_SCRIPT, {
            method: 'POST',
            body: JSON.stringify({
                email: email.trim(),
                asunto: inyectar(asuntoT),
                cuerpoHtml: inyectar(cuerpoT).replace(/\n/g, '<br>'),
                cc: `habitatcar@gmail.com, ${mailCC || ''}`
            })
        });
        
        mostrarToast(`‚úÖ Enviado v√≠a Brevo a ${nombre}`);
    } catch (e) {
        console.error(e);
        mostrarToast("‚ùå Error de conexi√≥n", "error");
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-envelope"></i>';
    }
};

// FUNCIONES AUXILIARES PARA OBJETO GLOBAL
window.enviarMailPorKey = (btn, key) => {
    const d = window._ganadorData[key];
    if (!d) return mostrarToast("‚ùå Error: datos no encontrados", "error");
    window.enviarMail(btn, d.email, d.nombre, d.premio, d.comercio, d.mailComercio);
};
window.abrirWAPorKey = (key) => {
    const d = window._ganadorData[key];
    if (!d) return mostrarToast("‚ùå Error: datos no encontrados", "error");
    window.abrirWA(d.celular || d.whatsappComercio, d.nombre, d.premio);
};
window.copiarGanador = (key) => {
    const d = window._ganadorData[key];
    if (!d) return mostrarToast("‚ùå Error: datos no encontrados", "error");
    const texto = `${d.nombre} - WA: ${d.celular || 'sin tel'} - Email: ${d.email || 'sin email'}`.trim();
    navigator.clipboard.writeText(texto);
    mostrarToast('üìã Copiado', 'warning');
};

function formatearFechaHora(fechaISO) {
    if (!fechaISO) return null;
    try {
        const [fechaParte, horaParte] = fechaISO.split('T');
        if (!fechaParte || !horaParte) return null;
        const [anio, mes, dia] = fechaParte.split('-');
        const [hora, minutos] = horaParte.split(':');
        return { fecha: `${dia}/${mes}/${anio}`, hora: `${hora}:${minutos} Hs.` };
    } catch (e) { return null; }
}

window.mostrarConfirmacionSorteo = (total, ganadores, comercio) => {
    const listaGanadores = document.getElementById('lista-ganadores-popup');
    listaGanadores.innerHTML = ganadores.map(g => {
        const esVIP = g.tipo === "VIP";
        const badgeTipo = esVIP 
            ? `<span class="badge badge-vip"><i class="fas fa-crown"></i> VIP</span>` 
            : `<span class="badge badge-lead"><i class="fas fa-user"></i> LEAD</span>`;
        return `<div class="ganador-item">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <span style="font-weight:bold;"><i class="fas fa-trophy" style="color:var(--oro);margin-right:5px;"></i>${g.nombreMostrar}</span>
                ${badgeTipo}
            </div>
            <small style="color:#666;display:block;margin-top:5px;"><i class="fab fa-whatsapp"></i> ${g.celular||'Sin tel√©fono'}</small>
        </div>`;
    }).join('');
    document.getElementById('texto-sorteo').innerText = `Sorteo de ${comercio}: ${ganadores.length} ganador(es) entre ${total} participantes.`;
    document.getElementById('popup-confirmacion').style.display = 'flex';
};
window.cerrarModalSorteo = () => document.getElementById('popup-confirmacion').style.display = 'none';
window.irAlHistorial = () => { window.cerrarModalSorteo(); window.mostrarHistorial(); };

// GESTI√ìN DE SELECCIONES
window.itemsSeleccionados = new Set();
window.vistaActual = 'activos';
window.toggleSelectAll = () => {
    const selectAll = document.getElementById('select-all');
    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.checked = selectAll.checked;
        if(selectAll.checked) window.itemsSeleccionados.add(cb.dataset.id);
        else window.itemsSeleccionados.delete(cb.dataset.id);
    });
    actualizarBulkActions();
};
window.actualizarBulkActions = () => {
    const bulk = document.getElementById('bulk-actions');
    const count = document.getElementById('selected-count');
    const headerCb = document.getElementById('select-all');
    if(window.itemsSeleccionados.size > 0) {
        bulk.classList.add('active');
        count.textContent = window.itemsSeleccionados.size;
        headerCb.checked = window.itemsSeleccionados.size === document.querySelectorAll('.row-checkbox').length;
    } else {
        bulk.classList.remove('active');
        headerCb.checked = false;
    }
};
window.toggleSeleccion = (id, checkbox) => {
    if(checkbox.checked) window.itemsSeleccionados.add(id);
    else window.itemsSeleccionados.delete(id);
    actualizarBulkActions();
};
window.eliminarSeleccionados = async () => {
    if(window.itemsSeleccionados.size === 0) return mostrarToast("‚ö†Ô∏è No hay items seleccionados", "warning");
    if(!confirm(`¬øEliminar ${window.itemsSeleccionados.size} registro(s) del historial?`)) return;
    mostrarToast("üóëÔ∏è Eliminando...", "warning");
    try {
        await Promise.all(Array.from(window.itemsSeleccionados).map(id => deleteDoc(doc(db, "historial_sorteos", id))));
        mostrarToast(`‚úÖ ${window.itemsSeleccionados.size} eliminado(s)`, "success");
        window.itemsSeleccionados.clear();
        actualizarBulkActions();
        window.mostrarHistorial();
    } catch(e) { console.error(e); mostrarToast("‚ùå Error", "error"); }
};
window.desmarcarTodos = () => {
    window.itemsSeleccionados.clear();
    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    actualizarBulkActions();
};
window.eliminarIndividual = async (id, btn) => {
    if(!confirm('¬øEliminar este registro?')) return;
    const original = btn.innerHTML;
    btn.disabled = true; btn.innerHTML = "‚è≥";
    try {
        await deleteDoc(doc(db, "historial_sorteos", id));
        mostrarToast("‚úÖ Eliminado", "success");
        window.mostrarHistorial();
    } catch(e) { console.error(e); mostrarToast("‚ùå Error", "error"); btn.disabled=false; btn.innerHTML=original; }
};

// RELOJ DE CUENTA REGRESIVA
window.iniciarRelojes = () => {
    setInterval(() => {
        document.querySelectorAll('.btn-sortear-accion').forEach(btn => {
            const ts = parseInt(btn.dataset.timestamp);
            const ahora = Date.now();
            const faltan = ts - ahora;
            if (faltan > 0) {
                const d = Math.floor(faltan / 86400000);
                const h = Math.floor((faltan % 86400000) / 3600000);
                const m = Math.floor((faltan % 3600000) / 60000);
                const s = Math.floor((faltan % 60000) / 1000);
                btn.innerHTML = `‚è≥ ${d}d ${h}h ${m}m ${s}s`;
                btn.classList.add('btn-dark'); btn.classList.remove('btn-primary');
                btn.dataset.estado = 'bloqueado';
            } else {
                btn.innerHTML = `üé≤ SORTEAR AHORA`;
                btn.classList.remove('btn-dark'); btn.classList.add('btn-primary');
                btn.dataset.estado = 'listo';
            }
        });
    }, 1000);
};

// VALIDACI√ìN DE SEGURIDAD
window.validarAccionSegura = async (idComercio, claveIngresada) => {
    if (claveIngresada === CLAVE_MAESTRA) return true;
    try {
        const comercioRef = doc(db, "comercios", idComercio);
        const snap = await getDoc(comercioRef);
        if (snap.exists()) {
            const datosComercio = snap.data();
            const claveReal = datosComercio.password;
            if (claveIngresada === claveReal) return true;
        }
    } catch (error) { console.error("Error al validar clave:", error); }
    return false;
};

// INTENTAR SORTEO
window.intentarSorteo = async (btn) => {
    const ts = parseInt(btn.dataset.timestamp);
    const ahora = Date.now();
    if (ahora < ts) {
        const clave = prompt(`‚è∞ Sorteo programado para ${new Date(ts).toLocaleString()}\nIngrese CLAVE DE COMERCIO o MAESTRA para adelantar:`);
        if (!clave) return;
        if (!await validarAccionSegura(btn.dataset.id, clave)) {
            mostrarToast("‚ùå Contrase√±a incorrecta", "error");
            return;
        }
        mostrarToast("üîì Acceso autorizado - Sorteo adelantado", "warning");
    }
    ejecutarSorteo(btn.dataset.id, btn.dataset.nombre, btn.dataset.premio, parseInt(btn.dataset.cant), btn.dataset.mail, btn.dataset.logo, btn.dataset.desc, btn.dataset.claveComercio);
};

// ELIMINAR SORTEO
window.intentarEliminarSorteo = async (idComercio, fechaSorteoISO) => {
    const timestampSorteo = new Date(fechaSorteoISO).getTime();
    const ahora = Date.now();
    const diferenciaHoras = (timestampSorteo - ahora) / (1000 * 60 * 60);
    let mensajePrompt = "";
    if (diferenciaHoras < 24 && diferenciaHoras > 0) {
        mensajePrompt = "‚ö†Ô∏è ZONA CR√çTICA: Faltan menos de 24hs. Solo CLAVE MAESTRA:";
    } else {
        mensajePrompt = "Ingrese CLAVE DE COMERCIO para eliminar:";
    }
    const clave = prompt(mensajePrompt);
    if (!clave) return;
    const autorizado = await window.validarAccionSegura(idComercio, clave);
    if (autorizado) {
        if (diferenciaHoras < 24 && diferenciaHoras > 0 && clave !== CLAVE_MAESTRA) {
            mostrarToast("‚ùå Solo Admin General puede cancelar sorteos inminentes", "error");
            return;
        }
        try {
            await updateDoc(doc(db, "comercios", idComercio), {
                titulo_sorteo: null, descripcion_sorteo: null, fecha_sorteo: null, cantidad_premios: null, logoUrl: null
            });
            mostrarToast("üóëÔ∏è Sorteo cancelado exitosamente", "success");
            cargarActivos();
        } catch(e) { console.error(e); mostrarToast("‚ùå Error al eliminar", "error"); }
    } else {
        mostrarToast("‚ùå Contrase√±a incorrecta", "error");
    }
};

// CARGAR SORTEOS ACTIVOS
const cargarActivos = async () => {
    window.vistaActual = 'activos';
    window.itemsSeleccionados.clear();
    actualizarBulkActions();
    document.getElementById('header-checkbox').style.display = 'none';
    
    onSnapshot(collection(db, "comercios"), async (snap) => {
        const tabla = document.getElementById('tabla-sorteos');
        tabla.innerHTML = "";
        for (const docCom of snap.docs) {
            const c = docCom.data();
            if (c.titulo_sorteo) {
                const nomCom = c.nombre;
                const premio = c.titulo_sorteo;
                const descPremio = c.descripcion_sorteo || "";
                const cant = parseInt(c.cantidad_premios) || 1;
                const fechaSorteo = c.fecha_sorteo ? new Date(c.fecha_sorteo) : null;
                const timestamp = fechaSorteo ? fechaSorteo.getTime() : Date.now();
                const fechaISO = c.fecha_sorteo || "";
                
                let cLead = 0, cVip = 0;
                const qP = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nomCom));
                const snapP = await getDocs(qP);
                const resultados = await Promise.all(snapP.docs.map(async (p) => {
                    const dataP = p.data();
                    if (dataP.usuarioId && !dataP.usuarioId.startsWith('temp_')) {
                        try {
                            const leadDoc = await getDoc(doc(db, "leads", dataP.usuarioId));
                            if (leadDoc.exists() && (leadDoc.data().convertidoVIP || leadDoc.data().tipo === "VIP")) return "VIP";
                        } catch(e) {}
                    }
                    return dataP.tipo === "VIP" ? "VIP" : "LEAD";
                }));
                resultados.forEach(t => t === "VIP" ? cVip++ : cLead++);
                const totalP = cLead + cVip;
                
                const f = formatearFechaHora(c.fecha_sorteo) || {fecha: 'A definir', hora: ''};
                const estadoBadge = timestamp > Date.now() 
                    ? `<span class="timestamp-badge">üïê Programado: ${f.fecha} ${f.hora}</span>` 
                    : `<span class="badge badge-critica">üî¥ LISTO PARA SORTEAR</span>`;
                
                tabla.innerHTML += `<tr>
                    <td><div class="fecha-cell"><span class="fecha-principal">${f.fecha}</span><span class="hora-secundaria">${f.hora}</span>${estadoBadge}</div></td>
                    <td><img src="${c.logoUrl||''}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
                    <td>
                        <span class="badge badge-comercio">${nomCom}</span><br>
                        <span class="badge badge-premio">üéÅ ${premio}</span>
                        ${descPremio ? `<div class="premio-desc">${descPremio}</div>` : ''}
                    </td>
                    <td>
                        <div class="participantes-cell">
                            <div class="participantes-row"><span>LEAD:</span><span class="participantes-value valor-lead">${cLead}</span></div>
                            <div class="participantes-row"><span>VIP:</span><span class="participantes-value valor-vip">${cVip}</span></div>
                            <div class="participantes-row"><b>TOTAL:</b><span class="participantes-value valor-total">${totalP}</span></div>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sortear-accion" data-id="${docCom.id}" data-nombre="${nomCom}" data-premio="${premio}" data-cant="${cant}" data-mail="${c.email||''}" data-logo="${c.logoUrl||''}" data-desc="${descPremio}" data-timestamp="${timestamp}" data-clave-comercio="${c.password||''}" onclick="intentarSorteo(this)">Calculando...</button>
                        <br><button class="btn btn-danger btn-sm" style="margin-top:5px;font-size:0.8rem" onclick="intentarEliminarSorteo('${docCom.id}', '${fechaISO}')">üóëÔ∏è Cancelar</button>
                    </td>
                    <td style="text-align:center"><span class="badge badge-premios">üéÅ ${cant} premio${cant>1?'s':''}</span></td>
                </tr>`;
            }
        }
    });
};

// EJECUTAR SORTEO
const ejecutarSorteo = async (idCom, nomCom, premio, cant, mailC, logoUrl, desc, claveComercio) => {
    mostrarToast(`üé≤ Procesando sorteo para ${nomCom}...`, "warning");
    try {
        const q = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nomCom));
        const snap = await getDocs(q);
        let participantes = [];
        
        for (const d of snap.docs) {
            const partData = d.data();
            let nombreFinal = partData.nombre || "Participante";
            let celFinal = partData.celular || partData.whatsapp || "S/D";
            let tipoFinal = partData.tipo || "LEAD";
            let emailFinal = partData.email || "";
            
            if (partData.usuarioId && !partData.usuarioId.startsWith('temp_')) {
                const leadDoc = await getDoc(doc(db, "leads", partData.usuarioId));
                if (leadDoc.exists()) {
                    const ld = leadDoc.data();
                    nombreFinal = `${ld.nombres||''} ${ld.apellido||''}`.trim() || nombreFinal;
                    celFinal = ld.whatsapp || ld.celular || celFinal;
                    tipoFinal = (ld.convertidoVIP || ld.tipo === "VIP") ? "VIP" : "LEAD";
                    emailFinal = ld.email || emailFinal;
                }
            }
            participantes.push({ ...partData, nombreMostrar: nombreFinal, celular: celFinal, tipo: tipoFinal, email: emailFinal });
        }
        
        if (participantes.length === 0) { mostrarToast(`‚ö†Ô∏è Sin participantes`, "error"); return; }
        
        let ganadores = [], bolsa = [...participantes];
        for (let i=0; i<Math.min(cant, bolsa.length); i++) {
            const idx = Math.floor(Math.random() * bolsa.length);
            ganadores.push(bolsa.splice(idx, 1)[0]);
        }
        
        const comercioDoc = await getDoc(doc(db, "comercios", idCom));
        const comercioData = comercioDoc.exists() ? comercioDoc.data() : {};
        
        await addDoc(collection(db, "historial_sorteos"), {
            comercio: nomCom,
            premio: premio,
            descripcion_sorteo: desc || "",
            logoUrl: logoUrl || "",
            ganadores: ganadores,
            fecha: serverTimestamp(),
            mailComercio: mailC || 'habitatcar@gmail.com',
            claveComercio: claveComercio,
            timestampProgramado: Date.now(),
            whatsappComercio: comercioData.whatsapp || "",
            direccionComercio: comercioData.direccion || ""
        });
        
        mostrarToast(`‚úÖ Sorteo exitoso`, "success");
        window.mostrarConfirmacionSorteo(participantes.length, ganadores, nomCom);
    } catch(e) { console.error(e); mostrarToast("‚ùå Error en sorteo", "error"); }
};

// MOSTRAR HISTORIAL
window.mostrarHistorial = () => {
    window.vistaActual = 'historial';
    window.itemsSeleccionados.clear();
    window._ganadorData = {};
    actualizarBulkActions();
    document.getElementById('header-checkbox').style.display = 'table-cell';
    
    const tabla = document.getElementById('tabla-sorteos');
    onSnapshot(collection(db, "historial_sorteos"), (snap) => {
        tabla.innerHTML = "";
        window._ganadorData = {};
        
        const docs = snap.docs.sort((a,b) => (b.data().fecha?.seconds||0) - (a.data().fecha?.seconds||0));
        
        docs.forEach(docSnap => {
            const h = docSnap.data();
            const fecha = h.fecha?.toDate ? h.fecha.toDate().toLocaleString() : "Reciente";
            
            h.ganadores?.forEach((g, idx) => {
                const nombreG = g.nombreMostrar || "Invitado";
                const celG = g.celular || "";
                const emailG = g.email || "";
                const esVIP = g.tipo === "VIP";
                const badgeTipo = esVIP 
                    ? `<span class="badge badge-vip"><i class="fas fa-crown"></i> VIP</span>` 
                    : `<span class="badge badge-lead"><i class="fas fa-user"></i> LEAD</span>`;
                
                const ganadorKey = `${docSnap.id}_${idx}`;
                
                window._ganadorData[ganadorKey] = {
                    email: emailG,
                    nombre: nombreG,
                    premio: h.premio || "",
                    comercio: h.comercio || "",
                    mailComercio: h.mailComercio || 'habitatcar@gmail.com',
                    logoUrl: h.logoUrl || '',
                    whatsappComercio: h.whatsappComercio || '',
                    direccionComercio: h.direccionComercio || '',
                    celular: celG
                };
                
                tabla.innerHTML += `<tr>
                    <td class="checkbox-cell"><input type="checkbox" class="row-checkbox" data-id="${docSnap.id}" onchange="toggleSeleccion('${docSnap.id}', this)"></td>
                    <td><small>${fecha}</small></td>
                    <td><img src="${h.logoUrl||''}" class="logo-mini" onerror="this.src='${LOGO_DEFAULT}'"></td>
                    <td>
                        <span class="badge badge-comercio">${h.comercio}</span><br>
                        <span class="badge badge-premio">üéÅ ${h.premio}</span>
                        ${h.descripcion_sorteo ? `<div class="premio-desc">${h.descripcion_sorteo}</div>` : ''}
                    </td>
                    <td>
                        <div style="font-weight:bold">${nombreG}</div>
                        <div style="margin-top:4px">${badgeTipo}</div>
                    </td>
                    <td>
                        <div style="font-size:0.85em;color:var(--verde);margin-bottom:3px;">
                            <i class="fab fa-whatsapp"></i> ${celG}
                        </div>
                        ${emailG ? `<div class="email-display"><i class="fas fa-envelope"></i> ${emailG}</div>` : ''}
                        <div style="margin-top:8px;display:flex;gap:5px;">
                            <button class="btn-accion btn-wa" onclick="abrirWAPorKey('${ganadorKey}')">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button class="btn-accion btn-mail" onclick="enviarMailPorKey(this, '${ganadorKey}')">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <button class="btn-accion" style="background:#666" onclick="copiarGanador('${ganadorKey}')">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn-accion btn-delete" onclick="eliminarIndividual('${docSnap.id}', this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
        });
    });
};

// TOAST NOTIFICATIONS
function mostrarToast(mensaje, tipo="success") {
    const div = document.createElement('div');
    div.className = `toast ${tipo}`;
    div.innerText = mensaje;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3000);
}

// INICIALIZACI√ìN
document.getElementById('btn-activos').onclick = cargarActivos;
document.getElementById('btn-historial').onclick = window.mostrarHistorial;

document.addEventListener('DOMContentLoaded', () => {
    cargarActivos();
    window.iniciarRelojes();
});

// EXPORTAR FUNCIONES GLOBALES
window.abrirWA = abrirWA;
window.enviarMail = enviarMail;
window.enviarMailPorKey = enviarMailPorKey;
window.abrirWAPorKey = abrirWAPorKey;
window.copiarGanador = copiarGanador;
window.mostrarHistorial = mostrarHistorial;
window.mostrarToast = mostrarToast;
window.mostrarConfirmacionSorteo = mostrarConfirmacionSorteo;
window.cerrarModalSorteo = cerrarModalSorteo;
window.irAlHistorial = irAlHistorial;
window.toggleSeleccion = toggleSeleccion;
window.toggleSelectAll = toggleSelectAll;
window.eliminarSeleccionados = eliminarSeleccionados;
window.desmarcarTodos = desmarcarTodos;
window.eliminarIndividual = eliminarIndividual;
window.actualizarBulkActions = actualizarBulkActions;
window.intentarSorteo = intentarSorteo;
window.intentarEliminarSorteo = intentarEliminarSorteo;
window.validarAccionSegura = validarAccionSegura;
</script>
</body>
</html>
