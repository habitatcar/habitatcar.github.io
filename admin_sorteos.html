<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Sorteos Elite | H√°bitat-Car</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        header h1 { font-size: 1.8rem; margin-bottom: 8px; }
        header p { opacity: 0.9; font-size: 0.95rem; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        th { background: #667eea; color: white; padding: 14px 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .btn-accion { padding: 6px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; color: white; }
        .btn-wa { background: #25D366; }
        .btn-mail { background: #ea4335; }
        .btn-copy { background: #6c757d; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .badge-premio { background: #fff3cd; color: #856404; }
        .badge-comercio { background: #d1ecf1; color: #0c5460; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 10px; color: white; z-index: 9999; animation: slideIn 0.3s ease; }
        .success { background: #28a745; } .error { background: #dc3545; } .warning { background: #ffc107; color: #333; }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèÜ SORTEOS PREMIUM</h1>
            <p>Panel de Sorteos Elite | H√°bitat-Car</p>
        </header>

        <div class="controls">
            <button class="btn btn-primary" id="btn-prueba">üß™ CARGAR PRUEBA</button>
            <button class="btn btn-success" id="btn-activos">SORTEOS ACTIVOS</button>
            <button class="btn btn-warning" id="btn-historial">HISTORIAL DE √âXITOS</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>FECHA / INFO</th>
                    <th>COMERCIO / PREMIO</th>
                    <th>GANADORES Y ACCIONES</th>
                    <th>DATOS</th>
                </tr>
            </thead>
            <tbody id="tabla-sorteos"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // üìù COPIA AQU√ç TUS CREDENCIALES DE admin_comercios.html
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbz2xzSyQfL23SSFvvZ5jfKYYWvjMIy56XX33cSuq-DAQG64geSLsHdLnVzNmXDkzSXM5A/exec";

        /* =========================================================
           üõ†Ô∏è L√ìGICA DE WHATSAPP Y MAIL (SACADAS A WINDOW)
        ========================================================== */
        window.normalizarTelefonoAR = (numero) => {
            if (!numero) return null;
            let num = numero.toString().replace(/\D/g, '');
            if (num.length === 10) return '549' + num;
            if (num.startsWith('54') && !num.startsWith('549')) return '549' + num.substring(2);
            return num.startsWith('549') ? num : '549' + num;
        };

        window.abrirWA = (cel, nom, pre) => {
            const num = window.normalizarTelefonoAR(cel);
            const msg = encodeURIComponent(`¬°Hola ${nom}! üèÜ Soy de H√°bitat-Car. ¬°Felicidades, ganaste el sorteo de ${pre}! üéâ`);
            window.open(`https://wa.me/${num}?text=${msg}`, '_blank');
        };

        window.enviarMail = async (btn, mailG, nombre, premio, comercio, mailC) => {
            const original = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = "‚è≥";
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a5');
            doc.setDrawColor(230, 57, 70); doc.setLineWidth(2); doc.rect(5, 5, 200, 138);
            doc.text("¬°FELICITACIONES!", 105, 35, { align: "center" });
            doc.text(nombre.toUpperCase(), 105, 75, { align: "center" });
            const pdfBase64 = doc.output('datauristring').split(',')[1];

            try {
                await fetch(URL_SCRIPT, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ email: mailG, nombreGanador: nombre, premio, comercio, pdfB64: pdfBase64, cc: `habitatcar@gmail.com, ${mailC}` })
                });
                mostrarToast("‚úÖ Mail enviado correctamente");
            } catch (e) { mostrarToast("‚ùå Error en env√≠o", "error"); }
            btn.disabled = false; btn.innerHTML = original;
        };

        /* =========================================================
           üìä CARGA DE DATOS REALES
        ========================================================== */
        const cargarActivos = () => {
            onSnapshot(collection(db, "comercios"), (snap) => {
                const tabla = document.getElementById('tabla-sorteos');
                tabla.innerHTML = "";
                snap.forEach(docCom => {
                    const c = docCom.data();
                    if (c.titulo_sorteo) {
                        const fila = `<tr>
                            <td>${c.fecha_inicio_sorteo || 'Vigente'}</td>
                            <td><span class="badge badge-comercio">${c.nombre}</span><br><span class="badge badge-premio">üéÅ ${c.titulo_sorteo}</span></td>
                            <td><button class="btn btn-primary" id="btn-${docCom.id}">üé≤ SORTEAR (${c.cantidad_ganadores || 1})</button></td>
                            <td id="count-${docCom.id}">Calculando...</td>
                        </tr>`;
                        tabla.innerHTML += fila;
                        // Delegar evento despu√©s de insertar
                        setTimeout(() => {
                            const b = document.getElementById(`btn-${docCom.id}`);
                            if(b) b.onclick = () => ejecutarSorteo(c.nombre, c.titulo_sorteo, c.cantidad_ganadores || 1, c.email);
                        }, 100);
                    }
                });
            });
        };

        const ejecutarSorteo = async (nomCom, premio, cant, mailC) => {
            mostrarToast("Sorteando...");
            const q = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nomCom));
            const snap = await getDocs(q);
            let p = []; snap.forEach(d => p.push(d.data()));
            
            if(p.length === 0) return mostrarToast("Sin participantes", "error");
            
            let gans = [];
            for(let i=0; i<cant; i++) {
                if(p.length===0) break;
                gans.push(p.splice(Math.floor(Math.random()*p.length), 1)[0]);
            }

            await addDoc(collection(db, "historial_sorteos"), { comercio: nomCom, premio, ganadores: gans, fecha: serverTimestamp(), mailComercio: mailC });
            mostrarToast("‚úÖ Sorteo guardado. Revisa el historial.");
        };

        window.mostrarHistorial = () => {
            onSnapshot(collection(db, "historial_sorteos"), (snap) => {
                const tabla = document.getElementById('tabla-sorteos');
                tabla.innerHTML = "";
                snap.forEach(doc => {
                    const h = doc.data();
                    h.ganadores.forEach(g => {
                        tabla.innerHTML += `<tr>
                            <td>${h.fecha ? new Date(h.fecha.seconds*1000).toLocaleDateString() : '-'}</td>
                            <td><span class="badge badge-comercio">${h.comercio}</span></td>
                            <td><strong>${g.nombre}</strong><br>
                                <button class="btn-accion btn-wa" onclick="abrirWA('${g.celular || g.telefono}','${g.nombre}','${h.premio}')">üí¨</button>
                                <button class="btn-accion btn-mail" onclick="enviarMail(this,'${g.email}','${g.nombre}','${h.premio}','${h.comercio}','${h.mailComercio}')">üìß</button>
                            </td>
                            <td><button class="btn-accion btn-copy" onclick="navigator.clipboard.writeText('${g.nombre}')">üìã</button></td>
                        </tr>`;
                    });
                });
            });
        };

        function mostrarToast(m, t="success") {
            const div = document.createElement('div'); div.className = `toast ${t}`;
            div.innerText = m; document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // Asignar botones
        document.getElementById('btn-activos').onclick = cargarActivos;
        document.getElementById('btn-historial').onclick = window.mostrarHistorial;
        document.getElementById('btn-prueba').onclick = () => mostrarToast("Modo prueba listo", "warning");

        // Carga inicial
        cargarActivos();
    </script>
</body>
</html>
