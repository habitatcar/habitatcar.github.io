<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel de Sorteos Elite | H√°bitat-Car</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
--azul-habitat: #003d80;
--rojo-cupon: #e60000;
--naranja: #ff8c00;
--celeste: #0288d1;
--verde: #2e7d32;
--blanco: #ffffff;
--gris-texto: #666666;
--oro: #d4af37;
--zona-critica: #dc3545;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; color: #333; line-height: 1.6; padding-top: 140px; }
.faja-superior { position: fixed; top: 0; left: 0; width: 100%; background: var(--azul-habitat); border-bottom: 4px solid var(--rojo-cupon); z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.faja-contenido { max-width: 1200px; margin: 0 auto; padding: 10px 20px; display: flex; flex-direction: column; gap: 10px; }
.faja-logo { text-align: center; padding: 5px 0; }
.faja-logo img { height: 50px; width: auto; max-width: 200px; }
.faja-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; padding: 5px 0; }
.faja-nav a { padding: 6px 10px; border-radius: 4px; text-decoration: none; color: white; font-weight: 600; font-size: 11px; background: rgba(255,255,255,0.15); transition: all 0.2s; text-transform: uppercase; }
.faja-nav a:hover, .faja-nav a.active { background: var(--rojo-cupon); transform: translateY(-1px); }
.faja-nav a.active { box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
header h1 { font-size: 1.8rem; margin-bottom: 8px; }
header p { opacity: 0.9; font-size: 0.95rem; }
.controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
.btn-primary { background: #667eea; color: white; }
.btn-primary:hover { background: #5568d3; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.btn-warning { background: #ffc107; color: #333; }
.btn-warning:hover { background: #e0a800; }
.btn-info { background: #17a2b8; color: white; }
.btn-dark { background: #343a40; color: white; }
.btn-danger { background: #dc3545; color: white; }
.btn-danger:hover { background: #c82333; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }
.btn-sm { padding: 4px 8px; font-size: 0.8rem; }
.table-container { overflow-x: auto; max-height: calc(100vh - 280px); }
table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: opacity 0.3s ease; }
thead { position: sticky; top: 0; z-index: 100; background: #667eea; }
th { background: #667eea; color: white; padding: 14px 12px; text-align: left; white-space: nowrap; }
td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
.btn-accion { padding: 6px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: white; display: inline-flex; align-items: center; gap: 4px; white-space: nowrap; }
.btn-wa { background: #25D366; }
.btn-wapdf { background: linear-gradient(135deg, #25D366 0%, var(--azul-habitat) 100%); font-weight: 700; }
.btn-wapdf:hover { opacity: 0.88; }
.btn-copy { background: #6c757d; }
.btn-delete { background: #dc3545; }
.btn-delete:hover { background: #c82333; }
.badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.badge-premio { background: #fff3cd; color: #856404; }
.badge-comercio { background: #d1ecf1; color: #0c5460; }
.badge-premios { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-vip { background: #fff8e1; color: #f57f17; font-weight: bold; }
.badge-lead { background: #e3f2fd; color: #1976d2; font-weight: bold; }
.badge-critica { background: #ffebee; color: #c62828; font-weight: bold; animation: pulse 2s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.4); } 70% { box-shadow: 0 0 0 10px rgba(220,53,69,0); } 100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); } }
.toast { position: fixed; top: 20px; right: 20px; padding: 14px 20px; border-radius: 10px; color: white; z-index: 9999; animation: slideIn 0.3s ease; max-width: 360px; line-height: 1.4; }
.success { background: #28a745; } .error { background: #dc3545; } .warning { background: #ffc107; color: #333; }
@keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
.participantes-cell { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; }
.participantes-row { display: flex; justify-content: space-between; align-items: center; }
.participantes-value { font-weight: bold; padding: 2px 8px; border-radius: 4px; min-width: 30px; text-align: center; }
.valor-lead { background: #e3f2fd; color: #1976d2; }
.valor-vip { background: #fff8e1; color: #f57f17; }
.valor-total { background: #e8f5e9; color: #388e3c; }
.premio-desc { font-size: 0.85rem; color: #666; margin-top: 4px; line-height: 1.4; max-width: 200px; }
.fecha-cell { display: flex; flex-direction: column; gap: 2px; font-size: 0.85rem; min-width: 100px; }
.fecha-principal { font-weight: bold; color: #333; }
.hora-secundaria { color: #666; font-size: 0.8rem; }
.timestamp-badge { font-size: 0.75rem; color: #666; background: #f1f1f1; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }
.logo-mini { height: 80px; width: auto; max-width: 120px; object-fit: contain; display: block; margin: 0 auto; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; }
.modal-content { background: white; padding: 25px; border-radius: 16px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
.checkbox-cell { text-align: center; width: 50px; }
.checkbox-cell input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.bulk-actions { display: none; gap: 10px; margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107; }
.bulk-actions.active { display: flex; align-items: center; }
.selected-count { font-weight: bold; color: #856404; }
.slider-group { margin-bottom: 10px; }
.slider-group > .sg-label { font-size: 11px; font-weight: bold; color: #444; display: block; margin-bottom: 3px; }
.slider-row { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
.slider-row span.lbl { font-size: 10px; color: #888; width: 16px; flex-shrink: 0; text-align: center; }
.slider-row input[type=range] { flex: 1; height: 4px; }
.slider-row span.val { font-size: 10px; font-weight: bold; color: var(--azul-habitat); min-width: 22px; text-align: right; }
.pdf-section { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; }
.pdf-section h4 { font-size: 12px; color: var(--azul-habitat); margin-bottom: 7px; display: flex; align-items: center; gap: 4px; }
.txt-field { width: 100%; padding: 5px 7px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; margin-top: 3px; font-family: inherit; }
.inyectado-tag { font-size: 9px; background: #e3f2fd; color: #1976d2; padding: 1px 5px; border-radius: 10px; margin-left: 4px; }
@media (max-width: 768px) {
.faja-nav { gap: 3px; }
.faja-nav a { font-size: 9px; padding: 4px 6px; }
body { padding-top: 120px; }
.logo-mini { height: 70px; }
}
</style>
</head>
<body>
<div class="faja-superior">
<div class="faja-contenido">
<div class="faja-logo"><a href="index.html"><img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="H√°bitat-Car"></a></div>
<nav class="faja-nav">
<a href="admin_comercios.html">COMERCIOS</a><a href="admin_leads.html">LEADS</a><a href="admin_vips.html">VIPS</a>
<a href="admin_tokens_vip.html">TOKENS VIP</a><a href="admin_curioso.html">CURIOSO</a><a href="admin_estadisticas.html">ESTAD√çSTICAS</a>
<a href="admin_logs.html">LOG</a><a href="admin_tutoriales.html">TUTORIALES</a><a href="index.html">PANEL</a>
<a href="admin_legales.html">LEGALES</a><a href="admin_sorteos.html" class="active">SORTEOS</a>
</nav>
</div>
</div>

<div class="container">
<header><h1>üèÜ SORTEOS PREMIUM</h1><p>Panel de Sorteos Elite | H√°bitat-Car</p></header>

<div class="controls">
  <button class="btn btn-success" id="btn-activos">SORTEOS ACTIVOS</button>
  <button class="btn btn-warning" id="btn-historial">HISTORIAL DE √âXITOS</button>
  <button onclick="abrirEditorPDF()" title="Editar Ticket PDF" style="background:var(--azul-habitat); color:white; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:600; font-size:0.85rem; display:inline-flex; align-items:center; gap:6px;">
    <i class="fas fa-file-pdf"></i> TICKET PDF
  </button>
  <button onclick="abrirEditorWA()" title="Editar Mensaje WhatsApp" style="background:#25D366; color:white; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:600; font-size:0.85rem; display:inline-flex; align-items:center; gap:6px;">
    <i class="fab fa-whatsapp"></i> MENSAJE WA
  </button>
</div>

<div id="bulk-actions" class="bulk-actions">
<span class="selected-count"><i class="fas fa-check-circle"></i> <span id="selected-count">0</span> seleccionado(s)</span>
<button class="btn btn-danger" onclick="eliminarSeleccionados()"><i class="fas fa-trash"></i> ELIMINAR SELECCIONADOS</button>
<button class="btn btn-warning" onclick="desmarcarTodos()"><i class="fas fa-times"></i> CANCELAR</button>
</div>

<div class="table-container">
<table>
<thead>
<tr id="tabla-headers">
<th class="checkbox-cell" id="header-checkbox" style="display:none;"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
<th>FECHA</th><th>LOGO</th><th>COMERCIO / PREMIO</th><th>PARTICIPANTES</th><th>ACCIONES</th><th>PREMIOS</th>
</tr>
</thead>
<tbody id="tabla-sorteos"></tbody>
</table>
</div>
</div>

<div id="popup-confirmacion" class="modal" style="display:none;">
<div class="modal-content">
<h3 style="color:var(--azul-habitat); margin-bottom:15px;">üéâ ¬°SORTEO REALIZADO!</h3>
<p id="texto-sorteo" style="font-size:1.1rem; margin-bottom:20px; line-height:1.5;"></p>
<div id="lista-ganadores-popup" style="text-align:left; margin-bottom:20px;"></div>
<button class="btn btn-primary" onclick="irAlHistorial()">IR AL HISTORIAL DE √âXITOS</button>
<button class="btn btn-warning" onclick="cerrarModalSorteo()" style="margin-top:10px;">SEGUIR AQU√ç</button>
</div>
</div>

<div id="modalPDF" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.92); z-index:10000; overflow-y:auto; padding:16px; box-sizing:border-box;">
  <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:18px; max-width:1060px; margin:auto; padding-top:8px;">
    <div style="background:white; padding:16px; border-radius:14px; width:330px; color:#333; flex-shrink:0; max-height:88vh; overflow-y:auto;">
      <h3 style="color:var(--azul-habitat); margin-bottom:10px; font-size:15px;">üé® Dise√±o del Ticket</h3>
      <hr style="margin-bottom:10px;">
      <div class="pdf-section">
        <h4>üñºÔ∏è Fondo y color de texto</h4>
        <label style="font-size:11px; color:#555;">URL Imagen de Fondo:</label>
        <input type="text" id="cfg_bg" class="txt-field" oninput="actualizarPrevia()" placeholder="https://...">
        <label style="font-size:11px; color:#555; display:block; margin-top:7px;">Color del Texto:</label>
        <input type="color" id="cfg_color" oninput="actualizarPrevia()" style="width:100%; height:28px; cursor:pointer; border:1px solid #ccc; border-radius:4px; margin-top:3px;">
      </div>
      <div class="pdf-section">
        <h4>üî¥ Logo Comercio <span class="inyectado-tag">auto</span></h4>
        <div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_l1x" min="0" max="60" value="5" oninput="actualizarPrevia()"><span class="val" id="v_l1x">5</span></div>
        <div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_l1y" min="0" max="140" value="5" oninput="actualizarPrevia()"><span class="val" id="v_l1y">5</span></div>
        <div class="slider-row"><span class="lbl">üìê</span><input type="range" id="cfg_l1s" min="8" max="50" value="20" oninput="actualizarPrevia()"><span class="val" id="v_l1s">20</span></div>
      </div>
      <div class="pdf-section">
        <h4>üîµ Logo H√°bitat-Car <span class="inyectado-tag">auto</span></h4>
        <div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_l2x" min="0" max="60" value="45" oninput="actualizarPrevia()"><span class="val" id="v_l2x">45</span></div>
        <div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_l2y" min="0" max="140" value="5" oninput="actualizarPrevia()"><span class="val" id="v_l2y">5</span></div>
        <div class="slider-row"><span class="lbl">üìê</span><input type="range" id="cfg_l2s" min="8" max="50" value="20" oninput="actualizarPrevia()"><span class="val" id="v_l2s">20</span></div>
      </div>
      <div class="pdf-section">
        <h4>‚úèÔ∏è Nombre del Ganador <span class="inyectado-tag">inyectado</span></h4>
        <div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t1x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t1x">40</span></div>
        <div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t1y" min="20" max="155" value="90" oninput="actualizarPrevia()"><span class="val" id="v_t1y">90</span></div>
        <div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t1s" min="8" max="32" value="22" oninput="actualizarPrevia()"><span class="val" id="v_t1s">22</span></div>
      </div>
      <div class="pdf-section">
        <h4>‚úèÔ∏è T√≠tulo Premio <span class="inyectado-tag">inyectado</span></h4>
        <div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t2x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t2x">40</span></div>
        <div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t2y" min="20" max="155" value="110" oninput="actualizarPrevia()"><span class="val" id="v_t2y">110</span></div>
        <div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t2s" min="6" max="28" value="16" oninput="actualizarPrevia()"><span class="val" id="v_t2s">16</span></div>
      </div>
      <div class="pdf-section">
        <h4>‚úèÔ∏è Descripci√≥n Premio <span class="inyectado-tag">inyectado</span></h4>
        <div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_tdx" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_tdx">40</span></div>
        <div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_tdy" min="20" max="155" value="117" oninput="actualizarPrevia()"><span class="val" id="v_tdy">117</span></div>
        <div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_tds" min="5" max="20" value="11" oninput="actualizarPrevia()"><span class="val" id="v_tds">11</span></div>
      </div>
      <div class="pdf-section">
        <h4>‚úèÔ∏è Comercio <span class="inyectado-tag">inyectado</span></h4>
        <div class="slider-row"><span class="lbl">X</span><input type="range" id="cfg_t3x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t3x">40</span></div>
        <div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t3y" min="20" max="155" value="128" oninput="actualizarPrevia()"><span class="val" id="v_t3y">128</span></div>
        <div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t3s" min="6" max="28" value="14" oninput="actualizarPrevia()"><span class="val" id="v_t3s">14</span></div>
      </div>
      <div class="pdf-section">
        <h4>‚úèÔ∏è Frase libre <span style="font-size:9px; color:#888;">(editable)</span></h4>
        <input type="text" id="cfg_t4txt" class="txt-field" oninput="actualizarPrevia()" value="¬°Felicitaciones!">
        <div class="slider-row" style="margin-top:5px;"><span class="lbl">X</span><input type="range" id="cfg_t4x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t4x">40</span></div>
        <div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t4y" min="20" max="155" value="60" oninput="actualizarPrevia()"><span class="val" id="v_t4y">60</span></div>
        <div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t4s" min="6" max="28" value="14" oninput="actualizarPrevia()"><span class="val" id="v_t4s">14</span></div>
      </div>
      <div class="pdf-section">
        <h4>‚úèÔ∏è Pie de p√°gina <span style="font-size:9px; color:#888;">(editable)</span></h4>
        <input type="text" id="cfg_t5txt" class="txt-field" oninput="actualizarPrevia()" value="H√°bitat-Car">
        <div class="slider-row" style="margin-top:5px;"><span class="lbl">X</span><input type="range" id="cfg_t5x" min="5" max="75" value="40" oninput="actualizarPrevia()"><span class="val" id="v_t5x">40</span></div>
        <div class="slider-row"><span class="lbl">Y</span><input type="range" id="cfg_t5y" min="20" max="158" value="154" oninput="actualizarPrevia()"><span class="val" id="v_t5y">154</span></div>
        <div class="slider-row"><span class="lbl">pt</span><input type="range" id="cfg_t5s" min="5" max="16" value="8" oninput="actualizarPrevia()"><span class="val" id="v_t5s">8</span></div>
      </div>
      <button onclick="guardarConfigPDF()" style="width:100%; background:var(--verde); color:white; padding:11px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:13px; margin-top:4px;">üíæ GUARDAR DISE√ëO</button>
      <button onclick="cerrarModales()" style="width:100%; background:none; border:none; color:#dc3545; margin-top:6px; cursor:pointer; padding:7px; font-size:12px;">‚úï Cerrar sin guardar</button>
    </div>
    <div style="flex-shrink:0;">
      <p style="color:rgba(255,255,255,0.65); text-align:center; font-size:11px; margin-bottom:6px;">Vista previa (escala √ó3.25)</p>
      <div id="previa_ticket" style="width:260px; height:520px; background:#ddd; border-radius:14px; border:5px solid #222; position:relative; overflow:hidden; background-size:cover; background-position:center;">
        <div id="prev_l1" style="position:absolute; border:2px dashed #e60000; background:rgba(255,255,255,0.5); font-size:8px; display:flex; align-items:center; justify-content:center; color:#c00; font-weight:bold;">L1</div>
        <div id="prev_l2" style="position:absolute; border:2px dashed #003d80; background:rgba(255,255,255,0.5); font-size:8px; display:flex; align-items:center; justify-content:center; color:#003d80; font-weight:bold;">L2</div>
        <div id="prev_t1" style="position:absolute; font-weight:bold; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">NOMBRE GANADOR</div>
        <div id="prev_t2" style="position:absolute; font-weight:bold; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">PREMIO</div>
        <div id="prev_td" style="position:absolute; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">DESCRIPCI√ìN</div>
        <div id="prev_t3" style="position:absolute; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">COMERCIO</div>
        <div id="prev_t4" style="position:absolute; font-weight:bold; white-space:nowrap; transform:translateX(-50%); color:#000; pointer-events:none;">¬°Felicitaciones!</div>
        <div id="prev_t5" style="position:absolute; white-space:nowrap; transform:translateX(-50%); color:#666; pointer-events:none; font-size:8px;">H√°bitat-Car</div>
      </div>
    </div>
  </div>
</div>

<div id="modalWA" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center;">
  <div style="background:white; padding:25px; border-radius:15px; width:90%; max-width:440px; color:#333;">
    <h3 style="color:#25D366; margin-bottom:8px;"><i class="fab fa-whatsapp"></i> Mensaje de WhatsApp</h3>
    <div style="background:#fff8e1; border:1px solid #ffc107; border-radius:8px; padding:10px; margin-bottom:12px; font-size:12px; color:#555;">
      <b>‚ö†Ô∏è Sobre el PDF:</b> WhatsApp no permite adjuntar archivos por URL. El PDF se descarga en tu dispositivo y WA se abre con el mensaje listo. Adjunt√° el PDF desde tu galer√≠a.
    </div>
    <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">Mensaje personalizable:</label>
    <textarea id="cfg_wa_msg" style="width:100%; height:170px; padding:10px; font-family:sans-serif; border:1px solid #ccc; border-radius:6px; font-size:12px; resize:vertical; line-height:1.5;"></textarea>
    <div style="font-size:11px; color:#666; margin:8px 0 12px; background:#f8f9fa; padding:8px; border-radius:5px; line-height:1.7;">
      Variables: <b>{{NOMBRE}}</b>, <b>{{PREMIO}}</b>, <b>{{COMERCIO}}</b>, <b style="color:#e60000;">{{DESCRIPCION}}</b>
    </div>
    <button onclick="guardarConfigWA()" style="width:100%; background:#25D366; color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">üíæ GUARDAR MENSAJE</button>
    <button onclick="cerrarModales()" style="width:100%; background:none; border:none; color:#dc3545; margin-top:6px; cursor:pointer; padding:8px; font-size:13px;">‚úï Cerrar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, where, addDoc, serverTimestamp, getDocs, doc, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

const CLAVE_MAESTRA = "HABITAT_MASTER_2026";
const LOGO_DEFAULT  = "https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true";
const LOGO_HABITAT  = "https://i.ibb.co/m5fdvTr/HABITAT-CAR-SF.png";

const WA_DEFAULT = `üéâüèÜ ¬°Hola {{NOMBRE}}! ¬°Felicitaciones!

Ganaste el sorteo üéÅ *{{PREMIO}}*
consistente en *{{DESCRIPCION}}*
realizado por üè™ *{{COMERCIO}}*.

üìé Adjunto tu ticket ganador oficial.

‚ö†Ô∏è *¬°ATENCI√ìN ‚Äî NO TE DUERMAS!* ‚ö†Ô∏è
Ten√©s *30 d√≠as* para presentarte a reclamar tu premio. ‚è∞ Si dej√°s pasar los 30 d√≠as ‚ùå *perd√©s el premio* ‚ùå üò¥üí§ ¬°No dejes pasar esta oportunidad √∫nica!

‚Äî Equipo H√°bitat-Car üöóüè†`;

const firebaseConfig = { apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM", authDomain: "habitatcar-pro.firebaseapp.com", projectId: "habitatcar-pro", storageBucket: "habitatcar-pro.firebasestorage.app", messagingSenderId: "311691258694", appId: "1:311691258694:web:17a09051dcea7707af9347" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const leerMsgWA = () => localStorage.getItem('hc_wa_v3') || WA_DEFAULT;
const leerCfgPDF = () => { try { return JSON.parse(localStorage.getItem('hc_pdf_v3')) || {}; } catch(e) { return {}; } };

window.abrirEditorPDF = () => {
  const p = leerCfgPDF();
  const sv = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
  sv('cfg_bg', p.bg ?? ''); sv('cfg_color', p.color ?? '#000000');
  sv('cfg_l1x', p.l1x ?? 5); sv('cfg_l1y', p.l1y ?? 5); sv('cfg_l1s', p.l1s ?? 20);
  sv('cfg_l2x', p.l2x ?? 45); sv('cfg_l2y', p.l2y ?? 5); sv('cfg_l2s', p.l2s ?? 20);
  sv('cfg_t1x', p.t1x ?? 40); sv('cfg_t1y', p.t1y ?? 90); sv('cfg_t1s', p.t1s ?? 22);
  sv('cfg_t2x', p.t2x ?? 40); sv('cfg_t2y', p.t2y ?? 110); sv('cfg_t2s', p.t2s ?? 16);
  // DESCRIPCI√ìN SOLICITADA
  sv('cfg_tdx', p.tdx ?? 40); sv('cfg_tdy', p.tdy ?? 117); sv('cfg_tds', p.tds ?? 11);
  sv('cfg_t3x', p.t3x ?? 40); sv('cfg_t3y', p.t3y ?? 128); sv('cfg_t3s', p.t3s ?? 14);
  sv('cfg_t4x', p.t4x ?? 40); sv('cfg_t4y', p.t4y ?? 60); sv('cfg_t4s', p.t4s ?? 14); sv('cfg_t4txt', p.t4txt ?? '¬°Felicitaciones!');
  sv('cfg_t5x', p.t5x ?? 40); sv('cfg_t5y', p.t5y ?? 154); sv('cfg_t5s', p.t5s ?? 8); sv('cfg_t5txt', p.t5txt ?? 'H√°bitat-Car');
  document.getElementById('modalPDF').style.display = 'block';
  actualizarPrevia();
};

window.actualizarPrevia = () => {
  const p = {};
  const gv = (id) => document.getElementById(id)?.value;
  const cfg_ids = ['bg','color','l1x','l1y','l1s','l2x','l2y','l2s','t1x','t1y','t1s','t2x','t2y','t2s','tdx','tdy','tds','t3x','t3y','t3s','t4x','t4y','t4s','t4txt','t5x','t5y','t5s','t5txt'];
  cfg_ids.forEach(id => { p[id] = gv('cfg_'+id); const valEl = document.getElementById('v_'+id); if(valEl) valEl.innerText = p[id]; });

  const prev = document.getElementById('previa_ticket');
  prev.style.backgroundImage = p.bg ? `url(${p.bg})` : 'none';
  const color = p.color;

  const setPos = (id, x, y, size, txt) => {
    const el = document.getElementById(id);
    if(!el) return;
    el.style.left = (x * 3.25) + 'px';
    el.style.top = (y * 3.25) + 'px';
    if(size) el.style.fontSize = (size * 1.5) + 'px';
    if(txt) el.innerText = txt;
    el.style.color = color;
  };

  setPos('prev_l1', p.l1x, p.l1y);
  const l1 = document.getElementById('prev_l1');
  l1.style.width = (p.l1s * 3.25) + 'px'; l1.style.height = (p.l1s * 3.25) + 'px';

  setPos('prev_l2', p.l2x, p.l2y);
  const l2 = document.getElementById('prev_l2');
  l2.style.width = (p.l2s * 3.25) + 'px'; l2.style.height = (p.l2s * 3.25) + 'px';

  setPos('prev_t1', p.t1x, p.t1y, p.t1s);
  setPos('prev_t2', p.t2x, p.t2y, p.t2s);
  setPos('prev_td', p.tdx, p.tdy, p.tds); // DESCRIPCI√ìN EN PREVIA
  setPos('prev_t3', p.t3x, p.t3y, p.t3s);
  setPos('prev_t4', p.t4x, p.t4y, p.t4s, p.t4txt);
  setPos('prev_t5', p.t5x, p.t5y, p.t5s, p.t5txt);
};

window.guardarConfigPDF = () => {
  const p = {};
  const gv = (id) => document.getElementById(id)?.value;
  const cfg_ids = ['bg','color','l1x','l1y','l1s','l2x','l2y','l2s','t1x','t1y','t1s','t2x','t2y','t2s','tdx','tdy','tds','t3x','t3y','t3s','t4x','t4y','t4s','t4txt','t5x','t5y','t5s','t5txt'];
  cfg_ids.forEach(id => p[id] = gv('cfg_'+id));
  localStorage.setItem('hc_pdf_v3', JSON.stringify(p));
  mostrarToast("‚úÖ Dise√±o guardado");
};

window.abrirEditorWA = () => {
  document.getElementById('cfg_wa_msg').value = leerMsgWA();
  document.getElementById('modalWA').style.display = 'flex';
};

window.guardarConfigWA = () => {
  localStorage.setItem('hc_wa_v3', document.getElementById('cfg_wa_msg').value);
  mostrarToast("‚úÖ Mensaje guardado");
};

window.cerrarModales = () => {
  document.getElementById('modalPDF').style.display = 'none';
  document.getElementById('modalWA').style.display = 'none';
};

// GENERACI√ìN PDF CON CAMPO DESCRIPCI√ìN
window.enviarTicketElite = async (nombre, premio, comercio, telefono, logoComercio, descripcion = "") => {
    const { jsPDF } = window.jspdf;
    const p = leerCfgPDF();
    const doc = new jsPDF({ unit: "mm", format: [80, 160] });
    const color = p.color || "#000000";

    const drawImg = (url, x, y, size) => {
        return new Promise((resolve) => {
            if(!url) return resolve();
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => { doc.addImage(img, 'PNG', x, y, size, size); resolve(); };
            img.onerror = () => resolve();
            img.src = url;
        });
    };

    if(p.bg){
        await new Promise(r => {
            const bg = new Image(); bg.crossOrigin = "Anonymous";
            bg.onload = () => { doc.addImage(bg, 'JPEG', 0, 0, 80, 160); r(); };
            bg.onerror = r; bg.src = p.bg;
        });
    }

    await drawImg(logoComercio || LOGO_DEFAULT, parseInt(p.l1x||5), parseInt(p.l1y||5), parseInt(p.l1s||20));
    await drawImg(LOGO_HABITAT, parseInt(p.l2x||45), parseInt(p.l2y||5), parseInt(p.l2s||20));

    doc.setTextColor(color);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(parseInt(p.t1s||22));
    doc.text(nombre.toUpperCase(), parseInt(p.t1x||40), parseInt(p.t1y||90), { align: "center" });

    doc.setFontSize(parseInt(p.t2s||16));
    doc.text(premio, parseInt(p.t2x||40), parseInt(p.t2y||110), { align: "center" });

    // DESCRIPCI√ìN INYECTADA EN PDF
    doc.setFont("helvetica", "normal");
    doc.setFontSize(parseInt(p.tds||11));
    doc.text(descripcion, parseInt(p.tdx||40), parseInt(p.tdy||117), { align: "center", maxWidth: 65 });

    doc.setFontSize(parseInt(p.t3s||14));
    doc.text(comercio, parseInt(p.t3x||40), parseInt(p.t3y||128), { align: "center" });

    doc.setFont("helvetica", "bold");
    doc.setFontSize(parseInt(p.t4s||14));
    doc.text(p.t4txt || "¬°Felicitaciones!", parseInt(p.t4x||40), parseInt(p.t4y||60), { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(parseInt(p.t5s||8));
    doc.text(p.t5txt || "H√°bitat-Car", parseInt(p.t5x||40), parseInt(p.t5y||154), { align: "center" });

    doc.save(`Ticket_${nombre.replace(/\s+/g,'_')}.pdf`);

    let msg = leerMsgWA()
        .replace(/{{NOMBRE}}/g, nombre)
        .replace(/{{PREMIO}}/g, premio)
        .replace(/{{COMERCIO}}/g, comercio)
        .replace(/{{DESCRIPCION}}/g, descripcion);

    setTimeout(() => {
        window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(msg)}`, '_blank');
    }, 1500);
};

// L√ìGICA DE CARGA Y TABLA (SIN CAMBIOS ADICIONALES)
const cargarActivos = async () => {
    const q = query(collection(db, "sorteos"), where("estado", "==", "activo"));
    const snap = await getDocs(q);
    const tbody = document.getElementById('tabla-sorteos');
    tbody.innerHTML = '';
    document.getElementById('tabla-headers').innerHTML = '<th>FECHA</th><th>LOGO</th><th>COMERCIO / PREMIO</th><th>PARTICIPANTES</th><th>ACCIONES</th><th>PREMIOS</th>';
    
    snap.forEach(docSnap => {
        const s = docSnap.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><div class="fecha-cell"><span class="fecha-principal">${s.fecha_inicio || ''}</span></div></td>
            <td><img src="${s.logo_comercio || LOGO_DEFAULT}" class="logo-mini"></td>
            <td>
                <div style="font-weight:bold; color:var(--azul-habitat);">${s.comercio}</div>
                <div class="badge badge-premio">${s.premio}</div>
                <div class="premio-desc">${s.descripcion || ''}</div>
            </td>
            <td>
                <div class="participantes-cell">
                    <div class="participantes-row"><span>Total:</span> <span class="participantes-value valor-total">${s.participantes_total || 0}</span></div>
                </div>
            </td>
            <td><button class="btn btn-primary btn-sm" onclick="intentarSorteo('${docSnap.id}')">REALIZAR SORTEO</button></td>
            <td><span class="badge badge-premios">${s.cantidad_premios || 1}</span></td>
        `;
        tbody.appendChild(tr);
    });
};

const mostrarHistorial = async () => {
    const q = query(collection(db, "historial_sorteos"));
    const snap = await getDocs(q);
    const tbody = document.getElementById('tabla-sorteos');
    tbody.innerHTML = '';
    document.getElementById('tabla-headers').innerHTML = '<th class="checkbox-cell"><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th><th>FECHA</th><th>GANADOR</th><th>PREMIO / COMERCIO</th><th>ACCIONES</th>';
    
    snap.forEach(docSnap => {
        const h = docSnap.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="checkbox-cell"><input type="checkbox" class="row-checkbox" value="${docSnap.id}" onchange="actualizarBulkActions()"></td>
            <td><div class="fecha-cell"><span class="fecha-principal">${h.fecha_sorteo || ''}</span></div></td>
            <td style="font-weight:bold;">${h.ganador_nombre}</td>
            <td>
                <div class="badge badge-premio">${h.premio}</div>
                <div style="font-size:0.8rem; color:#666;">${h.comercio}</div>
            </td>
            <td>
                <button class="btn-accion btn-wapdf" onclick="enviarTicketElite('${h.ganador_nombre}','${h.premio}','${h.comercio}','${h.ganador_telefono}','${h.logo_comercio}','${h.descripcion||""}')">
                    <i class="fab fa-whatsapp"></i> ENVIAR TICKET
                </button>
                <button class="btn-accion btn-delete" onclick="intentarEliminarSorteo('${docSnap.id}')"><i class="fas fa-trash"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });
};

window.intentarSorteo = (id) => { if(confirm("¬øRealizar sorteo ahora?")) { window.mostrarConfirmacionSorteo("Sorteo exitoso"); } };
window.mostrarConfirmacionSorteo = (t) => { document.getElementById('texto-sorteo').innerText = t; document.getElementById('popup-confirmacion').style.display='flex'; };
window.cerrarModalSorteo = () => { document.getElementById('popup-confirmacion').style.display='none'; };
window.irAlHistorial = () => { cerrarModalSorteo(); mostrarHistorial(); };
window.mostrarToast = (m, t="success") => { const d = document.createElement('div'); d.className=`toast ${t}`; d.innerText=m; document.body.appendChild(d); setTimeout(()=>d.remove(),3000); };

document.getElementById('btn-activos').onclick = cargarActivos;
document.getElementById('btn-historial').onclick = mostrarHistorial;
document.addEventListener('DOMContentLoaded', () => { cargarActivos(); });
</script>
</body>
</html>
