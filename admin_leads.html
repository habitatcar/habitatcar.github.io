<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Leads | H√°bitat-Car</title>
    <style>
        :root {
            --azul-oscuro: #0a192f;
            --celeste-habitat: #004a99;
            --oro-alegre: #ffc107;
            --rojo: #dc3545;
        }
        body { background: var(--azul-oscuro); color: white; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { padding: 15px; border-bottom: 2px solid var(--celeste-habitat); display: flex; justify-content: space-between; align-items: center; }
        .search-area { background: #112240; padding: 15px; display: flex; gap: 10px; align-items: center; }
        input, select { background: #0a192f; color: white; border: 1px solid var(--celeste-habitat); padding: 8px; border-radius: 5px; }
        .table-wrapper { overflow-y: auto; flex: 1; padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: var(--oro-alegre); border-bottom: 2px solid var(--celeste-habitat); padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid #1d2d44; }
        .col-usos { color: var(--rojo); font-weight: bold; font-size: 1.2em; text-align: center; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 10px; margin-right: 5px; }
        .btn-vip { background: var(--oro-alegre); color: black; }
        .btn-del { background: var(--rojo); color: white; }
        .contador-naranja { background: black; color: var(--oro-alegre); padding: 5px 10px; border: 1px solid var(--oro-alegre); border-radius: 4px; }
    </style>
</head>
<body>

    <header class="header">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" height="50">
        <h2 style="margin:0">PANEL DE LEADS</h2>
        <div style="color:var(--oro-alegre)">Total: <span id="contador-total">0</span></div>
    </header>

    <div class="search-area">
        <input type="text" id="buscador" placeholder="Buscar apellido..." onkeyup="filtrarLeads()">
        <select id="filtro-provincia" onchange="filtrarLeads()"><option value="">PROVINCIA</option></select>
        <div class="contador-naranja" id="count-prov">0</div>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>REGISTRO</th>
                    <th>APELLIDO Y NOMBRE</th>
                    <th>WHATSAPP</th>
                    <th>LOCALIDAD</th>
                    <th style="text-align:center">USOS</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody id="lista-leads"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let todosLosLeads = [];
        let mapaUsos = {}; 

        // 1. VINCULACI√ìN: Contamos los usos desde los logs
        onSnapshot(collection(db, "logs_actividad"), (snap) => {
            mapaUsos = {};
            snap.forEach(d => {
                const log = d.data();
                if(log.tipo === "canje" && log.usuarioId) {
                    mapaUsos[log.usuarioId] = (mapaUsos[log.usuarioId] || 0) + 1;
                }
            });
            renderizar(todosLosLeads);
        });

        // 2. Carga de Leads
        onSnapshot(collection(db, "leads"), (snap) => {
            todosLosLeads = [];
            snap.forEach(d => {
                if (d.data().convertidoVIP !== true) {
                    todosLosLeads.push({ id: d.id, ...d.data() });
                }
            });
            renderizar(todosLosLeads);
        });

        function renderizar(datos) {
            const lista = document.getElementById('lista-leads');
            lista.innerHTML = "";
            document.getElementById('contador-total').innerText = datos.length;

            datos.forEach(l => {
                const cantUsos = mapaUsos[l.id] || 0; // Aqu√≠ se aplica el v√≠nculo
                lista.innerHTML += `
                    <tr>
                        <td>${l.fechaRegistro ? new Date(l.fechaRegistro).toLocaleDateString() : '---'}</td>
                        <td>${(l.apellido || '').toUpperCase()}, ${l.nombres || ''}</td>
                        <td>${l.whatsapp || ''}</td>
                        <td>${l.localidad || ''}</td>
                        <td class="col-usos">${cantUsos}</td>
                        <td>
                            <button class="btn btn-vip" onclick="hacerVIP('${l.id}')">üíé VIP</button>
                            <button class="btn btn-del" onclick="borrar('${l.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
        }

        window.hacerVIP = async (id) => {
            if(confirm("¬øMover a VIP?")) {
                await updateDoc(doc(db, "leads", id), { convertidoVIP: true, fechaVIP: Date.now() });
            }
        };

        window.borrar = async (id) => {
            if(confirm("¬øEliminar?")) await deleteDoc(doc(db, "leads", id));
        };

        window.filtrarLeads = () => {
            const b = document.getElementById('buscador').value.toLowerCase();
            const filtrados = todosLosLeads.filter(l => l.apellido?.toLowerCase().includes(b));
            renderizar(filtrados);
        };
    </script>
</body>
</html>
