<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel Leads | Hábitat-Car</title>

  <!-- Librerías para generación de PDF y gráficos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --celeste-habitat: #004A99;
      --gris-fondo: #f5f5f5;
      --borde-tabla: #ddd;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: var(--gris-fondo);
      margin: 0;
      padding: 0;
    }
    .header {
      background-color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--celeste-habitat);
    }
    .logo {
      height: 40px;
    }
    .nav-links a {
      margin-left: 15px;
      text-decoration: none;
      color: var(--celeste-habitat);
      font-weight: bold;
    }
    .search-bar {
      padding: 15px 20px;
      background-color: white;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      border-bottom: 1px solid #eee;
    }
    .search-bar select, .search-bar button {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    .search-bar select {
      min-width: 150px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--borde-tabla);
    }
    th {
      background-color: var(--celeste-habitat);
      color: white;
      position: sticky;
      top: 0;
    }
    tr:hover {
      background-color: #f9f9f9;
    }
    .acciones button {
      margin-right: 5px;
      padding: 4px 8px;
      font-size: 12px;
    }
  </style>
</head>
<body>

<div class="header">
  <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="Hábitat-Car" class="logo">
  <div class="nav-links">
    <a href="admin_comercios.html">Comercios</a>
    <a href="admin_leads.html">Leads</a>
    <a href="admin_vips.html">Vips</a>
    <a href="admin_tokens_vip.html">Tokens Vip</a>
    <a href="admin_curioso.html">Curioso</a>
    <a href="admin_estadisticas.html">Estadísticas</a>
    <a href="admin_logs.html">Log</a>
    <a href="admin_tutoriales.html">Tutoriales</a>
    <a href="index.html">Panel Ingreso</a>
    <a href="admin_legales.html">Legales</a>
  </div>
</div>

<div class="search-bar">
  <select id="filtro-provincia">
    <option value="">PROVINCIA</option>
    <!-- Opciones se llenan dinámicamente -->
  </select>
  <select id="filtro-localidad">
    <option value="">LOCALIDAD</option>
    <!-- Opciones se llenan dinámicamente -->
  </select>
  <button onclick="restablecerTodosLosCupones()">RESTABLECER CUPONES</button>

  <!-- Selector de Reporte PDF (agregado aquí) -->
  <select onchange="generarReportePDF(this.value); this.value='';" style="border-color: var(--celeste-habitat); font-weight: bold;">
    <option value="">REPORTE PDF</option>
    <option value="localidad">POR LOCALIDAD</option>
    <option value="provincia">POR PROVINCIA</option>
    <option value="pais">PAÍS (REPORTE GENERAL)</option>
  </select>
</div>

<table id="tabla-leads">
  <thead>
    <tr>
      <th>REGISTRO ↕</th>
      <th>ÚLT. ACTIVIDAD ↕</th>
      <th>APELLIDO Y NOMBRE ↕</th>
      <th>WHATSAPP</th>
      <th>PROVINCIA</th>
      <th>CIUDAD</th>
      <th>CANT. USOS ↕</th>
      <th>ACCIONES</th>
    </tr>
  </thead>
  <tbody id="cuerpo-tabla-leads">
    <!-- Contenido dinámico -->
  </tbody>
</table>

<script type="module">
  // Aquí iría tu lógica principal de Firebase, carga de leads, filtros, etc.
  // Suponemos que `todosLosLeads` ya está definido globalmente o accesible en este scope.

  // --- LÓGICA DE REPORTE PDF (COPIADA DE ADMIN_VIPS) ---
  window.generarReportePDF = async (nivel) => {
    if (!nivel) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let filtrados = [];
    let tituloFiltro = "";

    if (nivel === "pais") {
        filtrados = todosLosLeads;
        tituloFiltro = "REPORTE GENERAL - TODO EL PAÍS";
    } else if (nivel === "provincia") {
        const prov = document.getElementById('filtro-provincia').value;
        if (!prov) return alert("Selecciona una provincia");
        filtrados = todosLosLeads.filter(l => l.provincia_normalized === prov);
        tituloFiltro = `PROVINCIA: ${prov.toUpperCase()}`;
    } else if (nivel === "localidad") {
        const loc = document.getElementById('filtro-localidad').value;
        if (!loc) return alert("Selecciona una localidad");
        filtrados = todosLosLeads.filter(l => l.localidad_normalized === loc);
        tituloFiltro = `LOCALIDAD: ${loc.toUpperCase()}`;
    }

    if (filtrados.length === 0) return alert("No hay datos para el reporte");

    // Encabezado Estilo Hábitat-Car
    doc.setFillColor(10, 25, 47);
    doc.rect(0, 0, 210, 40, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(22);
    doc.text("HÁBITAT-CAR: PANEL LEADS", 15, 25);
    doc.setFontSize(10);
    doc.text(`GENERADO: ${new Date().toLocaleString()}`, 15, 33);

    doc.setTextColor(0, 74, 153);
    doc.setFontSize(14);
    doc.text(tituloFiltro, 15, 50);
    doc.text(`TOTAL DE LEADS: ${filtrados.length}`, 15, 57);

    const filas = filtrados.map(l => [
        l.fechaRegistro ? new Date(l.fechaRegistro).toLocaleDateString() : '---',
        `${(l.apellido || '').toUpperCase()}, ${(l.nombres || '').toUpperCase()}`,
        l.whatsapp || '---',
        pascalCase(l.provincia || '---'),
        pascalCase(l.localidad || '---'),
        l.usos_count || 0
    ]);

    doc.autoTable({
        startY: 65,
        head: [['REGISTRO', 'APELLIDO Y NOMBRE', 'WHATSAPP', 'PROVINCIA', 'LOCALIDAD', 'USOS']],
        body: filas,
        headStyles: { fillColor: [0, 74, 153], textColor: 255 },
        alternateRowStyles: { fillColor: [240, 240, 240] },
        styles: { fontSize: 9 }
    });

    // Gráfico de Barras al final (Opcional, copiado del original)
    const stats = {};
    filtrados.forEach(l => {
        const loc = l.localidad || "Otros";
        stats[loc] = (stats[loc] || 0) + 1;
    });

    const labels = Object.keys(stats).slice(0, 10);
    const data = labels.map(l => stats[l]);

    const canvas = await renderBarChart("Top Localidades", labels, data);
    const imgData = canvas.toDataURL('image/png');
    doc.addPage();
    doc.text("ESTADÍSTICAS DE DISTRIBUCIÓN", 15, 20);
    doc.addImage(imgData, 'PNG', 15, 30, 180, 80);

    doc.save(`Reporte_Leads_${nivel}_${new Date().getTime()}.pdf`);
  };

  async function renderBarChart(titulo, labels, data) {
    const canvas = document.createElement('canvas');
    canvas.width = 800; canvas.height = 300;
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Cantidad de Leads',
                data: data,
                backgroundColor: 'rgba(0, 74, 153, 0.7)',
                borderColor: 'rgba(0, 74, 153, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: false,
            plugins: { title: { display: true, text: titulo } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
    });
    await new Promise(r => setTimeout(r, 200));
    return canvas;
  }

  // Función auxiliar requerida (asegúrate de que exista en tu código)
  function pascalCase(str) {
    return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
  }

  // Simulación mínima para evitar errores si `todosLosLeads` no está definido aún
  window.todosLosLeads = window.todosLosLeads || [];

</script>

</body>
</html>
