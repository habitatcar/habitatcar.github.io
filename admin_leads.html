<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Leads Real-Time | H√°bitat-Car</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --azul-oscuro: #0a192f; --oro: #ffc107; --rojo: #dc3545; }
        body { background-color: var(--azul-oscuro); color: white; font-family: 'Segoe UI', sans-serif; }
        .tab-active { border-bottom: 4px solid var(--rojo); color: white; }
        .text-oro { color: var(--oro); }
        .bg-navy { background-color: #112240; }
        
        /* Estilo para la columna de usos */
        .cant-usos-badge {
            background: black;
            border: 2px solid var(--rojo);
            color: var(--rojo);
            font-weight: 900;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 1.1rem;
        }
    </style>
</head>
<body class="p-4">

    <header class="flex justify-between items-center mb-6 border-b-2 border-blue-900 pb-4">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" class="h-16">
        <nav class="flex gap-2 text-[10px] font-bold uppercase">
            <a href="admin_leads.html" class="tab-active p-2">Leads</a>
            <a href="admin_vips.html" class="p-2 text-gray-500">Vips</a>
            <a href="admin_logs.html" class="p-2 text-gray-500">Log Actividad</a>
        </nav>
    </header>

    <div class="bg-navy p-4 rounded-xl mb-6 flex flex-wrap gap-4 items-center">
        <input type="text" id="buscador" placeholder="Buscar por apellido o WhatsApp..." 
               class="bg-black border border-blue-800 p-2 rounded-lg w-64 text-sm outline-none focus:border-oro">
        
        <div class="flex items-center gap-2">
            <span class="text-[10px] text-gray-400 uppercase">Total Leads:</span>
            <span id="cont-total" class="bg-black text-oro px-3 py-1 rounded border border-oro font-bold">0</span>
        </div>
    </div>

    <div class="overflow-x-auto bg-navy rounded-2xl border border-gray-800">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="text-oro text-[11px] uppercase border-b border-blue-900">
                    <th class="p-4">Registro</th>
                    <th class="p-4">Lead / Usuario</th>
                    <th class="p-4">WhatsApp</th>
                    <th class="p-4">Ubicaci√≥n</th>
                    <th class="p-4 text-center">Cant. Usos</th>
                    <th class="p-4">Acciones</th>
                </tr>
            </thead>
            <tbody id="tabla-leads" class="text-sm divide-y divide-gray-800">
                </tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let leadsLocal = [];
        let mapaUsos = {}; // Aqu√≠ guardaremos cu√°ntos canjes tiene cada ID

        // 1. ESCUCHAR LOS CANJES (Logs) PARA CONTAR USOS
        // Tal como lo hace tu c√≥digo de auditor√≠a
        const qLogs = query(collection(db, "logs_actividad"), where("tipo", "==", "canje"));
        onSnapshot(qLogs, (snap) => {
            mapaUsos = {}; // Reiniciar conteo
            snap.forEach(doc => {
                const data = doc.data();
                const uid = data.usuarioId || data.userId; // Aseguramos capturar el ID
                if(uid) {
                    mapaUsos[uid] = (mapaUsos[uid] || 0) + 1;
                }
            });
            renderizar(); // Re-renderizar cuando cambian los usos
        });

        // 2. ESCUCHAR LA COLECCI√ìN DE LEADS
        const qLeads = query(collection(db, "leads"), where("convertidoVIP", "==", false));
        onSnapshot(qLeads, (snap) => {
            leadsLocal = [];
            snap.forEach(d => leadsLocal.push({ id: d.id, ...d.data() }));
            renderizar();
        });

        function renderizar() {
            const tabla = document.getElementById('tabla-leads');
            const busq = document.getElementById('buscador').value.toLowerCase();
            tabla.innerHTML = "";

            const filtrados = leadsLocal.filter(l => 
                (l.apellido || "").toLowerCase().includes(busq) || 
                (l.whatsapp || "").includes(busq)
            );

            document.getElementById('cont-total').innerText = filtrados.length;

            filtrados.forEach(l => {
                // Buscamos en nuestro mapa de usos din√°mico
                const usosReales = mapaUsos[l.id] || 0;
                const fecha = l.fechaRegistro ? new Date(l.fechaRegistro).toLocaleDateString() : '---';

                tabla.innerHTML += `
                    <tr class="hover:bg-black/40 transition-colors">
                        <td class="p-4 text-gray-400 font-mono text-xs">${fecha}</td>
                        <td class="p-4">
                            <div class="font-bold text-white uppercase">${l.apellido}, ${l.nombres}</div>
                            <div class="text-[10px] text-blue-400 font-mono">${l.id}</div>
                        </td>
                        <td class="p-4 text-oro font-bold">${l.whatsapp}</td>
                        <td class="p-4 text-gray-400 text-xs">${l.localidad || '---'}<br>${l.provincia || '---'}</td>
                        <td class="p-4 text-center">
                            <span class="cant-usos-badge">${usosReales}</span>
                        </td>
                        <td class="p-4">
                            <button onclick="borrar('${l.id}')" class="bg-red-900/30 text-red-500 p-2 rounded hover:bg-red-600 hover:text-white transition-all">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
        }

        // Buscador en tiempo real
        document.getElementById('buscador').addEventListener('input', renderizar);

        window.borrar = async (id) => {
            if(confirm("¬øEliminar este lead permanentemente?")) {
                await deleteDoc(doc(db, "leads", id));
            }
        };

    </script>
</body>
</html>
