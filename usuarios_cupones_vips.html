<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIP Premium | H치bitat-Car</title>

    <link rel="icon" type="image/png" href="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo_redondo.png?raw=true">
    <link rel="apple-touch-icon" href="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo_redondo.png?raw=true">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="H치bitat-Car">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkhhYml0YXQtQ2FyIiwKICAic2hvcnRfbmFtZSI6ICJIYWJpdGF0LUNhciIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vZ2l0aHViLmNvbS9oYWJpdGF0Y2FyL2hhYml0YXRjYXIuZ2l0aHViLmlvL2Jsb2IvbWFpbi9sb2dvX3JlZG9uZG8ucG5nP3Jhdz10cnVlIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXSwKICAic3RhcnRfdXJsIjogIi91c3Vhcmlvc19jdXBvbmVzX3ZpcHMuaHRtbCIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzAwMDAwMCIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDAwMDAiCn0=">

    <style>
        :root {
            --oro: #d4af37;
            --oro-brillante: #f9d976;
            --negro-vip: #050505;
            --gris-oscuro: #1a1a1a;
            --blanco: #ffffff;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--negro-vip);
            color: var(--blanco);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .header-vip {
            width: 100%;
            background: linear-gradient(180deg, #111, #000);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid var(--oro);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-vip { width: 180px; filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.5)); }

        .search-container {
            width: 90%;
            max-width: 500px;
            margin: 20px 0;
        }

        #filtroNombre {
            width: 100%;
            padding: 15px;
            border-radius: 30px;
            border: 1px solid var(--oro);
            background: #111;
            color: white;
            font-size: 16px;
            outline: none;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 10px;
            padding-bottom: 100px;
        }

        .card-vip {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            border: 1px solid #333;
            border-radius: 20px;
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }

        .card-vip::before {
            content: "PREMIUM";
            position: absolute;
            top: 15px;
            right: -30px;
            background: var(--oro);
            color: black;
            font-size: 10px;
            font-weight: bold;
            padding: 5px 40px;
            transform: rotate(45deg);
        }

        .card-img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-bottom: 2px solid var(--oro);
        }

        .card-body { padding: 20px; text-align: center; }
        .card-title { font-size: 22px; color: var(--oro-brillante); margin: 0; text-transform: uppercase; letter-spacing: 1px; }
        .card-benefit { font-size: 18px; margin: 10px 0; color: #ddd; font-weight: 300; }

        .btn-canjear {
            background: linear-gradient(45deg, var(--oro), var(--oro-brillante));
            color: black;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            text-transform: uppercase;
            width: 100%;
            margin-top: 10px;
        }

        .btn-usado {
            background: #333;
            color: #777;
            cursor: not-allowed;
        }

        /* Modal Estilo VIP */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: #111;
            border: 2px solid var(--oro);
            border-radius: 30px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
        }

        .codigo-box {
            font-size: 40px;
            font-weight: 900;
            color: var(--oro-brillante);
            margin: 20px 0;
            letter-spacing: 5px;
            background: #000;
            padding: 20px;
            border-radius: 15px;
            border: 1px dashed var(--oro);
        }

        .footer-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #000;
            border-top: 1px solid var(--oro);
            display: flex;
            justify-content: space-around;
            padding: 15px;
            z-index: 100;
        }

        .nav-item { color: var(--oro); text-decoration: none; font-size: 12px; text-align: center; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 5px; }

        #loading {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: black; display:flex; justify-content:center; align-items:center; z-index:9999;
        }

        .spinner {
            width: 50px; height: 50px; border: 5px solid #333;
            border-top: 5px solid var(--oro); border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading"><div class="spinner"></div></div>

    <header class="header-vip">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" class="logo-vip">
    </header>

    <div class="search-container">
        <input type="text" id="filtroNombre" placeholder="Buscar comercio..." onkeyup="filtrar()">
    </div>

    <div class="container" id="contenedor-cupones">
        </div>

    <div id="modalCanje" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--oro);">C칍DIGO DE CANJE</h2>
            <p id="modal-comercio" style="font-weight: bold;"></p>
            <div class="codigo-box" id="codigo-generado">------</div>
            <p style="font-size: 14px; color: #aaa;">Mostr치 este c칩digo en el comercio para acceder al beneficio.</p>
            <div id="timer" style="color: var(--oro); font-weight: bold; font-size: 1.2em; margin-top: 10px;">
                Cerrando en <span id="countdown">30</span>s
            </div>
            <button class="btn-canjear" style="margin-top:20px;" onclick="location.reload()">ENTENDIDO</button>
        </div>
    </div>

    <nav class="footer-nav">
        <a href="#" class="nav-item"><i>游눑</i>Club VIP</a>
        <a href="https://wa.me/543884618228" class="nav-item"><i>游님</i>Soporte</a>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const leadId = localStorage.getItem('leadId_v16');
        if (!leadId) {
            window.location.replace("usuarios_registro_vip.html");
        }

        async function cargarCupones() {
            try {
                const querySnapshot = await getDocs(collection(db, "comercios_vips"));
                const contenedor = document.getElementById('contenedor-cupones');
                contenedor.innerHTML = "";

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const id = doc.id;
                    const usadoHoy = localStorage.getItem('uso_vip_' + id);
                    
                    const card = document.createElement('div');
                    card.className = 'card-vip';
                    card.dataset.nombre = data.nombre.toLowerCase();
                    
                    card.innerHTML = `
                        <img src="${data.imagen || 'https://via.placeholder.com/400x200?text=Comercio+VIP'}" class="card-img">
                        <div class="card-body">
                            <h3 class="card-title">${data.nombre}</h3>
                            <p class="card-benefit">${data.beneficio}</p>
                            <button class="btn-canjear ${usadoHoy ? 'btn-usado' : ''}" 
                                    onclick="window.abrirCanje('${id}', '${data.nombre}', '${data.beneficio}')"
                                    ${usadoHoy ? 'disabled' : ''}>
                                ${usadoHoy ? 'CUP칍N UTILIZADO' : 'OBTENER BENEFICIO'}
                            </button>
                        </div>
                    `;
                    contenedor.appendChild(card);
                });
                document.getElementById('loading').style.display = 'none';
            } catch (e) {
                console.error("Error al cargar:", e);
            }
        }

        cargarCupones();

        window.abrirCanje = (id, nom, ben) => {
            if (confirm(`쮻eseas canjear el beneficio en ${nom}? Solo puedes usarlo una vez por d칤a.`)) {
                window.confirmarCanje(id, nom, ben);
            }
        };

        window.confirmarCanje = async (id, nom, ben) => {
            const codigoIdentidad = Math.random().toString(36).substring(2, 8).toUpperCase();
            const modal = document.getElementById('modalCanje');
            const nUso = new Date().toLocaleDateString();

            document.getElementById('modal-comercio').innerText = nom;
            document.getElementById('codigo-generado').innerText = codigoIdentidad;
            modal.style.display = 'flex';

            try {
                const ahora = Date.now();

                // INICIO DE MODIFICACION LOGICA INTERNA - ACTUALIZAR CANT USOS EN LEADS
                const userRef = doc(db, "leads", leadId);
                await updateDoc(userRef, {
                    usos_count: increment(1),
                    lastSubmission: ahora
                });
                // FIN DE MODIFICACION LOGICA INTERNA

                await addDoc(collection(db, "logs_actividad"), {
                    timestamp: ahora,
                    tipo: "canje",
                    accion: "CANJE VIP",
                    nombre: `${codigoIdentidad} canje칩 ${ben} en ${nom}`,
                    comercioId: id,
                    modulo: "VIPS"
                });

                await addDoc(collection(db, "logs_vip"), { 
                    comercio: nom, 
                    comercioId: id,
                    fecha: serverTimestamp(), 
                    uso_nro: nUso,
                    tipo: "VIP",
                    beneficio: ben,
                    codigoGenerado: codigoIdentidad
                });

                localStorage.setItem('uso_vip_' + id, nUso);

                let s = 30;
                const t = setInterval(() => {
                    s--;
                    document.getElementById('countdown').innerText = s;
                    if(s <= 0) { 
                        clearInterval(t); 
                        location.reload(); 
                    }
                }, 1000);
            } catch(e) { 
                console.error("Error al registrar en Log:", e);
                alert("Error de conexi칩n con el servidor de Logs.");
            }
        };

        window.filtrar = () => {
            const texto = document.getElementById('filtroNombre').value.toLowerCase();
            document.querySelectorAll('.card-vip').forEach(c => {
                c.style.display = c.dataset.nombre.includes(texto) ? 'block' : 'none';
            });
        };
    </script>
</body>
</html>
