<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIP Premium | H√°bitat-Car</title>

    <link rel="icon" type="image/png" href="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true  ">
    <link rel="apple-touch-icon" href="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true  ">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="H√°bitat-Car">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkhhYml0YXQtQ2FyIFZJUCIsCiAgInNob3J0X25hbWUiOiAiSGFiSVRBVC1DQVIiLAogIClY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2dpdGh1Yi5jb20vaGFiaXRhdGNhci9oYWJpdGF0Y2FyLmdpdGh1Yi5pby9ibG9iL21haW4vbG9nby5wbmc/cmF3PXRydWUiLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNKYWJsZSIKICAgIH0KICBdLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzAwNGE5OSIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDRhOTkiCn0=">

    <script src="https://unpkg.com/html5-qrcode  "></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js  "></script>

    <style>
        :root {
            --dorado: #d4af37;
            --dorado-brillante: #f9f295;
            --negro-fondo: #0a0a0a;
            --negro-card: #141414;
            --azul-lindo: #0056b3;
            --verde: #2e7d32;
            --rosa: #c2185b;
            --gris-volver: #757575;
            --facebook: #1877f2;
            --instagram: #e4405f;
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: #1a1a1a; 
            background-image: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url("https://www.transparenttextures.com/patterns/gold-tips.png  "); 
            background-size: cover; 
            background-attachment: fixed; 
            margin: 0; 
            padding: 0; 
            padding-bottom: 80px; 
            color: white; 
        }

        .header-vip { 
            padding: 25px 15px; 
            text-align: center; 
            background: var(--negro-fondo); 
            border-bottom: 2px solid var(--dorado);
        }
        .logo-box { 
            display: inline-block; 
            border: 3px solid var(--dorado); 
            padding: 0; 
            border-radius: 15px; 
            background: #000; 
            overflow: hidden; 
        }
        .logo-box img { width: 100%; max-width: 650px; height: auto; display: block; }

        .top-nav { display: flex; gap: 10px; padding: 15px 20px; }
        .btn-top {
            flex: 1; padding: 14px; border-radius: 12px; border: 3px solid var(--dorado);
            color: white; font-weight: 800; font-size: 0.9em; text-align: center; text-decoration: none;
            background: rgba(0,0,0,0.5); text-transform: uppercase;
        }

        .search-area { padding: 0 15px 15px; display: flex; gap: 8px; }
        .input-search { 
            flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--dorado); 
            background: #1a1a1a; color: white; font-size: 1em; text-align: center;
        }
        .select-vence { 
            flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--dorado); 
            background: #1a1a1a; color: white; font-size: 1em;
        }

        .grid { padding: 5px 20px; display: grid; grid-template-columns: 1fr; gap: 20px; }

        .card-vip { 
            background: var(--negro-card); border-radius: 25px; padding: 25px; 
            margin-bottom: 35px; text-align: center; border: 3px solid var(--dorado); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.9);
        }
        
        .logo-container { 
            width: 180px; 
            height: 180px; 
            margin: 0 auto 15px; 
            border-radius: 50%; 
            background: white; 
            overflow: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border: 4px solid var(--dorado);
        }
        .logo-c { width: 100%; height: 100%; object-fit: cover; }
        
        .nombre-c { font-size: 1.7em; font-weight: 800; color: var(--dorado-brillante); margin: 5px 0; text-transform: uppercase; }
        .beneficio-c { font-size: 1.8em; font-weight: 900; color: white; margin: 5px 0; }

        .info-txt { display: block; font-size: 18px; color: #eee; margin: 12px 0; font-weight: 600; }
        .ico-large { font-size: 27px; vertical-align: middle; margin-right: 8px; }

        .btn-stack { padding: 0 15px; display: flex; flex-direction: column; gap: 15px; margin-top: 15px; }
        .btn-act { 
            width: 100%; padding: 15px; border-radius: 10px; border: none; 
            font-weight: bold; font-size: 16px; color: white; cursor: pointer; text-transform: uppercase;
        }
        .btn-conozca { background: var(--azul-lindo); }
        .btn-llegar { background: var(--verde); }
        .btn-validar { background: var(--rosa); }
        .btn-usar { background: #222; color: #555; pointer-events: none; transition: 0.3s; }
        .btn-usar.activo { 
            background: var(--dorado); 
            color: black; 
            pointer-events: auto; 
            animation: glow-pulse 1.5s infinite;
        }

        @keyframes glow-pulse {
            0% { box-shadow: 0 0 5px var(--dorado); }
            50% { box-shadow: 0 0 20px var(--dorado-brillante); }
            100% { box-shadow: 0 0 5px var(--dorado); }
        }

        .contador-nube { 
            background: var(--negro-card); 
            color: var(--dorado); 
            padding: 4px 10px; 
            border-radius: 15px; 
            font-size: 0.9em; 
            font-weight: bold; 
            margin-left: 10px; 
        }

        .custom-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 3000;
        }
        .custom-alert {
            background: var(--negro-card); width: 85%; max-width: 400px; border-radius: 20px;
            border: 3px solid var(--dorado); 
            text-align: center; padding: 30px; box-sizing: border-box;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
        }
        .custom-alert h2 { margin: 0 0 15px 0; font-size: 22px; font-weight: 900; color: var(--dorado); }
        .custom-alert p { font-size: 17px; color: #eee; margin: 15px 0; line-height: 1.4; }
        .soporte-link { color: var(--dorado-brillante); text-decoration: underline; display: block; margin-bottom: 20px; font-weight: bold; }
        .btn-alert { 
            width: 100%; padding: 15px; border: none; border-radius: 10px; 
            font-weight: 900; font-size: 16px; cursor: pointer; text-transform: uppercase;
            background: linear-gradient(45deg, var(--dorado), var(--dorado-brillante)); color: #000;
        }

        #msg-validacion {
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.95em;
        }
        .valido { background: rgba(40, 167, 69, 0.2); color: #28a745; border: 1px solid #28a745; }
        .invalido { background: rgba(220, 53, 69, 0.2); color: #dc3545; border: 1px solid #dc3545; }

        .input-group { margin-bottom: 18px; text-align: left; }
        label { display: block; margin-bottom: 5px; color: var(--dorado-brillante); font-weight: bold; font-size: 0.9em; }
        input, select { 
            width: 100%; padding: 14px; border: 1px solid var(--dorado); border-radius: 12px; 
            background: rgba(0,0,0,0.3); color: white; box-sizing: border-box; font-size: 1rem;
        }
        select option { background: var(--negro-card); color: white; }

        .terminos-box {
            margin: 20px 0;
            color: #ccc;
            font-size: 0.85em;
        }
        .terminos-box a {
            color: var(--dorado-brillante);
            text-decoration: underline;
            font-weight: bold;
        }

        .btn-vip {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, var(--dorado), var(--dorado-brillante));
            color: #000;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.3s;
        }
        .btn-vip:disabled { background: #444; color: #888; cursor: not-allowed; filter: grayscale(1); }

        .success-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--negro-fondo); z-index: 2000; display: none; flex-direction: column;
            align-items: center; justify-content: center; text-align: center; padding: 20px;
            box-sizing: border-box; overflow-y: auto;
        }
        .success-page h1 { color: var(--dorado); font-size: 28px; margin: 10px 0; font-weight: 900; }
        
        .timer-circle {
            width: 70px; height: 70px; border-radius: 50%;
            border: 6px solid var(--dorado); display: flex;
            align-items: center; justify-content: center; font-size: 30px; font-weight: bold;
            color: var(--dorado); margin-bottom: 10px;
        }

        .seccion-validacion {
            width: 100%; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; 
            margin: 10px 0; box-sizing: border-box; border: 2px solid rgba(212, 175, 55, 0.3);
        }
        .id-manual { font-size: 32px; font-weight: 900; color: var(--dorado-brillante); letter-spacing: 2px; margin: 10px 0; }
        .barcode-svg { width: 100%; max-width: 300px; height: auto; }
        .btn-copiar { 
            background: var(--dorado); color: black; border: none; padding: 8px 15px; 
            border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 14px;
        }

        .cuadro-instruccion {
            border: 4px solid var(--dorado);
            padding: 10px;
            margin: 10px 0;
            border-radius: 15px;
            animation: parpadeoSuave 2s infinite ease-in-out;
        }
        .cuadro-instruccion p {
            margin: 0;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .footer-identificacion {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 4px solid var(--dorado);
            padding: 10px 0; display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 900;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
        .footer-row { display: flex; justify-content: center; align-items: center; gap: 20px; width: 100%; }
        .footer-link { text-decoration: none; color: var(--azul-lindo); font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        
        .btn-footer {
            padding: 8px 15px; border-radius: 20px; text-decoration: none; color: white; font-weight: bold; font-size: 13px;
        }
    </style>
</head>
<body>

    <div id="notificacion">
        <span style="font-size: 1.5em;">üíé</span><br>
        <strong>¬°BIENVENIDO AL CLUB VIP!</strong><br>
        <span style="font-size: 0.8em; font-weight: normal;">Activando cuenta...</span>
    </div>

    <div id="overlay-error" class="custom-overlay">
        <div class="custom-alert">
            <h2 id="error-titulo">‚ö†Ô∏è ATENCI√ìN VIP</h2>
            <div id="error-contenido">
                <p id="error-mensaje">Por favor, complete todos los campos requeridos.</p>
            </div>
            <button class="btn-alert" onclick="cerrarError()">REVISAR DATOS</button>
        </div>
    </div>

    <div class="header-vip">
        <div class="logo-box">
            <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true  " alt="Logo H√°bitat-Car">
        </div>
    </div>

    <nav class="top-nav">
        <a href="usuarios_terminos.html" class="btn-top">BENEFICIOS</a>
        <a href="usuarios_tutoriales.html" class="btn-top">TUTORIAL</a>
    </nav>

    <div class="search-area">
        <input type="text" id="filtroNombre" class="input-search" placeholder="Buscar local..." onkeyup="filtrar()">
        <select id="filtroVence" class="select-vence" onchange="filtrar()">
            <option value="todos">Vence en...</option>
            <option value="3">3 d√≠as o menos</option>
            <option value="7">7 d√≠as o menos</option>
            <option value="15">15 d√≠as o menos</option>
        </select>
    </div>

    <div id="contenedor-vip" class="grid"></div>

    <div id="overlay-validado" class="custom-overlay">
        <div class="custom-alert">
            <h2>‚úÖ QR VALIDADO</h2>
            <p>Ahora pulse el bot√≥n <b>"USAR BENEFICIO"</b></p>
            <button class="btn-alert" onclick="cerrarValidado()">ENTENDIDO</button>
        </div>
    </div>

    <div id="overlay-error-qr" class="custom-overlay">
        <div class="custom-alert" style="border-color: var(--dorado);">
            <h2 style="color: var(--dorado);">‚ùå ERROR DE VALIDACI√ìN</h2>
            <p><b>El c√≥digo escaneado no coincide con este comercio.</b></p>
            <p>H√°bitat-Car le pide que escanee el QR correcto ubicado en el mostrador.</p>
            <button class="btn-alert" style="background: var(--dorado); color: black;" onclick="cerrarErrorQR()">REINTENTAR</button>
        </div>
    </div>

    <div id="overlay-atencion" class="custom-overlay">
        <div class="custom-alert">
            <h2 style="color:var(--dorado);">‚ö†Ô∏è ATENCI√ìN VIP</h2>
            <p>¬øAvisaste al cajero que usar√°s el <b>beneficio VIP</b>?</p>
            <p>Si no avisaste, perder√°s el beneficio.</p>
            <div class="btn-group-alert">
                <button id="btn-confirmar-final" class="btn-alert" style="background: var(--verde); color: white;">S√ç</button>
                <button class="btn-alert" style="background: var(--rosa); color: white;" onclick="cerrarAtencion()">NO</button>
            </div>
        </div>
    </div>

    <div id="popup-redes" class="popup-redes">
        <h3 id="pop-nombre" style="margin:0; color:var(--dorado)"></h3>
        <a id="lnk-ig" class="btn-red" style="background:var(--instagram); color:white;" target="_blank">INSTAGRAM</a>
        <a id="lnk-web" class="btn-red" style="background:var(--azul-lindo); color:white;" target="_blank">SITIO WEB</a>
        <button onclick="cerrarPopup()" style="border:none; background:none; color:#666; font-weight:bold; cursor:pointer; margin-top:10px;">CERRAR</button>
    </div>

    <div id="modal-qr" class="modal">
        <h2 style="color:white">Escanee el QR del local</h2>
        <div id="reader"></div>
        <button onclick="cerrarScanner()" style="margin-top:20px; padding:10px 20px; background:white; border:none; border-radius:5px; font-weight:bold;">CANCELAR</button>
    </div>

    <div id="pantalla-exito" class="success-page">
        <div class="timer-circle" id="countdown">30</div>
        <h1>üéâ ¬°CANJE EXITOSO!</h1>
        
        <div class="cuadro-instruccion">
            <p>Muestre esta pantalla al vendedor</p>
        </div>

        <div class="seccion-validacion">
            <p style="margin:0; font-weight:bold; color:var(--dorado);">C√ìDIGO DE VALIDACI√ìN</p>
            <div class="id-manual" id="exito-id-texto">---</div>
            <button class="btn-copiar" onclick="copiarID()">COPIAR C√ìDIGO</button>
            <div style="margin-top:15px;">
                <svg id="barcode"></svg>
            </div>
        </div>

        <h2 id="exito-comercio" style="text-transform:uppercase; color: var(--dorado); margin-top:10px;"></h2>
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true  " style="width:180px; height:auto; margin-top:15px;">
    </div>

    <footer class="footer-identificacion">
        <div class="footer-row">
            <a href="https://www.habitatcar.com.ar  " class="footer-link" target="_blank">www.habitatcar.com.ar</a>
            <a href="https://wa.me/543884618228  " class="footer-link" target="_blank">Cel: 388-4618228</a>
        </div>
    </footer>

    <script type="module">
        if (localStorage.getItem('habitat_vip_auth') === 'true') {
            window.location.replace("usuarios_cupones_vips.html");
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js  ";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, increment, addDoc, getDoc, arrayUnion, setDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js  "; // A√±adido deleteField

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- CAPTURA DE DATOS PROTEGIDA ---
        const socioId = localStorage.getItem('socioId_habitat'); // Cambiado a socioId_habitat
        const socioNombre = localStorage.getItem('socioNombre') || "Usuario";
        const socioApellido = localStorage.getItem('socioApellido') || "Vip";
        
        if (!socioId) { 
            window.location.replace("usuarios_registro_vip.html"); 
        }
        // ------------------------------------

        let deferredPrompt;
        const btnInstalar = document.getElementById('btn-instalar-pwa');
        const yaInstalado = localStorage.getItem('habitat_pwa_instalada');

        window.addEventListener('beforeinstallprompt', (e) => {
            if (yaInstalado) return;
            e.preventDefault();
            deferredPrompt = e;
            btnInstalar.style.display = 'block';
        });

        btnInstalar.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    btnInstalar.style.display = 'none';
                    localStorage.setItem('habitat_pwa_instalada', 'true');
                }
                deferredPrompt = null;
            }
        });

        let scanner = null;
        let idEnProceso = "";
        let tokenEsperado = "";
        
        const getInicios = () => JSON.parse(localStorage.getItem('inicios_cupones') || "{}");
        const getUsadosLocal = () => JSON.parse(localStorage.getItem('usados_v16_ok') || "[]");

        // Funci√≥n para obtener el n√∫mero de usos locales de un comercio espec√≠fico
        const getUsosLocales = (comercioId) => {
            return parseInt(localStorage.getItem(`uso_vip_${comercioId}`) || "0");
        };

        // ESCUCHAMOS AL USUARIO PARA TENER LOS CONTEOS DE LA NUBE
        onSnapshot(doc(db, "leads", socioId), (socioSnap) => { // Escucha el doc del lead usando socioId
            const socioData = socioSnap.data() || {};
            
            onSnapshot(collection(db, "comercios"), (snap) => {
                const contenedor = document.getElementById('contenedor-vip');
                const inicios = getInicios();
                let html = "";
                let huboCambioInicio = false;

                snap.forEach(docSnap => {
                    const c = docSnap.data();
                    const id = docSnap.id;
                    if (c.estado === "inactivo") return;

                    // L√≥gica de nube: se lee el campo .usos dentro del objeto del comercio
                    const datosComercio = socioData[c.nombre] || {};
                    const nUso = datosComercio.usos || 0;
                    const esUsado = nUso > 0; // Se bloquea si ya se us√≥ al menos una vez

                    const nombre = c.nombre || "Local";
                    const vigenciaTotal = parseInt(c.vigenciaVip) || 0;
                    
                    let diasRestantes = vigenciaTotal;
                    let mostrarReloj = vigenciaTotal > 0;

                    if (mostrarReloj) {
                        if (!inicios[id]) {
                            inicios[id] = Date.now();
                            huboCambioInicio = true;
                        }
                        const transcurrido = Date.now() - inicios[id];
                        const diasPasados = Math.floor(transcurrido / (1000 * 60 * 60 * 24));
                        diasRestantes = vigenciaTotal - diasPasados;
                    }

                    if (mostrarReloj && diasRestantes < 0) return;

                    let htmlLogo = "";
                    if (c.logoUrl && c.logoUrl.trim() !== "") {
                        htmlLogo = `<div class="logo-container"><img src="${c.logoUrl}" class="logo-c"></div>`;
                    }

                    const beneficio = c.valVip ? `${c.valVip}% ${c.txtVip || ''}` : "Consultar";
                    const token = c.tokenQR || "";
                    const ig = c.instagram ? (c.instagram.includes('http') ? c.instagram : `https://instagram.com/  ${c.instagram.replace('@','')}`) : "";
                    const web = c.sitioWeb ? (c.sitioWeb.includes('http') ? c.sitioWeb : `https://${c.sitioWeb}`) : "";
                    const tieneRedes = (ig !== "" || web !== "");
                    
                    let infoVencimiento = "";
                    if (!mostrarReloj) {
                        infoVencimiento = `<span class="ico-large">‚è≥</span>Sin vencimiento (Un solo uso)`;
                    } else if (diasRestantes <= 3) {
                        infoVencimiento = `<span class="box-vence-3"><span class="ico-large">‚è≥</span>Vencimiento: ${diasRestantes} d√≠as</span>`;
                    } else {
                        infoVencimiento = `<span class="ico-large">‚è≥</span>Vencimiento: ${diasRestantes} d√≠as`;
                    }

                    html += `
                        <div class="card-vip ${esUsado ? 'usado' : ''}" data-nombre="${nombre.toLowerCase()}" data-vence="${diasRestantes}">
                            ${htmlLogo}
                            <div class="nombre-c">${nombre}</div>
                            <div class="beneficio-c">${beneficio}</div>
                            <span class="info-txt">${infoVencimiento}</span>
                            ${c.direccion ? `<span class="info-txt"><span class="ico-large">üìç</span>${c.direccion}</span>` : ""}
                            <div class="btn-stack">
                                ${tieneRedes ? `<button class="btn-act btn-conozca" onclick="abrirPopup('${nombre}', '${ig}', '${web}')">Conozca el comercio</button>` : ""}
                                <button class="btn-act btn-llegar" onclick="window.open('https://www.google.com/maps/search/?api=1&query=  ${encodeURIComponent(c.direccion || nombre)}')">C√≥mo llegar</button>
                                <button class="btn-act btn-validar" onclick="abrirQR('${id}', '${token}')">Validar Cup√≥n con QR</button>
                                <button class="btn-act btn-usar ${esUsado ? 'usado' : ''}" id="btn-usar-${id}" onclick="confirmarAtencion('${id}', '${nombre}')">
                                    Usar el Beneficio <span class="contador-nube">${nUso}</span>
                                </button>
                            </div>
                        </div>`;
                });

                if (huboCambioInicio) {
                    localStorage.setItem('inicios_cupones', JSON.stringify(inicios));
                }
                contenedor.innerHTML = html;
            });
        });

        // Sync con Firebase para cupones usados si el socio existe
        const syncUsados = async () => {
            try {
                const sSnap = await getDoc(doc(db, "leads", socioId)); // Lee desde leads usando socioId
                if (sSnap.exists()) {
                    const deFirebase = sSnap.data().cupones_usados || [];
                    const locales = getUsadosLocal();
                    const combinados = [...new Set([...locales, ...deFirebase])];
                    localStorage.setItem('usados_v16_ok', JSON.stringify(combinados));
                }
            } catch(e) {}
        };
        syncUsados();

        window.cerrarValidado = () => { document.getElementById('overlay-validado').style.display = 'none'; };
        window.cerrarErrorQR = () => { document.getElementById('overlay-error-qr').style.display = 'none'; };
        window.cerrarAtencion = () => { document.getElementById('overlay-atencion').style.display = 'none'; };

        window.confirmarAtencion = (id, nom) => {
            document.getElementById('overlay-atencion').style.display = 'flex'; // Muestra el overlay original
            // Configura el bot√≥n "S√ç" para llamar a usarCupon
            document.getElementById('btn-confirmar-final').onclick = () => {
                document.getElementById('overlay-atencion').style.display = 'none';
                usarCupon(id, nom);
            };
        };

        window.abrirPopup = (nom, ig, web) => {
            document.getElementById('pop-nombre').innerText = nom;
            document.getElementById('lnk-ig').href = ig || "#";
            document.getElementById('lnk-ig').style.display = ig ? 'block' : 'none';
            document.getElementById('lnk-web').href = web || "#";
            document.getElementById('lnk-web').style.display = web ? 'block' : 'none';
            document.getElementById('popup-redes').style.display = 'flex';
        };
        window.cerrarPopup = () => document.getElementById('popup-redes').style.display = 'none';
        
        window.abrirQR = (id, token) => {
            idEnProceso = id; tokenEsperado = token;
            document.getElementById('modal-qr').style.display = 'flex';
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                if (text.trim() === tokenEsperado.trim()) {
                    cerrarScanner();
                    document.getElementById('overlay-validado').style.display = 'flex';
                    const btn = document.getElementById(`btn-usar-${idEnProceso}`);
                    if(btn) { btn.classList.add('activo'); btn.innerText = "USAR BENEFICIO"; }
                } else { 
                    cerrarScanner();
                    document.getElementById('overlay-error-qr').style.display = 'flex'; 
                }
            }).catch(e => console.error(e));
        };
        
        window.cerrarScanner = () => {
            document.getElementById('modal-qr').style.display = 'none';
            if(scanner) { scanner.stop().then(() => scanner.clear()).catch(err => console.log(err)); }
        };

        window.copiarID = () => {
            const idTexto = document.getElementById('exito-id-texto').innerText;
            navigator.clipboard.writeText(idTexto).then(() => { alert("C√≥digo copiado: " + idTexto); });
        };

        // --- FUNCI√ìN MODIFICADA: window.usarCupon ---
        window.usarCupon = async (id, nom) => {
            try {
                const ahora = Date.now();
                const fechaLegible = new Date().toLocaleDateString();
                const horaLegible = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // 1. OBTENEMOS ID DE VALIDACI√ìN DEL COMERCIO
                const refComercio = doc(db, "comercios", id);
                const snapCom = await getDoc(refComercio);
                const totalActual = (snapCom.data().totalUsos || 0) + 1;
                const idManual = "HAB-VIP-" + String(totalActual).padStart(4, '0');

                // 2. ACTUALIZACI√ìN COMERCIO (Estad√≠sticas)
                await updateDoc(refComercio, { totalUsos: increment(1), lastSubmission: ahora });

                // 3. LOG DE ACTIVIDAD
                try {
                    await addDoc(collection(db, "logs_actividad"), {
                        timestamp: ahora,
                        tipo: "canje_vip",
                        accion: "CANJE VIP",
                        nombreComercio: nom,
                        usuarioId: socioId, // Usamos socioId
                        idValidacion: idManual
                    });
                } catch(eLog) { console.error("Error Log:", eLog); }

                // 4. ACTUALIZACI√ìN EN EL DOCUMENTO DEL SOCIO (EN LA COLECCI√ìN LEADS)
                const docRef = doc(db, "leads", socioId); // Referencia al documento del socio en la colecci√≥n 'leads'
                
                // 1. Obtenemos los datos actuales del socio para sumar
                const docSnap = await getDoc(docRef);
                const userData = docSnap.data() || {};

                // 2. Calculamos los nuevos valores
                // 'usos_count' es el campo que lee admin_vips.html
                const nuevosUsosTotales = (userData.usos_count || 0) + 1;
                // Incrementamos el campo espec√≠fico del comercio
                const nuevosUsosComercio = (userData[nom] && typeof userData[nom] === 'object' && typeof userData[nom].usos === 'number' ? userData[nom].usos : 0) + 1;

                // 3. Actualizamos el documento del socio en la colecci√≥n 'leads'
                await updateDoc(docRef, {
                    usos_count: nuevosUsosTotales, // Incrementamos el contador total
                    [`${nom}.usos`]: nuevosUsosComercio, // Incrementamos el contador espec√≠fico del comercio
                    [`${nom}.ultimo_codigo`]: idManual, // Actualizamos el √∫ltimo c√≥digo
                    [`${nom}.ultima_fecha`]: fechaLegible, // Actualizamos la √∫ltima fecha
                    cupones_detallados: arrayUnion({ // A√±adimos al array de canjes detallados
                        comercio: nom,
                        fecha: fechaLegible,
                        hora: horaLegible,
                        codigo: idManual,
                        timestamp: ahora
                    }),
                    lastSubmission: ahora // Actualizamos la √∫ltima actividad
                });

                // 5. √âXITO VISUAL
                document.getElementById('exito-comercio').innerText = nom;
                document.getElementById('exito-id-texto').innerText = idManual;
                JsBarcode("#barcode", idManual, { format: "CODE128", width: 2, height: 80, displayValue: false });
                document.getElementById('pantalla-exito').style.display = 'flex';
                
                let s = 30;
                const t = setInterval(() => {
                    s--; 
                    document.getElementById('countdown').innerText = s;
                    if(s <= 0) { 
                        clearInterval(t); 
                        // Actualizar local storage y recargar
                        const usadosLocales = getUsadosLocal();
                        usadosLocales.push(id);
                        localStorage.setItem('usados_v16_ok', JSON.stringify(usadosLocales));
                        location.reload(); 
                    }
                }, 1000);

            } catch(e) { 
                console.error("Error General:", e);
                alert("Error cr√≠tico: " + e.message); 
            }
        };
        // --- FIN FUNCI√ìN MODIFICADA ---

        window.filtrar = () => {
            const texto = document.getElementById('filtroNombre').value.toLowerCase();
            const vencimiento = document.getElementById('filtroVence').value;
            document.querySelectorAll('.card-vip').forEach(c => {
                const nombreMatch = c.dataset.nombre.includes(texto);
                const dias = parseInt(c.dataset.vence);
                let venceMatch = true;
                if (vencimiento !== "todos") {
                    venceMatch = (dias >= 0 && dias <= parseInt(vencimiento));
                }
                c.style.display = (nombreMatch && venceMatch) ? 'block' : 'none';
            });
        };
    </script>
</body>
</html>
