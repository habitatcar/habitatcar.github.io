<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIP Premium | Hábitat-Car</title>

    <link rel="icon" type="image/png" href="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo_redondo.png?raw=true">
    <link rel="apple-touch-icon" href="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo_redondo.png?raw=true">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Hábitat-Car">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="manifest" href="application/json;base64,ewogICJuYW1lIjogIkhhYml0YXQtQ2FyIiwKICAic2hvcnRfbmFtZSI6ICJIYWJpdGF0LUNhciIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vZ2l0aHViLmNvbS9oYWJpdGF0Y2FyL2hhYml0YXRjYXIuZ2l0aHViLmlvL2Jsb2IvbWFpbi9sb2dvX3JlZG9uZG8ucG5nP3Jhdz10cnVlIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXSwKICAic3RhcnRfdXJsIjogIi91c3Vhcmlvcy5odG1sIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMGExOTJmIiwKICAidGhlbWVfY29sb3IiOiAiIzBhMTkyZiIKfQ==">

    <style>
        :root {
            --azul-oscuro: #0a192f;
            --azul-medio: #172a45;
            --azul-claro: #334766;
            --oro: #ffc107;
            --oro-brillante: #ffdb70;
            --blanco: #e6f1ff;
            --gris-texto: #8892b0;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--azul-oscuro);
            color: var(--blanco);
            padding-bottom: 80px;
        }

        .header-vip {
            background: linear-gradient(135deg, var(--azul-oscuro) 0%, var(--azul-medio) 100%);
            padding: 25px 20px;
            text-align: center;
            border-bottom: 2px solid var(--oro);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .header-vip img { height: 70px; margin-bottom: 10px; }
        .header-vip h1 { 
            margin: 0; 
            font-size: 22px; 
            color: var(--oro); 
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .socio-info {
            background: rgba(255,193,7,0.1);
            margin: 15px;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--oro);
            text-align: center;
        }

        .socio-info span { color: var(--oro); font-weight: bold; font-size: 18px; }

        .search-box {
            padding: 10px 15px;
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--azul-oscuro);
        }

        #filtroNombre {
            width: 100%;
            padding: 12px;
            border-radius: 25px;
            border: 1px solid var(--azul-claro);
            background: var(--azul-medio);
            color: white;
            box-sizing: border-box;
        }

        .grid-vip {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            padding: 15px;
        }

        .card-vip {
            background: var(--azul-medio);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05);
            transition: 0.3s;
            display: flex;
            flex-direction: column;
        }

        .card-vip img { width: 100%; height: 100px; object-fit: cover; }
        
        .card-content { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; }
        
        .card-content h3 { margin: 0 0 5px 0; font-size: 14px; color: var(--oro); height: 35px; overflow: hidden; }
        .card-content p { margin: 0; font-size: 12px; color: var(--gris-texto); margin-bottom: 10px; }

        .btn-usar {
            background: var(--oro);
            color: var(--azul-oscuro);
            border: none;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            font-size: 12px;
        }

        .btn-usar:disabled { background: #555; color: #888; cursor: not-allowed; }

        /* Modal simple */
        .modal {
            display: none;
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: var(--azul-medio);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid var(--oro);
            max-width: 400px;
            width: 100%;
        }
    </style>
</head>
<body>

    <div class="header-vip">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo_redondo.png?raw=true" alt="Logo">
        <h1>Socio Premium</h1>
    </div>

    <div class="socio-info">
        Hola, <span id="nombre-socio">...</span>
    </div>

    <div class="search-box">
        <input type="text" id="filtroNombre" placeholder="Buscar comercio o beneficio..." onkeyup="filtrar()">
    </div>

    <div class="grid-vip" id="contenedor-vips">
        <!-- Los cupones se cargarán aquí -->
    </div>

    <div id="modal-uso" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--oro)">¡BENEFICIO ACTIVADO!</h2>
            <p>Mostrá esta pantalla en el comercio</p>
            <div id="codigo-uso" style="font-size: 32px; font-weight: bold; letter-spacing: 5px; margin: 20px 0; color: white;"></div>
            <p>Válido por: <span id="countdown" style="color: var(--oro); font-weight: bold;">30</span> segundos</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const socioId = 
            localStorage.getItem('leadId_v16') ||
            localStorage.getItem('leadId_habitat') ||
            localStorage.getItem('leadId');

        if (!socioId) {
            window.location.replace("usuarios_registro_lead.html");
        }

        async function cargarDatosSocio() {
            try {
                const docRef = doc(db, "leads", socioId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    
                    if (d.convertidoVIP !== true) {
                        window.location.replace("usuarios_cupones_leads.html");
                        return;
                    }
                    
                    document.getElementById('nombre-socio').innerText = (d.apellido || "") + " " + (d.nombres || "");
                    await cargarComercios();
                } else {
                    window.location.replace("usuarios_registro_lead.html");
                }
            } catch (error) {
                console.error("Error al validar VIP:", error);
                document.getElementById('nombre-socio').innerText = "Error de conexión";
            }
        }

        async function cargarComercios() {
            const querySnapshot = await getDocs(collection(db, "comercios_vips"));
            const contenedor = document.getElementById('contenedor-vips');
            contenedor.innerHTML = "";

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const id = doc.id;
                const nombre = data.nombre || "Comercio";
                const beneficio = data.beneficio || "Consulte beneficio";
                const imagen = data.imagen || "https://via.placeholder.com/300x150?text=Premium";

                const card = document.createElement('div');
                card.className = 'card-vip';
                card.dataset.nombre = nombre.toLowerCase();
                
                const ultimoUso = localStorage.getItem('uso_vip_' + id);
                const hoy = new Date().toLocaleDateString();
                const disabled = ultimoUso === hoy ? 'disabled' : '';
                const btnText = ultimoUso === hoy ? 'YA UTILIZADO HOY' : 'USAR BENEFICIO';

                card.innerHTML = `
                    <img src="${imagen}" alt="${nombre}">
                    <div class="card-content">
                        <h3>${nombre}</h3>
                        <p>${beneficio}</p>
                        <button class="btn-usar" ${disabled} onclick="usarCupon('${id}', '${nombre}', '${beneficio}')">${btnText}</button>
                    </div>
                `;
                contenedor.appendChild(card);
            });
        }

        cargarDatosSocio();

        window.usarCupon = async (id, nom, ben) => {
            if(!confirm(`¿Deseas activar el beneficio en ${nom}? Solo tenés un uso diario.`)) return;

            const codigoIdentidad = socioId.slice(-4).toUpperCase();
            document.getElementById('codigo-uso').innerText = codigoIdentidad;
            document.getElementById('modal-uso').style.display = 'flex';

            try {
                const ahora = Date.now();

                // --- ACTUALIZAR EL CONTADOR GLOBAL DE USOS DEL USUARIO ---
                const userRef = doc(db, "leads", socioId);
                await updateDoc(userRef, {
                    usos_count: increment(1), // <-- ESTA ES LA LÍNEA CLAVE
                    lastSubmission: ahora
                });

                // --- REGISTRAR EN LOGS ---
                await addDoc(collection(db, "logs_actividad"), {
                    timestamp: ahora,
                    tipo: "canje",
                    accion: "CANJE VIP",
                    nombre: `${codigoIdentidad} canjeó ${ben} en ${nom}`,
                    comercioId: id,
                    modulo: "VIPS"
                });

                await addDoc(collection(db, "logs_vip"), { 
                    comercio: nom, 
                    comercioId: id,
                    fecha: serverTimestamp(), 
                    uso_nro: new Date().toLocaleDateString(),
                    tipo: "VIP",
                    beneficio: ben,
                    codigoGenerado: codigoIdentidad
                });

                localStorage.setItem('uso_vip_' + id, new Date().toLocaleDateString());

                let s = 30;
                const t = setInterval(() => {
                    s--;
                    document.getElementById('countdown').innerText = s;
                    if(s <= 0) { 
                        clearInterval(t); 
                        location.reload(); 
                    }
                }, 1000);
            } catch(e) { 
                console.error("Error al registrar en Log:", e);
                alert("Error de conexión con el servidor de Logs.");
            }
        };

        window.filtrar = () => {
            const texto = document.getElementById('filtroNombre').value.toLowerCase();
            document.querySelectorAll('.card-vip').forEach(c => {
                c.style.display = c.dataset.nombre.includes(texto) ? 'block' : 'none';
            });
        };
    </script>
</body>
</html>
