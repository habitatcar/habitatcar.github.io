<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIP Premium | H√°bitat-Car</title>

    <link rel="icon" type="image/png" href="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true">
    <link rel="apple-touch-icon" href="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="H√°bitat-Car">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="manifest" href="application/json;base64,ewogICJuYW1lIjogIkhhYml0YXQtQ2FyIFZJUCIsCiAgInNob3J0X25hbWUiOiAiSC5WSVAiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2dpdGh1Yi5jb20vaGFiaXRhdGNhci9oYWJpdGF0Y2FyLmdpdGh1Yi5pby9ibG9iL21haW4vbG9nby5wbmc/cmF3PXRydWUiLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNKYWJsZSIKICAgIH0KICBdLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzAwNDU5MCIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDQ1OTAiCn0=">

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        :root {
            --azul-habitat: #003d80; 
            --rojo-cupon: #e60000;
            --naranja: #ff8c00;
            --celeste: #0288d1;
            --verde: #2e7d32;
            --rosa: #c2185b;
            --negro: #000000;
            --azul-validar: #0d124a;
            --oro: #ffc107;
        }

        body { 
            margin: 0; padding: 0; 
            background-color: var(--azul-habitat); 
            font-family: 'Segoe UI', Arial, sans-serif; 
            padding-bottom: 100px; 
        }

        .header-vip { 
            padding: 20px 15px; 
            text-align: center; 
            background: linear-gradient(120deg, #1a2a6c, #2c3e50); 
            border-bottom: 6px solid var(--oro);
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-vip img { width: 100%; max-width: 250px; height: auto; display: block; margin: 0 auto; }
        .nav-link-vip {
            color: white; 
            text-decoration: none; 
            font-weight: bold; 
            padding: 8px 15px; 
            border-radius: 20px; 
            background: rgba(255,255,255,0.15);
            transition: 0.3s;
            font-size: 0.9em;
        }
        .nav-link-vip:hover { background: var(--oro); color: var(--azul-habitat); }

        .filtro-container {
            padding: 15px;
            display: flex;
            gap: 10px;
            background: rgba(255,255,255,0.1);
        }
        
        .search-wrapper {
            position: relative;
            flex: 1;
        }
        .search-wrapper::before {
            content: "üîç";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }
        .search-wrapper input {
            width: 100%;
            padding: 12px 12px 12px 35px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            box-sizing: border-box;
            background: rgba(255,255,255,0.9);
        }

        .filtro-container select {
            flex: 1; padding: 12px; border-radius: 8px; border: none; font-size: 16px; background: rgba(255,255,255,0.9);
        }

        .grid { padding: 15px; display: grid; grid-template-columns: 1fr; gap: 20px; }

        .card-vip {
            background: linear-gradient(145deg, #1e2a4a, #111a30);
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
            padding-bottom: 25px;
            border: 2px solid var(--oro);
            transition: transform 0.3s;
        }
        .card-vip:hover { transform: translateY(-5px); }

        .logo-container { height: 220px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); padding: 15px; }
        .logo-c { max-height: 180px; max-width: 90%; object-fit: contain; }

        .nombre-c { font-weight: 900; font-size: 26px; color: var(--oro); margin: 12px 0; text-transform: uppercase; letter-spacing: 1px; }
        .beneficio-c { color: white; font-size: 32px; font-weight: 900; margin: 10px 0; text-shadow: 0 0 10px rgba(255,193,7,0.7); }

        .info-txt { display: block; font-size: 18px; color: #aaa; margin: 12px 0; font-weight: 500; }
        .ico-large { font-size: 27px; vertical-align: middle; margin-right: 8px; }

        .btn-stack { padding: 0 15px; display: flex; flex-direction: column; gap: 12px; margin-top: 15px; }
        .btn-act {
            padding: 16px; border-radius: 12px; border: none; 
            font-weight: bold; font-size: 17px; color: white; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn-conozca { background: linear-gradient(45deg, #ff8c00, #ff6b00); }
        .btn-conozca:hover { background: linear-gradient(45deg, #ff6b00, #e05a00); transform: scale(1.03); }
        .btn-llegar { background: linear-gradient(45deg, #0288d1, #01579b); }
        .btn-llegar:hover { background: linear-gradient(45deg, #01579b, #003f6c); transform: scale(1.03); }
        .btn-validar { background: linear-gradient(45deg, #0d124a, #0a0f3a); }
        .btn-validar:hover { background: linear-gradient(45deg, #0a0f3a, #070c2a); transform: scale(1.03); }
        .btn-activar { 
            background: linear-gradient(45deg, #2e7d32, #1b5e20); 
            animation: pulseVIP 2s infinite;
        }
        .btn-activar:hover { background: linear-gradient(45deg, #1b5e20, #0d3d15); transform: scale(1.05); }

        @keyframes pulseVIP {
            0% { box-shadow: 0 0 0 0 rgba(46, 125, 50, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(46, 125, 50, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 125, 50, 0); }
        }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
        }
        #reader { width: 300px; background: white; border-radius: 15px; overflow: hidden; padding: 15px; }

        /* POPUP DE REDES SOCIALES */
        .popup-redes {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 0 35px rgba(0,0,0,0.8);
            z-index: 10000;
            flex-direction: column;
            width: 90%;
            max-width: 350px;
            border: 3px solid var(--oro);
        }
        .btn-red {
            display: none;
            width: 100%;
            padding: 14px;
            margin-bottom: 10px;
            text-align: center;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 15px;
            box-sizing: border-box;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: 0.2s;
        }
        .btn-red:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.3); }

        .success-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0a0f2a, #1a2a4a); 
            z-index: 2000; display: none; flex-direction: column;
            align-items: center; justify-content: center; text-align: center; padding: 20px;
            box-sizing: border-box;
        }
        .success-page h1 { 
            color: var(--oro); 
            font-size: 42px; 
            margin: 10px 0; 
            font-weight: 900; 
            text-shadow: 0 0 15px rgba(255,193,7,0.8);
            letter-spacing: 2px;
        }
        
        .timer-circle {
            width: 90px; height: 90px; border-radius: 50%;
            border: 8px solid var(--oro); 
            display: flex;
            align-items: center; justify-content: center; 
            font-size: 40px; font-weight: bold;
            color: white; 
            background: var(--azul-habitat);
            margin-bottom: 20px;
            box-shadow: 0 0 25px rgba(255,193,7,0.7);
        }

        .seccion-validacion {
            width: 100%; background: rgba(0,0,0,0.3); border-radius: 20px; padding: 20px; 
            margin: 20px 0; box-sizing: border-box; border: 2px solid var(--oro);
        }
        .id-manual { 
            font-size: 38px; 
            font-weight: 900; 
            color: white; 
            letter-spacing: 3px; 
            margin: 15px 0; 
            text-shadow: 0 0 10px var(--oro);
        }
        .barcode-svg { width: 100%; max-width: 350px; height: auto; margin: 15px auto; display: block; }
        .btn-copiar { 
            background: var(--azul-habitat); 
            color: white; 
            border: 2px solid var(--oro); 
            padding: 12px 25px; 
            border-radius: 50px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px;
            margin-top: 10px;
            transition: 0.3s;
        }
        .btn-copiar:hover { background: var(--oro); color: var(--azul-habitat); transform: scale(1.05); }

        .cuadro-instruccion {
            border: 4px solid var(--oro);
            padding: 15px;
            margin: 15px 0;
            border-radius: 20px;
            background: rgba(0,0,0,0.2);
            animation: brilloVIP 2s infinite ease-in-out;
        }
        @keyframes brilloVIP {
            0% { box-shadow: 0 0 5px rgba(255,193,7,0.5); }
            50% { box-shadow: 0 0 20px rgba(255,193,7,0.9); }
            100% { box-shadow: 0 0 5px rgba(255,193,7,0.5); }
        }
        .cuadro-instruccion p {
            margin: 0;
            font-size: 20px;
            font-weight: 900;
            text-transform: uppercase;
            color: white;
            text-shadow: 0 0 8px var(--oro);
        }

        .footer-identificacion {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(120deg, #1a2a6c, #0d124a);
            border-top: 4px solid var(--oro);
            padding: 12px 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 12px; 
            z-index: 900;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .footer-row { display: flex; justify-content: center; align-items: center; gap: 25px; width: 100%; flex-wrap: wrap; }
        .footer-link { 
            text-decoration: none; 
            color: var(--oro); 
            font-weight: bold; 
            font-size: 15px; 
            display: flex; 
            align-items: center; 
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            background: rgba(255,193,7,0.15);
            transition: 0.3s;
        }
        .footer-link:hover { background: var(--oro); color: var(--azul-habitat); }
        
        .btn-footer {
            padding: 10px 20px; 
            border-radius: 25px; 
            text-decoration: none; 
            color: white; 
            font-weight: bold; 
            font-size: 14px;
            background: var(--azul-habitat);
            border: 2px solid var(--oro);
            transition: 0.3s;
        }
        .btn-footer:hover { background: var(--oro); color: var(--azul-habitat); transform: scale(1.05); }

        .vip-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(45deg, var(--oro), #ff9800);
            color: var(--azul-habitat);
            font-weight: 900;
            padding: 5px 15px;
            border-radius: 25px;
            font-size: 14px;
            letter-spacing: 1px;
            box-shadow: 0 0 15px rgba(255,193,7,0.8);
            z-index: 10;
            animation: bounce 1s infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }
    </style>
</head>
<body>

    <header class="header-vip">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="Habitat Car VIP">
        <a href="usuarios_terminos.html" class="nav-link-vip">Beneficios</a>
        <a href="usuarios_tutoriales.html" class="nav-link-vip">Tutorial</a>
    </header>

    <div class="filtro-container">
        <div class="search-wrapper">
            <input type="text" id="filtroNombre" placeholder="Buscar comercio..." onkeyup="filtrar()">
        </div>
        <select id="filtroVence" onchange="filtrar()">
            <option value="todos">Vence en...</option>
            <option value="3">3 d√≠as</option>
            <option value="5">5 d√≠as</option>
            <option value="7">7 d√≠as</option>
            <option value="15">15 d√≠as</option>
        </select>
    </div>

    <div id="contenedor-cupones" class="grid"></div>

    <div id="overlay-error-qr" class="modal">
        <div style="background:white; padding:30px; border-radius:20px; text-align:center; max-width:350px; width:90%;">
            <img src="https://cdn-icons-png.flaticon.com/512/753/753345.png" style="width:80px; margin-bottom:15px;">
            <h2 style="color:var(--rojo-cupon); margin:10px 0; font-size:24px;">‚ùå ERROR QR</h2>
            <p style="font-size:18px; margin:15px 0; line-height:1.5;">El c√≥digo escaneado no coincide con este comercio.</p>
            <p style="font-weight:900; color:var(--azul-habitat); margin:10px 0;">Escanee el QR ubicado en el mostrador del comercio elegido.</p>
            <button class="btn-act btn-validar" onclick="cerrarErrorQR()" style="width:100%; margin-top:20px; padding:12px;">REINTENTAR</button>
        </div>
    </div>

    <!-- POPUP DE REDES SOCIALES CON VALIDACI√ìN DE SORTEOS/PROMOS -->
    <div id="popup-redes" class="popup-redes">
        <h3 id="pop-nombre" style="margin:0 0 20px 0; color:var(--negro); text-align:center; font-size:24px; font-weight:900;"></h3>
        
        <a id="lnk-sorteos" class="btn-red" style="background:#ff8c00; display:none;" href="#">SORTEOS Y PROMOCIONES</a>
        <hr id="separador-sorteos" style="width:100%; border:0; border-top:1px solid #eee; margin:15px 0; display:none;">
        
        <a id="lnk-ig" class="btn-red" style="background:#e1306c; display:none;" target="_blank">INSTAGRAM</a>
        <a id="lnk-fb" class="btn-red" style="background:#3b5998; display:none;" target="_blank">FACEBOOK</a>
        <a id="lnk-tk" class="btn-red" style="background:#000000; display:none;" target="_blank">TIKTOK</a>
        <a id="lnk-web" class="btn-red" style="background:var(--azul-habitat); display:none;" target="_blank">SITIO WEB</a>
        
        <button onclick="cerrarPopup()" style="border:none; background:#f8f9fa; color:#333; padding:14px; border-radius:10px; cursor:pointer; margin-top:15px; font-weight:bold; width:100%; font-size:16px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">CERRAR</button>
    </div>

    <div id="modal-qr" class="modal">
        <h2 style="color:white; font-size:28px; margin-bottom:25px; text-shadow:0 0 10px var(--oro);">Escanee el QR del local</h2>
        <div id="reader"></div>
        <button onclick="cerrarScanner()" style="margin-top:25px; padding:14px 30px; background:var(--rojo-cupon); color:white; border:none; border-radius:50px; font-weight:bold; font-size:18px; box-shadow:0 6px 20px rgba(230,0,0,0.5);">CANCELAR</button>
    </div>

    <div id="pantalla-exito" class="success-page">
        <div class="timer-circle" id="countdown">30</div>
        <h1>üëë VIP ACTIVADO</h1>
        
        <div class="cuadro-instruccion">
            <p>Mostrale esta pantalla al cajero</p>
        </div>

        <div class="seccion-validacion">
            <p style="margin:0; font-weight:bold; color:#ccc; font-size:18px;">C√ìDIGO DE VALIDACI√ìN</p>
            <div class="id-manual" id="exito-id-texto">---</div>
            <div style="margin-top:20px;">
                <svg id="barcode"></svg>
            </div>
        </div>

        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" style="width:200px; height:auto; margin-top:25px; filter: drop-shadow(0 0 10px var(--oro));">
    </div>

    <footer class="footer-identificacion">
        <div class="footer-row">
            <a href="https://www.habitatcar.com.ar" class="footer-link" target="_blank">
                <i class="fas fa-globe"></i> www.habitatcar.com.ar
            </a>
            <a href="https://wa.me/543884618228" class="footer-link" target="_blank">
                <i class="fab fa-whatsapp"></i> WA: 388-4618228
            </a>
        </div>
    </footer>

    <script type="module">
        // --- ESCUDO DE SEGURIDAD LEADS ---
        if (!localStorage.getItem('habitat_vip_auth') || localStorage.getItem('habitat_vip_auth') !== 'true') {
            window.location.replace("usuarios_cupones_leads.html");
        }

        history.pushState(null, null, location.href);
        window.onpopstate = function () { history.go(1); };
        localStorage.setItem('habitat_vip_auth', 'true');

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, increment, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const vipId = localStorage.getItem('vipId') || "invitado_vip_" + Date.now();

        let scanner = null;
        let idEnProceso = "";
        let tokenEsperado = "";
        
        const getInicios = () => JSON.parse(localStorage.getItem('inicios_vip') || "{}");
        const getUsadosLocal = () => JSON.parse(localStorage.getItem('usados_vip') || "[]");

        const getUsosLocales = (comercioId) => {
            return parseInt(localStorage.getItem(`uso_vip_${comercioId}`) || "0");
        };

        onSnapshot(collection(db, "comercios"), (snap) => {
            const contenedor = document.getElementById('contenedor-cupones');
            const inicios = getInicios();
            let html = "";
            let huboCambioInicio = false;

            snap.forEach(docSnap => {
                const c = docSnap.data();
                const id = docSnap.id;
                if (c.estado !== "activo" || !c.usosVip || c.usosVip <= 0) return;

                const nUso = getUsosLocales(id);
                const esUsado = nUso > 0;

                const nombre = c.nombre || "Comercio VIP";
                const vigenciaTotal = parseInt(c.vigenciaVip) || 0;
                
                let diasRestantes = vigenciaTotal;
                let mostrarReloj = vigenciaTotal > 0;

                if (mostrarReloj) {
                    if (!inicios[id]) {
                        inicios[id] = Date.now();
                        huboCambioInicio = true;
                    }
                    const transcurrido = Date.now() - inicios[id];
                    const diasPasados = Math.floor(transcurrido / (1000 * 60 * 60 * 24));
                    diasRestantes = vigenciaTotal - diasPasados;
                }

                if (mostrarReloj && diasRestantes < 0) return;

                let htmlLogo = "";
                if (c.logoUrl && c.logoUrl.trim() !== "") {
                    htmlLogo = `<div class="logo-container"><img src="${c.logoUrl}" class="logo-c"></div>`;
                }

                const beneficio = c.descVip ? `${c.descVip} ${c.detalleVip || ''}` : "Beneficio VIP Exclusivo";
                const token = c.tokenQR || "";
                
                // Capturar redes sociales
                const ig = c.instagram || "";
                const fb = c.facebook || "";
                const tk = c.web || ""; // TikTok guardado en 'web'
                const sitioWeb = c.sitioWeb || "";

                // Verificamos si tiene al menos UNA red social
                const tieneRedes = (ig !== "" || fb !== "" || tk !== "" || sitioWeb !== "");

                // Solo creamos el HTML del bot√≥n si tiene redes
                let btnConozcaHTML = "";
                if (tieneRedes) {
                    const escapeAttr = (str) => str.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    btnConozcaHTML = `<button class="btn-act btn-conozca" onclick="abrirPopup('${escapeAttr(nombre)}', '${escapeAttr(ig)}', '${escapeAttr(sitioWeb)}', '${escapeAttr(fb)}', '${escapeAttr(tk)}', '${id}', '${escapeAttr(c.sorteoTitulo || '')}', '${escapeAttr(c.promoTitulo || '')}')">
                        <i class="fas fa-info-circle"></i> CONOZCA EL COMERCIO
                    </button>`;
                }

                let infoVencimiento = "";
                if (!mostrarReloj) {
                    infoVencimiento = `<span class="ico-large">‚ôæÔ∏è</span>ILIMITADO`;
                } else if (diasRestantes <= 3) {
                    infoVencimiento = `<span style="background:var(--rojo-cupon); color:white; padding:3px 10px; border-radius:15px; font-weight:bold;">${diasRestantes} d√≠as</span>`;
                } else {
                    infoVencimiento = `<span class="ico-large">‚è≥</span>${diasRestantes} d√≠as`;
                }

                html += `
                    <div class="card-vip" data-nombre="${nombre.toLowerCase()}" data-vence="${diasRestantes}">
                        <div class="vip-badge">üëë VIP EXCLUSIVO</div>
                        ${htmlLogo}
                        <div class="nombre-c">${nombre}</div>
                        <div class="beneficio-c">${beneficio}</div>
                        <span class="info-txt">${infoVencimiento}</span>
                        ${c.direccion ? `<span class="info-txt"><span class="ico-large">üìç</span>${c.direccion}</span>` : ""}
                        <div class="btn-stack">
                            ${btnConozcaHTML}
                            <button class="btn-act btn-llegar" onclick="window.open('${c.mapsUrl ? c.mapsUrl : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((c.direccion || '') + ' ' + (c.ciudad || '') + ' ' + (c.provincia || ''))}`}')">
                                <i class="fas fa-map-marker-alt"></i> C√ìMO LLEGAR
                            </button>
                            <button class="btn-act btn-validar" onclick="abrirQR('${id}', '${token}')">
                                <i class="fas fa-qrcode"></i> ESCANEAR QR
                            </button>
                            <button class="btn-act btn-activar" id="btn-activar-${id}" onclick="activarBeneficio('${id}', '${nombre.replace(/'/g, "\\'")}')">
                                <i class="fas fa-crown"></i> ACTIVAR BENEFICIO VIP
                            </button>
                        </div>
                    </div>`;
            });

            if (huboCambioInicio) {
                localStorage.setItem('inicios_vip', JSON.stringify(inicios));
            }
            contenedor.innerHTML = html;
        });

        window.cerrarErrorQR = () => { document.getElementById('overlay-error-qr').style.display = 'none'; };
        window.cerrarScanner = () => {
            document.getElementById('modal-qr').style.display = 'none';
            if(scanner) { scanner.stop().then(() => scanner.clear()).catch(err => console.log(err)); }
        };

        window.abrirQR = (id, token) => {
            idEnProceso = id; tokenEsperado = token;
            document.getElementById('modal-qr').style.display = 'flex';
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                if (text.trim() === tokenEsperado.trim()) {
                    cerrarScanner();
                    const btn = document.getElementById(`btn-activar-${idEnProceso}`);
                    if(btn) { 
                        btn.classList.add('activo'); 
                        btn.innerHTML = '<i class="fas fa-check"></i> ¬°LISTO PARA ACTIVAR!';
                        btn.onclick = () => activarBeneficio(idEnProceso, btn.dataset.nombre);
                        btn.dataset.nombre = document.querySelector(`.card-vip[data-nombre*="${idEnProceso.toLowerCase()}"] .nombre-c`).innerText;
                    }
                } else { 
                    cerrarScanner();
                    document.getElementById('overlay-error-qr').style.display = 'flex'; 
                }
            }).catch(e => console.error(e));
        };

        window.activarBeneficio = async (id, nom) => {
            try {
                const refComercio = doc(db, "comercios", id);
                const snapCom = await getDoc(refComercio);
                
                if (!snapCom.exists()) {
                    alert("Comercio no encontrado");
                    return;
                }

                const totalActual = (snapCom.data().totalUsosVip || 0) + 1;
                const idManual = "VIP-" + String(totalActual).padStart(4, '0');

                await updateDoc(refComercio, { 
                    totalUsosVip: increment(1),
                    lastSubmissionVip: Date.now()
                });

                // Actualizar contador local
                const nuevosUsos = getUsosLocales(id) + 1;
                localStorage.setItem(`uso_vip_${id}`, nuevosUsos);

                // Mostrar pantalla de √©xito
                document.getElementById('exito-id-texto').innerText = idManual;
                JsBarcode("#barcode", idManual, { 
                    format: "CODE128", 
                    width: 2, 
                    height: 80, 
                    displayValue: true,
                    fontSize: 18,
                    textColor: "#fff",
                    lineColor: "#fff"
                });
                document.getElementById('pantalla-exito').style.display = 'flex';
                
                // Temporizador de 30 segundos
                let s = 30;
                const t = setInterval(() => {
                    s--; 
                    document.getElementById('countdown').innerText = s;
                    if(s <= 0) { 
                        clearInterval(t); 
                        location.reload(); 
                    }
                }, 1000);

            } catch(e) { 
                console.error("Error de Activaci√≥n:", e);
                alert("Error cr√≠tico: " + e.message); 
            }
        };

        // ‚úÖ FUNCI√ìN CORREGIDA: abrirPopup con validaci√≥n de sorteos/promos
        window.abrirPopup = (nom, ig, web, fb, tk, idComercio, sorteoTitulo, promoTitulo) => {
            document.getElementById('pop-nombre').innerText = nom;
            document.getElementById('lnk-sorteos').href = `usuarios_sorteos_promos.html?id=${idComercio}`;
            
            const configurarBoton = (id, link) => {
                const el = document.getElementById(id);
                if (link && link.trim() !== "" && link !== "#") {
                    el.href = link.startsWith('http') ? link : `https://${link}`;
                    el.style.display = "block";
                    return true;
                } else {
                    el.style.display = "none";
                    return false;
                }
            };

            const h1 = configurarBoton('lnk-ig', ig);
            const h2 = configurarBoton('lnk-fb', fb);
            const h3 = configurarBoton('lnk-tk', tk);
            const h4 = configurarBoton('lnk-web', web);

            // ‚úÖ SOLO MOSTRAR BOT√ìN DE SORTEOS SI HAY DATOS EN FIREBASE
            const tieneSorteoOPromo = (sorteoTitulo && sorteoTitulo.trim() !== "") || (promoTitulo && promoTitulo.trim() !== "");
            document.getElementById('lnk-sorteos').style.display = tieneSorteoOPromo ? "block" : "none";
            document.getElementById('separador-sorteos').style.display = tieneSorteoOPromo ? "block" : "none";

            document.getElementById('popup-redes').style.display = 'flex';
        };

        window.cerrarPopup = () => {
            document.getElementById('popup-redes').style.display = 'none';
            document.getElementById('lnk-sorteos').style.display = "none";
            document.getElementById('separador-sorteos').style.display = "none";
        };

        window.filtrar = () => {
            const texto = document.getElementById('filtroNombre').value.toLowerCase();
            const vencimiento = document.getElementById('filtroVence').value;
            document.querySelectorAll('.card-vip').forEach(c => {
                const nombreMatch = c.dataset.nombre.includes(texto);
                const dias = parseInt(c.dataset.vence);
                let venceMatch = true;
                if (vencimiento !== "todos") {
                    venceMatch = (dias >= 0 && dias <= parseInt(vencimiento));
                }
                c.style.display = (nombreMatch && venceMatch) ? 'block' : 'none';
            });
        };
    </script>
    
    <!-- Font Awesome para √≠conos -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>
</html>
