<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beneficios Habitat-Car</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      padding: 20px 16px;
      font-size: 22px;
      line-height: 1.5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .logo {
      width: 98%;
      max-width: 520px;
      display: block;
      margin: 0 auto 20px;
    }
    .titulo {
      color: #2c5aa0;
      font-size: 32px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 25px;
    }
    .cupon {
      background: white;
      border-radius: 20px;
      padding: 30px 20px;
      margin: 30px 0;
      box-shadow: 0 5px 18px rgba(0,0,0,0.1);
    }
    .cupon.inactivo {
      background: #e0e0e0 !important;
      opacity: 1 !important;
      filter: grayscale(30%) brightness(90%);
    }
    .nombre {
      font-size: 28px;
      font-weight: bold;
      margin: 12px 0;
    }
    .descuento {
      font-size: 24px;
      margin: 12px 0;
      font-weight: bold;
    }
    .info {
      margin: 12px 0;
      font-size: 20px;
      line-height: 1.4;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      margin-top: 12px;
      border: none;
    }
    .btn-qr {
      background: #E91E63;
      color: white;
    }
    .btn-usar {
      background: #2c5aa0;
      color: white;
    }
    .btn-como-llegar {
      background: #4CAF50;
      color: white;
    }
    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    #grilla { display: block; }
    #exito { display: none; text-align: center; padding: 40px 20px; }
    #exito img {
      width: 98%;
      max-width: 520px;
      margin-bottom: 20px;
    }
    #contador {
      font-size: 60px;
      font-weight: bold;
      color: #d32f2f;
      margin: 20px 0;
    }
    /* Scanner de QR */
    .qr-scanner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
    }
    .qr-scanner video {
      width: 90%;
      max-width: 500px;
      border: 2px dashed #fff;
      border-radius: 12px;
      margin-bottom: 25px;
    }
    .qr-scanner .close-btn {
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px 28px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
    }
    .qr-scanner .confirm-btn {
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px 28px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
    }
    .qr-scanner p {
      color: white;
      font-size: 20px;
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
    }
    /* Mensaje de QR validado */
    .mensaje-validado {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 16px 24px;
      border-radius: 14px;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 9998;
      max-width: 90%;
      text-align: center;
    }
    /* Advertencia */
    .advertencia-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
    }
    .advertencia-contenido {
      background: white;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      max-width: 520px;
      width: 90%;
    }
    .advertencia-contenido h3 {
      color: #d32f2f;
      font-size: 26px;
      margin: 0 0 20px;
      font-weight: bold;
    }
    .advertencia-contenido p {
      font-size: 22px;
      line-height: 1.5;
      margin-bottom: 25px;
      font-weight: bold;
      color: #333;
    }
    .advertencia-btns {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    .advertencia-btn {
      padding: 16px;
      font-size: 20px;
      font-weight: bold;
      border-radius: 12px;
      flex: 1;
    }
    .btn-si {
      background: #d32f2f;
      color: white;
      border: none;
    }
    .btn-no {
      background: #666;
      color: white;
      border: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="/logo.png" alt="Habitat-Car" class="logo">
    <div class="titulo">üéÅ Tus beneficios Habitat-Car</div>

    <div id="grilla">
      <!-- Los comercios se generar√°n aqu√≠ -->
    </div>

    <div id="exito">
      <img src="/logo.png" alt="Habitat-Car">
      <h2>üéâ ¬°FELICITACIONES!</h2>
      <p id="exito-texto"></p>
      <div id="contador">30</div>
      <p>V√°lido por 30 segundos.</p>
    </div>
  </div>

  <script>
    const COMERCIOS = [
      { id: "cafex", nombre: "Cafex", beneficio: "10% en medialunas", direccion: "Pje. Suiza 897", telefono: "387584856", mapa: "https://maps.app.goo.gl/EnrwchwaueLCpHWZ6" },
      { id: "llavero", nombre: "Llaverito", beneficio: "15%", direccion: "Tilcara 319", telefono: "6546546665", mapa: "https://maps.app.goo.gl/EnrwchwaueLCpHWZ7" },
      { id: "fotocopias", nombre: "Fotocopiadora Ely", beneficio: "20%", direccion: "Quintana 226, San Salvador de Jujuy", telefono: "45685534", mapa: "" },
      { id: "pinturasx", nombre: "Pinturer√≠a", beneficio: "5% en l√°tex", direccion: "√âxodo 476, San Salvador de Jujuy", telefono: "", mapa: "" }
    ];

    let usos = JSON.parse(localStorage.getItem('usosHabitatCar') || '{}');
    let validados = JSON.parse(localStorage.getItem('validadosHabitatCar') || '{}');

    function mostrarGrilla() {
      document.getElementById('grilla').style.display = 'block';
      document.getElementById('exito').style.display = 'none';

      const grilla = document.getElementById('grilla');
      grilla.innerHTML = '';

      COMERCIOS.forEach(com => {
        const usado = usos[com.id];
        const cupon = document.createElement('div');
        cupon.className = `cupon ${usado ? 'inactivo' : ''}`;
        cupon.innerHTML = `
          <div class="nombre">${com.nombre}</div>
          <div class="descuento">${com.beneficio}</div>
          <div class="info"><strong>üìç Direcci√≥n:</strong> ${com.direccion}</div>
          ${com.telefono ? `<div class="info"><strong>üìû Tel√©fono:</strong> <a href="tel:${com.telefono}">${com.telefono}</a></div>` : ''}
          <div style="margin-top:20px; display:flex; flex-direction:column; gap:12px;">
            ${!usado ? 
              `<button class="btn btn-qr" onclick="abrirCamara('${com.id}')">Validar Cup√≥n con QR en comercio</button>` :
              `<div style="text-align:center; color:#b71c1c; font-weight:bold;">‚úÖ Beneficio ya utilizado</div>`
            }
            ${com.mapa ? `<a href="${com.mapa}" target="_blank" class="btn btn-como-llegar">C√≥mo llegar</a>` : ''}
            <button class="btn btn-usar" id="btn-usar-${com.id}" ${usado || !validados[com.id] ? 'disabled' : ''} onclick="usar('${com.id}', '${com.nombre}', '${com.beneficio}')">Usar el beneficio</button>
          </div>
        `;
        grilla.appendChild(cupon);
      });

      COMERCIOS.forEach(com => {
        if (validados[com.id] && !usos[com.id]) {
          const btn = document.getElementById(`btn-usar-${com.id}`);
          if (btn) btn.disabled = false;
        }
      });
    }

    function abrirCamara(comercioId) {
      const scanner = document.createElement('div');
      scanner.className = 'qr-scanner';
      scanner.innerHTML = `
        <video id="video-qr" autoplay playsinline></video>
        <p>Apunt√° la c√°mara al QR del comercio</p>
        <button class="confirm-btn" onclick="confirmarEscaneo('${comercioId}')">‚úÖ Escane√© el QR del comercio</button>
        <button class="close-btn" onclick="cerrarCamara()">Cerrar</button>
      `;
      document.body.appendChild(scanner);

      const video = document.getElementById('video-qr');
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          video.srcObject = stream;
          video.play();
        })
        .catch(err => {
          alert("No se pudo acceder a la c√°mara. Asegurate de permitir el acceso.");
          cerrarCamara();
        });
    }

    function cerrarCamara() {
      const scanner = document.querySelector('.qr-scanner');
      if (scanner) scanner.remove();
    }

    function confirmarEscaneo(comercioId) {
      cerrarCamara();
      validarCupon(comercioId);
    }

    function validarCupon(comercioId) {
      validados[comercioId] = true;
      localStorage.setItem('validadosHabitatCar', JSON.stringify(validados));
      const btn = document.getElementById(`btn-usar-${comercioId}`);
      if (btn) btn.disabled = false;

      const mensaje = document.createElement('div');
      mensaje.className = 'mensaje-validado';
      mensaje.textContent = "‚úÖ QR del comercio validado. Ahora pod√©s usar el beneficio.";
      document.body.appendChild(mensaje);

      setTimeout(() => {
        if (mensaje.parentNode) mensaje.remove();
      }, 4000);
    }

    function usar(comercioId, nombre, beneficio) {
      if (!validados[comercioId]) {
        alert("‚ö†Ô∏è Primero valid√° el QR en el comercio.");
        return;
      }
      if (usos[comercioId]) {
        alert("‚úÖ Ya usaste este beneficio.");
        return;
      }

      const alerta = document.createElement('div');
      alerta.className = 'advertencia-overlay';
      alerta.innerHTML = `
        <div class="advertencia-contenido">
          <h3>‚ö†Ô∏è ¬°ATENCI√ìN!</h3>
          <p>¬øAvisaste al cajero que usar√°s el cup√≥n de descuento?<br>
          <strong>Si no le avisaste, perder√°s la validez del beneficio.</strong></p>
          <div class="advertencia-btns">
            <button class="advertencia-btn btn-si" onclick="confirmarUso('${comercioId}', '${nombre}', '${beneficio}')">S√ç, le avis√©</button>
            <button class="advertencia-btn btn-no" onclick="cerrarAdvertencia()">Volver</button>
          </div>
        </div>
      `;
      document.body.appendChild(alerta);
    }

    function cerrarAdvertencia() {
      const alerta = document.querySelector('.advertencia-overlay');
      if (alerta) alerta.remove();
    }

    function confirmarUso(comercioId, nombre, beneficio) {
      cerrarAdvertencia();
      usos[comercioId] = true;
      localStorage.setItem('usosHabitatCar', JSON.stringify(usos));

      document.getElementById('exito-texto').textContent = `Beneficio activado en ${nombre}. ${beneficio}`;
      document.getElementById('grilla').style.display = 'none';
      document.getElementById('exito').style.display = 'block';

      let c = 30;
      const int = setInterval(() => {
        c--;
        document.getElementById('contador').textContent = c;
        if (c <= 0) {
          clearInterval(int);
          setTimeout(() => mostrarGrilla(), 1000);
        }
      }, 1000);
    }

    mostrarGrilla();
  </script>
</body>
</html>
