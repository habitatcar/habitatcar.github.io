<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beneficios Habitat-Car</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      padding: 20px 16px;
      font-size: 22px;
      line-height: 1.5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .logo-container {
      text-align: center;
      margin-bottom: 25px;
    }
    .logo {
      width: 90%;
      max-width: 500px;
      height: auto;
      margin: 0 auto 20px;
      display: block;
    }
    .titulo {
      color: #2c5aa0;
      font-size: 32px;
      margin: 0;
      text-align: center;
      font-weight: bold;
    }
    .formulario-registro {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin: 20px 0 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    .formulario-registro h3 {
      margin-bottom: 15px;
      color: #2c5aa0;
      text-align: center;
    }
    .formulario-registro input {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 12px;
      font-size: 18px;
    }
    .btn-form {
      width: 100%;
      padding: 16px;
      background: #2c5aa0;
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
    }
    .cupon {
      background: white;
      border-radius: 20px;
      padding: 30px 20px;
      margin: 30px 0;
      box-shadow: 0 5px 18px rgba(0,0,0,0.1);
      text-align: left;
      position: relative;
    }
    .cupon.inactivo {
      background: #e0e0e0 !important;
      opacity: 1 !important;
      filter: grayscale(30%) brightness(90%);
    }
    .cupon.inactivo::after {
      content: "üîí";
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 24px;
      color: #b71c1c;
    }
    .vence {
      color: #b71c1c !important;
      font-size: 22px !important;
      font-weight: bold !important;
      text-align: center;
      margin: 12px 0 !important;
      background: #ffebee;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ffcdd2;
    }
    .cupon.inactivo .nombre,
    .cupon.inactivo .descuento {
      color: #757575;
    }
    .logo-comercio {
      width: 80px;
      height: auto;
      display: block;
      margin-bottom: 12px;
    }
    .nombre {
      font-size: 28px;
      font-weight: bold;
      margin: 12px 0;
    }
    .descuento {
      font-size: 24px;
      margin: 12px 0;
      font-weight: bold;
    }
    .info {
      margin: 12px 0;
      font-size: 20px;
      line-height: 1.4;
    }
    .info a {
      color: #1976d2;
      text-decoration: none;
    }
    .btn, a[style*="background"] {
      display: block;
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      margin-top: 12px;
    }
    .btn {
      background: #2c5aa0;
      color: white;
      border: none;
    }
    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    #grilla-cupones {
      display: none;
    }
    .exito {
      text-align: center;
      padding: 40px 20px;
    }
    .exito img {
      width: 80%;
      max-width: 400px;
      margin-bottom: 20px;
    }
    .exito h2 {
      font-size: 28px;
      color: #2c5aa0;
      margin-bottom: 15px;
    }
    .contador {
      font-size: 60px;
      font-weight: bold;
      color: #d32f2f;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-container">
      <img src="/logo.png" alt="Habitat-Car" class="logo">
      <div class="titulo">üéÅ Tus beneficios Habitat-Car</div>
    </div>

    <div id="formulario-registro" class="formulario-registro">
      <h3>üîí Acceso exclusivo</h3>
      <p style="margin-bottom:15px; font-size:18px;">Complet√° tus datos para activar tus beneficios:</p>
      <input type="text" id="nombre" placeholder="Nombre y Apellido" required>
      <input type="tel" id="whatsapp" placeholder="WhatsApp (sin 54, ej: 3884618228)" required>
      <input type="email" id="email" placeholder="Email (opcional)">
      <button class="btn-form" onclick="registrarUsuario()">Activar beneficios</button>
    </div>

    <div id="grilla-cupones"></div>
  </div>

  <script>
    const COMERCIOS = [
      { id: "cafex", nombre: "Cafex", logo: "https://via.placeholder.com/80?text=Cafex", descuentoLead: "10% de descuento", vigenciaLead: 7, descuentoVip: "15% de descuento", vigenciaVip: 0, estado: "activo", direccion: "Pje. Suiza 897, Palpal√°", telefono: "387584856", mapa: "https://maps.app.goo.gl/..." },
      { id: "pollosf", nombre: "El Pollo Feliz", logo: "https://via.placeholder.com/80?text=Pollo", descuentoLead: "15% en men√∫ ejecutivo", vigenciaLead: 10, descuentoVip: "20% + bebida gratis", vigenciaVip: 0, estado: "activo", direccion: "Av. Bolivia 1200, San Salvador de Jujuy", telefono: "3884123456", mapa: "https://maps.app.goo.gl/..." },
      { id: "carnesruben", nombre: "Super Carnes Rub√©n", logo: "https://via.placeholder.com/80?text=Carnes", descuentoLead: "10% en achuras", vigenciaLead: 15, descuentoVip: "15% en todo + env√≠o gratis", vigenciaVip: 0, estado: "activo", direccion: "Ruta 9 Km 13, Palpal√°", telefono: "3884987654", mapa: "https://maps.app.goo.gl/..." },
      { id: "panificadora", nombre: "Panificadora Don Pepe", logo: "https://via.placeholder.com/80?text=Pan", descuentoLead: "2x1 en facturas (mi√©rcoles)", vigenciaLead: 7, descuentoVip: "2x1 todos los d√≠as", vigenciaVip: 0, estado: "activo", direccion: "San Mart√≠n 450, San Salvador", telefono: "3884111222", mapa: "https://maps.app.goo.gl/..." },
      { id: "ferreteria", nombre: "Ferreter√≠a El Hogar", logo: "https://via.placeholder.com/80?text=Ferre", descuentoLead: "5% en herramientas", vigenciaLead: 30, descuentoVip: "10% + retiro sin cargo", vigenciaVip: 0, estado: "activo", direccion: "9 de Julio 789, San Salvador", telefono: "3884333444", mapa: "https://maps.app.goo.gl/..." },
      { id: "optica", nombre: "√ìptica Visi√≥n Jujuy", logo: "https://via.placeholder.com/80?text=√ìptica", descuentoLead: "$500 off en anteojos", vigenciaLead: 60, descuentoVip: "$1000 off + ajuste gratis", vigenciaVip: 0, estado: "activo", direccion: "Belgrano 200, San Salvador", telefono: "3884555666", mapa: "https://maps.app.goo.gl/..." },
      { id: "floreria", nombre: "Florer√≠a Jard√≠n Secreto", logo: "https://via.placeholder.com/80?text=Flor", descuentoLead: "10% en ramos", vigenciaLead: 15, descuentoVip: "Ramos premium + entrega gratis", vigenciaVip: 0, estado: "activo", direccion: "Lavalle 300, San Salvador", telefono: "3884777888", mapa: "https://maps.app.goo.gl/..." },
      { id: "heladeria", nombre: "Helader√≠a Dulce Sur", logo: "https://via.placeholder.com/80?text=Helado", descuentoLead: "2x1 en helado artesanal", vigenciaLead: 7, descuentoVip: "2x1 todos los d√≠as + topping gratis", vigenciaVip: 0, estado: "activo", direccion: "Per√∫ 500, San Salvador", telefono: "3884999000", mapa: "https://maps.app.goo.gl/..." },
      { id: "gimnasio", nombre: "Gym Power Jujuy", logo: "https://via.placeholder.com/80?text=Gym", descuentoLead: "1 semana gratis", vigenciaLead: 15, descuentoVip: "1 mes gratis + evaluaci√≥n", vigenciaVip: 0, estado: "activo", direccion: "Av. Fuerza A√©rea 600, Palpal√°", telefono: "3884121212", mapa: "https://maps.app.goo.gl/..." },
      { id: "libreria", nombre: "Librer√≠a El Estudiante", logo: "https://via.placeholder.com/80?text=Libro", descuentoLead: "10% en √∫tiles escolares", vigenciaLead: 30, descuentoVip: "15% + env√≠o a domicilio", vigenciaVip: 0, estado: "activo", direccion: "Sarmiento 400, San Salvador", telefono: "3884343434", mapa: "https://maps.app.goo.gl/..." }
    ];

    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz5DN_Q8a09_DQLQItkl1d-vkahYJsdz6x4Ey-vHWcA_XcnTW2AzFJYx2tTxzTZX4M1Qw/exec";

    function verificarRegistro() {
      const usuario = JSON.parse(localStorage.getItem('usuarioHabitatCar'));
      if (usuario && usuario.whatsapp) {
        document.getElementById('formulario-registro').style.display = 'none';
        document.getElementById('grilla-cupones').style.display = 'block';
        renderizarGrilla(usuario);
      }
    }

    function registrarUsuario() {
      const nombre = document.getElementById('nombre').value.trim();
      const whatsapp = document.getElementById('whatsapp').value.trim().replace(/\D/g, '');
      const email = document.getElementById('email').value.trim();

      if (!nombre || !whatsapp) {
        alert('Por favor, complet√° nombre y WhatsApp.');
        return;
      }

      const usuario = { nombre, whatsapp, email, tipo: 'lead' };
      localStorage.setItem('usuarioHabitatCar', JSON.stringify(usuario));

      fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ accion: 'registrarLead', ...usuario })
      }).catch(e => console.log('Registro enviado'));

      document.getElementById('formulario-registro').style.display = 'none';
      document.getElementById('grilla-cupones').style.display = 'block';
      renderizarGrilla(usuario);
    }

    function renderizarGrilla(usuario) {
      const grilla = document.getElementById('grilla-cupones');
      grilla.innerHTML = '';

      const hoy = new Date();
      const usos = JSON.parse(localStorage.getItem('usosHabitatCar') || '{}');

      COMERCIOS.forEach(com => {
        if (com.estado !== 'activo') return;

        const usado = usos[com.id];
        const vigenciaDias = usuario.tipo === 'vip' ? com.vigenciaVip : com.vigenciaLead;
        const esIlimitado = vigenciaDias === 0;
        let vencido = false;

        if (!esIlimitado && !usado) {
          const fechaRegistro = new Date();
          const fechaVencimiento = new Date(fechaRegistro);
          fechaVencimiento.setDate(fechaRegistro.getDate() + vigenciaDias);
          vencido = hoy > fechaVencimiento;
        }

        const cuponHTML = document.createElement('div');
        cuponHTML.className = `cupon ${usado || vencido ? 'inactivo' : ''}`;

        let descuento = usuario.tipo === 'vip' ? com.descuentoVip : com.descuentoLead;
        let mensajeVencido = '';

        if (usado) {
          mensajeVencido = `<div class="vence">‚úÖ Beneficio ya utilizado</div>`;
        } else if (vencido) {
          mensajeVencido = `<div class="vence">‚ùå Beneficio vencido</div>`;
        } else if (!esIlimitado) {
          const vence = new Date();
          vence.setDate(hoy.getDate() + vigenciaDias);
          mensajeVencido = `<div class="vence">Vence: ${vence.toLocaleDateString('es-AR')}</div>`;
        }

        cuponHTML.innerHTML = `
          ${com.logo ? `<img src="${com.logo}" alt="${com.nombre}" class="logo-comercio">` : ''}
          <div class="nombre">${com.nombre}</div>
          <div class="descuento">${descuento}</div>
          ${mensajeVencido}
          ${com.direccion ? `<div class="info"><strong>üìç Direcci√≥n:</strong> ${com.direccion}</div>` : ''}
          ${com.telefono ? `<div class="info"><strong>üìû Tel√©fono:</strong> <a href="tel:${com.telefono}">${com.telefono}</a></div>` : ''}
          <div style="margin-top:20px; display:flex; flex-direction:column; gap:12px;">
            ${!usado && !vencido ? 
              `<button class="btn" onclick="usarCupon('${com.id}', '${com.nombre}', '${descuento}')">Usar el beneficio</button>` :
              `<div style="text-align:center; color:#b71c1c; font-weight:bold; font-size:20px; margin-top:12px;">${usado ? '‚úÖ Beneficio ya utilizado' : '‚ùå Beneficio vencido'}</div>`
            }
            ${com.mapa ? `<a href="${com.mapa}" target="_blank" style="background:#4CAF50; color:white; text-decoration:none; padding:16px; border-radius:16px; font-size:20px; font-weight:bold; text-align:center;">C√≥mo llegar</a>` : ''}
            ${com.telefono ? `<a href="tel:${com.telefono}" style="background:#E91E63; color:white; text-decoration:none; padding:16px; border-radius:16px; font-size:20px; font-weight:bold; text-align:center;">Llamar ahora</a>` : ''}
          </div>
        `;
        grilla.appendChild(cuponHTML);
      });
    }

    function usarCupon(comercioId, nombre, descuento) {
      const alerta = document.createElement('div');
      alerta.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        padding: 20px;
      `;
      alerta.innerHTML = `
        <div style="background:white; border-radius:20px; padding:30px; text-align:center; max-width:500px; width:90%;">
          <h3 style="color:#d32f2f; margin:0 0 20px; font-size:24px;">‚ö†Ô∏è ¬°Importante!</h3>
          <p style="font-size:20px; line-height:1.5; margin-bottom:25px;">
            ¬øAvisaste al cajero que utilizar√°s el cup√≥n de descuento?<br>
            <strong>Si no le avisaste y continu√°s, perd√©s la validez del cup√≥n.</strong>
          </p>
          <div style="display:flex; gap:15px; justify-content:center;">
            <button onclick="confirmarUso('${comercioId}', '${nombre}', '${descuento}')" style="background:#d32f2f; color:white; border:none; border-radius:12px; padding:14px 20px; font-size:18px; font-weight:bold; flex:1;">
              S√≠, le avis√©
            </button>
            <button onclick="cerrarAlerta()" style="background:#666; color:white; border:none; border-radius:12px; padding:14px 20px; font-size:18px; font-weight:bold; flex:1;">
              Volver
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(alerta);
    }

    function cerrarAlerta() {
      const alerta = document.querySelector('div[style*="z-index: 9999"]');
      if (alerta) alerta.remove();
    }

    function confirmarUso(comercioId, nombre, descuento) {
      cerrarAlerta();

      let usos = JSON.parse(localStorage.getItem('usosHabitatCar') || '{}');
      usos[comercioId] = true;
      localStorage.setItem('usosHabitatCar', JSON.stringify(usos));

      const usuario = JSON.parse(localStorage.getItem('usuarioHabitatCar'));
      fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ accion: 'registrarUso', whatsapp: usuario.whatsapp, comercio: comercioId })
      }).catch(e => console.log('Uso registrado'));

      document.querySelector('.container').innerHTML = `
        <div class="exito">
          <img src="/logo.png" alt="Habitat-Car">
          <h2>üéâ ¬°FELICITACIONES!</h2>
          <p>Acab√°s de recibir tu beneficio en <strong>${nombre}</strong>.</p>
          <p>${descuento}</p>
          <div class="contador" id="contador">30</div>
          <p>V√°lido por 30 segundos.</p>
        </div>
      `;
      iniciarContador(30);
    }

    function iniciarContador(segundos) {
      let contador = segundos;
      const elem = document.getElementById('contador');
      const interval = setInterval(() => {
        contador--;
        elem.textContent = contador;
        if (contador <= 0) {
          clearInterval(interval);
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        }
      }, 1000);
    }

    verificarRegistro();
  </script>
</body>
</html>
