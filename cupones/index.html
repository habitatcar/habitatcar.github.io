<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beneficios Habitat-Car</title>
  <script src="https://unpkg.com/@zxing/library@0.18.3/umd/index.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      padding: 20px 16px;
      font-size: 22px;
      line-height: 1.5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .logo {
      width: 98%;
      max-width: 520px;
      display: block;
      margin: 0 auto 20px;
    }
    .titulo {
      color: #2c5aa0;
      font-size: 32px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .botones-superiores {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
    }
    .botones-superiores .btn {
      flex: 1;
      padding: 14px;
      font-size: 18px;
    }
    .btn-curioso { background: #ff9800; color: white; }
    .btn-tutorial { background: #03a9f4; color: white; }
    
    /* ‚úÖ ESTILO VIP DORADO */
    body.vip {
      background: #fffaf0;
    }
    body.vip .titulo {
      color: #d4af37;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    body.vip .cupon {
      border: 2px solid #d4af37;
      background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='2' fill='%23d4af37' opacity='0.2'/%3E%3Ctext x='50' y='60' font-size='40' text-anchor='middle' fill='%23d4af37' opacity='0.1'>%24%3C/text%3E%3C/svg%3E") repeat;
    }
    body.vip .btn-conozca, body.vip .btn-como-llegar, body.vip .btn-qr, body.vip .btn-usar {
      background: #d4af37 !important;
      color: white !important;
    }
    body.vip .vencimiento.normal { background: #fff8e1; color: #5d4037; }
    body.vip .vencimiento.proximo { background: #ffecb3; color: #e65100; }
    body.vip .recuadro-comercio {
      border: 2px solid #d4af37;
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
    }
    
    .cupon {
      background: white;
      border-radius: 20px;
      padding: 25px 20px;
      margin: 30px 0;
      box-shadow: 0 5px 18px rgba(0,0,0,0.1);
    }
    .recuadro-comercio {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
    }
    .recuadro-comercio img {
      max-width: 420px;
      max-height: 252px;
      margin: 0 auto 15px;
      display: block;
    }
    .recuadro-comercio .nombre-comercio {
      font-size: 28px;
      font-weight: bold;
      color: #2c5aa0;
      margin: 0;
    }
    .cupon.inactivo {
      background: #e0e0e0 !important;
      opacity: 1 !important;
      filter: grayscale(30%) brightness(90%);
    }
    .descuento {
      font-size: 24px;
      margin: 12px 0;
      font-weight: bold;
      color: #d4af37; /* Dorado para VIP y Lead */
    }
    .info {
      margin: 12px 0;
      font-size: 20px;
      line-height: 1.4;
    }
    .vencimiento {
      font-size: 20px;
      font-weight: bold;
      margin: 12px 0;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
    }
    .normal { background: #e3f2fd; color: #1976d2; }
    .proximo { background: #fff3e0; color: #f57c00; }
    .vencido { background: #ffebee; color: #d32f2f; }
    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      margin-top: 12px;
      border: none;
    }
    .btn-conozca { background: #9c27b0; color: white; }
    .btn-como-llegar { background: #4CAF50; color: white; }
    .btn-qr { background: #E91E63; color: white; }
    .btn-usar { background: #2c5aa0; color: white; }
    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    #grilla, #redes, #tutoriales { display: block; }
    #redes, #tutoriales { display: none; text-align: center; padding: 30px 20px; }
    .video-item {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin: 15px 0;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      text-align: left;
    }
    .video-item h3 {
      font-size: 20px;
      margin: 0 0 10px;
      color: #03a9f4;
    }
    .video-item p {
      font-size: 18px;
      margin: 0 0 15px;
      color: #555;
    }
    .qr-scanner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
    }
    .qr-scanner video {
      width: 90%;
      max-width: 500px;
      border: 2px dashed #fff;
      border-radius: 12px;
      margin-bottom: 25px;
    }
    .qr-scanner .close-btn {
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px 28px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
    }
    .qr-scanner p {
      color: white;
      font-size: 20px;
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
    }
    .mensaje-error {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #f44336;
      color: white;
      padding: 16px 24px;
      border-radius: 14px;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 9998;
      max-width: 90%;
      text-align: center;
    }
    .advertencia-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
    }
    .advertencia-contenido {
      background: white;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      max-width: 520px;
      width: 90%;
    }
    .advertencia-contenido h3 {
      color: #d32f2f;
      font-size: 26px;
      margin: 0 0 20px;
      font-weight: bold;
    }
    .advertencia-contenido p {
      font-size: 22px;
      line-height: 1.5;
      margin-bottom: 25px;
      font-weight: bold;
      color: #333;
    }
    .advertencia-btns {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    .advertencia-btn {
      padding: 16px;
      font-size: 20px;
      font-weight: bold;
      border-radius: 12px;
      flex: 1;
    }
    .btn-si { background: #d32f2f; color: white; border: none; }
    .btn-no { background: #666; color: white; border: none; }
    #reiniciar-btn {
      position: fixed;
      bottom: 15px;
      right: 15px;
      width: 50px;
      height: 50px;
      background: #ff9800;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body id="body">
  <div class="container">
    <img src="/logo.png" alt="Habitat-Car" class="logo">
    <div class="titulo">üéÅ Tus beneficios Habitat-Car</div>
    
    <div class="botones-superiores">
      <button class="btn btn-curioso" onclick="alert('Pr√≥ximamente: informaci√≥n sobre Habitat-Car.')">Soy curioso</button>
      <button class="btn btn-tutorial" onclick="mostrarTutoriales()">Tutorial</button>
    </div>

    <div id="grilla"></div>
    <div id="redes"></div>
    <div id="tutoriales"></div>
  </div>
  <button id="reiniciar-btn" onclick="reiniciarCupones()">üîÑ</button>

  <script>
    const COMERCIOS = [{"id":"cafex","nombre":"Cafex","logo":"https://habitatcar.github.io/logos/cafex.png","beneficio":"10% en medialunas","vigenciaLead":7,"descuentoVip":"20%","vigenciaVip":14,"estado":"activo","direccion":"Pje. Suiza 897","telefono":387584856,"mapa":"https://maps.app.goo.gl/EnrwchwaueLCpHWZ6","instagram":"https://instagram.com/cafex","facebook":"https://facebook.com/cafex","x":"https://x.com/cafex","tokenQR":"TOKEN_CAFEX_990"},{"id":"llavero","nombre":"Llaverito","logo":"https://habitatcar.github.io/logos/llavero.png","beneficio":"15%","vigenciaLead":15,"descuentoVip":"30%","vigenciaVip":30,"estado":"activo","direccion":"Tilcara 319","telefono":6546546665,"mapa":"https://maps.app.goo.gl/EnrwchwaueLCpHWZ7","instagram":"","facebook":"","x":"","tokenQR":"TOKEN_LLAVERO_990"},{"id":"fotocopias","nombre":"Fotocopiadora Ely","logo":"https://habitatcar.github.io/logos/fotocopias.png","beneficio":"20%","vigenciaLead":10,"descuentoVip":"40%","vigenciaVip":0,"estado":"activo","direccion":"Quintana 226, San Salvador de Jujuy","telefono":45685534,"mapa":"","instagram":"","facebook":"","x":"","tokenQR":"TOKEN_COPIAS_990"},{"id":"pinturasx","nombre":"Pinturer√≠a","logo":"","beneficio":"5% en l√°tex","vigenciaLead":30,"descuentoVip":"10% en brochas","vigenciaVip":365,"estado":"activo","direccion":"√âxodo 476, San Salvador de Jujuy","telefono":"","mapa":"","instagram":"","facebook":"","x":"","tokenQR":"TOKEN_PINTURAS_990"},{"id":"ferreteria","nombre":"Ferremax","logo":"","beneficio":"10% en herrajes","vigenciaLead":30,"descuentoVip":"20%","vigenciaVip":200,"estado":"activo","direccion":"Tilcara 315","telefono":"San Salvador de Jujuy","mapa":"","instagram":"","facebook":"","x":"","tokenQR":"token_ferreteria_111126"},{"id":"vineriabrown","nombre":"Viner√≠a Almirante Brown","logo":"","beneficio":"5% en espumantes","vigenciaLead":7,"descuentoVip":"10%","vigenciaVip":60,"estado":"activo","direccion":"Almirante Brown esq. Azopardo","telefono":"San Salvador de Jujuy","mapa":"","instagram":"","facebook":"","x":"","tokenQR":"token_vineriabrown_806897"},{"id":"almacen","nombre":"Almac√©n Los Hermanos","logo":"","beneficio":"10% en bebidas","vigenciaLead":15,"descuentoVip":"30% en todo el rubro","vigenciaVip":90,"estado":"activo","direccion":"Ernesto Romero 118, San Salvador de Jujuy","telefono":"","mapa":"","instagram":"","facebook":"","x":"","tokenQR":"token_almacen_490781"},{"id":"farmacia","nombre":"Farmacia Luj√°n","logo":"","beneficio":"15% en analg√©sicos, 10% en vendajes y 15% en perfumer√≠a","vigenciaLead":30,"descuentoVip":"20% en analg√©sicos, 120% en vendajes y 20% en perfumer√≠a y 5% en los otros productos","vigenciaVip":90,"estado":"activo","direccion":"Exodo 487","telefono":"","mapa":"https://maps.app.goo.gl/rQSqu4XcV51fRMaU6","instagram":"","facebook":"","x":"","tokenQR":"token_farmacia_754687"}];
    const TUTORIALES = [];
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz5DN_Q8a09_DQLQItkl1d-vkahYJsdz6x4Ey-vHWcA_XcnTW2AzFJYx2tTxzTZX4M1Qw/exec";

    let usos = JSON.parse(localStorage.getItem('usosHabitatCar') || '{}');
    let validados = JSON.parse(localStorage.getItem('validadosHabitatCar') || '{}');
    let registro = JSON.parse(localStorage.getItem('usuarioHabitatCar') || '{}');

    function verificarTipoUsuario() {
      if (!registro.whatsapp) {
        window.location.replace("/registroleads/");
        return;
      }

      fetch(APPS_SCRIPT_URL + "?accion=verificarVip&whatsapp=" + registro.whatsapp)
        .then(resp => resp.json())
        .then(data => {
          if (data && data.tipo === 'vip') {
            registro.tipo = 'vip';
            localStorage.setItem('usuarioHabitatCar', JSON.stringify(registro));
            // ‚úÖ Activar estilo VIP
            document.getElementById('body').className = 'vip';
          }
          mostrarGrilla();
        })
        .catch(err => {
          mostrarGrilla();
        });
    }

    function mostrarGrilla() {
      document.getElementById('grilla').style.display = 'block';
      document.getElementById('redes').style.display = 'none';
      document.getElementById('tutoriales').style.display = 'none';
      document.getElementById('grilla').innerHTML = '';

      const hoy = new Date();

      COMERCIOS.forEach(com => {
        const usado = usos[com.id];
        let vencimientoHtml = '';
        let esVencido = false;
        let esProximo = false;

        if (!usado) {
          const fechaActivacion = registro.fechaRegistro ? new Date(registro.fechaRegistro) : hoy;
          const vigenciaDias = registro.tipo === 'vip' ? com.vigenciaVip : com.vigenciaLead;
          const esIlimitado = vigenciaDias === 0;

          if (!esIlimitado) {
            const fechaVencimiento = new Date(fechaActivacion);
            fechaVencimiento.setDate(fechaActivacion.getDate() + vigenciaDias);
            const diffTime = fechaVencimiento - hoy;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays <= 0) {
              esVencido = true;
              vencimientoHtml = `<div class="vencimiento vencido">‚ùå Cup√≥n vencido</div>`;
            } else if (diffDays <= 3) {
              esProximo = true;
              vencimientoHtml = `<div class="vencimiento proximo">‚ö†Ô∏è Cup√≥n de ${com.nombre} pr√≥ximo a vencer</div>`;
            } else {
              vencimientoHtml = `<div class="vencimiento normal">Vence en ${diffDays} d√≠as</div>`;
            }
          } else {
            vencimientoHtml = `<div class="vencimiento normal">‚úÖ Vigencia ilimitada</div>`;
          }
        }

        let recuadroComercio = '';
        if (com.logo) {
          recuadroComercio = `<div class="recuadro-comercio"><img src="${com.logo}" alt="${com.nombre}"><h2 class="nombre-comercio">${com.nombre}</h2></div>`;
        } else {
          recuadroComercio = `<div class="recuadro-comercio"><h2 class="nombre-comercio">${com.nombre}</h2></div>`;
        }

        const beneficioMostrar = registro.tipo === 'vip' ? com.descuentoVip : com.beneficio;

        const cupon = document.createElement('div');
        cupon.className = `cupon ${usado || esVencido ? 'inactivo' : ''}`;
        cupon.innerHTML = `
          ${recuadroComercio}
          <div class="descuento">${beneficioMostrar}</div>
          ${vencimientoHtml}
          <div class="info"><strong>üìç Direcci√≥n:</strong> ${com.direccion}</div>
          ${com.telefono ? `<div class="info"><strong>üìû Tel√©fono:</strong> <a href="tel:${com.telefono}">${com.telefono}</a></div>` : ''}
          <div style="margin-top:20px; display:flex; flex-direction:column; gap:12px;">
            <button class="btn btn-conozca" onclick="mostrarRedes('${com.id}')">Conozca el Comercio</button>
            ${com.mapa ? `<a href="${com.mapa}" target="_blank" class="btn btn-como-llegar">C√≥mo llegar</a>` : ''}
            ${!usado && !esVencido ? 
              `<button class="btn btn-qr" onclick="abrirCamara('${com.id}', '${com.tokenQR}')">Validar Cup√≥n con QR en el comercio</button>` :
              `<div style="text-align:center; color:#b71c1c; font-weight:bold;">${usado ? '‚úÖ Beneficio ya utilizado' : '‚ùå Cup√≥n vencido'}</div>`
            }
            <button class="btn btn-usar" id="btn-usar-${com.id}" ${usado || esVencido || !validados[com.id] ? 'disabled' : ''} onclick="usar('${com.id}', '${com.nombre}', '${beneficioMostrar}')">Usar el beneficio</button>
          </div>
        `;
        document.getElementById('grilla').appendChild(cupon);
      });
    }

    // === FUNCIONES EXISTENTES (mostrarRedes, c√°mara, etc.) ===
    function mostrarRedes(comercioId) {
      const com = COMERCIOS.find(c => c.id === comercioId);
      if (!com) return;

      let enlaces = '';
      if (com.instagram) enlaces += `<a href="${com.instagram}" target="_blank" class="btn btn-conozca">Instagram</a>`;
      if (com.facebook) enlaces += `<a href="${com.facebook}" target="_blank" class="btn btn-conozca">Facebook</a>`;
      if (com.x) enlaces += `<a href="${com.x}" target="_blank" class="btn btn-conozca">X (Twitter)</a>`;

      if (!enlaces) {
        alert("Este comercio no tiene redes sociales registradas.");
        return;
      }

      let recuadroComercio = '';
      if (com.logo) {
        recuadroComercio = `<div class="recuadro-comercio"><img src="${com.logo}" alt="${com.nombre}"><h2 class="nombre-comercio">${com.nombre}</h2></div>`;
      } else {
        recuadroComercio = `<div class="recuadro-comercio"><h2 class="nombre-comercio">${com.nombre}</h2></div>`;
      }

      document.getElementById('grilla').style.display = 'none';
      document.getElementById('redes').style.display = 'block';
      document.getElementById('redes').innerHTML = `
        ${recuadroComercio}
        <div style="margin-top:20px; display:flex; flex-direction:column; gap:12px;">
          ${enlaces}
          <button class="btn" style="background:#666; color:white;" onclick="mostrarGrilla()">Volver a beneficios</button>
        </div>
      `;
    }

    function mostrarTutoriales() {
      if (TUTORIALES.length === 0) {
        alert("No hay tutoriales disponibles.");
        return;
      }

      let videos = '';
      TUTORIALES.forEach(tut => {
        videos += `
          <div class="video-item">
            <h3>${tut.titulo}</h3>
            <p>${tut.descripcion}</p>
            <a href="${tut.url}" target="_blank" class="btn" style="background:#03a9f4; color:white;">Ver video</a>
          </div>
        `;
      });

      document.getElementById('grilla').style.display = 'none';
      document.getElementById('redes').style.display = 'none';
      document.getElementById('tutoriales').style.display = 'block';
      document.getElementById('tutoriales').innerHTML = `
        <img src="/logo.png" alt="Habitat-Car" class="logo">
        <h2 style="font-size:32px; color:#2c5aa0; margin:20px 0; text-align:center;">üéì Tutoriales</h2>
        <div style="margin-top:20px;">
          ${videos}
          <button class="btn" style="background:#666; color:white; margin-top:20px;" onclick="mostrarGrilla()">Volver a beneficios</button>
        </div>
      `;
    }

    let codigoQR;
    let video;
    let stream;

    function abrirCamara(comercioId, tokenEsperado) {
      const scanner = document.createElement('div');
      scanner.className = 'qr-scanner';
      scanner.innerHTML = `
        <video id="video-qr"></video>
        <p style="color:white; font-size:20px; font-weight:bold;">Apunt√° al QR del comercio</p>
        <button class="close-btn" onclick="cerrarCamara()">Cerrar</button>
      `;
      document.body.appendChild(scanner);

      video = document.getElementById('video-qr');
      codigoQR = new ZXing.BrowserMultiFormatReader();

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(s => {
          stream = s;
          video.srcObject = stream;
          video.play();
          codigoQR.decodeFromVideoDevice(undefined, 'video-qr', (result, err) => {
            if (result) {
              const textoLeido = result.getText().trim();
              if (textoLeido === tokenEsperado) {
                cerrarCamara();
                validarCupon(comercioId);
              } else {
                cerrarCamara();
                mostrarError("‚ùå Token no v√°lido para este comercio.");
              }
            }
            if (err && !(err instanceof ZXing.NotFoundException)) {
              cerrarCamara();
            }
          });
        })
        .catch(err => {
          cerrarCamara();
          mostrarError("‚ùå No se pudo acceder a la c√°mara.");
        });
    }

    function cerrarCamara() {
      if (stream) stream.getTracks().forEach(track => track.stop());
      const scanner = document.querySelector('.qr-scanner');
      if (scanner) scanner.remove();
      if (codigoQR) codigoQR.reset();
    }

    function mostrarError(mensaje) {
      const error = document.createElement('div');
      error.className = 'mensaje-error';
      error.textContent = mensaje;
      document.body.appendChild(error);
      setTimeout(() => error.remove(), 4000);
    }

    function validarCupon(comercioId) {
      validados[comercioId] = true;
      localStorage.setItem('validadosHabitatCar', JSON.stringify(validados));
      const btn = document.getElementById(`btn-usar-${comercioId}`);
      if (btn) btn.disabled = false;
      mostrarError("‚úÖ QR validado. Ya pod√©s usar el beneficio.");
    }

    function usar(comercioId, nombre, beneficio) {
      if (!validados[comercioId]) {
        mostrarError("‚ö†Ô∏è Primero valid√° el QR en el comercio.");
        return;
      }
      if (usos[comercioId]) {
        mostrarError("‚úÖ Ya usaste este beneficio.");
        return;
      }

      const alerta = document.createElement('div');
      alerta.className = 'advertencia-overlay';
      alerta.innerHTML = `
        <div class="advertencia-contenido">
          <h3>‚ö†Ô∏è ¬°ATENCI√ìN!</h3>
          <p>¬øAvisaste al cajero que usar√°s el cup√≥n de descuento?<br>
          <strong>Si no le avisaste, perder√°s la validez del beneficio.</strong></p>
          <div class="advertencia-btns">
            <button class="advertencia-btn btn-si" onclick="confirmarUso('${comercioId}', '${nombre}', '${beneficio}')">S√ç, le avis√©</button>
            <button class="advertencia-btn btn-no" onclick="cerrarAdvertencia()">Volver</button>
          </div>
        </div>
      `;
      document.body.appendChild(alerta);
    }

    function cerrarAdvertencia() {
      const alerta = document.querySelector('.advertencia-overlay');
      if (alerta) alerta.remove();
    }

    function confirmarUso(comercioId, nombre, beneficio) {
      cerrarAdvertencia();
      usos[comercioId] = true;
      localStorage.setItem('usosHabitatCar', JSON.stringify(usos));

      document.getElementById('grilla').innerHTML = `
        <div style="text-align:center; padding:40px 20px;">
          <img src="/logo.png" alt="Habitat-Car" style="width:98%; max-width:520px; margin-bottom:20px;">
          <h2>üéâ ¬°FELICITACIONES!</h2>
          <p>Beneficio activado en <strong>${nombre}</strong>.</p>
          <p>${beneficio}</p>
          <div id="contador" style="font-size:60px; font-weight:bold; color:#d32f2f; margin:20px 0;">30</div>
          <p>V√°lido por 30 segundos.</p>
        </div>
      `;

      let c = 30;
      const int = setInterval(() => {
        c--;
        document.getElementById('contador').textContent = c;
        if (c <= 0) {
          clearInterval(int);
          usos = JSON.parse(localStorage.getItem('usosHabitatCar') || '{}');
          verificarTipoUsuario();
        }
      }, 1000);
    }

    function reiniciarCupones() {
      if (confirm("¬øReiniciar cupones? Se borrar√°n usos y validaciones.")) {
        localStorage.removeItem('usosHabitatCar');
        localStorage.removeItem('validadosHabitatCar');
        localStorage.removeItem('usuarioHabitatCar');
        usos = {};
        validados = {};
        registro = {};
        window.location.replace("/registroleads/");
      }
    }

    verificarTipoUsuario();
  </script>
</body>
</html>
  
