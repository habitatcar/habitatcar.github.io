<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beneficios Habitat-Car</title>
  <script src="https://unpkg.com/@zxing/library@0.18.3/umd/index.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      padding: 20px 16px;
      font-size: 22px;
      line-height: 1.5;
    }
    .container { max-width: 600px; margin: 0 auto; }
    .logo { width: 98%; max-width: 520px; display: block; margin: 0 auto 20px; }
    .titulo { color: #2c5aa0; font-size: 32px; text-align: center; font-weight: bold; margin-bottom: 10px; }
    #subtitulo { text-align: center; color: #d4af37; font-size: 22px; font-weight: bold; margin-bottom: 15px; display: none; }
    
    .botones-superiores { display: flex; gap: 15px; margin-bottom: 25px; }
    .botones-superiores .btn { flex: 1; padding: 14px; font-size: 18px; }
    .btn-curioso { background: #ff9800; color: white; }
    .btn-tutorial { background: #03a9f4; color: white; }

    body.vip { background: #fffaf0; }
    body.vip .titulo, body.vip #subtitulo { color: #d4af37; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
    body.vip .cupon { border: 2px solid #d4af37; background: white; }
    /* El bot√≥n se vuelve dorado en VIP solo si no est√° deshabilitado */
    body.vip .btn-usar:not(:disabled) { background: #d4af37 !important; color: white !important; }
    body.vip .btn-conozca, body.vip .btn-como-llegar, body.vip .btn-qr { background: #d4af37 !important; color: white !important; }

    .cupon { background: white; border-radius: 20px; padding: 25px 20px; margin: 30px 0; box-shadow: 0 5px 18px rgba(0,0,0,0.1); }
    .recuadro-comercio { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
    .recuadro-comercio img { max-width: 100%; height: auto; margin: 0 auto 15px; display: block; }
    .recuadro-comercio .nombre-comercio { font-size: 28px; font-weight: bold; color: #2c5aa0; margin: 0; }
    
    .cupon.inactivo { background: #e0e0e0 !important; opacity: 1 !important; filter: grayscale(30%) brightness(90%); }
    .descuento { font-size: 24px; margin: 12px 0; font-weight: bold; color: #2c5aa0; text-align: center; }
    body.vip .descuento { color: #d4af37; }
    
    .info { margin: 12px 0; font-size: 20px; line-height: 1.4; }
    .btn { display: block; width: 100%; padding: 16px; border-radius: 16px; font-size: 20px; font-weight: bold; text-align: center; text-decoration: none; cursor: pointer; margin-top: 12px; border: none; }
    
    .btn-conozca { background: #9c27b0; color: white; }
    .btn-como-llegar { background: #4CAF50; color: white; }
    .btn-qr { background: #E91E63; color: white; }
    .btn-usar { background: #2c5aa0; color: white; }
    
    /* ESTADO DESHABILITADO (Gris para todos) */
    .btn:disabled { background: #cccccc !important; color: #666666 !important; cursor: not-allowed; box-shadow: none; }

    .aviso-validado {
      position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
      width: 90%; max-width: 450px; background: #2e7d32; color: white;
      padding: 30px; border-radius: 25px; text-align: center; z-index: 10001;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 4px solid #fff;
    }
    .aviso-validado h2 { font-size: 32px; margin-bottom: 10px; }
    .aviso-validado p { font-size: 24px; font-weight: bold; line-height: 1.3; }

    .qr-scanner { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
    .qr-scanner video { width: 90%; max-width: 500px; border: 2px dashed #fff; border-radius: 12px; }
    .close-btn { background: #d32f2f; color: white; border: none; border-radius: 12px; padding: 14px 28px; font-size: 18px; margin-top: 15px; }

    .advertencia-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; padding: 20px; }
    .advertencia-contenido { background: white; border-radius: 20px; padding: 30px; text-align: center; max-width: 520px; width: 90%; }
  </style>
</head>
<body id="body">
  <div class="container">
    <img src="/logo.png" alt="Habitat-Car" class="logo">
    <div class="titulo">üéÅ Tus beneficios Habitat-Car</div>
    <div id="subtitulo"></div>
    
    <div class="botones-superiores">
      <button class="btn btn-curioso" onclick="alert('Pr√≥ximamente m√°s info.')">Soy curioso</button>
      <button class="btn btn-tutorial" onclick="alert('Pr√≥ximamente tutorial.')">Tutorial</button>
    </div>

    <div id="grilla"></div>
    <div id="redes"></div>
  </div>

  <script>
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzxgDElajJ9JFV6WPInb-YMyY7dfd8uRd2SpXpF9CgQU4k0tCxRabbZ_c_L7TkAmAo_uw/exec";

    let usos = JSON.parse(localStorage.getItem('usosHabitatCar') || '{}');
    let validados = JSON.parse(localStorage.getItem('validadosHabitatCar') || '{}');
    let registro = JSON.parse(localStorage.getItem('usuarioHabitatCar') || '{}');

    function verificarTipoUsuario() {
      if (!registro.whatsapp) { window.location.replace("/registroleads/"); return; }
      fetch(APPS_SCRIPT_URL + "?accion=verificarVip&whatsapp=" + registro.whatsapp)
        .then(resp => resp.json())
        .then(data => {
          registro.tipo = (data && data.tipo === 'vip') ? 'vip' : 'lead';
          localStorage.setItem('usuarioHabitatCar', JSON.stringify(registro));
          if (registro.tipo === 'vip') {
            document.getElementById('body').className = 'vip';
            document.getElementById('subtitulo').style.display = 'block';
            document.getElementById('subtitulo').textContent = 'Clientes VIP';
          }
          cargarComercios();
        });
    }

    function cargarComercios() {
      fetch(APPS_SCRIPT_URL + "?accion=obtenerComercios")
        .then(resp => resp.json())
        .then(comercios => mostrarGrilla(comercios));
    }

    function mostrarGrilla(COMERCIOS) {
      const grilla = document.getElementById('grilla');
      grilla.innerHTML = '';
      
      COMERCIOS.forEach(com => {
        const usado = usos[com.id];
        const estaValidado = validados[com.id];
        const beneficioMostrar = registro.tipo === 'vip' ? (com.descuentoVip || com.beneficio) : com.beneficio;
        
        const cupon = document.createElement('div');
        cupon.className = `cupon ${usado ? 'inactivo' : ''}`;
        cupon.innerHTML = `
          <div class="recuadro-comercio">
            ${com.logo ? `<img src="${com.logo}">` : ''}
            <h2 class="nombre-comercio">${com.nombre}</h2>
          </div>
          <div class="descuento">${beneficioMostrar}</div>
          <div class="info"><strong>üìç Direcci√≥n:</strong> ${com.direccion}</div>
          
          <div style="margin-top:20px; display:flex; flex-direction:column; gap:12px;">
            <a href="${com.web || '#'}" class="btn btn-conozca" target="_blank">Conozca el comercio</a>
            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(com.nombre + ' ' + com.direccion)}" class="btn btn-como-llegar" target="_blank">C√≥mo llegar</a>
            
            ${!usado ? `
              <button class="btn btn-qr" onclick="abrirCamara('${com.id}', '${com.tokenQR}')">Validar QR en Comercio</button>
              <button class="btn btn-usar" id="btn-usar-${com.id}" ${!estaValidado ? 'disabled' : ''} onclick="usar('${com.id}', '${com.nombre}', '${beneficioMostrar}')">Usar el beneficio</button>
            ` : `
              <div style="text-align:center; color:#b71c1c; font-weight:bold; padding:10px;">‚úÖ Beneficio ya utilizado</div>
            `}
          </div>
        `;
        grilla.appendChild(cupon);
      });
    }

    function usar(comercioId, nombre, beneficio) {
      const alerta = document.createElement('div');
      alerta.className = 'advertencia-overlay';
      alerta.innerHTML = `
        <div class="advertencia-contenido">
          <h3>‚ö†Ô∏è ¬°ATENCI√ìN!</h3>
          <p>¬øAvisaste al cajero? Si no avis√°s ahora, perd√©s el beneficio.</p>
          <button class="btn btn-usar" onclick="confirmarUso('${comercioId}', '${nombre}', '${beneficio}')">S√ç, AVIS√â</button>
          <button class="btn" style="background:#666; color:white;" onclick="this.parentElement.parentElement.remove()">VOLVER</button>
        </div>
      `;
      document.body.appendChild(alerta);
    }

    function confirmarUso(comercioId, nombre, beneficio) {
      document.querySelector('.advertencia-overlay').remove();
      
      if (registro.tipo !== 'vip') {
        usos[comercioId] = true;
        localStorage.setItem('usosHabitatCar', JSON.stringify(usos));
      }

      fetch(APPS_SCRIPT_URL + "?accion=registrarUso&whatsapp=" + registro.whatsapp + "&comercioNombre=" + encodeURIComponent(nombre) + "&tipo=" + registro.tipo);

      document.getElementById('grilla').innerHTML = `
        <div style="text-align:center; padding:40px 20px; background:white; border-radius:20px;">
          <h2>üéâ ¬°BENEFICIO ACTIVADO!</h2>
          <p>Mostr√° esto en caja:</p>
          <div id="contador" style="font-size:80px; font-weight:bold; color:#d4af37;">30</div>
          <p style="font-size:24px; font-weight:bold;">${beneficio}</p>
        </div>
      `;

      let c = 30;
      const int = setInterval(() => {
        c--;
        if(document.getElementById('contador')) document.getElementById('contador').textContent = c;
        if (c <= 0) {
          clearInterval(int);
          validados[comercioId] = false; 
          localStorage.setItem('validadosHabitatCar', JSON.stringify(validados));
          location.reload();
        }
      }, 1000);
    }

    let stream;
    function abrirCamara(id, token) {
      const sc = document.createElement('div'); sc.className='qr-scanner';
      sc.innerHTML = `<video id="v"></video><button class="close-btn" onclick="cerrar()">Cerrar</button>`;
      document.body.appendChild(sc);
      const scanner = new ZXing.BrowserMultiFormatReader();
      navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(s=>{
        stream=s; document.getElementById('v').srcObject=s; document.getElementById('v').play();
        scanner.decodeFromVideoDevice(undefined,'v',(res)=>{
          if(res && res.getText().trim()===token){ 
            cerrar(); 
            validados[id]=true; 
            localStorage.setItem('validadosHabitatCar', JSON.stringify(validados)); 
            
            const msj = document.createElement('div');
            msj.className = 'aviso-validado';
            msj.innerHTML = `<h2>‚úÖ ¬°VALIDADO!</h2><p>Ya pod√©s hacer uso del bot√≥n "Usar el beneficio"</p>`;
            document.body.appendChild(msj);
            
            setTimeout(() => { 
              msj.remove(); 
              cargarComercios(); 
            }, 3500);
          }
        });
      });
    }
    function cerrar(){ if(stream) stream.getTracks().forEach(t=>t.stop()); document.querySelector('.qr-scanner').remove(); }

    verificarTipoUsuario();
  </script>
</body>
</html>
