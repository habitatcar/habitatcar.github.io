<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beneficios Habitat-Car</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      padding: 20px 16px;
      font-size: 22px;
      line-height: 1.5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .logo-container {
      text-align: center;
      margin-bottom: 25px;
    }
    .logo {
      width: 90%;
      max-width: 500px;
      height: auto;
      margin: 0 auto 20px;
      display: block;
    }
    .titulo {
      color: #2c5aa0;
      font-size: 32px;
      margin: 0;
      text-align: center;
      font-weight: bold;
    }
    .formulario-registro {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin: 20px 0 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    .formulario-registro input {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 12px;
      font-size: 18px;
    }
    .btn-form {
      width: 100%;
      padding: 16px;
      background: #2c5aa0;
      color: white;
      border: none;
      border-radius: 16px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
    }
    .cupon {
      background: white;
      border-radius: 20px;
      padding: 30px 20px;
      margin: 30px 0;
      box-shadow: 0 5px 18px rgba(0,0,0,0.1);
      text-align: left;
      position: relative;
    }
    .cupon.inactivo {
      background: #e0e0e0 !important;
      opacity: 1 !important;
      filter: grayscale(30%) brightness(90%);
    }
    .cupon.inactivo::after {
      content: "üîí";
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 24px;
      color: #b71c1c;
    }
    .vence {
      color: #b71c1c !important;
      font-size: 22px !important;
      font-weight: bold !important;
      text-align: center;
      margin: 12px 0 !important;
      background: #ffebee;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ffcdd2;
    }
    .logo-comercio {
      width: 80px;
      height: auto;
      display: block;
      margin-bottom: 12px;
    }
    .nombre {
      font-size: 28px;
      font-weight: bold;
      margin: 12px 0;
    }
    .descuento {
      font-size: 24px;
      margin: 12px 0;
      font-weight: bold;
    }
    .info {
      margin: 12px 0;
      font-size: 20px;
      line-height: 1.4;
    }
    .btn, a[style*="background"] {
      display: block;
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      margin-top: 12px;
    }
    .btn {
      background: #2c5aa0;
      color: white;
      border: none;
    }
    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    #grilla-cupones {
      display: none;
    }
    .exito {
      text-align: center;
      padding: 40px 20px;
    }
    .exito img {
      width: 80%;
      max-width: 400px;
      margin-bottom: 20px;
    }
    .exito h2 {
      font-size: 28px;
      color: #2c5aa0;
      margin-bottom: 15px;
    }
    .contador {
      font-size: 60px;
      font-weight: bold;
      color: #d32f2f;
      margin: 20px 0;
    }
    .qr-scanner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
      flex-direction: column;
    }
    .qr-scanner video {
      width: 80%;
      max-width: 400px;
      border: 2px dashed #fff;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    .qr-scanner .close-btn {
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    .instruccion {
      font-size: 18px;
      color: #fff;
      margin: 15px 0;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo-container">
      <img src="/logo.png" alt="Habitat-Car" class="logo">
      <div class="titulo">üéÅ Tus beneficios Habitat-Car</div>
    </div>

    <div id="formulario-registro" class="formulario-registro">
      <p style="margin-bottom:15px; font-size:18px;">Complet√° tus datos para activar tus beneficios:</p>
      <input type="text" id="nombre" placeholder="Nombre y Apellido" required>
      <input type="tel" id="whatsapp" placeholder="WhatsApp (sin 54, ej: 3884618228)" required>
      <input type="email" id="email" placeholder="Email (opcional)">
      <button class="btn-form" onclick="registrarUsuario()">Activar beneficios</button>
    </div>

    <div id="grilla-cupones"></div>
  </div>

  <script>
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz5DN_Q8a09_DQLQItkl1d-vkahYJsdz6x4Ey-vHWcA_XcnTW2AzFJYx2tTxzTZX4M1Qw/exec";
    const COMERCIOS = [
      {
        "id": "cafex",
        "nombre": "Cafex",
        "logo": "",
        "beneficio": "10% en medialunas los viernes",
        "vigenciaLead": 7,
        "descuentoVip": "15% + caf√© gratis",
        "vigenciaVip": 0,
        "estado": "activo",
        "direccion": "Pje. Suiza 897, Palpal√°",
        "telefono": "387584856",
        "mapa": "https://maps.app.goo.gl/EnrwchwaueLCpHWZ6",
        "tokenQR": "TOKEN_CAFEX_123"
      }
    ];

    // === UTILIDADES ===
    function guardarEnStorage(clave, valor) {
      try {
        localStorage.setItem(clave, JSON.stringify(valor));
      } catch (e) {
        console.warn("No se pudo guardar en localStorage", e);
      }
    }

    function leerDeStorage(clave) {
      try {
        return JSON.parse(localStorage.getItem(clave)) || null;
      } catch (e) {
        console.warn("Error al leer localStorage", e);
        return null;
      }
    }

    // === FLUJO PRINCIPAL ===
    function verificarRegistro() {
      const usuario = leerDeStorage('usuarioHabitatCar');
      if (usuario && usuario.whatsapp) {
        document.getElementById('formulario-registro').style.display = 'none';
        document.getElementById('grilla-cupones').style.display = 'block';
        renderizarGrilla(usuario);
      }
    }

    function registrarUsuario() {
      const nombre = document.getElementById('nombre').value.trim();
      const whatsapp = document.getElementById('whatsapp').value.trim().replace(/\D/g, '');
      const email = document.getElementById('email').value.trim();
      if (!nombre || !whatsapp) {
        alert('Por favor, complet√° nombre y WhatsApp.');
        return;
      }
      const usuario = { nombre, whatsapp, email, tipo: 'lead' };
      guardarEnStorage('usuarioHabitatCar', usuario);
      document.getElementById('formulario-registro').style.display = 'none';
      document.getElementById('grilla-cupones').style.display = 'block';
      renderizarGrilla(usuario);
    }

    function renderizarGrilla(usuario) {
      const grilla = document.getElementById('grilla-cupones');
      grilla.innerHTML = '';
      const hoy = new Date();
      const usos = leerDeStorage('usosHabitatCar') || {};
      const validados = leerDeStorage('validadosHabitatCar') || {};

      COMERCIOS.forEach(com => {
        if (com.estado !== 'activo') return;
        const usado = usos[com.id];
        const vigenciaDias = usuario.tipo === 'vip' ? com.vigenciaVip : com.vigenciaLead;
        const esIlimitado = vigenciaDias === 0;
        let vencido = false;
        if (!esIlimitado && !usado) {
          const fechaVencimiento = new Date(hoy);
          fechaVencimiento.setDate(hoy.getDate() + vigenciaDias);
          vencido = hoy > fechaVencimiento;
        }

        const cuponHTML = document.createElement('div');
        cuponHTML.className = `cupon ${usado || vencido ? 'inactivo' : ''}`;
        let beneficio = usuario.tipo === 'vip' ? com.descuentoVip : com.beneficio;
        let mensajeVencido = '';
        if (usado) {
          mensajeVencido = `<div class="vence">‚úÖ Beneficio ya utilizado</div>`;
        } else if (vencido) {
          mensajeVencido = `<div class="vence">‚ùå Beneficio vencido</div>`;
        } else if (!esIlimitado) {
          const vence = new Date(hoy);
          vence.setDate(hoy.getDate() + vigenciaDias);
          mensajeVencido = `<div class="vence">Vence: ${vence.toLocaleDateString('es-AR')}</div>`;
        }

        let logoHTML = '';
        if (com.logo && com.logo.trim() !== '') {
          logoHTML = `<img src="${com.logo}" alt="${com.nombre}" class="logo-comercio">`;
        }

        cuponHTML.innerHTML = `
          ${logoHTML}
          <div class="nombre">${com.nombre}</div>
          <div class="descuento">${beneficio}</div>
          ${mensajeVencido}
          ${com.direccion ? `<div class="info"><strong>üìç Direcci√≥n:</strong> ${com.direccion}</div>` : ''}
          ${com.telefono ? `<div class="info"><strong>üìû Tel√©fono:</strong> <a href="tel:${com.telefono}">${com.telefono}</a></div>` : ''}
          <div style="margin-top:20px; display:flex; flex-direction:column; gap:12px;">
            ${!usado && !vencido ? 
              `<button class="btn" style="background:#E91E63;" onclick="validarConQR('${com.id}', '${com.nombre}', '${beneficio}')">Validar Cup√≥n con QR en comercio</button>` :
              `<div style="text-align:center; color:#b71c1c; font-weight:bold; font-size:20px; margin-top:12px;">${usado ? '‚úÖ Beneficio ya utilizado' : '‚ùå Beneficio vencido'}</div>`
            }
            ${com.mapa ? `<a href="${com.mapa}" target="_blank" style="background:#4CAF50; color:white; text-decoration:none; padding:16px; border-radius:16px; font-size:20px; font-weight:bold; text-align:center;">C√≥mo llegar</a>` : ''}
            <button class="btn usar-boton" data-id="${com.id}" data-nombre="${com.nombre}" data-beneficio="${beneficio}" disabled>Usar el beneficio</button>
          </div>
        `;
        grilla.appendChild(cuponHTML);
      });

      // Activar botones ya validados
      document.querySelectorAll('.usar-boton').forEach(btn => {
        const id = btn.dataset.id;
        if (validados[id]) {
          btn.disabled = false;
          btn.style.backgroundColor = '#2c5aa0';
          btn.onclick = () => usarCupon(id, btn.dataset.nombre, btn.dataset.beneficio);
        }
      });
    }

    function validarConQR(comercioId, nombre, beneficio) {
      alert("Simulaci√≥n: escaneando QR de " + nombre);
      // En producci√≥n, aqu√≠ ir√≠a el escaneo real
      activarBotonUsar(comercioId, nombre, beneficio);
    }

    function activarBotonUsar(comercioId, nombre, beneficio) {
      let validados = leerDeStorage('validadosHabitatCar') || {};
      validados[comercioId] = true;
      guardarEnStorage('validadosHabitatCar', validados);
      
      const btn = document.querySelector(`.usar-boton[data-id="${comercioId}"]`);
      if (btn) {
        btn.disabled = false;
        btn.style.backgroundColor = '#2c5aa0';
        btn.onclick = () => usarCupon(comercioId, nombre, beneficio);
      }
    }

    function usarCupon(comercioId, nombre, beneficio) {
      const validados = leerDeStorage('validadosHabitatCar') || {};
      if (!validados[comercioId]) {
        alert("Primero deb√©s validar el comercio escaneando el QR.");
        return;
      }

      if (!confirm("¬øAvisaste al cajero que usar√°s el cup√≥n?\nSi no le avisaste, perd√©s la validez.")) {
        return;
      }

      // Registrar uso
      let usos = leerDeStorage('usosHabitatCar') || {};
      usos[comercioId] = true;
      guardarEnStorage('usosHabitatCar', usos);

      // Mostrar √©xito
      document.querySelector('.container').innerHTML = `
        <div class="exito">
          <img src="/logo.png" alt="Habitat-Car">
          <h2>üéâ ¬°FELICITACIONES!</h2>
          <p>Acab√°s de recibir tu beneficio en <strong>${nombre}</strong>.</p>
          <p>${beneficio}</p>
          <div class="contador" id="contador">30</div>
          <p>V√°lido por 30 segundos.</p>
        </div>
      `;

      // Contador
      let contador = 30;
      const elem = document.getElementById('contador');
      const interval = setInterval(() => {
        contador--;
        elem.textContent = contador;
        if (contador <= 0) {
          clearInterval(interval);
          setTimeout(() => window.location.reload(), 1000);
        }
      }, 1000);
    }

    verificarRegistro();
  </script>
</body>
</html>
