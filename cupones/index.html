<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beneficios Habitat-Car</title>
  <script src="https://unpkg.com/@zxing/library@0.18.3/umd/index.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      padding: 20px 16px;
      font-size: 22px;
      line-height: 1.5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    .logo {
      width: 98%;
      max-width: 520px;
      display: block;
      margin: 0 auto 20px;
    }
    .titulo {
      color: #2c5aa0;
      font-size: 32px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 25px;
    }
    .cupon {
      background: white;
      border-radius: 20px;
      padding: 30px 20px;
      margin: 30px 0;
      box-shadow: 0 5px 18px rgba(0,0,0,0.1);
    }
    .cupon.inactivo {
      background: #e0e0e0 !important;
      opacity: 1 !important;
      filter: grayscale(30%) brightness(90%);
    }
    .nombre {
      font-size: 28px;
      font-weight: bold;
      margin: 12px 0;
    }
    .descuento {
      font-size: 24px;
      margin: 12px 0;
      font-weight: bold;
    }
    .info {
      margin: 12px 0;
      font-size: 20px;
      line-height: 1.4;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      margin-top: 12px;
      border: none;
    }
    .btn-qr {
      background: #E91E63;
      color: white;
    }
    .btn-usar {
      background: #2c5aa0;
      color: white;
    }
    .btn-como-llegar {
      background: #4CAF50;
      color: white;
    }
    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    #grilla { display: block; }
    #exito { display: none; text-align: center; padding: 40px 20px; }
    #exito img {
      width: 98%;
      max-width: 520px;
      margin-bottom: 20px;
    }
    #contador {
      font-size: 60px;
      font-weight: bold;
      color: #d32f2f;
      margin: 20px 0;
    }
    .qr-scanner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
    }
    .qr-scanner video {
      width: 90%;
      max-width: 500px;
      border: 2px dashed #fff;
      border-radius: 12px;
      margin-bottom: 25px;
    }
    .qr-scanner .close-btn {
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px 28px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
    }
    .qr-scanner p {
      color: white;
      font-size: 20px;
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
    }
    .mensaje-error {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #f44336;
      color: white;
      padding: 16px 24px;
      border-radius: 14px;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 9998;
      max-width: 90%;
      text-align: center;
    }
    .advertencia-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 20px;
    }
    .advertencia-contenido {
      background: white;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      max-width: 520px;
      width: 90%;
    }
    .advertencia-contenido h3 {
      color: #d32f2f;
      font-size: 26px;
      margin: 0 0 20px;
      font-weight: bold;
    }
    .advertencia-contenido p {
      font-size: 22px;
      line-height: 1.5;
      margin-bottom: 25px;
      font-weight: bold;
      color: #333;
    }
    .advertencia-btns {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    .advertencia-btn {
      padding: 16px;
      font-size: 20px;
      font-weight: bold;
      border-radius: 12px;
      flex: 1;
    }
    .btn-si {
      background: #d32f2f;
      color: white;
      border: none;
    }
    .btn-no {
      background: #666;
      color: white;
      border: none;
    }
    #reiniciar-btn {
      position: fixed;
      bottom: 15px;
      right: 15px;
      width: 50px;
      height: 50px;
      background: #ff9800;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <img src="/logo.png" alt="Habitat-Car" class="logo">
    <div class="titulo">üéÅ Tus beneficios Habitat-Car</div>
    <div id="grilla"></div>
    <div id="exito"></div>
  </div>
  <button id="reiniciar-btn" onclick="reiniciarCupones()">üîÑ</button>

  <script>
    const COMERCIOS = [{"id":"cafex","nombre":"Cafex","logo":"","beneficio":"10% en medialunas","vigenciaLead":7,"descuentoVip":"10% en medialunas","vigenciaVip":0,"estado":"activo","direccion":"Pje. Suiza 897","telefono":387584856,"mapa":"https://maps.app.goo.gl/EnrwchwaueLCpHWZ6","tokenQR":"TOKEN_CAFEX_990"},{"id":"llavero","nombre":"Llaverito","logo":"","beneficio":"15%","vigenciaLead":15,"descuentoVip":"15%","vigenciaVip":0,"estado":"activo","direccion":"Tilcara 319","telefono":6546546665,"mapa":"https://maps.app.goo.gl/EnrwchwaueLCpHWZ7","tokenQR":"TOKEN_LLAVERO_990"},{"id":"fotocopias","nombre":"Fotocopiadora Ely","logo":"","beneficio":"20%","vigenciaLead":10,"descuentoVip":"20%","vigenciaVip":0,"estado":"activo","direccion":"Quintana 226, San Salvador de Jujuy","telefono":45685534,"mapa":"","tokenQR":"TOKEN_COPIAS_990"},{"id":"pinturasx","nombre":"Pinturer√≠a","logo":"","beneficio":"5% en l√°tex","vigenciaLead":30,"descuentoVip":"5% en l√°tex","vigenciaVip":0,"estado":"activo","direccion":"√âxodo 476, San Salvador de Jujuy","telefono":"","mapa":"","tokenQR":"TOKEN_PINTURAS_990"},{"id":"panaderia","nombre":"Linda Panader√≠a","logo":"","beneficio":"20% en mi√±ones","vigenciaLead":60,"descuentoVip":"20% en mi√±ones","vigenciaVip":0,"estado":"activo","direccion":"Florida 186, San Salvador de Jujuy","telefono":"","mapa":"","tokenQR":"TOKEN_PAN_12"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__571"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__539"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__289"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__941"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__264"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__297"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__588"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__778"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__883"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__898"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__457"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__889"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__733"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__568"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__620"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__949"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__576"},{"id":"","nombre":"","logo":"","beneficio":"","vigenciaLead":30,"descuentoVip":"","vigenciaVip":0,"estado":"activo","direccion":"","telefono":"","mapa":"","tokenQR":"TOKEN__334"}];

    let usos = JSON.parse(localStorage.getItem('usosHabitatCar') || '{}');
    let validados = JSON.parse(localStorage.getItem('validadosHabitatCar') || '{}');

    function mostrarGrilla() {
      document.getElementById('grilla').innerHTML = '';
      COMERCIOS.forEach(com => {
        const usado = usos[com.id];
        const cupon = document.createElement('div');
        cupon.className = `cupon ${usado ? 'inactivo' : ''}`;
        cupon.innerHTML = `
          <div class="nombre">${com.nombre}</div>
          <div class="descuento">${com.beneficio}</div>
          <div class="info"><strong>üìç Direcci√≥n:</strong> ${com.direccion}</div>
          ${com.telefono ? `<div class="info"><strong>üìû Tel√©fono:</strong> <a href="tel:${com.telefono}">${com.telefono}</a></div>` : ''}
          <div style="margin-top:20px; display:flex; flex-direction:column; gap:12px;">
            ${!usado ? 
              `<button class="btn btn-qr" onclick="abrirCamara('${com.id}', '${com.tokenQR}')">Validar Cup√≥n con QR en comercio</button>` :
              `<div style="text-align:center; color:#b71c1c; font-weight:bold;">‚úÖ Beneficio ya utilizado</div>`
            }
            ${com.mapa ? `<a href="${com.mapa}" target="_blank" class="btn btn-como-llegar">C√≥mo llegar</a>` : ''}
            <button class="btn btn-usar" id="btn-usar-${com.id}" ${usado || !validados[com.id] ? 'disabled' : ''} onclick="usar('${com.id}', '${com.nombre}', '${com.beneficio}')">Usar el beneficio</button>
          </div>
        `;
        document.getElementById('grilla').appendChild(cupon);
      });

      COMERCIOS.forEach(com => {
        if (validados[com.id] && !usos[com.id]) {
          const btn = document.getElementById(`btn-usar-${com.id}`);
          if (btn) btn.disabled = false;
        }
      });
    }

    let codigoQR;
    let video;
    let stream;

    function abrirCamara(comercioId, tokenEsperado) {
      const scanner = document.createElement('div');
      scanner.className = 'qr-scanner';
      scanner.innerHTML = `
        <video id="video-qr"></video>
        <p style="color:white; font-size:20px; font-weight:bold;">Apunt√° al QR del comercio</p>
        <button class="close-btn" onclick="cerrarCamara()">Cerrar</button>
      `;
      document.body.appendChild(scanner);

      video = document.getElementById('video-qr');
      codigoQR = new ZXing.BrowserMultiFormatReader();

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(s => {
          stream = s;
          video.srcObject = stream;
          video.play();
          codigoQR.decodeFromVideoDevice(undefined, 'video-qr', (result, err) => {
            if (result) {
              const textoLeido = result.getText().trim();
              if (textoLeido === tokenEsperado) {
                cerrarCamara();
                validarCupon(comercioId);
              } else {
                cerrarCamara();
                mostrarError("‚ùå Token no v√°lido para este comercio.");
              }
            }
            if (err && !(err instanceof ZXing.NotFoundException)) {
              cerrarCamara();
            }
          });
        })
        .catch(err => {
          cerrarCamara();
          mostrarError("‚ùå No se pudo acceder a la c√°mara.");
        });
    }

    function cerrarCamara() {
      if (stream) stream.getTracks().forEach(track => track.stop());
      const scanner = document.querySelector('.qr-scanner');
      if (scanner) scanner.remove();
      if (codigoQR) codigoQR.reset();
    }

    function mostrarError(mensaje) {
      const error = document.createElement('div');
      error.className = 'mensaje-error';
      error.textContent = mensaje;
      document.body.appendChild(error);
      setTimeout(() => error.remove(), 4000);
    }

    function validarCupon(comercioId) {
      validados[comercioId] = true;
      localStorage.setItem('validadosHabitatCar', JSON.stringify(validados));
      const btn = document.getElementById(`btn-usar-${comercioId}`);
      if (btn) btn.disabled = false;
      mostrarError("‚úÖ QR validado. Ya pod√©s usar el beneficio.");
    }

    function usar(comercioId, nombre, beneficio) {
      if (!validados[comercioId]) {
        mostrarError("‚ö†Ô∏è Primero valid√° el QR del comercio.");
        return;
      }
      if (usos[comercioId]) {
        mostrarError("‚úÖ Ya usaste este beneficio.");
        return;
      }

      const alerta = document.createElement('div');
      alerta.className = 'advertencia-overlay';
      alerta.innerHTML = `
        <div class="advertencia-contenido">
          <h3>‚ö†Ô∏è ¬°ATENCI√ìN!</h3>
          <p>¬øAvisaste al cajero que usar√°s el cup√≥n de descuento?<br>
          <strong>Si no le avisaste, perder√°s la validez del beneficio.</strong></p>
          <div class="advertencia-btns">
            <button class="advertencia-btn btn-si" onclick="confirmarUso('${comercioId}', '${nombre}', '${beneficio}')">S√ç, le avis√©</button>
            <button class="advertencia-btn btn-no" onclick="cerrarAdvertencia()">Volver</button>
          </div>
        </div>
      `;
      document.body.appendChild(alerta);
    }

    function cerrarAdvertencia() {
      const alerta = document.querySelector('.advertencia-overlay');
      if (alerta) alerta.remove();
    }

    function confirmarUso(comercioId, nombre, beneficio) {
      cerrarAdvertencia();
      usos[comercioId] = true;
      localStorage.setItem('usosHabitatCar', JSON.stringify(usos));

      document.getElementById('grilla').innerHTML = `
        <div style="text-align:center; padding:40px 20px;">
          <img src="/logo.png" alt="Habitat-Car" style="width:98%; max-width:520px; margin-bottom:20px;">
          <h2>üéâ ¬°FELICITACIONES!</h2>
          <p>Beneficio activado en <strong>${nombre}</strong>.</p>
          <p>${beneficio}</p>
          <div id="contador" style="font-size:60px; font-weight:bold; color:#d32f2f; margin:20px 0;">30</div>
          <p>V√°lido por 30 segundos.</p>
        </div>
      `;

      let c = 30;
      const int = setInterval(() => {
        c--;
        document.getElementById('contador').textContent = c;
        if (c <= 0) {
          clearInterval(int);
          usos = JSON.parse(localStorage.getItem('usosHabitatCar') || '{}');
          mostrarGrilla();
        }
      }, 1000);
    }

    function reiniciarCupones() {
      if (confirm("¬øReiniciar cupones? Se borrar√°n usos y validaciones.")) {
        localStorage.removeItem('usosHabitatCar');
        localStorage.removeItem('validadosHabitatCar');
        usos = {};
        validados = {};
        mostrarGrilla();
      }
    }

    mostrarGrilla();
  </script>
</body>
</html>
  
