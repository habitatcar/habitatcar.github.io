const SHEET_ID = "12FhkfYkKM67zifEeBwlAzHSJExXpB0tuq1ey-CyUzHU";

// --- 1. GESTIÃ“N DE TOKENS ---
function onEdit(e) {
  const sheet = e.source.getActiveSheet();
  const range = e.range;
  const sheetName = sheet.getName();
  const row = range.getRow();
  const col = range.getColumn();
  const value = e.value ? e.value.toString().toLowerCase() : "";

  if (sheetName === "TokensVIP" && col === 2 && value === "activo") {
    const cellToken = sheet.getRange(row, 1);
    if (cellToken.getValue() === "") {
      const randomToken = "vip_" + Math.random().toString(36).substring(2, 12);
      cellToken.setValue(randomToken);
    }
    const token = cellToken.getValue();
    sheet.getRange(row, 6).setValue("https://habitatcar.github.io/registrovip/?token=" + token); 
    sheet.getRange(row, 7).setValue("ðŸ“‹ Copiar link"); 
  }

  if (sheetName === "Comercios" && col === 8 && value === "activo") {
    const idCom = sheet.getRange(row, 1).getValue(); 
    const cellTokenQR = sheet.getRange(row, 12); 
    if (cellTokenQR.getValue() === "" && idCom !== "") {
      const randomNum = Math.floor(Math.random() * 900000) + 100000;
      cellTokenQR.setValue("token_" + idCom.toString().toLowerCase().trim() + "_" + randomNum);
    }
  }
}

// --- 2. API (RECEPCIÃ“N DE DATOS) ---
function doGet(e) {
  const acc = e.parameter.accion;
  const waInput = e.parameter.whatsapp ? e.parameter.whatsapp.toString().replace(/\D/g, "") : "";
  const ss = SpreadsheetApp.openById(SHEET_ID);

  // ACCIÃ“N: REGISTRO NORMAL (LEAD)
  if (acc === "registrarLead") {
    const hojaLeads = ss.getSheetByName("Leads");
    hojaLeads.appendRow([waInput, e.parameter.nombre, e.parameter.email, "", new Date(), "activo"]);
    return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
  }

  // ACCIÃ“N: REGISTRO VIP
  if (acc === "registrarVip") {
    const tokenRecibido = e.parameter.token;
    const hojaTokens = ss.getSheetByName("TokensVIP");
    const datosTokens = hojaTokens.getDataRange().getValues();
    
    let tokenValido = false;
    for (let i = 1; i < datosTokens.length; i++) {
      if (datosTokens[i][0] === tokenRecibido && datosTokens[i][1].toString().toLowerCase() === "activo") {
        tokenValido = true;
        break;
      }
    }

    if (!tokenValido) {
      return ContentService.createTextOutput(JSON.stringify({success: false, mensaje: "QR o Token invÃ¡lido o ya usado"})).setMimeType(ContentService.MimeType.JSON);
    }

    const hojaVip = ss.getSheetByName("ClientesVIP");
    const hojaLeads = ss.getSheetByName("Leads");
    if (hojaLeads) {
      const datosLeads = hojaLeads.getDataRange().getValues();
      for (let i = 1; i < datosLeads.length; i++) {
        if (datosLeads[i][0].toString().replace(/\D/g, "") === waInput) {
          hojaLeads.getRange(i + 1, 10).setValue("sÃ­");
          break;
        }
      }
    }
    hojaVip.appendRow([waInput, e.parameter.nombre, e.parameter.email, "", new Date(), "", "", "", "", "activo"]);
    return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
  }

  // ACCIÃ“N: REGISTRAR USO (CON VALIDACIÃ“N DE TOKEN COMERCIO)
  if (acc === "registrarUso") {
    const tokenQR = e.parameter.tokenQR;
    const comercio = e.parameter.comercio;
    const hojaCom = ss.getSheetByName("Comercios");
    const datosCom = hojaCom.getDataRange().getValues();
    
    let esValido = false;
    for (let i = 1; i < datosCom.length; i++) {
      if (datosCom[i][1] === comercio && datosCom[i][11] === tokenQR) {
        esValido = true;
        break;
      }
    }

    if (!esValido) {
      return ContentService.createTextOutput(JSON.stringify({success: false, mensaje: "QR incorrecto para este comercio"})).setMimeType(ContentService.MimeType.JSON);
    }

    const st = ss.getSheetByName("EstadÃ­sticas de Uso");
    let nombreEncontrado = "Usuario Desconocido";
    const hojas = ["ClientesVIP", "Leads"];
    for (let h = 0; h < hojas.length; h++) {
      let hoja = ss.getSheetByName(hojas[h]);
      if (hoja) {
        let datos = hoja.getDataRange().getValues();
        for (let i = 1; i < datos.length; i++) {
          if (datos[i][0].toString().replace(/\D/g, "") === waInput) {
            nombreEncontrado = datos[i][1];
            break;
          }
        }
      }
      if (nombreEncontrado !== "Usuario Desconocido") break;
    }
    st.appendRow([new Date(), waInput, nombreEncontrado, e.parameter.tipo, comercio]);
    actualizarTablaRecuento();
    return ContentService.createTextOutput(JSON.stringify({success: true, nombre: nombreEncontrado})).setMimeType(ContentService.MimeType.JSON);
  }
}

function actualizarTablaRecuento() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const hojaEst = ss.getSheetByName("EstadÃ­sticas de Uso");
  if (!hojaEst) return;
  const datos = hojaEst.getDataRange().getValues();
  if (datos.length < 2) return;
  let conteo = {};
  for (let i = 1; i < datos.length; i++) {
    if (!datos[i][0]) continue;
    let clave = (datos[i][4] || "General") + "|" + (datos[i][2] || "Desconocido") + "|" + (datos[i][3] || "lead");
    conteo[clave] = (conteo[clave] || 0) + 1;
  }
  let tabla = [["COMERCIO", "USUARIO", "TIPO", "USOS"]];
  for (let k in conteo) {
    let p = k.split("|");
    tabla.push([p[0], p[1], p[2], conteo[k]]);
  }
  hojaEst.getRange("I:L").clearContent();
  hojaEst.getRange(1, 9, tabla.length, 4).setValues(tabla);
  hojaEst.getRange(1, 9, 1, 4).setBackground("#2c5aa0").setFontColor("white").setFontWeight("bold");
}

function onOpen() {
  SpreadsheetApp.getUi().createMenu('Habitat-Car')
    .addItem('Actualizar Tabla Recuento', 'actualizarTablaRecuento')
    .addToUi();
}
