<script>
  var URL_WEB_APP = "https://script.google.com/macros/s/AKfycbw5Ib_Bjheux6ASI90ejyzIBukqnG3lIrw5jyW-LU9avs9_lBy-mh7r9Bbpw8aFubU2/exec";

  // ✅ Redirección automática si ya está registrado
  (function() {
    var registro = localStorage.getItem('usuarioHabitatCar');
    if (registro) {
      window.location.replace("/cupones/");
    }
  })();

  function registrar() {
    var nombre = document.getElementById('nombre').value.trim();
    var whatsapp = document.getElementById('whatsapp').value.trim().replace(/\D/g, '');
    var email = document.getElementById('email').value.trim();
    if (!nombre || !whatsapp) {
      alert("Por favor, complet\u00e1 nombre y WhatsApp.");
      return;
    }
    fetch(URL_WEB_APP + "?accion=registrarLead&nombre=" + encodeURIComponent(nombre) + "&whatsapp=" + whatsapp + "&email=" + encodeURIComponent(email))
      .then(function(resp) { return resp.json(); })
      .then(function(data) {
        if (data.success) {
          // ✅ Guardar fecha de registro para que vigencia empiece HOY
          localStorage.setItem('usuarioHabitatCar', JSON.stringify({
            nombre: nombre,
            whatsapp: whatsapp,
            email: email,
            tipo: 'lead',
            fechaRegistro: new Date().toISOString()
          }));
          document.getElementById('mensaje').innerHTML = '<div class="mensaje">\u2705 \u00a1Registro exitoso! Redirigiendo...</div>';
          setTimeout(function() { window.location.replace("/cupones/"); }, 2000);
        } else {
          // ✅ Mensaje específico si el número ya está registrado
          document.getElementById('mensaje').innerHTML = '<div class="mensaje" style="color:red;">\u274c N\u00famero ya registrado</div>';
        }
      })
      .catch(function(err) {
        document.getElementById('mensaje').innerHTML = '<div class="mensaje" style="color:red;">\u274c Error de conexi\u00f3n</div>';
      });
  }
</script>
