<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Beneficios Leads | H√°bitat-Car</title>

    <link rel="icon" type="image/png" href="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true">
    <link rel="apple-touch-icon" href="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="H√°bitat-Car">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkhhYml0YXQtQ2FyIExlYWRzIiwKICAic2hvcnRfbmFtZSI6ICJIYeWiaXRhdC1DYXIiLAogIClY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2dpdGh1Yi5jb20vaGFiaXRhdGNhci9oYWJpdGF0Y2FyL2Jsb2IvbWFpbi9sb2dvLnBuZz9yYXc9dHJ1ZSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2dpdGh1Yi5jb20vaGFiaXRhdGNhci9oYWJpdGF0Y2FyL2Jsb2IvbWFpbi9sb2dvLnBuZz9yYXc9dHJ1ZSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0sCiAgInN0YXJ0X3VybCI6ICIvaW5kZXguaHRtbCIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDRhOTkiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDRhOTkiCn0=">

    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --azul-habitat: #004a99;
            --rojo-cupon: #ff0000;
            --naranja: #ff9800;
            --celeste: #03a9f4;
            --verde: #4caf50;
            --rosa: #e91e63;
            --negro: #000000;
        }

        body { margin: 0; padding: 0; background-color: var(--azul-habitat); font-family: 'Segoe UI', Arial, sans-serif; -webkit-tap-highlight-color: transparent; }

        .header-white { padding: 40px 15px; text-align: center; background: white; border-bottom: 6px solid var(--rojo-cupon); position: sticky; top: 0; z-index: 100; }
        .header-white img { width: 100%; max-width: 350px; height: auto; }

        .filtro-container { padding: 15px; display: flex; gap: 10px; background: rgba(255,255,255,0.1); position: sticky; top: 145px; z-index: 90; backdrop-filter: blur(10px); }
        .filtro-container input, .filtro-container select { flex: 1; padding: 12px; border-radius: 8px; border: none; font-size: 16px; outline: none; }

        .grid { padding: 15px; display: grid; grid-template-columns: 1fr; gap: 20px; padding-bottom: 100px; }

        .card { background: white; border-radius: 15px; overflow: hidden; position: relative; box-shadow: 0 10px 20px rgba(0,0,0,0.3); text-align: center; padding-bottom: 20px; transition: 0.3s; }
        .card.usado { filter: grayscale(1); opacity: 0.7; pointer-events: none; }
        .card.usado::after { content: "CANJEADO"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-20deg); font-size: 40px; font-weight: bold; color: rgba(255,0,0,0.5); border: 5px solid rgba(255,0,0,0.5); padding: 10px; border-radius: 10px; z-index: 10; }

        .logo-container { height: 120px; display: flex; align-items: center; justify-content: center; background: #f9f9f9; padding: 10px; }
        .logo-c { max-height: 100px; max-width: 80%; object-fit: contain; }

        .nombre-c { font-weight: 900; font-size: 24px; color: var(--negro); margin: 10px 0; text-transform: uppercase; padding: 0 10px; }
        .beneficio-c { color: var(--rojo-cupon); font-size: 26px; font-weight: 900; margin: 5px 0; padding: 0 10px; }
        .info-txt { display: block; font-size: 14px; color: #666; margin: 4px 0; font-weight: 600; }

        .btn-stack { padding: 0 15px; display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .btn-act { padding: 15px; border-radius: 10px; border: none; font-weight: bold; font-size: 16px; color: white; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn-act:active { transform: scale(0.98); }

        .btn-conozca { background: var(--naranja); }
        .btn-llegar { background: var(--celeste); }
        .btn-validar { background: var(--negro); }
        .btn-usar { background: #ccc; pointer-events: none; }
        .btn-usar.activo { background: var(--verde); pointer-events: auto; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        #reader { width: 300px; background: white; border-radius: 10px; overflow: hidden; }

        .popup-redes { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.5); display: none; flex-direction: column; gap: 15px; z-index: 1100; width: 85%; max-width: 320px; text-align: center; }
        .btn-red { padding: 15px; border-radius: 10px; border: none; color: white; font-weight: bold; text-decoration: none; display: block; font-size: 16px; }

        .success-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .success-page h1 { color: var(--verde); font-size: 35px; margin: 20px 0; font-weight: 900; }
        .timer-circle { width: 120px; height: 120px; border-radius: 50%; border: 10px solid var(--rojo-cupon); display: flex; align-items: center; justify-content: center; font-size: 50px; font-weight: bold; color: var(--negro); margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="header-white">
    <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true">
</div>

<div class="filtro-container">
    <input type="text" id="filtroNombre" placeholder="üîç Buscar comercio..." onkeyup="filtrar()">
    <select id="filtroVence" onchange="filtrar()">
        <option value="todos">Vence en...</option>
        <option value="7">7 d√≠as</option>
        <option value="15">15 d√≠as</option>
    </select>
</div>

<div id="contenedor-cupones" class="grid"></div>

<div id="popup-redes" class="popup-redes">
    <h3 id="pop-nombre" style="margin:0; color:var(--negro); font-size: 22px;"></h3>
    <p style="margin: 0; color: #666; font-size: 14px;">Visite nuestras redes:</p>
    <a id="lnk-ig" class="btn-red" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%)" target="_blank">INSTAGRAM</a>
    <a id="lnk-web" class="btn-red" style="background: var(--azul-habitat)" target="_blank">SITIO WEB</a>
    <button onclick="cerrarPopup()" style="border:none; background:none; color:var(--rojo-cupon); font-weight:900; cursor:pointer; margin-top:10px; font-size: 16px;">CERRAR</button>
</div>

<div id="modal-qr" class="modal">
    <h2 style="color:white; margin-bottom: 20px;">Escanee el QR del local</h2>
    <div id="reader"></div>
    <button onclick="cerrarScanner()" style="margin-top:30px; padding:15px 30px; background:white; border:none; border-radius:10px; font-weight:bold; color: var(--rojo-cupon);">CANCELAR</button>
</div>

<div id="pantalla-exito" class="success-page">
    <div class="timer-circle" id="countdown">30</div>
    <h1>¬°CANJE EXITOSO!</h1>
    <p style="font-size: 18px; color: #444; font-weight: 600;">Muestre esta pantalla al vendedor</p>
    <h2 id="exito-comercio" style="text-transform:uppercase; color: var(--azul-habitat); font-size: 28px; margin-top: 10px;"></h2>
    <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" style="width:200px; margin-top:40px">
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, increment, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
        authDomain: "habitatcar-pro.firebaseapp.com",
        projectId: "habitatcar-pro",
        storageBucket: "habitatcar-pro.firebasestorage.app",
        messagingSenderId: "311691258694",
        appId: "1:311691258694:web:17a09051dcea7707af9347"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let scanner = null;
    let idEnProceso = "";
    let tokenEsperado = "";

    const getUsados = () => JSON.parse(localStorage.getItem('usados_v16_ok') || "[]");

    onSnapshot(collection(db, "comercios"), (snap) => {
        const contenedor = document.getElementById('contenedor-cupones');
        const usados = getUsados();
        let html = "";

        snap.forEach(docSnap => {
            const c = docSnap.data();
            const id = docSnap.id;
            if (c.estado === "inactivo") return;

            const esUsado = usados.includes(id);
            const nombre = c.nombre || "Comercio";

            html += `
                <div class="card ${esUsado ? 'usado' : ''}" data-nombre="${nombre.toLowerCase()}" data-vence="7">
                    <div class="logo-container">
                        <img src="${c.logo}" class="logo-c" onerror="this.src='https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true'">
                    </div>
                    <div class="nombre-c">${nombre}</div>
                    <div class="beneficio-c">${c.beneficio}</div>
                    <span class="info-txt">Vencimiento: 7 d√≠as</span>
                    <span class="info-txt">üìç ${c.direccion || 'Consulte direcci√≥n'}</span>
                    <div class="btn-stack">
                        <button class="btn-act btn-conozca" onclick="abrirPopup('${nombre}', '${c.instagram || ''}', '${c.web || ''}')">Conozca el comercio</button>
                        <button class="btn-act btn-llegar" onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(c.direccion || nombre)}')">C√≥mo llegar</button>
                        <button class="btn-act btn-validar" onclick="abrirQR('${id}', '${c.token}')">Validar Cup√≥n con QR</button>
                        <button class="btn-act btn-usar" id="btn-usar-${id}" onclick="finalizar('${id}', '${nombre}')">Usar el Beneficio</button>
                    </div>
                </div>`;
        });
        contenedor.innerHTML = html;
    });

    window.abrirPopup = (nom, ig, web) => {
        document.getElementById('pop-nombre').innerText = nom;
        document.getElementById('lnk-ig').href = ig ? (ig.includes('instagram.com') ? ig : `https://instagram.com/${ig.replace('@','')}`) : "#";
        document.getElementById('lnk-ig').style.display = ig ? 'block' : 'none';
        document.getElementById('lnk-web').href = web || "#";
        document.getElementById('lnk-web').style.display = web ? 'block' : 'none';
        document.getElementById('popup-redes').style.display = 'flex';
    };

    window.cerrarPopup = () => document.getElementById('popup-redes').style.display = 'none';

    window.abrirQR = (id, token) => {
        idEnProceso = id;
        tokenEsperado = token;
        document.getElementById('modal-qr').style.display = 'flex';
        scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
            if (text === tokenEsperado) {
                cerrarScanner();
                const btn = document.getElementById(`btn-usar-${idEnProceso}`);
                if(btn) { 
                    btn.classList.add('activo'); 
                    btn.innerText = "¬°CONFIRMAR CANJE!"; 
                    btn.style.background = "var(--verde)";
                }
            } else {
                alert("QR Incorrecto");
            }
        }).catch(e => console.error(e));
    };

    window.cerrarScanner = () => {
        document.getElementById('modal-qr').style.display = 'none';
        if(scanner) scanner.stop().then(() => scanner.clear());
    };

    window.finalizar = async (id, nom) => {
        try {
            // PROTOCOLO ESTRICTO: Solo se a√±ade el bloque de estad√≠sticas aqu√≠
            const ref = doc(db, "comercios", id);
            await updateDoc(ref, {
                totalUsos: increment(1),
                usosHoy: increment(1),
                usosSemana: increment(1),
                usosMes: increment(1),
                usosAnio: increment(1)
            });

            await addDoc(collection(db, "logs"), {
                fecha: Date.now(),
                tipo: "canje",
                modulo: "CUPONES",
                accion: "CANJE LEADS",
                detalle: `Canje realizado en: ${nom}`,
                comercioId: id
            });

            document.getElementById('exito-comercio').innerText = nom;
            document.getElementById('pantalla-exito').style.display = 'flex';
            
            let s = 30;
            const t = setInterval(() => {
                s--; 
                document.getElementById('countdown').innerText = s;
                if(s <= 0) { 
                    clearInterval(t); 
                    const u = getUsados(); 
                    u.push(id); 
                    localStorage.setItem('usados_v16_ok', JSON.stringify(u)); 
                    location.reload(); 
                }
            }, 1000);
        } catch(e) { 
            console.error(e);
            alert("Error al procesar canje"); 
        }
    };

    window.filtrar = () => {
        const texto = document.getElementById('filtroNombre').value.toLowerCase();
        const vencimiento = document.getElementById('filtroVence').value;
        document.querySelectorAll('.card').forEach(c => {
            const nombreMatch = c.dataset.nombre.includes(texto);
            const dias = parseInt(c.dataset.vence);
            let venceMatch = true;
            if (vencimiento !== "todos") {
                venceMatch = (dias >= 0 && dias <= parseInt(vencimiento));
            }
            c.style.display = (nombreMatch && venceMatch) ? 'block' : 'none';
        });
    };
</script>
</body>
</html>
