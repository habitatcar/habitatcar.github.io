<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cupones | Hábitat-Car</title>

    <link rel="icon" type="image/png" href="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo_redondo.png?raw=true">
    
    <style>
        :root {
            --azul-principal: #0056b3;
            --verde-exito: #2e7d32;
            --negro-fondo: #0a0a0a;
            --negro-card: #1a1a1a;
            --gris-volver: #757575;
            --rojo-alerta: #d32f2f;
        }

        body { 
            margin: 0; padding: 0; 
            background-color: var(--negro-fondo); 
            color: white;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif; 
            padding-bottom: 80px; 
        }

        .header { padding: 20px; text-align: center; border-bottom: 2px solid var(--azul-principal); }
        .header img { max-width: 200px; }

        .grilla { padding: 20px; }
        .card-promo { 
            background: var(--negro-card); border-radius: 15px; padding: 20px; 
            margin-bottom: 20px; text-align: center; border: 1px solid #333;
        }
        
        .nombre-c { font-size: 1.4em; font-weight: 700; color: white; margin-bottom: 5px; }
        .beneficio-c { font-size: 1.8em; font-weight: 900; color: #4dabf7; margin-bottom: 15px; }

        .btn-usar { 
            width: 100%; padding: 15px; border-radius: 10px; border: none;
            background: var(--azul-principal); color: white;
            font-size: 1em; font-weight: 800; cursor: pointer; text-transform: uppercase;
        }

        /* MODAL ADVERTENCIA (Lógica VIP aplicada a Lead) */
        .advertencia-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 5000;
        }
        .advertencia-contenido {
            background: white; border-radius: 20px; padding: 30px; text-align: center; 
            width: 85%; max-width: 340px; color: #000; border: 5px solid var(--rojo-alerta);
        }
        .btn-si, .btn-no { padding: 16px; font-size: 16px; border-radius: 12px; border: none; font-weight: bold; flex: 1; }
        .btn-si { background: var(--rojo-alerta); color: white; }
        .btn-no { background: var(--gris-volver); color: white; }

        /* PANTALLA ÉXITO (Lógica VIP aplicada a Lead) */
        .success-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 6000; display: none; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
        .success-card {
            border: 4px solid var(--azul-principal); border-radius: 25px; padding: 30px 15px;
            width: 85%; background: #111;
        }
        .timer-circle { font-size: 60px; font-weight: 900; color: var(--azul-principal); }
        .aviso-cajero { margin-top: 20px; padding: 15px; font-weight: 800; color: white; background: var(--azul-principal); border-radius: 10px; }

        .footer {
            position: fixed; bottom: 0; width: 100%; background: white; 
            padding: 15px 0; display: flex; justify-content: space-around;
        }
        .footer a { text-decoration: none; color: black; font-weight: 700; font-size: 13px; }
    </style>
</head>
<body>

    <div class="header">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="Logo">
    </div>

    <div class="grilla" id="contenedor-cupones"></div>

    <div id="pantalla-exito" class="success-page">
        <div class="success-card">
            <h1 style="color:var(--azul-principal);">CUPÓN ACTIVADO</h1>
            <p id="exito-comercio" style="font-weight:700; font-size:20px; color: #fff;"></p>
            <p id="exito-beneficio" style="font-size:24px; color:#4dabf7; font-weight:900;"></p>
            <div style="margin:20px auto; width:120px; height:120px; border-radius:50%; border:8px solid var(--azul-principal); display:flex; align-items:center; justify-content:center;">
                <div class="timer-circle" id="countdown">30</div>
            </div>
            <div class="aviso-cajero">MOSTRALE ESTA PANTALLA AL CAJERO</div>
        </div>
    </div>

    <footer class="footer">
        <a href="https://www.habitatcar.com.ar">www.habitatcar.com.ar</a>
        <a href="https://wa.me/543884618228">Soporte WA</a>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        onSnapshot(collection(db, "comercios"), (snap) => {
            const contenedor = document.getElementById('contenedor-cupones');
            let html = "";
            snap.forEach(d => {
                const c = d.data();
                if (c.estado === "inactivo") return;
                html += `
                    <div class="card-promo">
                        <div class="nombre-c">${c.nombre || ''}</div>
                        <div class="beneficio-c">${c.valPromo || 0}% OFF</div>
                        <button class="btn-usar" onclick="preguntarCajero('${d.id}', '${c.nombre}', '${c.valPromo}% OFF')">
                            Usar beneficio
                        </button>
                    </div>`;
            });
            contenedor.innerHTML = html;
        });

        window.preguntarCajero = (id, nombre, beneficio) => {
            const alerta = document.createElement('div');
            alerta.className = 'advertencia-overlay';
            alerta.id = 'alerta-cajero';
            alerta.innerHTML = `
                <div class="advertencia-contenido">
                    <h3 style="color:red;">⚠️ ATENCIÓN</h3>
                    <p>¿Avisaste al cajero que usarás el cupón?<br><br><b>Si no avisaste, perderás el beneficio.</b></p>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-si" onclick="finalizarLead('${id}', '${nombre}', '${beneficio}')">SÍ</button>
                        <button class="btn-no" onclick="document.getElementById('alerta-cajero').remove()">NO</button>
                    </div>
                </div>`;
            document.body.appendChild(alerta);
        };

        window.finalizarLead = async (id, nom, ben) => {
            const modal = document.getElementById('alerta-cajero');
            if(modal) modal.remove();
            
            document.getElementById('exito-comercio').innerText = nom;
            document.getElementById('exito-beneficio').innerText = ben;
            document.getElementById('pantalla-exito').style.display = 'flex';
            
            try {
                await updateDoc(doc(db, "comercios", id), { totalLeads: increment(1) });
                await addDoc(collection(db, "logs_leads"), { 
                    comercio: nom, 
                    comercioId: id,
                    fecha: serverTimestamp(), 
                    tipo: "PROMO"
                });

                let s = 30;
                const t = setInterval(() => {
                    s--;
                    document.getElementById('countdown').innerText = s;
                    if(s <= 0) { clearInterval(t); location.reload(); }
                }, 1000);
            } catch(e) { 
                console.error(e);
                location.reload();
            }
        };
    </script>
</body>
</html>
