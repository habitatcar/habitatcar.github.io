<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Beneficios Leads | Hábitat-Car</title>

    <link rel="icon" type="image/png" href="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true">
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

    <style>
        :root {
            --azul-habitat: #003d80; 
            --rojo-cupon: #e60000;
        }

        body { margin: 0; background-color: var(--azul-habitat); font-family: sans-serif; }

        .header-white { padding: 20px; text-align: center; background: white; border-bottom: 4px solid var(--rojo-cupon); }
        .header-white img { max-width: 200px; }

        .grid { padding: 15px; display: grid; gap: 20px; }

        /* EL DISEÑO DE TU TARJETA */
        .card {
            background: white; border-radius: 10px; overflow: hidden; position: relative;
            text-align: center; padding-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* LÓGICA DE BLOQUEO (Lo que pediste recomponer) */
        .card.usado { filter: grayscale(1); opacity: 0.7; }
        .card.usado .btn-validar { pointer-events: none; background: #666 !important; }
        .card.usado::after {
            content: "CANJEADO";
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            font-size: 35px; font-weight: bold; color: var(--rojo-cupon);
            border: 4px solid var(--rojo-cupon); padding: 5px 10px; z-index: 10;
        }

        .logo-container { height: 120px; display: flex; align-items: center; justify-content: center; }
        .logo-c { max-height: 100px; max-width: 80%; }

        .nombre-c { font-weight: bold; font-size: 18px; margin: 5px; }
        .beneficio-c { color: var(--rojo-cupon); font-size: 22px; font-weight: 900; margin-bottom: 5px; }

        /* CAMPO DE CONTEO (Lo nuevo que agregué según tu imagen) */
        .usos-info { font-size: 14px; font-weight: bold; color: #555; margin-bottom: 10px; }

        .btn-validar { 
            background: #0d124a; color: white; border: none; padding: 10px 20px; 
            border-radius: 5px; font-weight: bold; cursor: pointer; width: 80%;
        }
        .btn-usar { 
            background: #2e7d32; color: white; border: none; padding: 10px 20px; 
            border-radius: 5px; font-weight: bold; margin-top: 10px; display: none; width: 80%;
        }

        .custom-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 100; }
        .success-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
    </style>
</head>
<body>

    <div class="header-white">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true">
    </div>

    <div id="contenedor-cupones" class="grid"></div>

    <div id="modal-qr" class="custom-overlay">
        <div id="reader" style="width: 300px; margin: auto; margin-top: 20%;"></div>
        <button onclick="cerrarScanner()" style="display:block; margin: 20px auto;">CERRAR</button>
    </div>

    <div id="pantalla-exito" class="success-page">
        <h1 style="color:green">¡CANJEADO!</h1>
        <div id="codigo-barras"></div>
        <svg id="barcode"></svg>
        <p>Volviendo en <span id="countdown">10</span>s...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const leadId = localStorage.getItem('leadId_habitat');

        // Escuchamos los datos para actualizar el contador y el bloqueo
        onSnapshot(doc(db, "leads", leadId), (docLead) => {
            const dataLead = docLead.data();
            const conteos = dataLead.conteos_por_comercio || {};

            onSnapshot(collection(db, "comercios"), (snap) => {
                const contenedor = document.getElementById('contenedor-cupones');
                let html = "";
                snap.forEach(d => {
                    const c = d.data();
                    const nUsos = conteos[c.nombre] || 0;
                    const yaUsado = nUsos > 0; // BLOQUEO SI YA SE USÓ AL MENOS 1 VEZ

                    html += `
                        <div class="card ${yaUsado ? 'usado' : ''}">
                            <div class="logo-container"><img src="${c.logoUrl}" class="logo-c"></div>
                            <div class="nombre-c">${c.nombre}</div>
                            <div class="beneficio-c">${c.valLead}% OFF</div>
                            
                            <div class="usos-info">Usos: ${nUsos}</div>

                            <button class="btn-validar" onclick="abrirQR('${d.id}', '${c.tokenQR}')">
                                ${yaUsado ? 'CUPÓN USADO' : 'VALIDAR QR'}
                            </button>
                            <button id="btn-usar-${d.id}" class="btn-usar" onclick="confirmarCanje('${d.id}', '${c.nombre}')">CONFIRMAR USO</button>
                        </div>`;
                });
                contenedor.innerHTML = html;
            });
        });

        window.abrirQR = (id, token) => {
            document.getElementById('modal-qr').style.display = 'block';
            let scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                if(text === token) {
                    scanner.stop();
                    document.getElementById('modal-qr').style.display = 'none';
                    document.getElementById(`btn-usar-${id}`).style.display = 'inline-block';
                }
            });
        };

        window.confirmarCanje = async (id, nombreComercio) => {
            const campo = `conteos_por_comercio.${nombreComercio}`;
            await updateDoc(doc(db, "leads", leadId), {
                [campo]: increment(1)
            });

            document.getElementById('pantalla-exito').style.display = 'flex';
            JsBarcode("#barcode", "CANJE-" + id.substring(0,5));
            
            setTimeout(() => { location.reload(); }, 5000);
        };
    </script>
</body>
</html>
