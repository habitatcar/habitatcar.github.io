<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteos y Promociones | H√°bitat-Car</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --azul-oscuro: #0a192f;
            --azul-medio: #334766;
            --azul-claro: #415a77;
            --celeste-habitat: #004a99;
            --blanco-suave: #e6f1ff;
            --borravino: #800020;
            --verde: #28a745;
            --rojo: #dc3545;
            --oro: #ffc107;
            --naranja: #ff8c00;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: #fff; min-height: 100vh; }
        .header { background: rgba(0,0,0,0.3); padding: 15px; text-align: center; border-bottom: 2px solid #ff9800; }
        .logo { max-width: 180px; margin-bottom: 10px; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; }
        .loading { text-align: center; padding: 50px; }
        .spinner { width: 50px; height: 50px; border: 5px solid #ff9800; border-top: 5px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .card { background: rgba(0,0,0,0.3); padding: 30px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ff9800; }
        .card h2 { color: #ff9800; margin-bottom: 15px; font-size: 1.5em; }
        .card h3 { color: #fff; margin-bottom: 10px; font-size: 1.2em; }
        .card p { color: #cbd5e0; line-height: 1.6; margin-bottom: 10px; }
        .btn { display: inline-block; padding: 15px 30px; background: #ff9800; color: #fff; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 10px 5px; transition: all 0.3s; border: none; cursor: pointer; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,152,0,0.3); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid #fff; }
        .error-message { background: rgba(255,68,68,0.2); border: 1px solid #ff4444; padding: 20px; border-radius: 10px; text-align: center; display: none; }
        .error-message.active { display: block; }
        .footer { text-align: center; padding: 20px; background: rgba(0,0,0,0.3); margin-top: 30px; }
        .footer a { color: #ff9800; text-decoration: none; }
        
        /* NUEVA TARJETA DE PROMOCI√ìN */
        #card-promo {
            background: rgba(255,140,0,0.15);
            border: 2px solid var(--naranja);
            display: none;
        }
        #card-promo h2 {
            color: var(--naranja);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #vence-promo-container {
            color: var(--naranja);
            font-weight: bold;
            margin-top: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" alt="H√°bitat-Car Logo" class="logo">
        <h1>üéÅ Sorteos y Promociones | H√°bitat-Car</h1>
    </div>

    <div class="container">
        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>CARGANDO...</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message">
            <h2>‚ö†Ô∏è ACCESO NO DISPONIBLE</h2>
            <p>No hay promociones activas en este momento o el enlace no es v√°lido.</p>
            <button class="btn" onclick="volverABeneficios()">VOLVER A BENEFICIOS</button>
        </div>

        <!-- Contenido Principal -->
        <div id="contenidoPrincipal" style="display: none;">
            
            <!-- Tarjeta de Sorteo -->
            <div class="card" id="card-sorteo">
                <h2><i class="fas fa-trophy"></i> ¬°SORTEO MENSUAL!</h2>
                <h3 id="tit-sorteo"></h3>
                <p id="desc-sorteo"></p>
                <p id="fecha-sorteo" style="color: var(--oro); font-weight: bold;"></p>
                <button class="btn" onclick="participarSorteo()">QUIERO PARTICIPAR</button>
                <button class="btn btn-secondary" onclick="verBases()">Bases del Sorteo</button>
            </div>

            <!-- ‚úÖ NUEVA TARJETA DE PROMOCI√ìN (ACTUALIZADO) -->
            <div class="card" id="card-promo">
                <h2><i class="fas fa-tag"></i> PROMOCI√ìN ESPECIAL</h2>
                <h3 id="tit-promo"></h3>
                <p id="desc-promo"></p>
                <p id="vence-promo-container" style="color: var(--naranja); font-weight: bold; margin-top: 10px; font-size: 0.9em;">
                    <i class="fas fa-clock"></i> Promo v√°lida hasta: <span id="fecha-vence-promo"></span>
                </p>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <a href="javascript:history.back()" class="btn btn-secondary">‚Üê VOLVER A BENEFICIOS</a>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>
            <a href="https://www.habitatcar.com.ar" target="_blank">www.habitatcar.com.ar</a> | 
            <a href="https://wa.me/543884618228" target="_blank">WA: 388-4618228</a>
        </p>
        <p style="margin-top: 10px; font-size: 0.8em; color: #888;">¬© 2024 H√°bitat-Car. Todos los derechos reservados.</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // VALIDAR PAR√ÅMETROS Y CARGAR DATOS
        window.addEventListener('load', function() {
            setTimeout(function() {
                validarYcargarDatos();
            }, 1000);
        });

        async function validarYcargarDatos() {
            const urlParams = new URLSearchParams(window.location.search);
            const comercioId = urlParams.get('comercioId');

            // Verificar par√°metros
            if(!comercioId) {
                mostrarError();
                return;
            }

            try {
                // Buscar comercio en Firebase
                const q = query(collection(db, "comercios"), where("idComercio", "==", comercioId));
                const querySnapshot = await getDocs(q);

                if(querySnapshot.empty) {
                    mostrarError();
                    return;
                }

                const comercio = querySnapshot.docs[0].data();

                // Verificar si tiene sorteo o promo activa
                if(!comercio.titulo_sorteo && !comercio.titulo_promo) {
                    mostrarError();
                    return;
                }

                // Cargar datos exitosamente
                document.getElementById('loading').style.display = 'none';
                document.getElementById('contenidoPrincipal').style.display = 'block';

                // Vincular datos a la interfaz
                vincularDatos(comercio);

            } catch(error) {
                console.error("Error al cargar datos:", error);
                mostrarError();
            }
        }

        function vincularDatos(c) {
            // === SORTEO ===
            if(c.titulo_sorteo && c.titulo_sorteo.trim() !== "") {
                document.getElementById('card-sorteo').style.display = 'block';
                document.getElementById('tit-sorteo').innerText = c.titulo_sorteo;
                document.getElementById('desc-sorteo').innerText = c.descripcion_sorteo || "";
                document.getElementById('fecha-sorteo').innerText = c.fecha_sorteo ? `üìÖ ${c.fecha_sorteo}` : "";
            } else {
                document.getElementById('card-sorteo').style.display = 'none';
            }

            // === PROMO (ACTUALIZADO CON promo_vence) ===
            if (c.titulo_promo && c.titulo_promo.trim() !== "") {
                document.getElementById('card-promo').style.display = 'block';
                document.getElementById('tit-promo').innerText = c.titulo_promo;
                document.getElementById('desc-promo').innerText = c.descripcion_promo || "";
                
                // Carga la fecha de vencimiento si existe
                if (c.promo_vence) {
                    document.getElementById('fecha-vence-promo').innerText = c.promo_vence;
                    document.getElementById('vence-promo-container').style.display = 'block';
                } else {
                    document.getElementById('vence-promo-container').style.display = 'none';
                }
            } else {
                document.getElementById('card-promo').style.display = 'none';
            }
        }

        function mostrarError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorMessage').classList.add('active');
        }

        function participarSorteo() {
            const usuarioVIP = localStorage.getItem('hc_usuario_vip');
            if(!usuarioVIP) {
                alert('Deb√©s tener una cuenta VIP activa para participar');
                return;
            }
            
            // Aqu√≠ ir√≠a la l√≥gica de registro para el sorteo
            alert('¬°Gracias por participar! Te notificaremos si result√°s ganador.');
        }

        function verBases() {
            alert('BASES DEL SORTEO:\n\n1. Solo miembros VIP pueden participar\n2. El sorteo se realiza el √∫ltimo d√≠a de cada mes\n3. El ganador ser√° notificado por email y WhatsApp\n4. El premio debe retirarse en el comercio dentro de los 30 d√≠as');
        }

        function volverABeneficios() {
            window.location.href = 'usuarios_cupones_vips.html';
        }

        // Exportar funciones para uso global
        window.participarSorteo = participarSorteo;
        window.verBases = verBases;
        window.volverABeneficios = volverABeneficios;
    </script>
</body>
</html>
