<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteos y Promociones | H√°bitat-Car</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --oro: #ffc107;
            --azul-oscuro: #0a192f;
            --azul-medio: #112240;
            --blanco: #e6f1ff;
            --naranja: #ff8c00;
            --verde: #28a745;
            --gris: #6c757d;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--azul-oscuro);
            color: var(--blanco);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .header {
            width: 100%;
            padding: 30px 0;
            text-align: center;
            background: var(--azul-medio);
            border-bottom: 4px solid var(--naranja);
        }

        .logo { 
            width: 90%;
            max-width: 450px; 
            height: auto;
        }

        .container {
            width: 90%;
            max-width: 500px;
            padding: 20px;
            text-align: center;
        }

        .comercio-info h1 {
            color: var(--oro);
            font-size: 2.2em;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        /* ‚úÖ LEYENDA ECOSISTEMA: M√ÅS VISIBLE Y CLARA */
        .leyenda-ecosistema {
            color: #ffffff;
            font-size: 1.05em;
            font-weight: 600;
            margin-bottom: 25px;
            line-height: 1.5;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            padding: 8px 12px;
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
            border-left: 3px solid var(--naranja);
        }

        /* ‚úÖ T√çTULO DE SECCI√ìN PARA CARDS (SORTEO / PROMOCI√ìN) */
        .card-seccion-titulo {
            color: var(--oro);
            font-size: 1.4em;
            font-weight: 700;
            margin: 0 0 15px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .card-seccion-titulo i {
            font-size: 1.2em;
        }

        .promo-card {
            background: linear-gradient(145deg, #112240, #1a3055);
            border-radius: 20px;
            padding: 30px;
            margin-top: 25px;
            border: 2px solid var(--naranja);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .promo-titulo {
            font-size: 1.6em;
            margin-bottom: 15px;
            color: white;
            font-weight: bold;
        }

        .promo-detalle {
            font-size: 1.15em;
            color: #ccd6f6;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }

        .vigencia-texto {
            color: var(--naranja);
            font-weight: bold;
            margin-top: 10px;
            font-size: 0.95em;
            display: none;
        }

        .btn-participar {
            background: var(--naranja);
            color: white;
            padding: 18px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.2em;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .btn-especificaciones {
            background: transparent;
            color: var(--oro);
            border: 1px solid var(--oro);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .popup {
            background: var(--azul-medio);
            padding: 40px 30px;
            border-radius: 30px;
            text-align: center;
            width: 85%;
            max-width: 380px;
            border: 2px solid var(--verde);
        }

        .popup i { font-size: 4.5em; color: var(--verde); margin-bottom: 20px; }
        .popup h2 { color: white; margin: 0 0 10px 0; font-size: 1.8em; }

        /* ‚úÖ BOT√ìN VOLVER CON COLOR DORADO QUE CONTRASTA */
        .footer-link {
            margin: 40px 0;
            background: var(--oro);
            color: var(--azul-oscuro);
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 12px;
            display: inline-block;
            font-weight: bold;
            border: 2px solid var(--oro);
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        .footer-link:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.5);
        }

        /* ‚úÖ M√ÅS ESPACIADO PARA EL CARTEL VERDE */
        .participacion-info {
            background: rgba(40, 167, 69, 0.2);
            border: 2px solid var(--verde);
            padding: 20px;
            border-radius: 15px;
            margin-top: 25px;
            margin-bottom: 25px;
            display: none;
            width: 100%;
        }
        .participacion-info.visible {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ‚úÖ ESTILOS PARA FECHA Y HORA SEPARADAS */
        .fecha-hora-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .fecha-item, .hora-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }
        .fecha-item i, .hora-item i {
            color: var(--oro);
            width: 20px;
        }
        
        /* ‚úÖ CONTADOR DE TRANSPARENCIA */
        #contador-transparencia {
            display: none;
            background: rgba(255,193,7,0.1);
            border: 1px solid var(--oro);
            padding: 12px 20px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            font-size: 0.95em;
            color: var(--blanco);
            animation: pulse 2s infinite;
        }
        #contador-transparencia i {
            margin-right: 8px;
            color: var(--verde);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        
        /* ‚úÖ BOT√ìN GOOGLE CALENDAR */
        .btn-calendar {
            background: #4285F4;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 15px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .btn-calendar:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }
    </style>
</head>
<body>

    <header class="header">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" class="logo" alt="H√°bitat-Car">
    </header>

    <div class="container">
        <div class="comercio-info">
            <h1 id="nombre-comercio">CARGANDO...</h1>
            <p style="color: var(--naranja); font-weight: bold; margin-bottom: 5px; font-size: 1.1em;">SORTEOS Y PROMOCIONES</p>
            <p class="leyenda-ecosistema">‚ú® Este es un espacio V√°lido para todos los miembros del Ecosistema Habitat-Car. ‚ú®</p>
        </div>

        <!-- ‚úÖ CONTADOR DE TRANSPARENCIA EN TIEMPO REAL -->
        <div id="contador-transparencia" style="display:none;">
            <i class="fas fa-users"></i> <span id="texto-contador">Cargando participantes...</span>
        </div>

        <!-- ‚úÖ CARD SORTEO CON T√çTULO PRINCIPAL -->
        <div class="promo-card" id="card-sorteo">
            <h3 class="card-seccion-titulo">
                <i class="fas fa-gift"></i> SORTEO
            </h3>
            
            <h2 id="tit-sorteo" class="promo-titulo"></h2>
            <p id="desc-sorteo" class="promo-detalle"></p>
            
            <!-- ‚úÖ FECHA Y HORA SEPARADAS EN FORMATO ARGENTINO -->
            <div class="fecha-hora-container" id="fecha-sorteo-container" style="display: none;">
                <div class="fecha-item">
                    <i class="fas fa-calendar-day"></i>
                    <span id="fecha-sorteo"></span>
                </div>
                <div class="hora-item">
                    <i class="fas fa-clock"></i>
                    <span id="hora-sorteo"></span>
                </div>
            </div>
            
            <!-- ‚úÖ BOT√ìN CON ESTADO DIN√ÅMICO -->
            <button class="btn-participar" id="btn-participar" onclick="abrirPopupExito()">QUIERO PARTICIPAR</button>
            
            <!-- ‚úÖ MENSAJE DE YA PARTICIP√ì -->
            <div class="participacion-info" id="participacionInfo">
                <i class="fas fa-check-circle" style="color: var(--verde); font-size: 2em; margin-bottom: 10px;"></i>
                <p style="color: var(--verde); font-weight: bold; margin: 0;">‚úÖ YA EST√ÅS PARTICIPANDO</p>
                <p style="font-size: 0.9em; color: #aaa; margin: 5px 0 0 0;">Te notificaremos si resultas ganador</p>
            </div>
            
            <button class="btn-especificaciones" onclick="alert('Bases: 1. Ser miembro activo. 2. Presentar cup√≥n.')">Bases del Sorteo</button>
        </div>

        <!-- ‚úÖ CARD PROMOCI√ìN CON T√çTULO PRINCIPAL -->
        <div class="promo-card" id="card-promo" style="border-color: var(--oro);">
            <h3 class="card-seccion-titulo">
                <i class="fas fa-star"></i> PROMOCI√ìN
            </h3>
            
            <h2 id="tit-promo" class="promo-titulo"></h2>
            <p id="desc-promo" class="promo-detalle"></p>
            
            <!-- ‚úÖ VENCIMIENTO DE PROMO CON FECHA/HORA SEPARADAS -->
            <div class="fecha-hora-container" id="vence-promo-container" style="display: none;">
                <div class="fecha-item">
                    <i class="fas fa-calendar-check"></i>
                    <span id="vence-fecha"></span>
                </div>
                <div class="hora-item">
                    <i class="fas fa-hourglass-end"></i>
                    <span id="vence-hora"></span>
                </div>
            </div>
        </div>

        <!-- ‚úÖ BOT√ìN VOLVER CON COLOR DORADO -->
        <a href="javascript:history.back()" class="footer-link">
            <i class="fas fa-arrow-left"></i> VOLVER A BENEFICIOS
        </a>
    </div>

    <div id="overlay">
        <div class="popup">
            <i class="fas fa-check-circle"></i>
            <h2>¬°MUCHAS GRACIAS!</h2>
            <p id="txt-exito-dinamico"></p>
            
            <!-- ‚úÖ BOT√ìN GOOGLE CALENDAR PARA NOTIFICARME -->
            <button onclick="notificarGoogleCalendar()" class="btn-calendar">
                <i class="fab fa-google"></i> AGENDAR Y NOTIFICARME (Google)
            </button>
            
            <button class="btn-participar" style="margin-top: 15px; background: var(--verde);" onclick="cerrarPopup()">EXCELENTE</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, getDoc, doc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ‚úÖ Obtener nombre del comercio de la URL de forma segura
        const params = new URLSearchParams(window.location.search);
        const nombreComercio = decodeURIComponent(params.get('id') || "");
        let datosComercioGlobal = null;
        let fechaSorteoData = "";

        // ‚úÖ FUNCI√ìN PARA FORMATEAR FECHA ISO A FORMATO ARGENTINO
        function formatearFechaHoraArgentina(fechaISO) {
            if (!fechaISO) return null;
            try {
                const [fechaParte, horaParte] = fechaISO.split('T');
                if (!fechaParte || !horaParte) return null;
                const [anio, mes, dia] = fechaParte.split('-');
                return {
                    fecha: `${dia}/${mes}/${anio}`,
                    hora: `${horaParte} Hs.`
                };
            } catch (e) {
                return null;
            }
        }

        // ‚úÖ VERIFICAR SI YA PARTICIP√ì
        async function verificarParticipacion() {
            const leadId = localStorage.getItem('leadId_v16') || 'anonimo';
            const participacionKey = `participo_sorteo_${nombreComercio}_${leadId}`;
            
            const yaParticipoLocal = localStorage.getItem(participacionKey);
            if (yaParticipoLocal === 'true') {
                mostrarSoloCartelVerde();
                return true;
            }

            try {
                const q = query(
                    collection(db, "admin_participantes_sorteos"),
                    where("comercio", "==", nombreComercio),
                    where("usuarioId", "==", leadId)
                );
                const snap = await getDocs(q);
                if (!snap.empty) {
                    mostrarSoloCartelVerde();
                    return true;
                }
            } catch (e) {
                console.log("‚ö†Ô∏è Verificando participaci√≥n:", e.message);
            }
            return false;
        }

        // ‚úÖ OCULTAR BOT√ìN Y MOSTRAR SOLO CARTEL VERDE
        function mostrarSoloCartelVerde() {
            const btn = document.getElementById('btn-participar');
            const info = document.getElementById('participacionInfo');
            if (btn) btn.style.display = 'none';
            if (info) info.classList.add('visible');
        }

        // ‚úÖ BOT√ìN PARTICIPAR - ENV√çO A admin_participantes_sorteos
        window.abrirPopupExito = async () => {
            const leadId = localStorage.getItem('leadId_v16');
            if (!leadId || !datosComercioGlobal) {
                alert("Espera a que carguen los datos o reingres√° a la App.");
                return;
            }

            try {
                const userRef = doc(db, "leads", leadId);
                const userSnap = await getDoc(userRef);
                const u = userSnap.exists() ? userSnap.data() : {};

                await addDoc(collection(db, "admin_participantes_sorteos"), {
                    usuarioId: leadId,
                    nombre: u.nombre || "Usuario An√≥nimo",
                    celular: u.celular || "Sin WhatsApp",
                    tipo: u.vip === "si" ? "VIP" : "LEAD",
                    comercio: nombreComercio,
                    comercioId: datosComercioGlobal.id,
                    premio: datosComercioGlobal.titulo_sorteo || "Sorteo General",
                    fecha_sorteo: fechaSorteoData,
                    timestamp: serverTimestamp()
                });

                // Guardar en localStorage como respaldo
                const participacionKey = `participo_sorteo_${nombreComercio}_${leadId}`;
                localStorage.setItem(participacionKey, 'true');

                document.getElementById('txt-exito-dinamico').innerText = 
                    `¬°Excelente ${u.nombre || ''}! Ya est√°s participando. No olvides agendarlo en tu calendario.`;
                document.getElementById('overlay').style.display = 'flex';
                mostrarSoloCartelVerde();

            } catch (e) {
                console.error("‚ùå Error al registrar participaci√≥n:", e);
                alert("Error al registrar participaci√≥n. Reintente.");
            }
        };

        // ‚úÖ NOTIFICARME (GOOGLE CALENDAR)
        window.notificarGoogleCalendar = () => {
            if (!datosComercioGlobal || !datosComercioGlobal.fecha_sorteo) {
                alert("No hay una fecha definida para este sorteo.");
                return;
            }

            try {
                // Parsear fecha ISO (YYYY-MM-DDTHH:mm)
                const [fechaParte, horaParte] = datosComercioGlobal.fecha_sorteo.split('T');
                const [anio, mes, dia] = fechaParte.split('-');
                const [hora, minutos] = horaParte ? horaParte.split(':') : ['19', '00'];
                
                // Formato Google Calendar: YYYYMMDDTHHMMSSZ
                const fechaInicio = `${anio}${mes}${dia}T${hora}${minutos}00Z`;
                const fechaRecordatorio = `${anio}${mes}${dia}T${String(parseInt(hora)-1).padStart(2,'0')}${minutos}00Z`;
                
                const titulo = encodeURIComponent(`üéÅ SORTEO: ${datosComercioGlobal.titulo_sorteo} - ${nombreComercio}`);
                const detalles = encodeURIComponent(`No te pierdas el sorteo de H√°bitat-Car en ${nombreComercio}.\n\nüèÜ Premio: ${datosComercioGlobal.titulo_sorteo}\nüìç Comercio: ${nombreComercio}\n\n¬°Mucha suerte! üçÄ`);
                const ubicacion = encodeURIComponent(nombreComercio);
                
                const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${titulo}&dates=${fechaRecordatorio}/${fechaInicio}&details=${detalles}&location=${ubicacion}&sf=true&output=xml`;
                
                window.open(url, '_blank');
            } catch (e) {
                console.error("Error al generar evento:", e);
                alert("‚ö†Ô∏è No se pudo generar el evento.");
            }
        };

        window.cerrarPopup = () => {
            document.getElementById('overlay').style.display = 'none';
        };

        // ‚úÖ CARGA DE DATOS DEL COMERCIO - VERSI√ìN CORREGIDA Y DIN√ÅMICA
        if (nombreComercio) {
            document.getElementById('nombre-comercio').innerText = "Cargando...";

            // 1. CARGA DE DATOS DEL SORTEO (CON ERROR CATCH PARA EVITAR EL BLOQUEO)
            const qComercio = query(collection(db, "comercios"), where("nombre", "==", nombreComercio), limit(1));
            
            onSnapshot(qComercio, (snap) => {
                if (!snap.empty) {
                    const docSnap = snap.docs[0];
                    datosComercioGlobal = { id: docSnap.id, ...docSnap.data() };
                    
                    console.log("‚úÖ Datos del comercio cargados:", datosComercioGlobal);
                    
                    // Actualizar interfaz
                    document.getElementById('nombre-comercio').innerText = datosComercioGlobal.nombre || nombreComercio;
                    document.getElementById('tit-sorteo').innerText = datosComercioGlobal.titulo_sorteo || "Sorteo Pr√≥ximamente";
                    document.getElementById('desc-sorteo').innerText = datosComercioGlobal.descripcion_sorteo || "Seguinos para enterarte de los premios.";
                    
                    // ‚úÖ FORMATEAR FECHA Y HORA DEL SORTEO
                    if (datosComercioGlobal.fecha_sorteo) {
                        const fechaFormateada = formatearFechaHoraArgentina(datosComercioGlobal.fecha_sorteo);
                        if (fechaFormateada) {
                            document.getElementById("fecha-sorteo").innerText = fechaFormateada.fecha;
                            document.getElementById("hora-sorteo").innerText = fechaFormateada.hora;
                            document.getElementById("fecha-sorteo-container").style.display = 'flex';
                            fechaSorteoData = `${fechaFormateada.fecha} ${fechaFormateada.hora}`;
                        } else {
                            fechaSorteoData = datosComercioGlobal.fecha_sorteo;
                        }
                    }
                    
                    // Promociones
                    if (datosComercioGlobal.titulo_promo && datosComercioGlobal.titulo_promo.trim() !== "") {
                        document.getElementById("card-promo").style.display = 'flex';
                        document.getElementById("tit-promo").innerText = datosComercioGlobal.titulo_promo;
                        document.getElementById("desc-promo").innerText = datosComercioGlobal.descripcion_promo || "Sin informaci√≥n de promoci√≥n.";
                        
                        if (datosComercioGlobal.promo_vence && datosComercioGlobal.promo_vence.trim() !== "") {
                            const fechaFormateada = formatearFechaHoraArgentina(datosComercioGlobal.promo_vence);
                            if (fechaFormateada) {
                                document.getElementById("vence-fecha").innerText = fechaFormateada.fecha;
                                document.getElementById("vence-hora").innerText = fechaFormateada.hora;
                                document.getElementById("vence-promo-container").style.display = 'flex';
                            }
                        }
                    }
                    
                    // Mostrar card de sorteo si hay t√≠tulo
                    if (datosComercioGlobal.titulo_sorteo && datosComercioGlobal.titulo_sorteo.trim() !== "") {
                        document.getElementById("card-sorteo").style.display = 'flex';
                    }
                    
                } else {
                    console.error("‚ö†Ô∏è No se encontr√≥ el comercio en la DB con nombre:", nombreComercio);
                    document.getElementById('nombre-comercio').innerText = "‚ùå Comercio no encontrado";
                    document.getElementById('nombre-comercio').style.color = "var(--rojo)";
                }
            }, (error) => {
                console.error("‚ùå Error de conexi√≥n Firebase:", error);
                document.getElementById('nombre-comercio').innerText = "‚ö†Ô∏è Error de conexi√≥n";
                document.getElementById('nombre-comercio').style.color = "var(--rojo)";
            });

            // 2. CONTADOR DE TRANSPARENCIA EN TIEMPO REAL
            const qPart = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nombreComercio));
            onSnapshot(qPart, (snap) => {
                const total = snap.size;
                const container = document.getElementById('contador-transparencia');
                const texto = document.getElementById('texto-contador');
                if (container && texto) {
                    container.style.display = 'block';
                    texto.innerHTML = `Ya hay <b style="color:var(--verde); font-size:1.1em;">${total}</b> ${total === 1 ? 'persona' : 'personas'} participando üéâ`;
                }
            }, (error) => {
                console.warn("‚ö†Ô∏è No se pudo cargar el contador:", error.message);
            });
            
            // 3. Verificar participaci√≥n del usuario actual
            verificarParticipacion();
        } else {
            document.getElementById('nombre-comercio').innerText = "‚ö†Ô∏è Comercio no especificado";
            document.getElementById('nombre-comercio').style.color = "var(--rojo)";
        }

        // Hacer funciones accesibles globalmente
        window.abrirPopupExito = abrirPopupExito;
        window.notificarGoogleCalendar = notificarGoogleCalendar;
        window.cerrarPopup = cerrarPopup;
    </script>
</body>
</html>
