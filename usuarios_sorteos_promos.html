<!-- ========================================
     ARCHIVO: usuarios_sorteos_promos.html
     SORTEOS Y PROMOCIONES | H√ÅBITAT-CAR
     Funciones: Participaci√≥n, WhatsApp, Email, Google Calendar, Firebase
     √öltima actualizaci√≥n: 2026
     ======================================== -->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteos y Promociones | H√°bitat-Car</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --oro: #ffc107;
            --azul-oscuro: #0a192f;
            --azul-medio: #112240;
            --blanco: #e6f1ff;
            --naranja: #ff8c00;
            --verde: #28a745;
            --gris: #6c757d;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--azul-oscuro);
            color: var(--blanco);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .header {
            width: 100%;
            padding: 30px 0;
            text-align: center;
            background: var(--azul-medio);
            border-bottom: 4px solid var(--naranja);
        }
        .logo { width: 90%; max-width: 450px; height: auto; }
        .container {
            width: 90%;
            max-width: 500px;
            padding: 20px;
            text-align: center;
        }
        .comercio-info h1 {
            color: var(--oro);
            font-size: 2.2em;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .leyenda-ecosistema {
            color: #ffffff;
            font-size: 1.05em;
            font-weight: 600;
            margin-bottom: 25px;
            line-height: 1.5;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            padding: 8px 12px;
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
            border-left: 3px solid var(--naranja);
        }
        .card-seccion-titulo {
            color: var(--oro);
            font-size: 1.4em;
            font-weight: 700;
            margin: 0 0 15px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .card-seccion-titulo i { font-size: 1.2em; }
        .promo-card {
            background: linear-gradient(145deg, #112240, #1a3055);
            border-radius: 20px;
            padding: 30px;
            margin-top: 25px;
            border: 2px solid var(--naranja);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            align-items: center;
        }
        .promo-titulo {
            font-size: 1.6em;
            margin-bottom: 15px;
            color: white;
            font-weight: bold;
        }
        .promo-detalle {
            font-size: 1.15em;
            color: #ccd6f6;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }
        .badge-premios {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1rem;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .vigencia-texto {
            color: var(--naranja);
            font-weight: bold;
            margin-top: 10px;
            font-size: 0.95em;
            display: none;
        }
        .btn-participar {
            background: var(--naranja);
            color: white;
            padding: 18px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.2em;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .btn-participar:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-especificaciones {
            background: transparent;
            color: var(--oro);
            border: 1px solid var(--oro);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .popup {
            background: var(--azul-medio);
            padding: 40px 30px;
            border-radius: 30px;
            text-align: center;
            width: 85%;
            max-width: 380px;
            border: 2px solid var(--verde);
        }
        .popup i { font-size: 4.5em; color: var(--verde); margin-bottom: 20px; }
        .popup h2 { color: white; margin: 0 0 10px 0; font-size: 1.8em; }
        .footer-link {
            margin: 40px 0;
            background: var(--oro);
            color: var(--azul-oscuro);
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 12px;
            display: inline-block;
            font-weight: bold;
            border: 2px solid var(--oro);
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        .footer-link:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.5);
        }
        .participacion-info {
            background: rgba(40, 167, 69, 0.2);
            border: 2px solid var(--verde);
            padding: 20px;
            border-radius: 15px;
            margin-top: 25px;
            margin-bottom: 25px;
            display: none;
            width: 100%;
        }
        .participacion-info.visible { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fecha-hora-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .fecha-item, .hora-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }
        .fecha-item i, .hora-item i { color: var(--oro); width: 20px; }
        #contador-transparencia {
            display: none;
            background: rgba(255,193,7,0.1);
            border: 1px solid var(--oro);
            padding: 12px 20px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            font-size: 0.95em;
            color: var(--blanco);
            animation: pulse 2s infinite;
        }
        #contador-transparencia i { margin-right: 8px; color: var(--verde); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
        .btn-calendar {
            background: #4285F4;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 15px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .btn-calendar:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }
        @media (max-width: 768px) {
            body { padding-top: 0; }
            .promo-card { padding: 20px; }
            .promo-titulo { font-size: 1.3em; }
            .btn-participar { font-size: 1em; padding: 14px; }
            .badge-premios { font-size: 0.9rem; padding: 5px 12px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" class="logo" alt="H√°bitat-Car">
    </header>

    <div class="container">
        <div class="comercio-info">
            <h1 id="nombre-comercio">CARGANDO...</h1>
            <p style="color: var(--naranja); font-weight: bold; margin-bottom: 5px; font-size: 1.1em;">SORTEOS Y PROMOCIONES</p>
            <p class="leyenda-ecosistema">‚ú® Este es un espacio V√°lido para todos los miembros del Ecosistema Habitat-Car. ‚ú®</p>
        </div>

        <div id="contador-transparencia" style="display:none;">
            <i class="fas fa-users"></i> <span id="texto-contador">Cargando participantes...</span>
        </div>

        <div class="promo-card" id="card-sorteo">
            <h3 class="card-seccion-titulo"><i class="fas fa-gift"></i> SORTEO</h3>
            <h2 id="tit-sorteo" class="promo-titulo"></h2>
            <p id="desc-sorteo" class="promo-detalle"></p>
            
            <div id="badge-premios" class="badge-premios" style="display:none;">
                üéÅ <span id="cant-premios">1</span> premio<span id="plural-premios"></span> disponible<span id="plural-disp"></span>
            </div>
            
            <div class="fecha-hora-container" id="fecha-sorteo-container" style="display: none;">
                <div class="fecha-item"><i class="fas fa-calendar-day"></i><span id="fecha-sorteo"></span></div>
                <div class="hora-item"><i class="fas fa-clock"></i><span id="hora-sorteo"></span></div>
            </div>
            
            <button class="btn-participar" id="btn-participar" onclick="abrirPopupExito()">QUIERO PARTICIPAR</button>
            
            <div class="participacion-info" id="participacionInfo">
                <i class="fas fa-check-circle" style="color: var(--verde); font-size: 2em; margin-bottom: 10px;"></i>
                <p style="color: var(--verde); font-weight: bold; margin: 0;">‚úÖ YA EST√ÅS PARTICIPANDO</p>
                <p style="font-size: 0.9em; color: #aaa; margin: 5px 0 0 0;">Te notificaremos si resultas ganador</p>
            </div>
            
            <button class="btn-especificaciones" onclick="alert('Bases: 1. Ser miembro activo. 2. Presentar cup√≥n.')">Bases del Sorteo</button>
        </div>

        <div class="promo-card" id="card-promo" style="border-color: var(--oro);">
            <h3 class="card-seccion-titulo"><i class="fas fa-star"></i> PROMOCI√ìN</h3>
            <h2 id="tit-promo" class="promo-titulo"></h2>
            <p id="desc-promo" class="promo-detalle"></p>
            <div class="fecha-hora-container" id="vence-promo-container" style="display: none;">
                <div class="fecha-item"><i class="fas fa-calendar-check"></i><span id="vence-fecha"></span></div>
                <div class="hora-item"><i class="fas fa-hourglass-end"></i><span id="vence-hora"></span></div>
            </div>
        </div>

        <a href="javascript:history.back()" class="footer-link">
            <i class="fas fa-arrow-left"></i> VOLVER A BENEFICIOS
        </a>
    </div>

    <div id="overlay">
        <div class="popup">
            <i class="fas fa-check-circle"></i>
            <h2>¬°MUCHAS GRACIAS!</h2>
            <p id="txt-exito-dinamico"></p>
            <button onclick="notificarGoogleCalendar()" class="btn-calendar">
                <i class="fab fa-google"></i> AGENDAR Y NOTIFICARME (Google)
            </button>
            <button class="btn-participar" style="margin-top: 15px; background: var(--verde);" onclick="cerrarPopup()">EXCELENTE</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, getDoc, getDocs, doc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const params = new URLSearchParams(window.location.search);
        const nombreComercio = decodeURIComponent(params.get('id') || "");
        
        let datosComercioGlobal = null;
        let fechaSorteoData = "";

        function formatearFechaHoraArgentina(fechaISO) {
            if (!fechaISO) return null;
            try {
                const [fechaParte, horaParte] = fechaISO.split('T');
                const [anio, mes, dia] = fechaParte.split('-');
                return { fecha: `${dia}/${mes}/${anio}`, hora: `${horaParte} Hs.` };
            } catch (e) { return null; }
        }

        async function verificarParticipacion() {
            let idFinal = localStorage.getItem('leadId_v16') || localStorage.getItem('userId_vip');
            if(!idFinal) return;
            const participacionKey = `participo_sorteo_${nombreComercio}_${idFinal}`;
            if (localStorage.getItem(participacionKey) === 'true') {
                mostrarSoloCartelVerde();
                return;
            }
            try {
                const q = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nombreComercio), where("usuarioId", "==", idFinal));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    localStorage.setItem(participacionKey, 'true');
                    mostrarSoloCartelVerde();
                }
            } catch (e) { console.error("Error verificando:", e); }
        }

        function mostrarSoloCartelVerde() {
            const btn = document.getElementById('btn-participar');
            const info = document.getElementById('participacionInfo');
            if (btn) btn.style.display = 'none';
            if (info) info.classList.add('visible');
        }

        // ‚úÖ FUNCI√ìN CORREGIDA: Detecci√≥n de usuario basada en convertidoVIP
        window.abrirPopupExito = async () => {
            // 1Ô∏è‚É£ Prioridad absoluta a los IDs reales
            let idFinal = localStorage.getItem('leadId_habitat') || 
                          localStorage.getItem('leadId_v16') || 
                          localStorage.getItem('userId_vip');
            
            // Si no hay ID, debemos mandarlo a registrarse o avisarle
            if (!idFinal || idFinal.startsWith('temp_')) {
                alert("‚ö†Ô∏è Para participar debes estar registrado. Por favor, completa tus datos primero.");
                window.location.href = "usuarios_registro_lead.html";
                return;
            }

            if (!datosComercioGlobal) {
                alert("‚ö†Ô∏è Los datos del comercio a√∫n no cargaron.");
                return;
            }

            try {
                let u = null;
                let tipoUsuario = "LEAD"; // Por defecto

                // 1Ô∏è‚É£ Primero intentamos buscar en la colecci√≥n de LEADS
                const leadSnap = await getDoc(doc(db, "leads", idFinal));
                
                if (leadSnap.exists()) {
                    u = leadSnap.data();
                    // üî• ESTA ES LA CLAVE: Si convertidoVIP es true, ES VIP.
                    if (u.convertidoVIP === true || u.tipo === "VIP") {
                        tipoUsuario = "VIP";
                    } else {
                        tipoUsuario = "LEAD";
                    }
                    console.log("Detectado en leads como:", tipoUsuario);
                } else {
                    // 2Ô∏è‚É£ Si no existe en leads, buscamos en la colecci√≥n de vips
                    const vipSnap = await getDoc(doc(db, "vips", idFinal));
                    if (vipSnap.exists()) {
                        u = vipSnap.data();
                        tipoUsuario = "VIP";
                        console.log("Detectado en vips como: VIP");
                    }
                }
                
                // Si despu√©s de ambas b√∫squedas no hay usuario, idFinal es temporal
                if (!u) {
                    tipoUsuario = "LEAD"; // O manejar como usuario no registrado
                }

                // 4Ô∏è‚É£ Construcci√≥n de datos con Fallbacks robustos
                const nombreReal = u ? (u.nombres || u.nombre || "") : "";
                const apellidoReal = u ? (u.apellido || "") : "";
                const nombreFinal = (nombreReal + " " + apellidoReal).trim() || "Usuario Sorteo";
                const whatsappFinal = u ? (u.whatsapp || u.celular || "S/D") : "S/D";
                const emailFinal = u ? (u.email || "S/D") : "S/D";

                // 5Ô∏è‚É£ Guardar en la base de participaci√≥n con tipo normalizado
                await addDoc(collection(db, "admin_participantes_sorteos"), {
                    usuarioId: idFinal,
                    nombre: nombreFinal,
                    nombres: nombreReal,
                    apellido: apellidoReal,
                    email: emailFinal,
                    celular: whatsappFinal,
                    whatsapp: whatsappFinal,
                    tipo: tipoUsuario, // ‚úÖ Aqu√≠ se guardar√° "VIP" si convertidoVIP era true
                    comercio: nombreComercio,
                    comercioId: datosComercioGlobal.id || "",
                    premio: datosComercioGlobal.titulo_sorteo || "Sorteo",
                    fecha_sorteo: fechaSorteoData,
                    timestamp: serverTimestamp()
                });

                localStorage.setItem(`participo_sorteo_${nombreComercio}_${idFinal}`, 'true');
                
                const saludo = nombreReal.split(' ')[0] || "¬°Listo!";
                document.getElementById('txt-exito-dinamico').innerText = `¬°Excelente ${saludo}! Ya est√°s participando.`;
                document.getElementById('overlay').style.display = 'flex';
                mostrarSoloCartelVerde();

            } catch (e) {
                console.error("‚ùå Error al participar:", e);
                alert("Error de conexi√≥n: " + e.message);
            }
        };

        // Carga de Datos Principal
        if (nombreComercio) {
            onSnapshot(query(collection(db, "comercios"), where("nombre", "==", nombreComercio), limit(1)), (snap) => {
                if (!snap.empty) {
                    datosComercioGlobal = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    document.getElementById('nombre-comercio').innerText = datosComercioGlobal.nombre;
                    
                    if (datosComercioGlobal.titulo_sorteo) {
                        document.getElementById('card-sorteo').style.display = 'flex';
                        document.getElementById('tit-sorteo').innerText = datosComercioGlobal.titulo_sorteo;
                        document.getElementById('desc-sorteo').innerText = datosComercioGlobal.descripcion_sorteo || "";
                        
                        const cantPremios = parseInt(datosComercioGlobal.cantidad_premios) || 1;
                        const badge = document.getElementById('badge-premios');
                        const spanCant = document.getElementById('cant-premios');
                        const spanPlural = document.getElementById('plural-premios');
                        const spanDisp = document.getElementById('plural-disp');
                        
                        spanCant.innerText = cantPremios;
                        spanPlural.innerText = cantPremios > 1 ? 's' : '';
                        spanDisp.innerText = cantPremios > 1 ? 's' : '';
                        badge.style.display = 'inline-block';
                        
                        const f = formatearFechaHoraArgentina(datosComercioGlobal.fecha_sorteo);
                        if (f) {
                            document.getElementById('fecha-sorteo').innerText = f.fecha;
                            document.getElementById('hora-sorteo').innerText = f.hora;
                            document.getElementById('fecha-sorteo-container').style.display = 'flex';
                            fechaSorteoData = `${f.fecha} ${f.hora}`;
                        }
                    }
                    
                    if (datosComercioGlobal.titulo_promo) {
                        document.getElementById("card-promo").style.display = 'flex';
                        document.getElementById("tit-promo").innerText = datosComercioGlobal.titulo_promo;
                        document.getElementById("desc-promo").innerText = datosComercioGlobal.descripcion_promo || "";
                    }
                }
            });

            onSnapshot(query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nombreComercio)), (snap) => {
                document.getElementById('contador-transparencia').style.display = 'block';
                document.getElementById('texto-contador').innerHTML = `Ya hay <b style="color:#28a745">${snap.size}</b> personas participando üéâ`;
            });

            verificarParticipacion();
        }

        window.cerrarPopup = () => document.getElementById('overlay').style.display = 'none';
        
        window.notificarGoogleCalendar = () => {
            if (!datosComercioGlobal || !datosComercioGlobal.fecha_sorteo) {
                alert("No hay una fecha definida para este sorteo.");
                return;
            }
            try {
                const [fechaParte, horaParte] = datosComercioGlobal.fecha_sorteo.split('T');
                const [anio, mes, dia] = fechaParte.split('-');
                const [hora, minutos] = horaParte ? horaParte.split(':') : ['19', '00'];
                const fechaInicio = `${anio}${mes}${dia}T${hora}${minutos}00Z`;
                const fechaRecordatorio = `${anio}${mes}${dia}T${String(parseInt(hora)-1).padStart(2,'0')}${minutos}00Z`;
                const titulo = encodeURIComponent(`üéÅ SORTEO: ${datosComercioGlobal.titulo_sorteo} - ${nombreComercio}`);
                const detalles = encodeURIComponent(`No te pierdas el sorteo de H√°bitat-Car en ${nombreComercio}.\n\nüèÜ Premio: ${datosComercioGlobal.titulo_sorteo}\nüìç Comercio: ${nombreComercio}\n\n¬°Mucha suerte! üçÄ`);
                const ubicacion = encodeURIComponent(nombreComercio);
                const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${titulo}&dates=${fechaRecordatorio}/${fechaInicio}&details=${detalles}&location=${ubicacion}&sf=true&output=xml`;
                window.open(url, '_blank');
            } catch (e) {
                console.error("Error al generar evento:", e);
                alert("‚ö†Ô∏è No se pudo generar el evento.");
            }
        };

        window.abrirPopupExito = abrirPopupExito;
        window.cerrarPopup = cerrarPopup;
        window.notificarGoogleCalendar = notificarGoogleCalendar;
    </script>
</body>
</html>
