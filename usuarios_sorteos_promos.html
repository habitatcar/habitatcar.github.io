<!-- ========================================
     ARCHIVO: usuarios_sorteos_promos.html
     SORTEOS Y PROMOCIONES | H√ÅBITAT-CAR
     Versi√≥n: CON GANADORES (CORREGIDO)
     ======================================== -->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorteos y Promociones | H√°bitat-Car</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --oro: #ffc107;
            --azul-oscuro: #0a192f;
            --azul-medio: #112240;
            --blanco: #e6f1ff;
            --naranja: #ff8c00;
            --verde: #28a745;
            --gris: #6c757d;
            --dorado-ganador: #d4af37;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--azul-oscuro);
            color: var(--blanco);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .header {
            width: 100%;
            padding: 30px 0;
            text-align: center;
            background: var(--azul-medio);
            border-bottom: 4px solid var(--naranja);
        }
        .logo { width: 90%; max-width: 450px; height: auto; }
        .container {
            width: 90%;
            max-width: 500px;
            padding: 20px;
            text-align: center;
        }
        .comercio-info h1 {
            color: var(--oro);
            font-size: 2.2em;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .leyenda-ecosistema {
            color: #ffffff;
            font-size: 1.05em;
            font-weight: 600;
            margin-bottom: 25px;
            line-height: 1.5;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            padding: 8px 12px;
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
            border-left: 3px solid var(--naranja);
        }
        .card-seccion-titulo {
            color: var(--oro);
            font-size: 1.4em;
            font-weight: 700;
            margin: 0 0 15px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .card-seccion-titulo i { font-size: 1.2em; }
        .promo-card {
            background: linear-gradient(145deg, #112240, #1a3055);
            border-radius: 20px;
            padding: 30px;
            margin-top: 25px;
            border: 2px solid var(--naranja);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            align-items: center;
        }
        .promo-titulo {
            font-size: 1.6em;
            margin-bottom: 15px;
            color: white;
            font-weight: bold;
        }
        .promo-detalle {
            font-size: 1.15em;
            color: #ccd6f6;
            line-height: 1.6;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }
        .badge-premios {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1rem;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        /* ‚úÖ ANIMACIONES PARA BOT√ìN DE GANADOR */
        @keyframes destello-ganador {
            0% { 
                box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.9);
                transform: scale(1);
                border-color: var(--dorado-ganador);
            }
            50% {
                box-shadow: 0 0 0 25px rgba(212, 175, 55, 0.4);
                transform: scale(1.03);
                border-color: #ffd966;
            }
            100% { 
                box-shadow: 0 0 0 45px rgba(212, 175, 55, 0);
                transform: scale(1);
                border-color: var(--dorado-ganador);
            }
        }
        
        .btn-ganador {
            background: linear-gradient(145deg, #8B6B1D, #C5A028);
            color: white;
            padding: 18px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.2em;
            border: 3px solid var(--dorado-ganador);
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s;
            animation: destello-ganador 1.5s infinite;
            position: relative;
            z-index: 1;
        }
        .btn-ganador.ya-visto {
            animation: none;
            box-shadow: none;
            background: #4a4a4a;
            border-color: #666;
        }
        
        .btn-participar {
            background: var(--naranja);
            color: white;
            padding: 18px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.2em;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .btn-participar:disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-especificaciones {
            background: transparent;
            color: var(--oro);
            border: 1px solid var(--oro);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        /* ‚úÖ MODAL DE GANADORES */
        #overlay-ganadores {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        .popup-ganadores {
            background: var(--azul-medio);
            padding: 30px 20px;
            border-radius: 30px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            border: 3px solid var(--dorado-ganador);
            max-height: 80vh;
            overflow-y: auto;
        }
        .popup-ganadores h2 {
            color: var(--dorado-ganador);
            font-size: 1.8em;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .ganador-item {
            background: rgba(0,0,0,0.3);
            border-left: 5px solid var(--dorado-ganador);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            text-align: left;
        }
        .ganador-nombre {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--dorado-ganador);
            margin-bottom: 5px;
        }
        .ganador-localidad {
            font-size: 1em;
            color: #aaa;
        }
        .ganador-localidad i {
            color: var(--oro);
            margin-right: 5px;
        }
        .btn-cerrar-ganadores {
            background: var(--dorado-ganador);
            color: black;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
        }
        
        .footer-link {
            margin: 40px 0;
            background: var(--oro);
            color: var(--azul-oscuro);
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 12px;
            display: inline-block;
            font-weight: bold;
            border: 2px solid var(--oro);
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        .footer-link:hover {
            background: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.5);
        }
        .participacion-info {
            background: rgba(40, 167, 69, 0.2);
            border: 2px solid var(--verde);
            padding: 20px;
            border-radius: 15px;
            margin-top: 25px;
            margin-bottom: 25px;
            display: none;
            width: 100%;
        }
        .participacion-info.visible { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fecha-hora-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .fecha-item, .hora-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }
        .fecha-item i, .hora-item i { color: var(--oro); width: 20px; }
        #contador-transparencia {
            display: none;
            background: rgba(255,193,7,0.1);
            border: 1px solid var(--oro);
            padding: 12px 20px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            font-size: 0.95em;
            color: var(--blanco);
            animation: pulse 2s infinite;
        }
        #contador-transparencia i { margin-right: 8px; color: var(--verde); }
        .btn-calendar {
            background: #4285F4;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 15px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        .btn-calendar:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }
        @media (max-width: 768px) {
            body { padding-top: 0; }
            .promo-card { padding: 20px; }
            .promo-titulo { font-size: 1.3em; }
            .btn-participar, .btn-ganador { font-size: 1em; padding: 14px; }
            .badge-premios { font-size: 0.9rem; padding: 5px 12px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" class="logo" alt="H√°bitat-Car">
    </header>

    <div class="container">
        <div class="comercio-info">
            <h1 id="nombre-comercio">CARGANDO...</h1>
            <p style="color: var(--naranja); font-weight: bold; margin-bottom: 5px; font-size: 1.1em;">SORTEOS Y PROMOCIONES</p>
            <p class="leyenda-ecosistema">‚ú® Este es un espacio V√°lido para todos los miembros del Ecosistema Habitat-Car. ‚ú®</p>
        </div>

        <div id="contador-transparencia" style="display:none;">
            <i class="fas fa-users"></i> <span id="texto-contador">Cargando participantes...</span>
        </div>

        <div class="promo-card" id="card-sorteo">
            <h3 class="card-seccion-titulo"><i class="fas fa-gift"></i> SORTEO</h3>
            <h2 id="tit-sorteo" class="promo-titulo"></h2>
            <p id="desc-sorteo" class="promo-detalle"></p>
            
            <div id="badge-premios" class="badge-premios" style="display:none;">
                üéÅ <span id="cant-premios">1</span> premio<span id="plural-premios"></span> disponible<span id="plural-disp"></span>
            </div>
            
            <div class="fecha-hora-container" id="fecha-sorteo-container" style="display: none;">
                <div class="fecha-item"><i class="fas fa-calendar-day"></i><span id="fecha-sorteo"></span></div>
                <div class="hora-item"><i class="fas fa-clock"></i><span id="hora-sorteo"></span></div>
            </div>
            
            <!-- Bot√≥n para participar (se muestra si el sorteo est√° activo) -->
            <button class="btn-participar" id="btn-participar" onclick="abrirPopupExito()">QUIERO PARTICIPAR</button>
            
            <!-- Bot√≥n para ver ganadores (se muestra si el sorteo ya finaliz√≥) -->
            <button class="btn-ganador" id="btn-ganador" style="display: none;" onclick="verGanadores()">üèÜ VER GANADOR(ES)</button>
            
            <div class="participacion-info" id="participacionInfo">
                <i class="fas fa-check-circle" style="color: var(--verde); font-size: 2em; margin-bottom: 10px;"></i>
                <p style="color: var(--verde); font-weight: bold; margin: 0;">‚úÖ YA EST√ÅS PARTICIPANDO</p>
                <p style="font-size: 0.9em; color: #aaa; margin: 5px 0 0 0;">Te notificaremos si resultas ganador</p>
            </div>
            
            <button class="btn-especificaciones" onclick="alert('Bases: 1. Ser miembro activo. 2. Presentar cup√≥n.')">Bases del Sorteo</button>
        </div>

        <div class="promo-card" id="card-promo" style="border-color: var(--oro);">
            <h3 class="card-seccion-titulo"><i class="fas fa-star"></i> PROMOCI√ìN</h3>
            <h2 id="tit-promo" class="promo-titulo"></h2>
            <p id="desc-promo" class="promo-detalle"></p>
            <div class="fecha-hora-container" id="vence-promo-container" style="display: none;">
                <div class="fecha-item"><i class="fas fa-calendar-check"></i><span id="vence-fecha"></span></div>
                <div class="hora-item"><i class="fas fa-hourglass-end"></i><span id="vence-hora"></span></div>
            </div>
        </div>

        <a href="javascript:history.back()" class="footer-link">
            <i class="fas fa-arrow-left"></i> VOLVER A BENEFICIOS
        </a>
    </div>

    <!-- Popup de participaci√≥n exitosa (SIN MODIFICACIONES) -->
    <div id="overlay">
        <div class="popup">
            <i class="fas fa-check-circle"></i>
            <h2>¬°MUCHAS GRACIAS!</h2>
            <p id="txt-exito-dinamico"></p>
            <button onclick="notificarGoogleCalendar()" class="btn-calendar">
                <i class="fab fa-google"></i> AGENDAR Y NOTIFICARME (Google)
            </button>
            <button class="btn-participar" style="margin-top: 15px; background: var(--verde);" onclick="cerrarPopup()">EXCELENTE</button>
        </div>
    </div>

    <!-- Modal para mostrar ganadores -->
    <div id="overlay-ganadores">
        <div class="popup-ganadores">
            <h2>üèÜ GANADOR(ES)</h2>
            <div id="lista-ganadores-modal"></div>
            <button class="btn-cerrar-ganadores" onclick="cerrarModalGanadores()">CERRAR</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, getDoc, getDocs, doc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const params = new URLSearchParams(window.location.search);
        const nombreComercio = decodeURIComponent(params.get('id') || "");
        
        let datosComercioGlobal = null;
        let fechaSorteoData = "";
        let idComercio = "";

        function formatearFechaHoraArgentina(fechaISO) {
            if (!fechaISO) return null;
            try {
                const [fechaParte, horaParte] = fechaISO.split('T');
                const [anio, mes, dia] = fechaParte.split('-');
                return { fecha: `${dia}/${mes}/${anio}`, hora: `${horaParte} Hs.` };
            } catch (e) { return null; }
        }

        // ‚úÖ Funci√≥n para obtener nombre parcial
        function obtenerNombreParcial(nombreCompleto) {
            if (!nombreCompleto) return "An√≥nimo";
            const partes = nombreCompleto.split(' ');
            if (partes.length === 0) return "An√≥nimo";
            
            const primerNombre = partes[0];
            const nombreCorto = primerNombre.length > 6 ? primerNombre.substring(0, 6) + '...' : primerNombre;
            
            if (partes.length > 1) {
                const apellido = partes[partes.length - 1];
                const letraApellido = apellido.charAt(0).toUpperCase();
                return `${nombreCorto} ${letraApellido}.`;
            }
            
            return nombreCorto;
        }

        // ‚úÖ Verificar si el sorteo ya finaliz√≥ y mostrar bot√≥n de ganador
        async function verificarSorteoFinalizado() {
            if (!idComercio || !datosComercioGlobal || !datosComercioGlobal.titulo_sorteo) return;
            
            const btnParticipar = document.getElementById('btn-participar');
            const btnGanador = document.getElementById('btn-ganador');
            const cartelVerde = document.getElementById('participacionInfo');
            
            // Buscar en historial_sorteos
            const q = query(
                collection(db, "historial_sorteos"),
                where("comercio", "==", nombreComercio),
                where("premio", "==", datosComercioGlobal.titulo_sorteo)
            );
            
            const snap = await getDocs(q);
            
            if (!snap.empty) {
                // El sorteo ya finaliz√≥
                const historial = snap.docs[0].data();
                const ganadores = historial.ganadores || [];
                
                // Guardar los ganadores en una variable global para usarlos despu√©s
                window.ganadoresDelSorteo = ganadores;
                
                // Ocultar bot√≥n participar y cartel verde
                btnParticipar.style.display = 'none';
                cartelVerde.classList.remove('visible');
                cartelVerde.style.display = 'none';
                
                // Verificar si ya vio los ganadores
                const yaVio = localStorage.getItem(`visto_ganadores_${idComercio}_${datosComercioGlobal.titulo_sorteo}`);
                
                if (yaVio) {
                    btnGanador.classList.add('ya-visto');
                    btnGanador.innerText = 'üèÜ VER GANADOR(ES)';
                } else {
                    btnGanador.classList.remove('ya-visto');
                }
                
                btnGanador.style.display = 'block';
            } else {
                // Sorteo activo
                btnGanador.style.display = 'none';
                btnParticipar.style.display = 'block';
                
                // Verificar participaci√≥n normalmente
                verificarParticipacion();
            }
        }

        // ‚úÖ Funci√≥n para mostrar ganadores
        window.verGanadores = () => {
            const btnGanador = document.getElementById('btn-ganador');
            const ganadores = window.ganadoresDelSorteo || [];
            
            if (ganadores.length === 0) {
                alert("No hay informaci√≥n de ganadores disponible.");
                return;
            }
            
            // Marcar como visto
            localStorage.setItem(`visto_ganadores_${idComercio}_${datosComercioGlobal.titulo_sorteo}`, 'true');
            btnGanador.classList.add('ya-visto');
            
            // Renderizar lista de ganadores
            const lista = document.getElementById('lista-ganadores-modal');
            lista.innerHTML = '';
            
            ganadores.forEach((g, index) => {
                const nombreParcial = obtenerNombreParcial(g.nombreMostrar || g.nombre || "Participante");
                // ‚úÖ AHORA S√ç: Tomar provincia y localidad del ganador
                const provincia = g.provincia || "No especificada";
                const localidad = g.localidad || "No especificada";
                
                const numeroPremio = g.numeroPremio || (ganadores.length === 1 ? "Ganador" : `${index + 1}¬∫ Premio`);
                
                lista.innerHTML += `
                    <div class="ganador-item">
                        <div class="ganador-nombre">${numeroPremio}: ${nombreParcial}</div>
                        <div class="ganador-localidad">
                            <i class="fas fa-map-marker-alt"></i> ${localidad}, ${provincia}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('overlay-ganadores').style.display = 'flex';
        };

        window.cerrarModalGanadores = () => {
            document.getElementById('overlay-ganadores').style.display = 'none';
        };

        async function verificarParticipacion() {
            let idFinal = localStorage.getItem('leadId_v16') || localStorage.getItem('userId_vip');
            if(!idFinal) return;
            const participacionKey = `participo_sorteo_${nombreComercio}_${idFinal}`;
            if (localStorage.getItem(participacionKey) === 'true') {
                mostrarSoloCartelVerde();
                return;
            }
            try {
                const q = query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nombreComercio), where("usuarioId", "==", idFinal));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    localStorage.setItem(participacionKey, 'true');
                    mostrarSoloCartelVerde();
                }
            } catch (e) { console.error("Error verificando:", e); }
        }

        function mostrarSoloCartelVerde() {
            const btn = document.getElementById('btn-participar');
            const info = document.getElementById('participacionInfo');
            if (btn) btn.style.display = 'none';
            if (info) {
                info.style.display = 'block';
                info.classList.add('visible');
            }
        }

        window.abrirPopupExito = async () => {
            let idFinal = localStorage.getItem('leadId_habitat') || 
                          localStorage.getItem('leadId_v16') || 
                          localStorage.getItem('userId_vip');
            
            if (!idFinal || idFinal.startsWith('temp_')) {
                alert("‚ö†Ô∏è Para participar debes estar registrado. Por favor, completa tus datos primero.");
                window.location.href = "usuarios_registro_lead.html";
                return;
            }

            if (!datosComercioGlobal) {
                alert("‚ö†Ô∏è Los datos del comercio a√∫n no cargaron.");
                return;
            }

            try {
                let u = null;
                let tipoUsuario = "LEAD";

                const leadSnap = await getDoc(doc(db, "leads", idFinal));
                
                if (leadSnap.exists()) {
                    u = leadSnap.data();
                    if (u.convertidoVIP === true || u.tipo === "VIP") {
                        tipoUsuario = "VIP";
                    } else {
                        tipoUsuario = "LEAD";
                    }
                } else {
                    const vipSnap = await getDoc(doc(db, "vips", idFinal));
                    if (vipSnap.exists()) {
                        u = vipSnap.data();
                        tipoUsuario = "VIP";
                    }
                }
                
                const nombreReal = u ? (u.nombres || u.nombre || "") : "";
                const apellidoReal = u ? (u.apellido || "") : "";
                const nombreFinal = (nombreReal + " " + apellidoReal).trim() || "Usuario Sorteo";
                const whatsappFinal = u ? (u.whatsapp || u.celular || "S/D") : "S/D";
                const emailFinal = u ? (u.email || "S/D") : "S/D";
                const provinciaFinal = u ? (u.provincia || "") : "";
                const localidadFinal = u ? (u.localidad || "") : "";

                await addDoc(collection(db, "admin_participantes_sorteos"), {
                    usuarioId: idFinal,
                    nombre: nombreFinal,
                    nombres: nombreReal,
                    apellido: apellidoReal,
                    email: emailFinal,
                    celular: whatsappFinal,
                    whatsapp: whatsappFinal,
                    provincia: provinciaFinal,
                    localidad: localidadFinal,
                    tipo: tipoUsuario,
                    comercio: nombreComercio,
                    comercioId: idComercio,
                    premio: datosComercioGlobal.titulo_sorteo || "Sorteo",
                    fecha_sorteo: fechaSorteoData,
                    timestamp: serverTimestamp()
                });

                localStorage.setItem(`participo_sorteo_${nombreComercio}_${idFinal}`, 'true');
                
                const saludo = nombreReal.split(' ')[0] || "¬°Listo!";
                document.getElementById('txt-exito-dinamico').innerText = `¬°Excelente ${saludo}! Ya est√°s participando.`;
                document.getElementById('overlay').style.display = 'flex';
                mostrarSoloCartelVerde();

            } catch (e) {
                console.error("‚ùå Error al participar:", e);
                alert("Error de conexi√≥n: " + e.message);
            }
        };

        // Carga de Datos Principal
        if (nombreComercio) {
            onSnapshot(query(collection(db, "comercios"), where("nombre", "==", nombreComercio), limit(1)), (snap) => {
                if (!snap.empty) {
                    const docSnap = snap.docs[0];
                    datosComercioGlobal = { id: docSnap.id, ...docSnap.data() };
                    idComercio = docSnap.id;
                    
                    document.getElementById('nombre-comercio').innerText = datosComercioGlobal.nombre;
                    
                    if (datosComercioGlobal.titulo_sorteo) {
                        document.getElementById('card-sorteo').style.display = 'flex';
                        document.getElementById('tit-sorteo').innerText = datosComercioGlobal.titulo_sorteo;
                        document.getElementById('desc-sorteo').innerText = datosComercioGlobal.descripcion_sorteo || "";
                        
                        const cantPremios = parseInt(datosComercioGlobal.cantidad_premios) || 1;
                        const badge = document.getElementById('badge-premios');
                        const spanCant = document.getElementById('cant-premios');
                        const spanPlural = document.getElementById('plural-premios');
                        const spanDisp = document.getElementById('plural-disp');
                        
                        spanCant.innerText = cantPremios;
                        spanPlural.innerText = cantPremios > 1 ? 's' : '';
                        spanDisp.innerText = cantPremios > 1 ? 's' : '';
                        badge.style.display = 'inline-block';
                        
                        const f = formatearFechaHoraArgentina(datosComercioGlobal.fecha_sorteo);
                        if (f) {
                            document.getElementById('fecha-sorteo').innerText = f.fecha;
                            document.getElementById('hora-sorteo').innerText = f.hora;
                            document.getElementById('fecha-sorteo-container').style.display = 'flex';
                            fechaSorteoData = `${f.fecha} ${f.hora}`;
                        }
                        
                        // Verificar si el sorteo ya finaliz√≥
                        verificarSorteoFinalizado();
                    }
                    
                    if (datosComercioGlobal.titulo_promo) {
                        document.getElementById("card-promo").style.display = 'flex';
                        document.getElementById("tit-promo").innerText = datosComercioGlobal.titulo_promo;
                        document.getElementById("desc-promo").innerText = datosComercioGlobal.descripcion_promo || "";
                        
                        if (datosComercioGlobal.promo_vence) {
                            const f = formatearFechaHoraArgentina(datosComercioGlobal.promo_vence);
                            if (f) {
                                document.getElementById('vence-fecha').innerText = f.fecha;
                                document.getElementById('vence-hora').innerText = f.hora;
                                document.getElementById('vence-promo-container').style.display = 'flex';
                            }
                        }
                    }
                }
            });

            onSnapshot(query(collection(db, "admin_participantes_sorteos"), where("comercio", "==", nombreComercio)), (snap) => {
                document.getElementById('contador-transparencia').style.display = 'block';
                document.getElementById('texto-contador').innerHTML = `Ya hay <b style="color:#28a745">${snap.size}</b> personas participando üéâ`;
            });
        }

        window.cerrarPopup = () => document.getElementById('overlay').style.display = 'none';
        
        window.notificarGoogleCalendar = () => {
            if (!datosComercioGlobal || !datosComercioGlobal.fecha_sorteo) {
                alert("No hay una fecha definida para este sorteo.");
                return;
            }
            try {
                const [fechaParte, horaParte] = datosComercioGlobal.fecha_sorteo.split('T');
                const [anio, mes, dia] = fechaParte.split('-');
                const [hora, minutos] = horaParte ? horaParte.split(':') : ['19', '00'];
                const fechaInicio = `${anio}${mes}${dia}T${hora}${minutos}00Z`;
                const fechaRecordatorio = `${anio}${mes}${dia}T${String(parseInt(hora)-1).padStart(2,'0')}${minutos}00Z`;
                const titulo = encodeURIComponent(`üéÅ SORTEO: ${datosComercioGlobal.titulo_sorteo} - ${nombreComercio}`);
                const detalles = encodeURIComponent(`No te pierdas el sorteo de H√°bitat-Car en ${nombreComercio}.\n\nüèÜ Premio: ${datosComercioGlobal.titulo_sorteo}\nüìç Comercio: ${nombreComercio}\n\n¬°Mucha suerte! üçÄ`);
                const ubicacion = encodeURIComponent(nombreComercio);
                const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${titulo}&dates=${fechaRecordatorio}/${fechaInicio}&details=${detalles}&location=${ubicacion}&sf=true&output=xml`;
                window.open(url, '_blank');
            } catch (e) {
                console.error("Error al generar evento:", e);
                alert("‚ö†Ô∏è No se pudo generar el evento.");
            }
        };

        window.abrirPopupExito = abrirPopupExito;
        window.cerrarPopup = cerrarPopup;
        window.notificarGoogleCalendar = notificarGoogleCalendar;
    </script>
</body>
</html>
