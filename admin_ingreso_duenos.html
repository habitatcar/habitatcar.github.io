<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor√≠a de Canjes | HABITAT-CAR</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --azul-oscuro: #0a192f;
            --azul-medio: #1e3a5f;
            --azul-claro: #415a77;
            --celeste-habitat: #004a99;
            --blanco-suave: #e6f1ff;
            --borravino: #800020;
            --verde: #28a745;
            --rojo: #dc3545;
            --oro: #ffc107;
            --dorado: #d4af37;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--azul-oscuro);
            color: var(--blanco-suave);
            margin: 0;
            padding: 0;
        }
        .header {
            background: var(--azul-medio);
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid var(--celeste-habitat);
        }
        .logo {
            height: 80px;
            margin-bottom: 10px;
        }
        .subtitulo {
            font-size: 1.2em;
            margin: 10px 0;
            color: var(--oro);
        }
        .acceso-privado {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 20px;
        }
        .form-id {
            max-width: 500px;
            margin: 0 auto 30px;
            text-align: center;
        }
        .input-id {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid var(--borravino);
            border-radius: 8px;
            text-align: center;
            background: #000;
            color: white;
            margin-bottom: 15px;
        }
        .btn-ingresar {
            background: var(--verde);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }
        .btn-ingresar:hover {
            background: #218838;
            transform: scale(1.02);
        }
        .stats-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0 30px;
            flex-wrap: wrap;
        }
        .stat-box {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
            border-left: 3px solid var(--oro);
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--oro);
        }
        .stat-label {
            font-size: 0.9em;
            color: #ccc;
        }
        .tabla-cupones {
            width: 95%;
            max-width: 900px;
            margin: 0 auto;
            background: var(--azul-medio);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .tabla-cupones table {
            width: 100%;
            border-collapse: collapse;
        }
        .tabla-cupones th,
        .tabla-cupones td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .tabla-cupones th {
            background: rgba(0,0,0,0.4);
            color: var(--oro);
            font-weight: bold;
        }
        .tabla-cupones tr:last-child td {
            border-bottom: none;
        }
        .acciones-finales {
            text-align: center;
            margin-top: 30px;
        }
        .btn-accion {
            padding: 12px 25px;
            margin: 0 10px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            transition: 0.3s;
        }
        .btn-imprimir {
            background: var(--azul-claro);
            color: white;
        }
        .btn-compartir {
            background: var(--borravino);
            color: white;
        }
        .btn-accion:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Estilos del Modal de Invitaciones */
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .hidden { display: none; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .z-50 { z-index: 50; }
        .p-4 { padding: 1rem; }
        .bg-black { background-color: black; }
        .bg-opacity-90 { background-color: rgba(0, 0, 0, 0.9); }
        .max-w-md { max-width: 28rem; }
        .w-full { width: 100%; }
        .p-6 { padding: 1.5rem; }
        .relative { position: relative; }
        .text-center { text-align: center; }
        .mb-6 { margin-bottom: 1.5rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: bold; }
        .text-sm { font-size: 0.875rem; }
        .mt-2 { margin-top: 0.5rem; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .max-h-\[50vh\] { max-height: 50vh; }
        .pr-2 { padding-right: 0.5rem; }
        .mt-8 { margin-top: 2rem; }
        .w-full { width: 100%; }
        .bg-gray-800 { background-color: #1f2937; }
        .hover\:bg-gray-700:hover { background-color: #374151; }
        .text-white { color: white; }
        .font-bold { font-weight: bold; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .transition-all { transition-property: all; transition-duration: 150ms; }
        .border { border-width: 1px; }
        .border-gray-600 { border-color: #4b5563; }
        .absolute { position: absolute; }
        .top-4 { top: 1rem; }
        .right-4 { right: 1rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-gray-400 { color: #9ca3af; }
        .hover\:text-white:hover { color: white; }
        .bg-gray-900 { background-color: #111827; }
        .border-2 { border-width: 2px; }
        .border-dorado { border-color: #d4af37; }
        .rounded-2xl { border-radius: 1rem; }
        .shadow-\[0_0_30px_rgba\(212\,175\,55\,0\.3\)\] { box-shadow: 0 0 30px rgba(212, 175, 55, 0.3); }
        .text-dorado { color: #d4af37; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d4af37; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <img src="https://github.com/habitatcar/habitatcar.github.io/blob/main/logo.png?raw=true" class="logo" alt="Habitat Car">
        <h1>HABITAT-CAR</h1>
        <div class="subtitulo">NEGOCIOS INMOBILIARIOS y GESTIONES DEL AUTOMOTOR</div>
        <div class="acceso-privado">Acceso Privado para Propietarios</div>
    </div>

    <div class="form-id">
        <input type="text" id="id-comercio" class="input-id" placeholder="Ingresa tu ID de Comercio" autocomplete="off">
        <button class="btn-ingresar" onclick="ingresar()">Ingresar al Sistema</button>
        
        <!-- ‚úÖ BOT√ìN DE INVITACIONES AGREGADO AQU√ç -->
        <div class="flex flex-wrap gap-4 justify-center my-6">
            <a id="link-modificar" href="#" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-all shadow-lg font-bold">
                ‚öôÔ∏è MODIFICAR LOS DATOS DE MI FICHA COMERCIAL
            </a>
            <button onclick="abrirInvitacionesVIP()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm transition-all shadow-lg font-bold border border-yellow-400">
                ‚ú® Invitaciones VIP de cortes√≠a
            </button>
        </div>
    </div>

    <div class="stats-container">
        <div class="stat-box">
            <div class="stat-value" id="total-usuarios">0</div>
            <div class="stat-label">Total Usuarios</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="canjes-vip">0</div>
            <div class="stat-label">Canjes VIP</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="canjes-lead">0</div>
            <div class="stat-label">Canjes Lead</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="ultimo-acceso">--:--</div>
            <div class="stat-label">√öltimo Acceso</div>
        </div>
    </div>

    <div class="tabla-cupones">
        <table>
            <thead>
                <tr>
                    <th>Fecha/Hora</th>
                    <th>Categor√≠a</th>
                    <th>Nro Cup√≥n</th>
                    <th>Detalle</th>
                </tr>
            </thead>
            <tbody id="registros-cupones">
                <!-- Los registros se cargar√°n aqu√≠ din√°micamente -->
            </tbody>
        </table>
    </div>

    <div class="acciones-finales">
        <button class="btn-accion btn-imprimir" onclick="imprimirReporte()">
            üñ®Ô∏è IMPRIMIR REPORTE
        </button>
        <button class="btn-accion btn-compartir" onclick="compartirEnlace()">
            üîó Compartir
        </button>
    </div>

    <!-- ‚úÖ MODAL DE INVITACIONES AGREGADO AQU√ç -->
    <div id="modal-invitaciones" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-gray-900 border-2 border-dorado rounded-2xl max-w-md w-full p-6 relative shadow-[0_0_30px_rgba(212,175,55,0.3)]">
            <button onclick="cerrarInvitaciones()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
            
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-dorado">¬°Felicidades! ‚ú®</h2>
                <p class="text-sm text-gray-300 mt-2">
                    Como agradecimiento por ser parte de <b>Habitat-Car</b>, tienes 10 invitaciones VIP de cortes√≠a para otorgar a tus clientes o amigos.
                </p>
            </div>

            <div id="lista-invitaciones" class="space-y-2 overflow-y-auto max-h-[50vh] pr-2 custom-scroll">
                <p class="text-center text-gray-500 animate-pulse">Cargando tus beneficios...</p>
            </div>

            <div class="mt-8 text-center">
                <button onclick="cerrarInvitaciones()" class="w-full bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-xl transition-all border border-gray-600">
                    Volver al Panel
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let comercioIdGlobal = null;

        function formatearFecha(timestamp) {
            if (!timestamp) return "--:--";
            const fecha = new Date(timestamp);
            return fecha.toLocaleString('es-AR', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function ingresar() {
            const idInput = document.getElementById('id-comercio');
            const idComercio = idInput.value.trim().toLowerCase();
            
            if (!idComercio) {
                alert("Por favor, ingresa tu ID de comercio.");
                return;
            }

            try {
                const q = query(collection(db, "comercios"), where("idComercio", "==", idComercio));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    alert("ID de comercio no encontrado. Verifica que lo hayas ingresado correctamente.");
                    return;
                }

                const docSnap = querySnapshot.docs[0];
                const data = docSnap.data();
                comercioIdGlobal = docSnap.id;

                // Actualizar el enlace de modificaci√≥n
                document.getElementById('link-modificar').href = 
                    `admin_comercios.html?id=${idComercio}&admin=true`;

                // Escuchar cambios en tiempo real
                onSnapshot(doc(db, "comercios", comercioIdGlobal), (docSnap) => {
                    if (docSnap.exists()) {
                        const c = docSnap.data();
                        actualizarEstadisticas(c);
                        cargarRegistros(c);
                    }
                });

            } catch (error) {
                console.error("Error al ingresar:", error);
                alert("Error de conexi√≥n. Intenta nuevamente.");
            }
        }

        function actualizarEstadisticas(comercio) {
            document.getElementById('total-usuarios').textContent = 
                (comercio.totalUsos || 0) + (comercio.totalVips || 0);
            document.getElementById('canjes-vip').textContent = comercio.totalVips || 0;
            document.getElementById('canjes-lead').textContent = comercio.totalUsos || 0;
            document.getElementById('ultimo-acceso').textContent = 
                formatearFecha(comercio.lastSubmission);
        }

        function cargarRegistros(comercio) {
            const tbody = document.getElementById('registros-cupones');
            tbody.innerHTML = '';

            // Aqu√≠ normalmente cargar√≠as los logs desde otra colecci√≥n
            // Por ahora, dejamos la tabla vac√≠a como en el original
        }

        function imprimirReporte() {
            if (!comercioIdGlobal) {
                alert("Primero debes ingresar con tu ID de comercio.");
                return;
            }
            // L√≥gica de impresi√≥n (no modificada)
            window.print();
        }

        function compartirEnlace() {
            if (!comercioIdGlobal) {
                alert("Primero debes ingresar con tu ID de comercio.");
                return;
            }
            const idComercio = document.getElementById('id-comercio').value.trim();
            const url = `${window.location.origin}${window.location.pathname}?id=${idComercio}`;
            navigator.clipboard.writeText(url).then(() => {
                alert("‚úÖ ¬°Enlace copiado! P√©galo en WhatsApp o redes.");
            });
        }

        // ‚úÖ L√ìGICA DE INVITACIONES VIP AGREGADA AQU√ç
        window.abrirInvitacionesVIP = async () => {
            const idComercio = document.getElementById('id-comercio').value.trim();
            if(!idComercio) return alert("Por favor, ingresa tu ID de comercio primero.");

            document.getElementById('modal-invitaciones').classList.remove('hidden');
            document.getElementById('modal-invitaciones').classList.add('flex');
            
            const lista = document.getElementById('lista-invitaciones');
            lista.innerHTML = '<p class="text-center text-dorado">Generando tus pases VIP...</p>';

            try {
                // Consultar si ya tiene las 10 invitaciones
                const q = query(collection(db, "tokens_vip"), where("comercioId", "==", idComercio), where("tipo", "==", "cortesia_dueno"));
                const snap = await getDocs(q);
                let tokens = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));

                // Si no existen, crearlas de una vez (Solo la primera vez)
                if (tokens.length === 0) {
                    for (let i = 1; i <= 10; i++) {
                        const nuevoToken = "CORTESIA-" + Math.random().toString(36).substr(2, 5).toUpperCase() + "-" + idComercio.substring(0,3).toUpperCase();
                        await addDoc(collection(db, "tokens_vip"), {
                            token: nuevoToken,
                            comercioId: idComercio,
                            estado: 'disponible',
                            tipo: 'cortesia_dueno',
                            fechaCreacion: Date.now()
                        });
                    }
                    return abrirInvitacionesVIP(); // Re-ejecutar para mostrar las reci√©n creadas
                }

                // Renderizar la lista con el formato solicitado
                lista.innerHTML = '';
                tokens.forEach((t, index) => {
                    const link = `https://habitatcar.com/registro?token=${t.token}`;
                    const esUsado = t.estado !== 'disponible';
                    
                    lista.innerHTML += `
                        <div class="flex items-center justify-between bg-black bg-opacity-50 p-3 rounded-xl border ${esUsado ? 'border-red-900' : 'border-gray-700'} mb-2">
                            <div class="flex flex-col">
                                <span class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">Pase ${index + 1}</span>
                                <span class="text-[11px] ${esUsado ? 'text-red-500' : 'text-green-400'} font-bold">
                                    ${esUsado ? 'üî¥ YA UTILIZADO' : 'üü¢ ESTADO: DISPONIBLE'}
                                </span>
                            </div>
                            
                            <button onclick="copiarLink('${link}')" 
                                    ${esUsado ? 'disabled' : ''}
                                    class="${esUsado ? 'bg-gray-800 text-gray-500 cursor-not-allowed' : 'bg-dorado text-black hover:scale-105 active:scale-95'} transition-all text-[10px] font-black py-2 px-3 rounded-lg shadow-md">
                                ${esUsado ? 'CANJEADO' : 'COPIAR PARA INVITAR'}
                            </button>
                        </div>
                    `;
                });

            } catch (e) {
                console.error(e);
                lista.innerHTML = '<p class="text-red-500 text-center">Error al conectar con el sistema.</p>';
            }
        };

        window.cerrarInvitaciones = () => {
            document.getElementById('modal-invitaciones').classList.add('hidden');
            document.getElementById('modal-invitaciones').classList.remove('flex');
        };

        window.copiarLink = (link) => {
            navigator.clipboard.writeText(link).then(() => {
                alert("‚úÖ ¬°Enlace de invitaci√≥n copiado!\nYa puedes pegarlo en el chat de tu cliente.");
            });
        };
    </script>
</body>
</html>
