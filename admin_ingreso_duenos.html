<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor칤a de Canjes | HABITAT-CAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --dorado: #d4af37; --negro-fondo: #0a0a0a; }
        body { background-color: var(--negro-fondo); color: white; font-family: 'Segoe UI', sans-serif; }
        .text-dorado { color: var(--dorado); }
        .bg-dorado { background-color: var(--dorado); }
        .border-dorado { border-color: var(--dorado); }
        
        /* Estilo solicitado para el t칤tulo: Azul con borde blanco grueso */
        .titulo-especial {
            color: #0033ff; 
            -webkit-text-stroke: 2px white;
            text-shadow: 0 0 10px rgba(0, 51, 255, 0.3);
        }

        /* Scroll para la tabla y encabezado fijo */
        .contenedor-tabla {
            max-height: 450px;
            overflow-y: auto;
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #1f2937; /* gray-800 */
            z-index: 10;
        }
    </style>
</head>
<body class="p-4 pb-32">

    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-8">
            <div class="border-b-2 border-dorado pb-6 mb-4">
                <h1 class="text-4xl font-black tracking-tighter italic titulo-especial">HABITAT-CAR</h1>
                <p class="text-dorado font-bold uppercase tracking-widest text-sm mt-1">NEGOCIOS INMOBILIARIOS y GESTIONES DEL AUTOMOTOR</p>
            </div>
            <p id="nombreComercioDinamico" class="text-dorado font-bold uppercase tracking-widest text-lg mt-2"></p>
            <p class="text-gray-400 font-semibold uppercase tracking-widest text-xs">Acceso Privado para Propietarios</p>
        </header>

        <div id="loginBox" class="bg-gray-900 p-6 rounded-2xl border border-dorado mb-8 shadow-2xl">
            <h2 class="text-dorado font-bold mb-4 uppercase text-center">Identificaci칩n de Comercio</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="comercioId" placeholder="ID de Usuario (ej: opticaelmiron)" 
                    class="bg-black border-2 border-gray-800 focus:border-dorado outline-none p-4 rounded-xl text-white transition-all text-sm">
                <input type="password" id="comercioPass" placeholder="Contrase침a" 
                    class="bg-black border-2 border-gray-800 focus:border-dorado outline-none p-4 rounded-xl text-white transition-all text-sm">
            </div>
            <button onclick="validarYConsultar()" 
                class="w-full mt-4 bg-dorado text-black font-black py-4 rounded-xl hover:bg-yellow-500 transition-all uppercase">
                Ingresar al Sistema
            </button>
        </div>

        <div id="dashboard" class="hidden">
            
            <div class="mb-8">
                <button onclick="irAFicha()" class="w-full bg-dorado text-black font-black p-4 rounded-xl flex items-center justify-center gap-2 hover:bg-yellow-500 shadow-lg">
                    <span>丘뙖잺</span> MODIFICAR LOS DATOS DE MI FICHA COMERCIAL
                </button>
            </div>

            <div class="bg-gray-900 p-6 rounded-2xl border border-gray-800 mb-8 shadow-lg">
                <div class="h-64"><canvas id="graficoSemanal"></canvas></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gray-900 p-5 rounded-2xl border-b-4 border-white">
                    <span class="block text-gray-500 text-[10px] font-black uppercase">Total Usuarios</span>
                    <span id="statTotal" class="text-3xl font-bold text-white">0</span>
                </div>
                <div class="bg-gray-900 p-5 rounded-2xl border-b-4 border-dorado">
                    <span class="block text-gray-500 text-[10px] font-black uppercase">Canjes VIP</span>
                    <span id="statVip" class="text-3xl font-bold text-dorado">0</span>
                </div>
                <div class="bg-gray-900 p-5 rounded-2xl border-b-4 border-blue-500">
                    <span class="block text-gray-500 text-[10px] font-black uppercase">Canjes Lead</span>
                    <span id="statLead" class="text-3xl font-bold text-blue-500">0</span>
                </div>
                <div class="bg-gray-900 p-5 rounded-2xl border-b-4 border-green-500">
                    <span class="block text-gray-500 text-[10px] font-black uppercase">칔ltimo Acceso</span>
                    <span id="statUltima" class="text-xl font-bold text-white">--:--</span>
                </div>
            </div>

            <div id="reporteArea" class="bg-gray-900 rounded-3xl border border-gray-800 overflow-hidden shadow-2xl">
                <div class="contenedor-tabla">
                    <table class="w-full text-left">
                        <thead class="bg-gray-800 text-gray-400 text-[10px] uppercase">
                            <tr><th class="p-5">Fecha/Hora</th><th class="p-5">Categor칤a</th><th class="p-5">Nro Cup칩n</th><th class="p-5">Detalle</th></tr>
                        </thead>
                        <tbody id="tablaMaestra" class="divide-y divide-gray-800 text-sm"></tbody>
                    </table>
                </div>
            </div>

            <footer class="fixed bottom-0 left-0 w-full bg-black/90 backdrop-blur-md p-4 border-t border-dorado flex gap-4 justify-center z-50">
                <button onclick="generarPDF()" class="bg-white text-black px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-gray-200 uppercase text-sm">
                    游늯 Generar PDF
                </button>
                <button onclick="compartirApp()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-blue-500 uppercase text-sm">
                    游댕 Compartir
                </button>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let unsubVip = null, unsubLead = null;
        let miGrafico = null;
        const registroUsuarios = {}; // Para contador de usos

        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const bypass = urlParams.get('admin');
            const cid = urlParams.get('id');

            if (bypass === 'true' && cid) {
                document.getElementById('comercioId').value = cid;
                try {
                    const q = query(collection(db, "comercios"), where("idComercio", "==", cid));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const docSnap = querySnapshot.docs[0];
                        const docData = docSnap.data();
                        const uidFirebase = docSnap.id;
                        document.getElementById('nombreComercioDinamico').innerText = docData.nombre || "";
                        sessionStorage.setItem('token_habitat_' + cid, 'admin_bypass_' + Date.now());
                        document.getElementById('loginBox').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        inicializarGrafico();
                        iniciarSuscripciones(uidFirebase);
                    }
                } catch (e) { console.error("Error bypass:", e); }
            }
        };

        window.validarYConsultar = async () => {
            const cid = document.getElementById('comercioId').value.trim();
            const pass = document.getElementById('comercioPass').value.trim();
            if(!cid || !pass) return alert("Complete los datos de acceso");

            try {
                const q = query(collection(db, "comercios"), where("idComercio", "==", cid));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) return alert("El ID de comercio no existe.");

                const docSnap = querySnapshot.docs[0];
                const docData = docSnap.data();
                const uidFirebase = docSnap.id; 

                if (docData.password === pass) {
                    document.getElementById('nombreComercioDinamico').innerText = docData.nombre || "";
                    sessionStorage.setItem('token_habitat_' + cid, 'autorizado_' + Date.now());
                    document.getElementById('loginBox').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    inicializarGrafico();
                    iniciarSuscripciones(uidFirebase);
                } else { alert("Contrase침a incorrecta"); }
            } catch (error) { console.error(error); alert("Error de conexi칩n."); }
        };

        function iniciarSuscripciones(uid) {
            const qVip = query(collection(db, "logs_vip"), where("comercioId", "==", uid));
            unsubVip = onSnapshot(qVip, (snap) => procesarSnapshot(snap, "VIP"));
            const qLead = query(collection(db, "logs_actividad"), where("comercioId", "==", uid), where("tipo", "==", "canje"));
            unsubLead = onSnapshot(qLead, (snap) => procesarSnapshot(snap, "LEAD"));
        }

        function procesarSnapshot(snap, tipo) {
            const tabla = document.getElementById('tablaMaestra');
            snap.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const d = change.doc.data();
                    const docId = change.doc.id;
                    if (document.getElementById(docId)) return;

                    let fecha = d.fecha?.toDate ? d.fecha.toDate() : (d.timestamp ? new Date(d.timestamp) : new Date());
                    const timestamp = fecha.getTime();
                    const esVip = (tipo === "VIP");
                    
                    // Contador de usos
                    const userId = d.usuarioId || d.userId || d.nombre || "anonimo";
                    registroUsuarios[userId] = (registroUsuarios[userId] || 0) + 1;
                    const usos = registroUsuarios[userId];

                    if (miGrafico) {
                        let diaIndex = fecha.getDay(); 
                        let diaAjustado = diaIndex === 0 ? 6 : diaIndex - 1; 
                        miGrafico.data.datasets[esVip ? 0 : 1].data[diaAjustado]++;
                        miGrafico.update();
                    }

                    const filaHTML = `
                        <tr id="${docId}" data-time="${timestamp}" class="hover:bg-black border-b border-gray-800">
                            <td class="p-5 font-bold">${fecha.toLocaleDateString()}<br><span class="text-gray-500 font-normal">${fecha.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}hs</span></td>
                            <td class="p-5"><span class="px-2 py-1 rounded text-[10px] font-black ${esVip ? 'bg-yellow-900/40 text-dorado' : 'bg-blue-900/40 text-blue-400'}">${esVip ? 'VIP' : 'LEAD'}</span></td>
                            <td class="p-5 font-mono">${d.codigoGenerado || 'LEAD'}</td>
                            <td class="p-5 text-gray-400 text-xs">
                                <div>${d.beneficio || d.nombre || 'Sin detalle'}</div>
                                <div class="text-dorado font-bold mt-1 uppercase text-[9px]">Usos registrados: ${usos}</div>
                            </td>
                        </tr>`;

                    // Inserci칩n ordenada cronol칩gicamente
                    const filas = Array.from(tabla.querySelectorAll('tr'));
                    const posicion = filas.findIndex(f => parseInt(f.getAttribute('data-time')) < timestamp);
                    if (posicion === -1) tabla.insertAdjacentHTML('beforeend', filaHTML);
                    else filas[posicion].insertAdjacentHTML('beforebegin', filaHTML);

                    // Actualizar Stats
                    const elStat = document.getElementById(esVip ? 'statVip' : 'statLead');
                    elStat.innerText = parseInt(elStat.innerText) + 1;
                    document.getElementById('statTotal').innerText = parseInt(document.getElementById('statVip').innerText) + parseInt(document.getElementById('statLead').innerText);
                    document.getElementById('statUltima').innerText = fecha.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                }
            });
        }

        window.irAFicha = () => {
            const cid = document.getElementById('comercioId').value;
            window.location.href = `admin_comercios.html?id=${cid}`;
        };

        window.generarPDF = async (soloBlob = false) => {
            const original = document.getElementById('reporteArea');
            const clon = original.cloneNode(true);
            const container = clon.querySelector('.contenedor-tabla');
            
            // Forzar que el clon no tenga scroll para que salga completo
            container.style.maxHeight = 'none';
            container.style.overflow = 'visible';
            clon.style.background = '#0a0a0a';
            
            const opt = { 
                margin: 0.2, 
                filename: 'Reporte_HabitatCar.pdf', 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2, backgroundColor: '#0a0a0a' }, 
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } 
            };

            if (soloBlob) return html2pdf().set(opt).from(clon).output('blob');
            html2pdf().set(opt).from(clon).save();
        };

        window.compartirApp = async () => {
            try {
                const pdfBlob = await generarPDF(true);
                const file = new File([pdfBlob], "Reporte_Habitat.pdf", { type: "application/pdf" });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'Reporte de Auditor칤a',
                        text: 'Adjunto reporte de canjes HABITAT-CAR'
                    });
                } else {
                    alert("Tu navegador no soporta compartir archivos directamente. Se descargar치 el PDF.");
                    window.generarPDF();
                }
            } catch (e) { console.error(e); alert("Error al procesar el archivo."); }
        };

        function inicializarGrafico() {
            const ctx = document.getElementById('graficoSemanal').getContext('2d');
            miGrafico = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Lun', 'Mar', 'Mi칠', 'Jue', 'Vie', 'S치b', 'Dom'],
                    datasets: [
                        { label: 'VIP', data: [0,0,0,0,0,0,0], borderColor: '#d4af37', tension: 0.4 },
                        { label: 'LEAD', data: [0,0,0,0,0,0,0], borderColor: '#3b82f6', tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#aaa' } } } }
            });
        }
    </script>
</body>
</html>
