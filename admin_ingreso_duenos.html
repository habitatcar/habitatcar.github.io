<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor√≠a de Canjes | HABITAT-CAR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --dorado: #d4af37; --negro-fondo: #0a0a0a; }
        body { background-color: var(--negro-fondo); color: white; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        .text-dorado { color: var(--dorado); }
        .bg-dorado { background-color: var(--dorado); }
        .border-dorado { border-color: var(--dorado); }
        
        /* T√≠tulo Principal */
        .titulo-especial {
            color: #00eeff; 
            -webkit-text-stroke: 2px white;
            text-shadow: 0 0 10px rgba(0, 238, 255, 0.3);
        }

        /* Tabla con scroll y encabezado fijo */
        .contenedor-tabla {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--dorado) #1a1a1a;
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #1f2937; /* bg-gray-800 */
            z-index: 10;
        }
    </style>
</head>
<body class="p-4 pb-32">

    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-8">
            <div class="border-b-2 border-dorado pb-4 mb-4">
                <h1 class="text-4xl font-black tracking-tighter italic titulo-especial">HABITAT-CAR</h1>
                <p class="text-dorado font-bold uppercase tracking-widest text-sm mt-1">NEGOCIOS INMOBILIARIOS y GESTIONES DEL AUTOMOTOR</p>
            </div>
            <p id="nombreComercioDinamico" class="text-dorado font-bold uppercase tracking-widest text-lg"></p>
            <p class="text-gray-400 font-semibold uppercase tracking-widest text-xs">Acceso Privado para Propietarios</p>
        </header>

        <div id="loginBox" class="bg-gray-900 p-6 rounded-2xl border border-dorado mb-8 shadow-2xl">
            <h2 class="text-dorado font-bold mb-4 uppercase text-center">Identificaci√≥n de Comercio</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="comercioId" placeholder="ID de Usuario" 
                    class="bg-black border-2 border-gray-800 focus:border-dorado outline-none p-4 rounded-xl text-white transition-all text-sm">
                <input type="password" id="comercioPass" placeholder="Contrase√±a" 
                    class="bg-black border-2 border-gray-800 focus:border-dorado outline-none p-4 rounded-xl text-white transition-all text-sm">
            </div>
            <button onclick="validarYConsultar()" 
                class="w-full mt-4 bg-dorado text-black font-black py-4 rounded-xl hover:bg-yellow-500 transition-all uppercase">
                Ingresar al Sistema
            </button>
        </div>

        <div id="dashboard" class="hidden">
            
            <div class="mb-8">
                <button onclick="irAFicha()" class="w-full bg-dorado text-black font-black p-4 rounded-xl flex items-center justify-center gap-2 hover:bg-yellow-500 shadow-lg">
                    <span>‚öôÔ∏è</span> MODIFICAR LOS DATOS DE MI FICHA COMERCIAL
                </button>
            </div>

            <div class="bg-gray-900 p-6 rounded-2xl border border-gray-800 mb-8 shadow-lg">
                <div class="h-64"><canvas id="graficoSemanal"></canvas></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-gray-900 p-5 rounded-2xl border-b-4 border-white">
                    <span class="block text-gray-500 text-[10px] font-black uppercase">Total Usuarios</span>
                    <span id="statTotal" class="text-3xl font-bold text-white">0</span>
                </div>
                <div class="bg-gray-900 p-5 rounded-2xl border-b-4 border-dorado">
                    <span class="block text-gray-500 text-[10px] font-black uppercase">Canjes VIP</span>
                    <span id="statVip" class="text-3xl font-bold text-dorado">0</span>
                </div>
                <div class="bg-gray-900 p-5 rounded-2xl border-b-4 border-blue-500">
                    <span class="block text-gray-500 text-[10px] font-black uppercase">Canjes Lead</span>
                    <span id="statLead" class="text-3xl font-bold text-blue-500">0</span>
                </div>
                <div class="bg-gray-900 p-5 rounded-2xl border-b-4 border-green-500">
                    <span class="block text-gray-500 text-[10px] font-black uppercase">√öltimo Acceso</span>
                    <span id="statUltima" class="text-xl font-bold text-white">--:--</span>
                </div>
            </div>

            <div id="areaImpresion" class="bg-gray-900 rounded-3xl border border-gray-800 overflow-hidden shadow-2xl">
                <div class="contenedor-tabla">
                    <table class="w-full text-left border-collapse">
                        <thead class="text-gray-400 text-[10px] uppercase">
                            <tr>
                                <th class="p-5 border-b border-gray-700">Fecha/Hora</th>
                                <th class="p-5 border-b border-gray-700">Categor√≠a</th>
                                <th class="p-5 border-b border-gray-700">Nro Cup√≥n</th>
                                <th class="p-5 border-b border-gray-700">Detalle</th>
                            </tr>
                        </thead>
                        <tbody id="tablaMaestra" class="divide-y divide-gray-800 text-sm">
                            </tbody>
                    </table>
                </div>
            </div>

            <footer class="fixed bottom-0 left-0 w-full bg-black/80 backdrop-blur-md p-4 border-t border-dorado flex gap-4 justify-center z-50">
                <button onclick="exportarPDF()" class="bg-white text-black px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-gray-200">
                    üìÑ GENERAR PDF
                </button>
                <button onclick="compartirDashboard()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:bg-blue-500">
                    üîó COMPARTIR
                </button>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD5M0kPsdU8Hk_YX3uEahfoQ5k9PD8SUXM",
            authDomain: "habitatcar-pro.firebaseapp.com",
            projectId: "habitatcar-pro",
            storageBucket: "habitatcar-pro.firebasestorage.app",
            messagingSenderId: "311691258694",
            appId: "1:311691258694:web:17a09051dcea7707af9347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let miGrafico = null;

        window.validarYConsultar = async () => {
            const cid = document.getElementById('comercioId').value.trim();
            const pass = document.getElementById('comercioPass').value.trim();
            if(!cid || !pass) return alert("Complete los datos");

            try {
                const q = query(collection(db, "comercios"), where("idComercio", "==", cid));
                const snap = await getDocs(q);
                if (snap.empty) return alert("No existe");

                const docData = snap.docs[0].data();
                if (docData.password === pass) {
                    document.getElementById('nombreComercioDinamico').innerText = docData.nombre || "";
                    document.getElementById('loginBox').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    inicializarGrafico();
                    iniciarSuscripciones(snap.docs[0].id);
                } else { alert("Error pass"); }
            } catch (e) { console.error(e); }
        };

        function iniciarSuscripciones(uid) {
            // VIPs
            onSnapshot(query(collection(db, "logs_vip"), where("comercioId", "==", uid)), (s) => procesar(s, "VIP"));
            // LEADS
            onSnapshot(query(collection(db, "logs_actividad"), where("comercioId", "==", uid), where("tipo", "==", "canje")), (s) => procesar(s, "LEAD"));
        }

        function procesar(snap, tipo) {
            const tabla = document.getElementById('tablaMaestra');
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const d = change.doc.data();
                    let f = d.fecha?.toDate ? d.fecha.toDate() : (d.timestamp ? new Date(d.timestamp) : new Date());
                    
                    const fila = `
                        <tr class="hover:bg-black border-b border-gray-800">
                            <td class="p-5 font-bold">${f.toLocaleDateString()}<br><span class="text-gray-500 font-normal">${f.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}hs</span></td>
                            <td class="p-5"><span class="px-2 py-1 rounded text-[10px] font-black ${tipo==='VIP'?'bg-yellow-900/40 text-dorado':'bg-blue-900/40 text-blue-400'}">${tipo}</span></td>
                            <td class="p-5 font-mono">${d.codigoGenerado || 'LEAD'}</td>
                            <td class="p-5 text-gray-400 text-xs">${d.beneficio || d.nombre || 'Sin detalle'}</td>
                        </tr>`;
                    tabla.insertAdjacentHTML('afterbegin', fila);
                    actualizarStats(tipo, f);
                }
            });
        }

        function actualizarStats(tipo, fecha) {
            const id = tipo === 'VIP' ? 'statVip' : 'statLead';
            const el = document.getElementById(id);
            el.innerText = parseInt(el.innerText) + 1;
            document.getElementById('statTotal').innerText = parseInt(document.getElementById('statVip').innerText) + parseInt(document.getElementById('statLead').innerText);
            document.getElementById('statUltima').innerText = fecha.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
        }

        function inicializarGrafico() {
            const ctx = document.getElementById('graficoSemanal').getContext('2d');
            miGrafico = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'],
                    datasets: [
                        { label:'VIP', data:[0,0,0,0,0,0,0], borderColor:'#d4af37', tension:0.4 },
                        { label:'LEAD', data:[0,0,0,0,0,0,0], borderColor:'#3b82f6', tension:0.4 }
                    ]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{labels:{color:'#aaa'}}} }
            });
        }

        // Funciones Globales para Botones
        window.exportarPDF = () => {
            const elemento = document.getElementById('areaImpresion');
            const opt = { margin: 1, filename: 'reporte-habitat.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            html2pdf().set(opt).from(elemento).save();
        };

        window.compartirDashboard = async () => {
            if (navigator.share) {
                try {
                    await navigator.share({ title: 'Auditor√≠a HABITAT-CAR', text: 'Reporte de canjes y actividad comercial.', url: window.location.href });
                } catch (e) { console.log("Error al compartir"); }
            } else { alert("Enlace copiado al portapapeles"); navigator.clipboard.writeText(window.location.href); }
        };

        window.irAFicha = () => {
            const cid = document.getElementById('comercioId').value;
            window.location.href = `admin_comercios.html?id=${cid}`;
        };
    </script>
</body>
</html>
